<!doctype html>
<html lang="th">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PY‑D (PropYield‑D) — Property Investment Tool · v5d (controls under Basic)</title>
  <style>
    :root {
      --bg: #0b0e13;
      --card: #12161c;
      --text: #e9eef3;
      --muted: #a7b0bb;
      --lime: #b2df37;
      --teal: #15d4cf;
      --warn: #f59e0b;
      --bad: #ef4444;
      --good: #22c55e;
      --border: rgba(255, 255, 255, .08);
      --shadow: 0 10px 30px rgba(0, 0, 0, .35);
      --radius: 16px
    }

    * {
      box-sizing: border-box
    }

    html,
    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font: 15px/1.6 Inter, system-ui, Segoe UI, Arial
    }

    h1,
    h2 {
      margin: 0 0 8px
    }

    h1 {
      font-size: 28px
    }

    h2 {
      font-size: 20px
    }

    .wrap {
      max-width: 1200px;
      margin: 0 auto;
      padding: 18px
    }

    .topbar {
      display: flex;
      gap: 12px;
      align-items: center;
      margin: 6px 0 14px
    }

    .badge {
      padding: 6px 10px;
      border: 1px solid var(--border);
      border-radius: 999px;
      color: var(--lime);
      background: rgba(178, 223, 55, .12);
      font-size: 12px
    }

    .grid {
      display: grid;
      gap: 16px
    }

    .card {
      background: linear-gradient(180deg, rgba(255, 255, 255, .02), rgba(255, 255, 255, .0));
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 16px;
      box-shadow: var(--shadow)
    }

    .layout {
      display: grid;
      gap: 16px
    }

    @media(min-width:1024px) {
      .layout {
        grid-template-columns: 1.05fr .95fr
      }
    }

    label {
      display: block;
      font-weight: 600;
      margin: 6px 0 6px
    }

    input[type=number],
    input[type=text],
    select {
      width: 100%;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: #0f1418;
      color: var(--text)
    }

    input.err {
      border-color: var(--bad)
    }

    .help {
      color: var(--muted);
      font-size: 12px
    }

    .row {
      display: grid;
      gap: 12px
    }

    .row-2 {
      grid-template-columns: repeat(2, minmax(0, 1fr))
    }

    .row-3 {
      grid-template-columns: repeat(3, minmax(0, 1fr))
    }

    .kpi {
      font-size: 26px;
      font-weight: 800
    }

    .kpi-sub {
      font-size: 12px;
      color: var(--muted)
    }

    .kval {
      font-variant-numeric: tabular-nums
    }

    .kval.good {
      color: var(--good)
    }

    .kval.warn {
      color: var(--warn)
    }

    .kval.bad {
      color: var(--bad)
    }

    .small {
      font-size: 12px;
      color: var(--muted)
    }

    .adv-btn {
      appearance: none;
      border: 1px solid var(--border);
      background: #0f1418;
      color: var(--text);
      padding: 8px 12px;
      border-radius: 10px;
      cursor: pointer
    }

    .controls {
      display: flex;
      align-items: center;
      gap: 10px;
      justify-content: flex-start;
      margin-top: 10px
    }

    .controls .spacer {
      flex: 1
    }

    .controls .small {
      opacity: .9
    }

    .adv-box {
      display: none;
      margin-top: 10px;
      padding: 12px;
      border-radius: 12px;
      background: #151a20;
      border: 1px solid var(--border)
    }

    .footer {
      opacity: .7;
      margin: 24px 0 40px
    }

    .sep {
      height: 1px;
      background: var(--border);
      margin: 8px 0
    }

    .table-like {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 6px
    }

    .pill {
      display: inline-block;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid transparent;
      font-size: 12px;
      margin: 4px 6px 0 0;
      font-weight: 700
    }

    .pill.good {
      background: #163d2a;
      color: #7ef6a9;
      border-color: #235f40
    }

    .pill.warn {
      background: #3e2f0f;
      color: #ffd579;
      border-color: #6b5418
    }

    .pill.bad {
      background: #4a1714;
      color: #ffb4ab;
      border-color: #7d2b27
    }

    /* Scenarios */
    .scenario {
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px;
      cursor: pointer;
      user-select: none
    }

    .scenario.active {
      outline: 2px solid var(--teal)
    }

    .sc-low {
      background: rgba(245, 158, 11, .08)
    }

    .sc-base {
      background: rgba(21, 212, 207, .08)
    }

    .sc-high {
      background: rgba(34, 197, 94, .08)
    }

    .sc-head {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
      font-weight: 800
    }

    .sc-metric {
      display: flex;
      justify-content: space-between;
      padding: 4px 0;
      border-bottom: 1px dashed var(--border);
      font-size: 13px
    }

    .sc-metric:last-child {
      border-bottom: none
    }

    .sc-val {
      font-variant-numeric: tabular-nums
    }

    .sc-val.good {
      color: var(--good)
    }

    .sc-val.warn {
      color: var(--warn)
    }

    .sc-val.bad {
      color: var(--bad)
    }

    .sc-desktop {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 12px
    }

    .seg {
      display: none
    }

    @media(max-width:1023px) {
      .seg {
        display: flex;
        gap: 6px
      }

      .seg button {
        flex: 1;
        padding: 8px;
        border-radius: 10px;
        border: 1px solid var(--border);
        background: #0f1418;
        color: var(--text)
      }

      .seg .active {
        border-color: var(--teal)
      }

      .sc-desktop {
        display: none
      }
    }

    .status-card {
      display: flex;
      flex-wrap: wrap;
      gap: 6px
    }

    /* Side switch */
    .switch {
      position: relative;
      display: inline-block;
      width: 42px;
      height: 24px;
      vertical-align: middle
    }

    .switch input {
      opacity: 0;
      width: 0;
      height: 0
    }

    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: #25303a;
      transition: .2s;
      border-radius: 999px;
      border: 1px solid var(--border)
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 3px;
      bottom: 3px;
      background: white;
      transition: .2s;
      border-radius: 50%
    }

    .switch input:checked+.slider {
      background: #165e56
    }

    .switch input:checked+.slider:before {
      transform: translateX(18px)
    }

    .panel-head {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px
    }

    .badge-on {
      padding: 4px 8px;
      border-radius: 999px;
      background: #17332c;
      color: #7ef6a9;
      font-size: 11px;
      border: 1px solid #265a47
    }

    .dim {
      opacity: .6
    }

    /* v1.5: Tooltips - HORIZONTAL ONLY */
    .tooltip-icon {
      display: inline-block;
      width: 16px;
      height: 16px;
      background: var(--teal);
      color: white;
      border-radius: 50%;
      text-align: center;
      line-height: 16px;
      font-size: 12px;
      cursor: help;
      margin-left: 4px;
      position: relative;
      /* Disable browser default tooltip */
      pointer-events: auto;
    }

    .tooltip-icon:hover {
      background: var(--lime);
    }

    .tooltip-content {
      /* HORIZONTAL LAYOUT - Width > Height, readable 1-3 lines */
      position: absolute !important;
      left: calc(100% + 10px) !important;
      top: 50% !important;
      transform: translateY(-50%) !important;

      /* Size for horizontal layout */
      min-width: 250px !important;
      max-width: 400px !important;
      width: max-content !important;

      /* Styling */
      background: var(--card) !important;
      color: var(--text) !important;
      padding: 10px 14px !important;
      border-radius: 8px !important;
      font-size: 13px !important;
      line-height: 1.5 !important;

      /* Text alignment - LEFT aligned, not centered */
      text-align: left !important;

      /* Text wrapping - Better line breaking for Thai text */
      white-space: normal !important;
      word-break: normal !important;
      word-wrap: break-word !important;
      overflow-wrap: break-word !important;
      hyphens: none !important;
      line-break: strict !important;

      /* Visual */
      border: 1px solid var(--border) !important;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4) !important;

      /* Visibility */
      opacity: 0 !important;
      visibility: hidden !important;
      transition: opacity 0.2s ease, visibility 0.2s ease !important;
      z-index: 10000 !important;
      pointer-events: none !important;
    }

    /* Arrow pointing left */
    .tooltip-content::before {
      content: '' !important;
      position: absolute !important;
      right: 100% !important;
      top: 50% !important;
      transform: translateY(-50%) !important;
      border: 6px solid transparent !important;
      border-right-color: var(--card) !important;
    }

    .tooltip-icon:hover .tooltip-content {
      opacity: 1 !important;
      visibility: visible !important;
    }

    /* v1.5: Help Modal */
    .help-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      z-index: 2000;
      display: none;
      align-items: center;
      justify-content: center;
    }

    .help-modal-content {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 0;
      max-width: 900px;
      width: 95%;
      max-height: 90vh;
      overflow: hidden;
      position: relative;
      display: flex;
      flex-direction: column;
    }

    .help-header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: var(--card);
    }

    .help-header h2 {
      margin: 0;
      font-size: 20px;
    }

    .help-close {
      background: none;
      border: none;
      color: var(--text);
      font-size: 24px;
      cursor: pointer;
      padding: 0;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
    }

    .help-close:hover {
      background: var(--border);
    }

    .help-content {
      padding: 24px;
      overflow-y: auto;
      flex: 1;
    }

    /* Accordion Styles */
    .accordion {
      border: 1px solid var(--border);
      border-radius: 8px;
      overflow: hidden;
    }

    .accordion-section {
      border-bottom: 1px solid var(--border);
    }

    .accordion-section:last-child {
      border-bottom: none;
    }

    .accordion-header {
      padding: 16px 20px;
      background: var(--bg);
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: 600;
      transition: background-color 0.2s ease;
      user-select: none;
    }

    .accordion-header:hover {
      background: var(--border);
    }

    .accordion-icon {
      transition: transform 0.2s ease;
      font-size: 14px;
    }

    .accordion-header.active .accordion-icon {
      transform: rotate(90deg);
    }

    .accordion-content {
      padding: 0 20px;
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease, padding 0.3s ease;
    }

    .accordion-content.active {
      max-height: 2000px;
      padding: 20px;
    }

    /* Content Styles */
    .example-card {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 12px;
      margin: 12px 0;
      font-size: 13px;
      line-height: 1.6;
    }

    .glossary-item {
      padding: 10px 0;
      border-bottom: 1px solid var(--border);
      font-size: 14px;
      line-height: 1.6;
    }

    .glossary-item:last-child {
      border-bottom: none;
    }

    .glossary-term {
      font-weight: 600;
      color: var(--lime);
    }

    .threshold-table {
      width: 100%;
      border-collapse: collapse;
      margin: 12px 0;
      font-size: 13px;
    }

    .threshold-table th,
    .threshold-table td {
      padding: 8px 12px;
      text-align: left;
      border: 1px solid var(--border);
    }

    .threshold-table th {
      background: var(--bg);
      font-weight: 600;
    }

    .faq-item {
      margin-bottom: 16px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--border);
    }

    .faq-item:last-child {
      border-bottom: none;
    }

    .help-section {
      margin-bottom: 24px;
    }

    .help-section h3 {
      color: var(--lime);
      margin-bottom: 12px;
    }

    .help-section h4 {
      color: var(--text);
      margin: 16px 0 8px 0;
      font-size: 16px;
    }

    .help-section ul {
      margin-left: 20px;
    }

    .help-section li {
      margin-bottom: 8px;
      line-height: 1.5;
    }

    .accordion-content h4 {
      color: var(--lime);
      margin: 16px 0 12px 0;
      font-size: 15px;
      font-weight: 600;
    }

    .accordion-content h4:first-child {
      margin-top: 0;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div>
        <div class="badge">PY‑D (PropYield‑D)</div>
        <h1>Property Investment Tool</h1>
      </div>
    </div>

    <div class="layout">
      <!-- LEFT -->
      <div class="grid">

        <!-- Investment -->
        <div class="card">
          <div class="panel-head">
            <h2>Investment</h2>
            <button id="help-btn" class="adv-btn" style="padding: 6px 10px; font-size: 12px;">❓ Help</button>
          </div>
          <div class="row row-3">
            <div><label>Purchase Price (THB) <span class="tooltip-icon"
                  data-tooltip="purchase_price">?</span></label><input type="text" id="purchase"
                placeholder="เช่น 4,000,000" /></div>
            <div><label>Avg / sqm (THB) <span class="tooltip-icon" data-tooltip="avg_psm">?</span></label><input
                type="text" id="avgpsm" placeholder="เช่น 120,000" /></div>
            <div><label>Area (sqm) <span class="tooltip-icon" data-tooltip="area_sqm">?</span></label><input type="text"
                id="area" placeholder="เช่น 35" /></div>
          </div>
          <div class="controls">
            <button class="adv-btn" data-target="#adv-invest">Show / Hide details</button>
            <div class="spacer"></div>
            <span class="small">Include in calc</span>
            <label class="switch"><input type="checkbox" id="swInv"><span class="slider"></span></label>
          </div>
          <div id="adv-invest" class="adv-box">
            <div class="row row-3">
              <div>
                <label>Acquisition Cost (%)</label><input type="number" id="acq_pct" value="3" inputmode="decimal" />
                <div class="help">≈ <span id="acq_thb">—</span> THB</div>
              </div>
              <div><label>Fit‑out (THB)</label><input type="number" id="fitout" value="0" inputmode="decimal" /></div>
              <div><label>Other Costs (THB)</label><input type="number" id="other" value="0" inputmode="decimal" />
              </div>
            </div>
            <div class="small">สวิตช์ “Include in calc” เปิด: จะบวก Acq/Fit‑out/Other เข้าต้นทุน (Cost basis)</div>
          </div>
        </div>

        <!-- Revenue -->
        <div class="card">
          <div class="panel-head">
            <h2>Revenue</h2>
          </div>
          <div class="row row-2">
            <div>
              <label>Rent / month (THB) <span class="tooltip-icon" data-tooltip="monthly_rent">?</span></label>
              <input type="text" id="rent" placeholder="เช่น 20,000" />
              <div class="help">two‑way with Target Gross Yield · base = Purchase</div>
            </div>
            <div>
              <label>Target Gross Yield (%) <span class="tooltip-icon"
                  data-tooltip="target_gross_yield">?</span></label>
              <input type="text" id="tgt_gross" placeholder="เช่น 5.0" />
            </div>
          </div>
          <div class="controls">
            <button class="adv-btn" data-target="#adv-rev">Show / Hide details</button>
            <div class="spacer"></div>
            <span class="small">Include in calc</span>
            <label class="switch"><input type="checkbox" id="swRev"><span class="slider"></span></label>
          </div>
          <div id="adv-rev" class="adv-box">
            <div class="row row-3">
              <div>
                <label>Occupancy (%)</label><input type="number" id="occ" value="90" inputmode="decimal" />
                <div class="help">Effective rent ≈ <span id="occ_eff">—</span> THB/mo</div>
              </div>
              <div>
                <label>Opex (%) (incl. common fee)</label><input type="number" id="opex" value="15"
                  inputmode="decimal" />
                <div class="help">Total opex ≈ <span id="opex_thb">—</span> THB/mo</div>
              </div>
              <div>
                <label>Agent Fee (months/yr)</label><input type="number" id="agentm" value="1" inputmode="decimal" />
                <div class="help">≈ <span id="agent_thb">—</span> THB/mo</div>
              </div>
            </div>
            <div class="small">สวิตช์ “Include in calc” เปิด: ใช้ Occ/Opex/Agent; ปิด: ใช้ neutral baseline (100%/0%/0)
            </div>
          </div>
        </div>

        <!-- Financing -->
        <div class="card">
          <div class="panel-head">
            <h2>Financing</h2>
          </div>
          <div class="row row-2">
            <div><label>Gross Salary (THB/mo) <span class="tooltip-icon"
                  data-tooltip="gross_salary">?</span></label><input type="text" id="salary"
                placeholder="เช่น 70,000" /></div>
            <div><label>Down Payment (%) <span class="tooltip-icon"
                  data-tooltip="down_payment_pct">?</span></label><input type="number" id="down" value="10"
                inputmode="decimal" /></div>
          </div>
          <div class="controls">
            <button class="adv-btn" data-target="#adv-fin">Show / Hide details</button>
            <div class="spacer"></div>
            <span class="small">Include in calc</span>
            <label class="switch"><input type="checkbox" id="swFin"><span class="slider"></span></label>
          </div>
          <div id="adv-fin" class="adv-box">
            <div class="row row-3">
              <div><label>Interest (APR %)</label><input type="number" id="rate" value="4.5" inputmode="decimal" />
              </div>
              <div><label>Tenor (years)</label>
                <select id="tenor">
                  <option value="30" selected>30</option>
                  <option value="25">25</option>
                  <option value="20">20</option>
                </select>
              </div>
              <div>
                <label>Equity Invested (auto)</label>
                <div id="equity_box" class="help">—</div>
              </div>
            </div>
            <div class="sep"></div>
            <div class="table-like small">
              <div>Down on Purchase</div>
              <div id="eq_down">—</div>
              <div>Acquisition Costs</div>
              <div id="eq_acq">—</div>
              <div>Fit‑out + Other</div>
              <div id="eq_fo">—</div>
            </div>
            <div class="small">สวิตช์ “Include in calc” เปิด: ใช้ APR/Tenor ตามฟิลด์; ปิด: ใช้ neutral baseline APR
              4.5%, 30y</div>
          </div>
        </div>

        <!-- Exit -->
        <div class="card">
          <div class="panel-head">
            <h2>Exit (optional)</h2>
          </div>
          <div><input type="checkbox" id="exit_on" /> รวม Exit ในสรุปผล</div>
          <div class="row row-3" style="margin-top:10px">
            <div><label>Holding (yrs) <span class="tooltip-icon" data-tooltip="holding_years">?</span></label><input
                type="number" id="hold" placeholder="เช่น 5" inputmode="decimal" />
            </div>
            <div><label>Price growth (%/yr) <span class="tooltip-icon"
                  data-tooltip="price_growth">?</span></label><input type="number" id="pgrow" placeholder="เช่น 3"
                inputmode="decimal" /></div>
            <div><label>Selling cost (%) <span class="tooltip-icon" data-tooltip="selling_cost">?</span></label><input
                type="number" id="sellc" value="3" inputmode="decimal" /></div>
          </div>
          <div class="controls">
            <button class="adv-btn" data-target="#adv-exit">Show / Hide details</button>
            <div class="spacer"></div>
            <span class="small">Include in calc</span>
            <label class="switch"><input type="checkbox" id="swExit"><span class="slider"></span></label>
          </div>
          <div id="adv-exit" class="adv-box">
            <div class="row row-3">
              <div><label>Exit Mode</label>
                <select id="exit_mode">
                  <option value="auto" selected>Auto (growth-driven)</option>
                  <option value="manual">Manual price</option>
                </select>
              </div>
              <div><label>Manual Exit Price (THB)</label><input type="number" id="exit_price" value="0"
                  inputmode="decimal" /></div>
              <div><label>Capital Gain Tax % (optional)</label><input type="number" id="tax_pct" value="0"
                  inputmode="decimal" /></div>
            </div>
            <div class="small">สวิตช์ “Include in calc” เปิด: ใช้ Exit Mode/Tax; ปิด: ใช้เฉพาะ Basic
              (Holding/Growth/Sell cost)</div>
          </div>
        </div>

      </div>

      <!-- RIGHT -->
      <div class="grid">

        <!-- Status -->
        <div class="card">
          <h2>Status</h2>
          <div id="status_pills" class="status-card"></div>
        </div>

        <!-- Scenarios -->
        <div class="card">
          <h2>Scenario Analysis</h2>
          <div class="seg">
            <button id="seg-low">Low</button><button id="seg-base" class="active">Base</button><button
              id="seg-high">High</button>
          </div>
          <div class="sc-desktop">
            <div class="scenario sc-low" id="card-low">
              <div class="sc-head"><span>Low (−10%)</span><span id="rent_low">—</span></div>
              <div class="sc-metric"><span>Net Yield</span><span id="ny_low" class="sc-val">—</span></div>
              <div class="sc-metric"><span>Cash Flow / mo</span><span id="cf_low" class="sc-val">—</span></div>
              <div class="sc-metric"><span>DTI</span><span id="dti_low" class="sc-val">—</span></div>
              <div class="sc-metric"><span>Payback (yrs)</span><span id="pb_low" class="sc-val">—</span></div>
              <div class="sc-metric"><span>CoC</span><span id="coc_low" class="sc-val">—</span></div>
            </div>
            <div class="scenario sc-base active" id="card-base">
              <div class="sc-head"><span>Base (0%)</span><span id="rent_base">—</span></div>
              <div class="sc-metric"><span>Net Yield</span><span id="ny_base" class="sc-val">—</span></div>
              <div class="sc-metric"><span>Cash Flow / mo</span><span id="cf_base" class="sc-val">—</span></div>
              <div class="sc-metric"><span>DTI</span><span id="dti_base" class="sc-val">—</span></div>
              <div class="sc-metric"><span>Payback (yrs)</span><span id="pb_base" class="sc-val">—</span></div>
              <div class="sc-metric"><span>CoC</span><span id="coc_base" class="sc-val">—</span></div>
            </div>
            <div class="scenario sc-high" id="card-high">
              <div class="sc-head"><span>High (+10%)</span><span id="rent_high">—</span></div>
              <div class="sc-metric"><span>Net Yield</span><span id="ny_high" class="sc-val">—</span></div>
              <div class="sc-metric"><span>Cash Flow / mo</span><span id="cf_high" class="sc-val">—</span></div>
              <div class="sc-metric"><span>DTI</span><span id="dti_high" class="sc-val">—</span></div>
              <div class="sc-metric"><span>Payback (yrs)</span><span id="pb_high" class="sc-val">—</span></div>
              <div class="sc-metric"><span>CoC</span><span id="coc_high" class="sc-val">—</span></div>
            </div>
          </div>
        </div>

        <!-- Key Metrics -->
        <div class="card">
          <h2>Key Metrics</h2>
          <div class="row row-3">
            <div>
              <div class="kpi kval" id="gross">—</div>
              <div class="kpi-sub">Gross Yield</div>
            </div>
            <div>
              <div class="kpi kval" id="net">—</div>
              <div class="kpi-sub">Net Yield (unlevered)</div>
            </div>
            <div>
              <div class="kpi kval" id="coc">—</div>
              <div class="kpi-sub">CoC Return</div>
            </div>
          </div>
          <div class="row row-3" style="margin-top:10px">
            <div>
              <div class="kpi kval" id="netmo">—</div>
              <div class="kpi-sub">Net / month (after debt or NOI if Financing off)</div>
            </div>
            <div>
              <div class="kpi kval" id="pmt">—</div>
              <div class="kpi-sub">PMT / month</div>
            </div>
            <div>
              <div class="kpi kval" id="dti">—</div>
              <div class="kpi-sub">DTI</div>
            </div>
          </div>
          <div class="row row-3" style="margin-top:10px">
            <div>
              <div class="kpi kval" id="payback">—</div>
              <div class="kpi-sub">Payback (yrs)</div>
            </div>
            <div>
              <div class="kpi kval" id="irr">—</div>
              <div class="kpi-sub">IRR (Exit ON)</div>
            </div>
            <div>
              <div class="kpi kval" id="emult">—</div>
              <div class="kpi-sub">Equity Multiple</div>
            </div>
          </div>
        </div>

        <!-- Affordability -->
        <div class="card">
          <h2>Affordability</h2>
          <div class="row row-3">
            <div>
              <div class="kpi" id="loan_amt">—</div>
              <div class="kpi-sub">Loan Amount</div>
            </div>
            <div>
              <div class="kpi" id="pmt2">—</div>
              <div class="kpi-sub">Monthly Payment</div>
            </div>
            <div>
              <div class="kpi" id="tot_int">—</div>
              <div class="kpi-sub">Total Interest</div>
            </div>
          </div>
          <div id="aff_warn" class="small" style="margin-top:8px">—</div>
        </div>

        <!-- Exit Summary -->
        <div class="card">
          <h2>Exit Summary</h2>
          <div class="row row-3">
            <div>
              <div class="kpi" id="tval">—</div>
              <div class="kpi-sub">Terminal Value</div>
            </div>
            <div>
              <div class="kpi" id="npro">—</div>
              <div class="kpi-sub">Net Proceeds</div>
            </div>
            <div>
              <div class="kpi" id="cgain">—</div>
              <div class="kpi-sub">Capital Gain</div>
            </div>
          </div>
        </div>

        <!-- AI Note -->
        <div class="card">
          <h2>AI Note:</h2>
          <div id="ai_note" class="small">—</div>
        </div>

      </div>
    </div>

    <div class="footer small">©2025 PropYield‑D. Prototype v5d (controls under Basic, side‑switch, neutral baseline,
      blank Basic)</div>
  </div>

  <!-- v1.5: Help Modal -->
  <!-- v1.6: Comprehensive Help Modal with Accordion -->
  <div id="help-modal" class="help-modal">
    <div class="help-modal-content">
      <div class="help-header">
        <h2>🏠 Property Investment Tool - Complete Documentation</h2>
        <button class="help-close" onclick="closeHelpModal()">&times;</button>
      </div>

      <div class="help-content">
        <div class="accordion">

          <!-- Quick Start -->
          <div class="accordion-section">
            <div class="accordion-header" onclick="toggleAccordion(this)">
              <span>🚀 Quick Start</span>
              <span class="accordion-icon">▸</span>
            </div>
            <div class="accordion-content">
              <h4>3 Steps to Start</h4>
              <p><strong>Step 1: Enter Basic Info</strong></p>
              <ul>
                <li>Purchase Price: ราคาซื้อทรัพย์สิน (เช่น 4,000,000 บาท)</li>
                <li>Monthly Rent: ค่าเช่าต่อเดือน (เช่น 20,000 บาท)</li>
                <li>→ ระบบจะคำนวณ Gross Yield ให้ทันที</li>
              </ul>
              <p><strong>Step 2: Turn On Switches (Optional)</strong></p>
              <ul>
                <li>Revenue Switch ON: รวมค่าใช้จ่าย (occupancy 90%, opex 15%, agent 1 เดือน/ปี)</li>
                <li>Financing Switch ON: รวมเงินกู้ (ต้องใส่ Salary)</li>
                <li>→ ระบบจะแสดง Net Yield, DTI, Cashflow</li>
              </ul>
              <p><strong>Step 3: Compare Scenarios</strong></p>
              <ul>
                <li>คลิก Low/Base/High cards</li>
                <li>เปรียบเทียบผลลัพธ์เมื่อค่าเช่าเปลี่ยน ±10%</li>
              </ul>
              <div class="example-card">
                <strong>Example:</strong><br>
                Purchase = 4,000,000 | Rent = 20,000 | Salary = 70,000<br>
                → Gross Yield = 6.0%<br>
                → Net Yield = 4.9% (with switches ON)<br>
                → DTI = 26.1% (ปลอดภัย)
              </div>
            </div>
          </div>

          <!-- Switch Logic -->
          <div class="accordion-section">
            <div class="accordion-header" onclick="toggleAccordion(this)">
              <span>🔧 Switch Logic</span>
              <span class="accordion-icon">▸</span>
            </div>
            <div class="accordion-content">
              <h4>Switch คืออะไร?</h4>
              <p>ปุ่มเปิด/ปิด ที่ควบคุมว่าจะรวมค่าใช้จ่าย/เงินกู้ ในการคำนวณหรือไม่</p>

              <div class="glossary-item">
                <strong>Investment Switch</strong><br>
                • เปิด (ON): รวม Acquisition Cost 3%, Fit-out, Other Costs<br>
                • ปิด (OFF): คำนวณจาก Purchase Price อย่างเดียว
              </div>

              <div class="glossary-item">
                <strong>Revenue Switch</strong><br>
                • เปิด (ON): ใช้ค่าจริง - Occupancy 90%, Opex 15%, Agent 1 เดือน/ปี<br>
                • ปิด (OFF): ใช้ neutral baseline - Occupancy 100%, Opex 0%, Agent 0 (Gross Yield สูงสุด)
              </div>

              <div class="glossary-item">
                <strong>Financing Switch</strong><br>
                • เปิด (ON): ใช้ค่าจริง - Interest 4.5%, Tenor 30 ปี<br>
                • ปิด (OFF): ใช้ neutral baseline - APR 4.5%, 30 ปี (แต่ถ้าไม่ใส่ Salary จะไม่คำนวณ PMT/DTI)
              </div>

              <div class="glossary-item">
                <strong>Exit Switch</strong><br>
                • เปิด (ON): ใช้ค่า Tax, Exit Mode ตาม Advanced panel<br>
                • ปิด (OFF): ใช้เฉพาะ Basic (Holding, Growth, Selling Cost)
              </div>

              <h4>เมื่อไหร่ควรเปิด Switch?</h4>
              <ul>
                <li>ต้องการดูผลตอบแทนสูงสุด (best case) → <strong>ปิดทุก switch</strong></li>
                <li>ต้องการดูผลจริง (realistic) → <strong>เปิด Revenue + Financing</strong></li>
                <li>วางแผนขาย → <strong>เปิด Exit</strong></li>
              </ul>
            </div>
          </div>

          <!-- Glossary - Input Fields -->
          <div class="accordion-section">
            <div class="accordion-header" onclick="toggleAccordion(this)">
              <span>📚 Glossary - Input Fields</span>
              <span class="accordion-icon">▸</span>
            </div>
            <div class="accordion-content">
              <h4>Investment Layer</h4>
              <div class="glossary-item">
                <span class="glossary-term">Purchase Price:</span> ราคาซื้อขาย = ราคาทรัพย์สินรวม VAT (ใช้คำนวณ Yield,
                Payback)
              </div>
              <div class="glossary-item">
                <span class="glossary-term">Avg/sqm:</span> ราคาต่อตารางเมตร = Purchase ÷ Area
              </div>
              <div class="glossary-item">
                <span class="glossary-term">Area:</span> พื้นที่ใช้สอย (ตร.ม.) = Purchase ÷ Avg/sqm
              </div>
              <div class="glossary-item">
                <span class="glossary-term">Acquisition Cost:</span> ค่าธรรมเนียมโอน+จดทะเบียน (% ของ Purchase, ทั่วไป
                2-3%)
              </div>
              <div class="glossary-item">
                <span class="glossary-term">Fit-out:</span> ค่าตกแต่งห้อง (บาท, รวมเฟอร์นิเจอร์)
              </div>
              <div class="glossary-item">
                <span class="glossary-term">Other Costs:</span> ค่าใช้จ่ายอื่นๆ (บาท)
              </div>

              <h4>Revenue Layer</h4>
              <div class="glossary-item">
                <span class="glossary-term">Rent:</span> ค่าเช่าต่อเดือน (บาท, ใช้คำนวณ Yield ทั้งหมด)
              </div>
              <div class="glossary-item">
                <span class="glossary-term">Target Gross Yield:</span> ผลตอบแทนเป้าหมาย = (Rent × 12 ÷ Purchase) × 100
                (two-way binding กับ Rent)
              </div>
              <div class="glossary-item">
                <span class="glossary-term">Occupancy:</span> อัตราการเช่าเฉลี่ย (%, กรุงเทพ 85-95%, ว่าง 1 เดือน/ปี =
                92%)
              </div>
              <div class="glossary-item">
                <span class="glossary-term">Opex:</span> ค่าดำเนินงาน (% ของ Rent, ทั่วไป 12-18%,
                รวมค่าส่วนกลาง+ซ่อมแซม)
              </div>
              <div class="glossary-item">
                <span class="glossary-term">Agent Fee:</span> ค่านายหน้าหาผู้เช่า (เดือน/ปี, ทั่วไป 1 เดือน/ปี, REPEAT
                ทุกปี)
              </div>

              <h4>Financing Layer</h4>
              <div class="glossary-item">
                <span class="glossary-term">Salary:</span> เงินเดือนรวมก่อนหักภาษี (บาท/เดือน, ใช้คำนวณ DTI)
              </div>
              <div class="glossary-item">
                <span class="glossary-term">Down Payment:</span> เงินดาวน์ (% ของ Purchase, ทั่วไป 10-30%, ยิ่งสูง DTI
                ยิ่งต่ำ)
              </div>
              <div class="glossary-item">
                <span class="glossary-term">Interest Rate:</span> ดอกเบี้ยต่อปี (APR %, ปัจจุบัน 4.0-5.5%)
              </div>
              <div class="glossary-item">
                <span class="glossary-term">Tenor:</span> ระยะเวลาผ่อน (ปี, ทางเลือก 20/25/30, ยาวขึ้น = ผ่อนน้อยลง
                แต่ดอกเบี้ยรวมมากขึ้น)
              </div>

              <h4>Exit Layer</h4>
              <div class="glossary-item">
                <span class="glossary-term">Holding Years:</span> ระยะเวลาถือครองก่อนขาย (ปี, ทั่วไป 5-10)
              </div>
              <div class="glossary-item">
                <span class="glossary-term">Price Growth:</span> อัตราเติบโตราคา (% ต่อปี, กรุงเทพเฉลี่ย 2-4%)
              </div>
              <div class="glossary-item">
                <span class="glossary-term">Selling Cost:</span> ค่าใช้จ่ายขาย (% ของราคาขาย, ทั่วไป 2-4%,
                รวมนายหน้า+โอน)
              </div>
              <div class="glossary-item">
                <span class="glossary-term">Capital Gains Tax:</span> ภาษีกำไรขาย (% ของกำไร, ขึ้นกับระยะเวลาถือครอง >5
                ปี อาจลดหย่อน)
              </div>
            </div>
          </div>

          <!-- Glossary - Output Metrics -->
          <div class="accordion-section">
            <div class="accordion-header" onclick="toggleAccordion(this)">
              <span>📊 Glossary - Output Metrics</span>
              <span class="accordion-icon">▸</span>
            </div>
            <div class="accordion-content">
              <h4>Basic Metrics</h4>
              <div class="glossary-item">
                <span class="glossary-term">Gross Yield:</span> ผลตอบแทนขั้นต้น = (Rent × 12 ÷ Purchase) × 100
                (ก่อนหักค่าใช้จ่าย, ≥6% = ดี)
              </div>
              <div class="glossary-item">
                <span class="glossary-term">Net Yield:</span> ผลตอบแทนสุทธิ (unlevered) = (NOI × 12 ÷ Purchase) × 100
                (หลังหักค่าใช้จ่าย ไม่รวมดอกเบี้ย, ≥6% = ดี)
              </div>
              <div class="glossary-item">
                <span class="glossary-term">NOI:</span> Net Operating Income = Rent × Occ% - Agent - Opex
                (รายได้สุทธิก่อนหักดอกเบี้ย)
              </div>
              <div class="glossary-item">
                <span class="glossary-term">CoC Return:</span> Cash-on-Cash = (Net Cashflow × 12 ÷ Equity) × 100
                (ผลตอบแทนเงินสด รวม leverage, >10% = ดี)
              </div>
              <div class="glossary-item">
                <span class="glossary-term">DTI:</span> Debt-to-Income = (PMT ÷ Salary) × 100 (อัตราหนี้ต่อรายได้, ≤30%
                = ปลอดภัย, >40% = เสี่ยง)
              </div>
              <div class="glossary-item">
                <span class="glossary-term">Payback:</span> ระยะเวลาคืนทุน = Cost Basis ÷ (NOI × 12) (ปี, <12=เร็ว,>18 =
                  ช้า)
              </div>
              <div class="glossary-item">
                <span class="glossary-term">PMT:</span> Monthly Payment = Annuity formula (ค่าผ่อนต่อเดือน
                รวมเงินต้น+ดอกเบี้ย)
              </div>
              <div class="glossary-item">
                <span class="glossary-term">Net Cashflow:</span> กระแสเงินสดสุทธิ = NOI - PMT (บาท/เดือน, บวก =
                เหลือเก็บ, ลบ = ต้องเติม)
              </div>

              <h4>Exit Metrics (เมื่อเปิด Exit)</h4>
              <div class="glossary-item">
                <span class="glossary-term">IRR:</span> Internal Rate of Return (% ต่อปี, ผลตอบแทนเฉลี่ยรวม
                cashflow+ขาย, >10% = ดี)
              </div>
              <div class="glossary-item">
                <span class="glossary-term">Equity Multiple:</span> ตัวคูณผลตอบแทน = (Total Cashflow + Net Proceeds) ÷
                Equity (เท่า, 2.0× = กำไร 100%, >2× = ดี)
              </div>
              <div class="glossary-item">
                <span class="glossary-term">Terminal Value:</span> มูลค่าสิ้นสุด = Purchase × (1 + Growth%)^Years
                (ราคาขายประมาณการ)
              </div>
              <div class="glossary-item">
                <span class="glossary-term">Net Proceeds:</span> เงินรับสุทธิ = Terminal - Selling Cost - CGT
                (เงินที่ได้รับจริงหลังหักค่าใช้จ่าย+ภาษี)
              </div>
              <div class="glossary-item">
                <span class="glossary-term">Capital Gain:</span> กำไรส่วนต่าง = Net Proceeds - Cost Basis
                (กำไรจากการขาย)
              </div>
            </div>
          </div>

          <!-- Examples -->
          <div class="accordion-section">
            <div class="accordion-header" onclick="toggleAccordion(this)">
              <span>💡 Examples (Real Scenarios)</span>
              <span class="accordion-icon">▸</span>
            </div>
            <div class="accordion-content">
              <div class="example-card">
                <strong>Example 1: คอนโดกรุงเทพ (ใกล้ BTS)</strong><br><br>
                <strong>Input:</strong><br>
                Purchase 4,000,000 | Area 35 sqm | Rent 20,000/mo | Salary 70,000 | Down 10% | Switches: Revenue ON,
                Financing ON<br><br>
                <strong>Output:</strong><br>
                • Gross Yield: 6.0%<br>
                • Net Yield: 4.9% ⚠️<br>
                • Net Cashflow: -1,824 บาท/เดือน (ต้องเติม)<br>
                • DTI: 26.1% ✅<br>
                • Payback: 24.8 ปี<br>
                • CoC: -5.2%<br><br>
                <strong>Verdict:</strong><br>
                ⚠️ พอใช้ - Net Yield ต่ำกว่ามาตรฐาน (ควร ≥6%)<br>
                ⚠️ Cashflow ติดลบ ต้องเติมเดือนละ 1,824 บาท<br>
                ✅ DTI ดี อยู่ในเกณฑ์ปลอดภัย<br>
                ❌ Payback นาน เกือบ 25 ปี<br><br>
                <strong>คำแนะนำ:</strong> เจรจาลดราคา หรือหาค่าเช่าสูงกว่า (≥22,000)
              </div>

              <div class="example-card">
                <strong>Example 2: คอนโดใหม่ (ใกล้รถไฟฟ้า)</strong><br><br>
                <strong>Input:</strong><br>
                Purchase 3,500,000 | Area 32 sqm | Rent 22,000/mo | Salary 80,000 | Down 20% | Switches: Revenue ON,
                Financing ON<br><br>
                <strong>Output:</strong><br>
                • Gross Yield: 7.5% ✅<br>
                • Net Yield: 6.2% ✅<br>
                • Net Cashflow: +1,450 บาท/เดือน (เหลือเก็บ)<br>
                • DTI: 21.8% ✅<br>
                • Payback: 18.2 ปี<br>
                • CoC: 5.1%<br><br>
                <strong>Verdict:</strong><br>
                ✅ ดี - Net Yield เกิน 6%<br>
                ✅ Cashflow บวก มี passive income<br>
                ✅ DTI ปลอดภัย ต่ำกว่า 30%<br>
                ⚠️ Payback ปานกลาง 18 ปี<br><br>
                <strong>คำแนะนำ:</strong> โอเค ลงทุนได้ ผลตอบแทนดี มี cashflow บวก
              </div>

              <div class="example-card">
                <strong>Example 3: ทาวน์เฮ้าส์ชานเมือง</strong><br><br>
                <strong>Input:</strong><br>
                Purchase 2,800,000 | Area 80 sqm | Rent 15,000/mo | Salary 60,000 | Down 15% | Switches: Revenue ON,
                Financing ON<br><br>
                <strong>Output:</strong><br>
                • Gross Yield: 6.4% ✅<br>
                • Net Yield: 5.4% ⚠️<br>
                • Net Cashflow: -1,200 บาท/เดือน<br>
                • DTI: 27.5% ✅<br>
                • Payback: 21.5 ปี<br>
                • CoC: -3.4%<br><br>
                <strong>Verdict:</strong><br>
                ⚠️ พอใช้ - Net Yield ใกล้ 6% แต่ยังไม่ถึง<br>
                ⚠️ Cashflow ติดลบเล็กน้อย<br>
                ✅ DTI ดี อยู่ในเกณฑ์ปลอดภัย<br>
                ❌ Payback ค่อนข้างนาน<br><br>
                <strong>คำแนะนำ:</strong> ต่อรองค่าเช่าให้สูงขึ้นเป็น 16,500 จะได้ Net ≥6%
              </div>
            </div>
          </div>

          <!-- Threshold Guide -->
          <div class="accordion-section">
            <div class="accordion-header" onclick="toggleAccordion(this)">
              <span>📏 Threshold Guide</span>
              <span class="accordion-icon">▸</span>
            </div>
            <div class="accordion-content">
              <h4>Quick Reference Table</h4>
              <table class="threshold-table">
                <tr>
                  <th>Metric</th>
                  <th>Good (ดี)</th>
                  <th>Fair (พอใช้)</th>
                  <th>Poor (ควรทบทวน)</th>
                </tr>
                <tr>
                  <td>Gross Yield</td>
                  <td>≥6%</td>
                  <td>5-6%</td>
                  <td>&lt;5%</td>
                </tr>
                <tr>
                  <td>Net Yield</td>
                  <td>≥6%</td>
                  <td>5-6%</td>
                  <td>&lt;5%</td>
                </tr>
                <tr>
                  <td>DTI</td>
                  <td>≤30%</td>
                  <td>30-40%</td>
                  <td>&gt;40%</td>
                </tr>
                <tr>
                  <td>Payback</td>
                  <td>&lt;12 ปี</td>
                  <td>12-18 ปี</td>
                  <td>&gt;18 ปี</td>
                </tr>
                <tr>
                  <td>CoC Return</td>
                  <td>&gt;10%</td>
                  <td>5-10%</td>
                  <td>&lt;5%</td>
                </tr>
                <tr>
                  <td>IRR (5-10y)</td>
                  <td>&gt;10%</td>
                  <td>6-10%</td>
                  <td>&lt;6%</td>
                </tr>
                <tr>
                  <td>Equity Multiple</td>
                  <td>&gt;2.0×</td>
                  <td>1.5-2.0×</td>
                  <td>&lt;1.5×</td>
                </tr>
                <tr>
                  <td>Cashflow/mo</td>
                  <td>&gt;0 (บวก)</td>
                  <td>-2K to 0</td>
                  <td>&lt;-2K (ติดลบมาก)</td>
                </tr>
              </table>

              <h4>Context Notes</h4>
              <div class="glossary-item">
                <strong>Gross/Net Yield:</strong><br>
                • กรุงเทพฯ ค่าเฉลี่ย 4-8%, ต่างจังหวัด 6-12%<br>
                • Net Yield ควรสูงกว่า Fixed Deposit (1-2%) อย่างน้อย 3-4%
              </div>
              <div class="glossary-item">
                <strong>DTI (Debt-to-Income):</strong><br>
                • ธนาคารส่วนใหญ่อนุมัติได้สูงสุด 40-45%<br>
                • แนะนำ ≤30% เพื่อมีเงินเหลือใช้จ่าย
              </div>
              <div class="glossary-item">
                <strong>Payback Period:</strong><br>
                • ยิ่งเร็วยิ่งดี แต่ต้องดู quality ของทำเล<br>
                • &gt;20 ปี = ควรพิจารณาว่าคุ้มค่าหรือไม่
              </div>
              <div class="glossary-item">
                <strong>CoC Return:</strong><br>
                • CoC ติดลบไม่ได้แปลว่าแย่เสมอ - อาจแลกกับ capital gain<br>
                • ดู IRR ประกอบถ้าวางแผนขาย
              </div>
              <div class="glossary-item">
                <strong>IRR vs Stock Market:</strong><br>
                • Stock market average ~8-10%<br>
                • Bond ~3-5%<br>
                • Real estate ควร &gt;6% เพื่อชดเชยความเสี่ยง
              </div>
              <div class="glossary-item">
                <strong>Equity Multiple:</strong><br>
                • 2.5× = ลงทุน 1 ล้าน ได้กลับ 2.5 ล้าน (กำไร 1.5 ล้าน)
              </div>
              <div class="glossary-item">
                <strong>Net Cashflow Strategy:</strong><br>
                • Cashflow ติดลบ = แลกกับ capital gain + forced savings
              </div>
            </div>
          </div>

          <!-- Common Mistakes -->
          <div class="accordion-section">
            <div class="accordion-header" onclick="toggleAccordion(this)">
              <span>⚠️ Common Mistakes</span>
              <span class="accordion-icon">▸</span>
            </div>
            <div class="accordion-content">
              <div class="glossary-item">
                <strong>1. ลืมรวมค่า Acquisition Cost</strong><br>
                ❌ ผิด: คิดแค่ราคาซื้อ 4,000,000<br>
                ✅ ถูก: ราคาซื้อ 4,000,000 + โอน 3% (120,000) = 4,120,000<br>
                <em>ผลกระทบ:</em> Payback นานขึ้น, CoC ต่ำลง<br>
                <em>วิธีแก้:</em> เปิด Investment Switch ON
              </div>
              <div class="glossary-item">
                <strong>2. ตั้ง Occupancy 100% (ไม่สมจริง)</strong><br>
                ❌ ผิด: คิดว่าเช่าเต็ม 12 เดือนทุกปี<br>
                ✅ ถูก: ใช้ 85-95% (มีช่วงว่างระหว่างผู้เช่า)<br>
                <em>ผลกระทบ:</em> Net Yield สูงเกินจริง, วางแผนผิดพลาด<br>
                <em>วิธีแก้:</em> ใช้ 90% (ว่าง ~1 เดือน/ปี)
              </div>
              <div class="glossary-item">
                <strong>3. ลืมคิดค่า Agent Fee</strong><br>
                ❌ ผิด: คิดว่าหาผู้เช่าได้เอง ไม่มีค่าใช้จ่าย<br>
                ✅ ถูก: ใช้นายหน้า ~1 เดือนค่าเช่า/ปี<br>
                <em>ผลกระทบ:</em> NOI สูงเกินจริง ~8%<br>
                <em>วิธีแก้:</em> ตั้ง Agent Fee = 1 เดือน/ปี
              </div>
              <div class="glossary-item">
                <strong>4. DTI เกิน 40% (อนุมัติยาก)</strong><br>
                ❌ ผิด: กู้เต็มที่ Down 10% แต่เงินเดือนไม่พอ<br>
                ✅ ถูก: เช็ค DTI ก่อนตัดสินใจ ควร ≤30%<br>
                <em>ผลกระทบ:</em> ธนาคารไม่อนุมัติสินเชื่อ<br>
                <em>วิธีแก้:</em> เพิ่ม Down payment หรือต่อรองราคาซื้อ
              </div>
              <div class="glossary-item">
                <strong>5. ไม่คิด Two-way Binding</strong><br>
                ❌ ผิด: กรอก Purchase, Avg/sqm, Area แยกกัน แล้วตัวเลขไม่ตรงกัน<br>
                ✅ ถูก: Purchase เป็นหลัก → ระบบคำนวณ Avg/sqm อัตโนมัติ<br>
                <em>ผลกระทบ:</em> สับสน ตัวเลขขัดแย้งกัน<br>
                <em>วิธีแก้:</em> ปล่อยให้ระบบคำนวณ 1 ใน 3 ช่อง
              </div>
              <div class="glossary-item">
                <strong>6. ใช้ Gross Yield แทน Net Yield ในการตัดสินใจ</strong><br>
                ❌ ผิด: Gross 6% ดูดี เลยลงทุน<br>
                ✅ ถูก: ต้องดู Net Yield (หลังหักค่าใช้จ่าย)<br>
                <em>ผลกระทบ:</em> ผลตอบแทนจริงต่ำกว่าที่คิด<br>
                <em>วิธีแก้:</em> เปิด Revenue Switch ON เพื่อดู Net Yield
              </div>
              <div class="glossary-item">
                <strong>7. คิดว่า CoC ติดลบ = แย่เสมอ</strong><br>
                ❌ ผิด: CoC -5% เลยไม่ลงทุน<br>
                ✅ ถูก: CoC ติดลบอาจเป็น forced savings + รอ capital gain<br>
                <em>Context:</em> ถ้า IRR ดี (&gt;10%) แม้ CoC ติดลบก็ยังคุ้ม<br>
                <em>วิธีแก้:</em> ดู IRR และ Equity Multiple ประกอบ
              </div>
            </div>
          </div>

          <!-- FAQ -->
          <div class="accordion-section">
            <div class="accordion-header" onclick="toggleAccordion(this)">
              <span>❓ FAQ</span>
              <span class="accordion-icon">▸</span>
            </div>
            <div class="accordion-content">
              <div class="faq-item">
                <strong>Q1: ทำไมต้องกรอก Purchase ก่อน?</strong><br>
                A: Purchase เป็น "หัวใจ" ของการคำนวณ Yield และ Payback - ถ้าไม่มี Purchase คำนวณ Yield ไม่ได้ (แต่ถ้ามี
                Avg/sqm + Area ระบบคำนวณ Purchase ให้)
              </div>
              <div class="faq-item">
                <strong>Q2: ทำไม DTI แสดง "—"?</strong><br>
                A: ต้องกรอก Salary ก่อน - DTI = PMT ÷ Salary, ไม่มี Salary คำนวณไม่ได้
              </div>
              <div class="faq-item">
                <strong>Q3: Switch คืออะไร? เมื่อไหร่ควรเปิด?</strong><br>
                A: Switch = ปุ่มควบคุมว่าจะใช้ค่าจริงหรือ neutral baseline<br>
                • OFF = ผลตอบแทนสูงสุด (best case)<br>
                • ON = ผลตอบแทนจริง (realistic)<br>
                แนะนำ: มือใหม่ปิดทุก switch ดู Gross ก่อน, ตัดสินใจจริงเปิด Revenue + Financing
              </div>
              <div class="faq-item">
                <strong>Q4: ทำไม Net Yield ต่ำกว่า Gross Yield เยอะ?</strong><br>
                A: เพราะหักค่าใช้จ่ายแล้ว - Occupancy 90% + Opex 15% + Agent Fee 1 เดือน/ปี (ลดประมาณ 1-2%)
              </div>
              <div class="faq-item">
                <strong>Q5: CoC ติดลบแปลว่าแย่ใช่ไหม?</strong><br>
                A: ไม่จำเป็น! CoC ติดลบ = ต้องเติมเงินทุกเดือน แต่ได้ asset + forced savings - ถ้า IRR &gt;10% + EM
                &gt;2× ยังคุ้ม
              </div>
              <div class="faq-item">
                <strong>Q6: Scenario Low/Base/High คืออะไร?</strong><br>
                A: เปรียบเทียบผลลัพธ์เมื่อค่าเช่าเปลี่ยน ±10% - Low (-10%) = worst case, Base (0%) = expected, High
                (+10%) = best case
              </div>
              <div class="faq-item">
                <strong>Q7: Payback 25 ปี นานไปไหม?</strong><br>
                A: ขึ้นกับเป้าหมาย - ถ้าต้องการคืนทุนเร็ว (&lt;12 ปี) นานเกินไป, ถ้าถือยาว + รอราคาขึ้น รับได้
                (โดยทั่วไป &lt;18 ปี = ดี, &gt;20 ปี = ควรทบทวน)
              </div>
              <div class="faq-item">
                <strong>Q8: ต้องเปิด Exit Switch เสมอไหม?</strong><br>
                A: ไม่จำเป็น - เปิดถ้าวางแผนขายใน 5-10 ปี (ดู IRR, EM), ปิดถ้าถือยาวไม่คิดขาย (ดู Net Yield, Cashflow)
              </div>
              <div class="faq-item">
                <strong>Q9: Two-way binding คืออะไร?</strong><br>
                A: ระบบคำนวณอัตโนมัติระหว่าง Purchase ⇄ Avg/sqm ⇄ Area - กรอก 2 ใน 3 คำนวณช่องที่ 3 ให้ (กฎ: Purchase
                เป็นหลัก ถ้ากรอกครบ 3 ไม่ตรง ยึด Purchase ปรับ Avg/sqm)
              </div>
              <div class="faq-item">
                <strong>Q10: แนะนำค่าเริ่มต้นสำหรับมือใหม่?</strong><br>
                A: เริ่มแบบง่าย - (1) กรอก Purchase + Rent อย่างเดียว (2) ดู Gross Yield (ควร ≥6%) (3) เปิด Revenue
                Switch → ดู Net Yield (4) มีแผนกู้ กรอก Salary → ดู DTI (5) พอเข้าใจ ค่อยลองเปิด Exit
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>

  <script>
    function clamp(v, min, max) { return Math.min(Math.max(v, min), max); }
    function n(v) {
      if (typeof v === 'string') {
        // Remove commas and convert to number
        v = v.replace(/,/g, '');
      }
      const x = Number(v);
      return Number.isFinite(x) ? x : NaN;
    }
    function thb(nu) { return Number.isFinite(nu) ? nu.toLocaleString('th-TH', { maximumFractionDigits: 0 }) + ' ฿' : '—'; }
    function pct(nu) { return Number.isFinite(nu) ? (nu * 100).toFixed(1) + '%' : '—'; }
    function formatNumber(num) {
      if (!Number.isFinite(num)) return '';
      return num.toLocaleString('en-US');
    }
    function isValidNumber(str) {
      if (!str || str.trim() === '') return true; // Empty is valid
      const cleanStr = str.replace(/,/g, '');
      const num = Number(cleanStr);
      return Number.isFinite(num) && num >= 0;
    }
    const el = (id) => document.getElementById(id);

    const E = {
      purchase: el('purchase'), avgpsm: el('avgpsm'), area: el('area'),
      acq: el('acq_pct'), fit: el('fitout'), other: el('other'),
      rent: el('rent'), tgt_gross: el('tgt_gross'),
      occ: el('occ'), opex: el('opex'), agentm: el('agentm'),
      salary: el('salary'), down: el('down'), rate: el('rate'), tenor: el('tenor'),
      exit_on: el('exit_on'), hold: el('hold'), pgrow: el('pgrow'), sellc: el('sellc'),
      exit_mode: el('exit_mode'), exit_price: el('exit_price'), tax_pct: el('tax_pct'),
      swInv: el('swInv'), swRev: el('swRev'), swFin: el('swFin'), swExit: el('swExit')
    };

    const O = {
      gross: el('gross'), net: el('net'), coc: el('coc'), dti: el('dti'),
      netmo: el('netmo'), pmt: el('pmt'), payback: el('payback'),
      tval: el('tval'), npro: el('npro'), cgain: el('cgain'),
      irr: el('irr'), emult: el('emult'),
      loan_amt: el('loan_amt'), pmt2: el('pmt2'), tot_int: el('tot_int'), aff_warn: el('aff_warn')
    };

    const H = { acq_thb: el('acq_thb'), occ_eff: el('occ_eff'), opex_thb: el('opex_thb'), agent_thb: el('agent_thb') };
    const ai = el('ai_note');
    let activeScenario = 'base';

    document.querySelectorAll('.adv-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const t = document.querySelector(btn.dataset.target);
        t.style.display = (t.style.display === 'none' || t.style.display === '') ? 'block' : 'none'; recalc();
      });
    });

    ['swInv', 'swRev', 'swFin', 'swExit'].forEach(id => { const s = E[id]; s.addEventListener('change', async () => await recalc()); });

    function setErr(node, bad, msg = '') { if (!node) return; node.classList.toggle('err', !!bad); if (bad && msg) node.title = msg; else node.removeAttribute('title'); }

    // Add number formatting to all numeric input fields
    const numericFields = ['rent', 'salary', 'fitout', 'other'];
    numericFields.forEach(id => {
      const field = E[id];
      if (field) {
        field.addEventListener('input', (e) => {
          const cursorPos = e.target.selectionStart;
          const oldValue = e.target.value;
          const newValue = formatInputNumber(oldValue);

          if (newValue !== oldValue) {
            e.target.value = newValue;
            const commasAdded = (newValue.match(/,/g) || []).length - (oldValue.match(/,/g) || []).length;
            e.target.setSelectionRange(cursorPos + commasAdded, cursorPos + commasAdded);
          }

          // Validate number format
          if (e.target.value !== '' && !isValidNumber(e.target.value)) {
            setErr(e.target, true, 'กรุณาใส่ตัวเลขที่ถูกต้อง');
          } else {
            setErr(e.target, false);
          }
        });

        field.addEventListener('blur', () => {
          if (field.value !== '' && !isValidNumber(field.value)) {
            setErr(field, true, 'กรุณาใส่ตัวเลขที่ถูกต้อง');
          } else {
            setErr(field, false);
          }
        });
      }
    });

    // Investment two-way - LAST-CHANGED-WINS logic
    let lastChanged = null;
    let isUpdating = false;

    ['purchase', 'avgpsm', 'area'].forEach(id => {
      E[id].addEventListener('input', (e) => {
        if (isUpdating) return;
        lastChanged = id;

        // Format number with commas as user types
        const cursorPos = e.target.selectionStart;
        const oldValue = e.target.value;
        const newValue = formatInputNumber(oldValue);

        if (newValue !== oldValue) {
          e.target.value = newValue;
          const commasAdded = (newValue.match(/,/g) || []).length - (oldValue.match(/,/g) || []).length;
          e.target.setSelectionRange(cursorPos + commasAdded, cursorPos + commasAdded);
        }

        // Instant update on every keystroke
        twoWayInvestment();
        recalc();
      });
    });

    function formatInputNumber(value) {
      if (!value) return '';
      // Remove all non-digits and decimal points
      const cleanValue = value.replace(/[^\d.]/g, '');
      const parts = cleanValue.split('.');

      // Format integer part with commas
      if (parts[0]) {
        parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ',');
      }

      // Return formatted number (with decimal if exists)
      return parts.length > 1 ? parts[0] + '.' + parts[1] : parts[0];
    }

    function twoWayInvestment() {
      if (isUpdating) return;

      const P = n(E.purchase.value);
      const A = n(E.area.value);
      const U = n(E.avgpsm.value);

      const hasP = Number.isFinite(P) && P > 0;
      const hasA = Number.isFinite(A) && A > 0;
      const hasU = Number.isFinite(U) && U > 0;

      // Clear all error states
      setErr(E.purchase, false);
      setErr(E.area, false);
      setErr(E.avgpsm, false);

      // Validate number format
      if (E.purchase.value !== '' && !isValidNumber(E.purchase.value)) {
        setErr(E.purchase, true, 'กรุณาใส่ตัวเลขที่ถูกต้อง');
        return;
      }
      if (E.area.value !== '' && !isValidNumber(E.area.value)) {
        setErr(E.area, true, 'กรุณาใส่ตัวเลขที่ถูกต้อง');
        return;
      }
      if (E.avgpsm.value !== '' && !isValidNumber(E.avgpsm.value)) {
        setErr(E.avgpsm, true, 'กรุณาใส่ตัวเลขที่ถูกต้อง');
        return;
      }

      // LAST-CHANGED-WINS LOGIC
      // Last field edited = source of truth, calculate other 2 fields from it
      // Formula: Purchase = Avg/sqm × Area

      isUpdating = true;

      if (lastChanged === 'purchase' && hasP) {
        // User edited Purchase → calculate Avg (if Area exists) OR Area (if Avg exists)
        if (hasA && !hasU) {
          // Calculate Avg from Purchase / Area
          E.avgpsm.value = formatNumber(Math.round(P / A));
        }
        else if (hasU && !hasA) {
          // Calculate Area from Purchase / Avg
          E.area.value = formatNumber((P / U).toFixed(2));
        }
        else if (hasA && hasU) {
          // Both exist, recalculate Avg to maintain Purchase as source
          E.avgpsm.value = formatNumber(Math.round(P / A));
        }
      }
      else if (lastChanged === 'avgpsm' && hasU) {
        // User edited Avg → calculate Purchase (if Area exists) OR Area (if Purchase exists)
        if (hasA && !hasP) {
          // Calculate Purchase from Avg × Area
          E.purchase.value = formatNumber(Math.round(U * A));
        }
        else if (hasP && !hasA) {
          // Calculate Area from Purchase / Avg
          E.area.value = formatNumber((P / U).toFixed(2));
        }
        else if (hasP && hasA) {
          // Both exist, recalculate Purchase to maintain Avg as source
          E.purchase.value = formatNumber(Math.round(U * A));
        }
      }
      else if (lastChanged === 'area' && hasA) {
        // User edited Area → calculate Purchase (if Avg exists) OR Avg (if Purchase exists)
        if (hasU && !hasP) {
          // Calculate Purchase from Avg × Area
          E.purchase.value = formatNumber(Math.round(U * A));
        }
        else if (hasP && !hasU) {
          // Calculate Avg from Purchase / Area
          E.avgpsm.value = formatNumber(Math.round(P / A));
        }
        else if (hasP && hasU) {
          // Both exist, recalculate Purchase to maintain Area as source
          E.purchase.value = formatNumber(Math.round(U * A));
        }
      }

      // Handle single non-Purchase field errors
      const filledCount = (hasP ? 1 : 0) + (hasA ? 1 : 0) + (hasU ? 1 : 0);
      if (filledCount === 1) {
        if (hasU && !hasP && !hasA) {
          setErr(E.purchase, true, 'กรุณาใส่ราคาซื้อหรือพื้นที่');
          setErr(E.area, true, 'กรุณาใส่ราคาซื้อหรือพื้นที่');
        }
        else if (hasA && !hasP && !hasU) {
          setErr(E.purchase, true, 'กรุณาใส่ราคาซื้อหรือราคาต่อตร.ม.');
          setErr(E.avgpsm, true, 'กรุณาใส่ราคาซื้อหรือราคาต่อตร.ม.');
        }
      }

      isUpdating = false;
    }

    // Revenue two-way (base = Purchase)
    E.rent.addEventListener('input', () => { twoWayRevenue('rent'); recalc(); });
    E.tgt_gross.addEventListener('input', () => { twoWayRevenue('tgt'); recalc(); });
    function twoWayRevenue(changed) {
      const P = n(E.purchase.value);
      const rent = n(E.rent.value), tgt = (n(E.tgt_gross.value)) / 100;
      const hasP = Number.isFinite(P);

      // Validate number format
      if (E.rent.value !== '' && !isValidNumber(E.rent.value)) {
        setErr(E.rent, true, 'กรุณาใส่ตัวเลขที่ถูกต้อง');
        return;
      }
      if (E.tgt_gross.value !== '' && !isValidNumber(E.tgt_gross.value)) {
        setErr(E.tgt_gross, true, 'กรุณาใส่ตัวเลขที่ถูกต้อง');
        return;
      }

      if (!hasP) {
        setErr(E.tgt_gross, true, 'กรอก Purchase ก่อน');
        setErr(E.rent, !Number.isFinite(rent) && E.rent.value !== '');
        return;
      }

      setErr(E.tgt_gross, false);
      setErr(E.rent, false);

      if (changed === 'tgt' && Number.isFinite(tgt)) {
        E.rent.value = formatNumber(Math.round((tgt * P) / 12));
      }
      else if (changed === 'rent' && Number.isFinite(rent) && P > 0) {
        E.tgt_gross.value = ((rent * 12) / P * 100).toFixed(2);
      }
    }

    // Helpers
    function PMT(rateAPR, years, principal) {
      const i = rateAPR / 1200, n = years * 12; return (i > 0) ? principal * i / (1 - Math.pow(1 + i, -n)) : (n > 0 ? principal / n : 0);
    }
    function IRR(flows) {
      function npv(r) { let s = 0; for (let t = 0; t < flows.length; t++) s += flows[t] / Math.pow(1 + r, t); return s; }
      let r0 = 0.1, r1 = 0.11, f0 = npv(r0), f1 = npv(r1);
      for (let i = 0; i < 50; i++) {
        const r2 = r1 - f1 * (r1 - r0) / (f1 - f0); if (!isFinite(r2)) return NaN;
        r0 = r1; f0 = f1; r1 = r2; f1 = npv(r1); if (Math.abs(f1) < 1e-8) break;
      }
      return r1;
    }

    // Global variables for API integration
    const API_CONFIG = {
      baseURL: window.location.hostname === 'localhost'
        ? 'http://localhost:8000'
        : 'https://your-api-domain.com',
      timeout: 10000
    };

    let apiCache = {};
    let isCalculating = false;
    let tooltipsData = {};

    // v1.5: Default tooltips (fallback if API fails)
    const DEFAULT_TOOLTIPS = {
      purchase_price: "ราคาซื้อขายทรัพย์สิน รวม VAT (ถ้ามี)|ตัวอย่าง: 4,000,000 บาท|ใช้เป็นฐานคำนวณ Yield และ Payback",
      avg_psm: "ราคาเฉลี่ยต่อตารางเมตร|คำนวณจาก ราคาซื้อ ÷ พื้นที่|ใช้เปรียบเทียบกับตลาด",
      area_sqm: "พื้นที่ใช้สอยของทรัพย์สิน|ตัวอย่าง: 35 ตร.ม.|กระทบต่อราคาต่อตารางเมตร",
      monthly_rent: "รายได้ค่าเช่าต่อเดือนก่อนหักค่าใช้จ่าย|ตัวอย่าง: 20,000 บาท|ใช้คำนวณ Gross Yield",
      target_gross_yield: "ผลตอบแทนขั้นต้นที่ต้องการ|คำนวณจาก (ค่าเช่า×12)÷ราคาซื้อ×100|เป้าหมาย 5-8%",
      gross_salary: "เงินเดือนรวมต่อเดือนก่อนหักภาษี|ตัวอย่าง: 70,000 บาท|ใช้คำนวณ DTI Ratio",
      down_payment_pct: "เปอร์เซ็นต์เงินดาวน์จากราคาซื้อ|ตัวอย่าง: 10%|กระทบต่อจำนวนเงินกู้และ CoC",
      holding_years: "ระยะเวลาถือครองทรัพย์สินก่อนขาย|ตัวอย่าง: 5 ปี|ใช้คำนวณ IRR และ Capital Gain",
      price_growth: "อัตราการเติบโตของราคาทรัพย์สินต่อปี|ตัวอย่าง: 3%|ค่าเฉลี่ยตลาด 2-5% ต่อปี",
      selling_cost: "ค่าใช้จ่ายในการขาย เช่น ค่านายหน้า ภาษี|ตัวอย่าง: 3%|ปกติ 2-5% ของราคาขาย"
    };

    async function computeScenario(rentBase, delta) {
      const rent = (rentBase || 0) * (1 + delta);
      const cacheKey = `${rentBase}_${delta}_${JSON.stringify(getInputValues())}`;

      // Return cached result if available
      if (apiCache[cacheKey]) {
        return apiCache[cacheKey];
      }

      try {
        const requestData = prepareApiRequest(rent);
        const response = await apiCall('/calc/scenario', requestData);

        if (response.status === 'success') {
          const result = parseApiResponse(response.data, rent);
          apiCache[cacheKey] = result;
          return result;
        } else {
          throw new Error(response.error?.message || 'Calculation failed');
        }
      } catch (error) {
        console.warn('API call failed, using fallback calculation:', error);
        return computeScenarioFallback(rentBase, delta);
      }
    }

    function computeScenarioFallback(rentBase, delta) {
      const P = n(E.purchase.value) || 0;

      // INVESTMENT
      const useInv = E.swInv.checked; // side switch
      const acqPct = useInv ? (n(E.acq.value) || 3) / 100 : 0;
      const fit = useInv ? (n(E.fit.value) || 0) : 0;
      const other = useInv ? (n(E.other.value) || 0) : 0;
      const cost_basis = P + P * acqPct + fit + other;

      // REVENUE
      const useRev = E.swRev.checked;
      const occ = useRev ? clamp((n(E.occ.value) || 90) / 100, 0.5, 1) : 1.0;   // neutral 100%
      const opex = useRev ? clamp((n(E.opex.value) || 15) / 100, 0, 0.6) : 0.0; // neutral 0%
      const agentm = useRev ? clamp(n(E.agentm.value) || 1, 0, 12) : 0;       // neutral 0

      // FINANCING
      const down = clamp((n(E.down.value) || 10) / 100, 0, 0.9),
        rate = (E.swFin.checked ? (n(E.rate.value) || 4.5) : 4.5), // neutral APR 4.5
        years = (E.swFin.checked ? +(E.tenor.value || 30) : 30);   // neutral 30y
      const salary = n(E.salary.value);
      const financeOn = Number.isFinite(salary) && salary > 0;

      const rent = (rentBase || 0) * (1 + delta);
      const acqCost = P * acqPct;
      const loan = Number.isFinite(P) ? Math.max(P - P * down, 0) : NaN;
      const pmt = financeOn && Number.isFinite(loan) ? PMT(rate, years, loan) : 0;
      const rentEff = rent * occ;
      const agentTHB = rent * (agentm / 12);
      const opexTHB = rent * opex;
      const noiMonthly = rentEff - agentTHB - opexTHB;
      const netMonthly = noiMonthly - pmt;

      // Yields on Purchase
      const grossYield = P > 0 ? (rent * 12) / P : NaN;
      const netYield = P > 0 ? (noiMonthly * 12) / P : NaN;

      const equity = (Number.isFinite(P) ? P * down : NaN) + acqCost + fit + other;
      const coc = equity > 0 ? (netMonthly * 12) / equity : NaN;
      const dti = financeOn && Number.isFinite(pmt) && salary > 0 ? pmt / salary : NaN;
      const payback = (noiMonthly > 0 && cost_basis > 0) ? (cost_basis / (noiMonthly * 12)) : NaN;

      return {
        rent, noiMonthly, netMonthly, grossYield, netYield, coc, dti, payback, pmt, loan, cost_basis, equity, financeOn,
        P, occ, opex
      };
    }

    function getInputValues() {
      return {
        purchase: n(E.purchase.value),
        rent: n(E.rent.value),
        salary: n(E.salary.value),
        swInv: E.swInv.checked,
        swRev: E.swRev.checked,
        swFin: E.swFin.checked,
        swExit: E.swExit.checked
      };
    }

    function prepareApiRequest(rent) {
      const P = n(E.purchase.value) || 0;
      const salary = n(E.salary.value);

      return {
        purchase_price: P,
        monthly_rent: rent,
        area_sqm: n(E.area.value) || null,
        gross_salary: Number.isFinite(salary) ? salary : null,
        loan_tenor_years: E.swFin.checked ? parseInt(E.tenor.value) || 30 : 30,
        interest_rate_annual: E.swFin.checked ? (n(E.rate.value) || 4.5) : 4.5,
        down_payment_pct: n(E.down.value) || 10,
        occupancy_rate: E.swRev.checked ? (n(E.occ.value) || 90) : 100,
        opex_rate: E.swRev.checked ? (n(E.opex.value) || 15) : 0,
        agent_fee_months: E.swRev.checked ? (n(E.agentm.value) || 1) : 0,
        target_net_yield: 6,
        currency_code: 'THB',
        trace_id: `v5d_${Date.now()}`
      };
    }

    async function apiCall(endpoint, data) {
      const url = `${API_CONFIG.baseURL}${endpoint}`;
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), API_CONFIG.timeout);

      try {
        const response = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data),
          signal: controller.signal
        });

        clearTimeout(timeoutId);

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        return await response.json();
      } catch (error) {
        clearTimeout(timeoutId);
        if (error.name === 'AbortError') {
          throw new Error('Request timeout - please try again');
        }
        throw error;
      }
    }

    function parseApiResponse(data, rent) {
      const combined = data.combined_results || {};
      const yieldResults = combined.yield_results || {};
      const affordabilityResults = combined.affordability_results || {};

      const parseVal = (v) => parseFloat(v) || 0;

      const noiMonthly = parseVal(yieldResults.net_monthly_income);
      const pmt = parseVal(affordabilityResults.monthly_payment);
      const netMonthly = noiMonthly - pmt;

      return {
        rent: rent,
        noiMonthly: noiMonthly,
        netMonthly: netMonthly,
        grossYield: parseVal(yieldResults.gross_yield),
        netYield: parseVal(yieldResults.net_yield),
        coc: 0, // TODO: Calculate from equity
        dti: parseVal(affordabilityResults.dti_ratio),
        payback: parseVal(yieldResults.payback_years),
        pmt: pmt,
        loan: parseVal(affordabilityResults.loan_amount),
        cost_basis: 0, // TODO: Calculate
        equity: 0, // TODO: Calculate
        financeOn: pmt > 0,
        P: n(E.purchase.value) || 0,
        occ: E.swRev.checked ? (n(E.occ.value) || 90) / 100 : 1.0,
        opex: E.swRev.checked ? (n(E.opex.value) || 15) / 100 : 0.0
      };
    }

    function clsNetYield(v) { if (!isFinite(v)) return ''; return v >= 0.06 ? 'good' : (v >= 0.05 ? 'warn' : 'bad'); }
    function clsPayback(y) { if (!isFinite(y)) return ''; return y < 12 ? 'good' : (y <= 18 ? 'warn' : 'bad'); }
    function clsDTI(v) { if (!isFinite(v)) return ''; return v <= 0.30 ? 'good' : (v <= 0.40 ? 'warn' : 'bad'); }
    function clsCash(nu) { if (!isFinite(nu)) return ''; return nu >= 0 ? 'good' : 'bad'; }
    function setKpiClass(elm, cls) { if (!elm) return; elm.className = 'kpi kval ' + (cls || ''); }

    async function recalc() {
      if (isCalculating) return;

      // Don't call twoWayInvestment here as it's already called in input handlers

      const rentBase = n(E.rent.value);

      // Skip calculation if no basic inputs
      if (!rentBase && !n(E.purchase.value)) {
        clearOutputs();
        return;
      }

      isCalculating = true;
      showCalculating(true);

      try {
        const scLow = await computeScenario(rentBase, -0.10);
        const scBase = await computeScenario(rentBase, 0.00);
        const scHigh = await computeScenario(rentBase, +0.10);

        function setCard(sc, id) {
          const rentId = id === 'low' ? 'rent_low' : (id === 'high' ? 'rent_high' : 'rent_base');
          const nyId = id === 'low' ? 'ny_low' : (id === 'high' ? 'ny_high' : 'ny_base');
          const cfId = id === 'low' ? 'cf_low' : (id === 'high' ? 'cf_high' : 'cf_base');
          const dtiId = id === 'low' ? 'dti_low' : (id === 'high' ? 'dti_high' : 'dti_base');
          const pbId = id === 'low' ? 'pb_low' : (id === 'high' ? 'pb_high' : 'pb_base');
          const cocId = id === 'low' ? 'coc_low' : (id === 'high' ? 'coc_high' : 'coc_base');
          document.getElementById(rentId).textContent = thb(sc.rent);
          const nyEl = el(nyId), cfEl = el(cfId), dtiEl = el(dtiId), pbEl = el(pbId), cocEl = el(cocId);
          nyEl.textContent = pct(sc.netYield); nyEl.className = 'sc-val ' + clsNetYield(sc.netYield);
          cfEl.textContent = thb(sc.netMonthly); cfEl.className = 'sc-val ' + clsCash(sc.netMonthly);
          dtiEl.textContent = pct(sc.dti); dtiEl.className = 'sc-val ' + clsDTI(sc.dti);
          pbEl.textContent = isFinite(sc.payback) ? sc.payback.toFixed(1) + 'y' : '—'; pbEl.className = 'sc-val ' + clsPayback(sc.payback);
          cocEl.textContent = pct(sc.coc); cocEl.className = 'sc-val ' + clsCash(sc.netMonthly);
        }
        setCard(scLow, 'low'); setCard(scBase, 'base'); setCard(scHigh, 'high');

        const sc = activeScenario === 'low' ? scLow : (activeScenario === 'high' ? scHigh : scBase);
        document.getElementById('card-low').classList.toggle('active', activeScenario === 'low');
        document.getElementById('card-base').classList.toggle('active', activeScenario === 'base');
        document.getElementById('card-high').classList.toggle('active', activeScenario === 'high');

        // Investment details & equity box (for display hints)
        const useInv = E.swInv.checked;
        const P = n(E.purchase.value);
        const acqPct = useInv ? (n(E.acq.value) || 3) / 100 : 0;
        const fit = useInv ? (n(E.fit.value) || 0) : 0;
        const other = useInv ? (n(E.other.value) || 0) : 0;
        const acqCost = (Number.isFinite(P) ? P : 0) * acqPct;
        if (Number.isFinite(P)) {
          el('equity_box')?.classList?.toggle('dim', !useInv);
          el('equity_box').textContent = thb((P * (n(E.down.value) || 10) / 100) + acqCost + fit + other);
          el('eq_down')?.classList?.toggle('dim', !useInv); el('eq_acq')?.classList?.toggle('dim', !useInv); el('eq_fo')?.classList?.toggle('dim', !useInv);
          el('eq_down').textContent = thb(P * (n(E.down.value) || 10) / 100);
          el('eq_acq').textContent = thb(acqCost);
          el('eq_fo').textContent = thb(fit + other);
          if (H.acq_thb) H.acq_thb.textContent = thb(acqCost).replace(' ฿', '');
        } else {
          if (el('equity_box')) el('equity_box').textContent = '—';
          if (el('eq_down')) el('eq_down').textContent = '—';
          if (el('eq_acq')) el('eq_acq').textContent = '—';
          if (el('eq_fo')) el('eq_fo').textContent = '—';
          if (H.acq_thb) H.acq_thb.textContent = '—';
        }

        // Revenue adv helpers for hints (dim if off)
        const useRev = E.swRev.checked;
        const occ = useRev ? clamp((n(E.occ.value) || 90) / 100, 0.5, 1) : 1.0;
        const opex = useRev ? clamp((n(E.opex.value) || 15) / 100, 0, 0.6) : 0.0;
        const agentm = useRev ? clamp(n(E.agentm.value) || 1, 0, 12) : 0;
        const rentEff = (n(E.rent.value) || 0) * occ; const agentTHB = (n(E.rent.value) || 0) * (agentm / 12); const opexTHB = (n(E.rent.value) || 0) * opex;
        ;['occ_eff', 'agent_thb', 'opex_thb'].forEach(id => { const k = el(id); if (k) k.parentElement.parentElement.classList.toggle('dim', !useRev); });
        if (H.occ_eff) H.occ_eff.textContent = Number.isFinite(rentEff) ? rentEff.toLocaleString('th-TH', { maximumFractionDigits: 0 }) : '—';
        if (H.agent_thb) H.agent_thb.textContent = Number.isFinite(agentTHB) ? agentTHB.toLocaleString('th-TH', { maximumFractionDigits: 0 }) : '—';
        if (H.opex_thb) H.opex_thb.textContent = Number.isFinite(opexTHB) ? opexTHB.toLocaleString('th-TH', { maximumFractionDigits: 0 }) : '—';

        // Key Metrics (with colors)
        O.gross.textContent = pct(sc.grossYield); setKpiClass(O.gross, clsNetYield(sc.grossYield));
        O.net.textContent = pct(sc.netYield); setKpiClass(O.net, clsNetYield(sc.netYield));
        O.coc.textContent = pct(sc.coc); setKpiClass(O.coc, clsCash(sc.netMonthly));
        O.netmo.textContent = thb(sc.netMonthly); setKpiClass(O.netmo, clsCash(sc.netMonthly));
        O.pmt.textContent = thb(sc.pmt); setKpiClass(O.pmt, '');
        const dti = sc.dti; O.dti.textContent = pct(dti); setKpiClass(O.dti, clsDTI(dti));
        O.payback.textContent = isFinite(sc.payback) ? sc.payback.toFixed(1) + ' yrs' : '—'; setKpiClass(O.payback, clsPayback(sc.payback));

        // Affordability (clear if financing off)
        if (sc.financeOn && Number.isFinite(sc.loan)) {
          const pmt = sc.pmt; const totInterest = pmt * (E.swFin.checked ? +(E.tenor.value || 30) : 30) * 12 - sc.loan;
          O.loan_amt.textContent = thb(sc.loan);
          O.pmt2.textContent = thb(pmt);
          O.tot_int.textContent = thb(totInterest);
          O.aff_warn.textContent = isFinite(dti) ? (dti > 0.4 ? 'High Risk: DTI > 40%.' : (dti > 0.3 ? 'Caution: DTI 30–40%.' : 'OK: DTI ≤ 30%.')) : '—';
        } else {
          O.loan_amt.textContent = '—';
          O.pmt2.textContent = '—';
          O.tot_int.textContent = '—';
          O.aff_warn.textContent = 'กรอก Salary เพื่อประเมิน DTI/PMT';
        }

        // Exit & IRR
        let tval = NaN, npro = NaN, cgain = NaN, irr = NaN, em = NaN;
        if (E.exit_on.checked && Number.isFinite(P) && Number.isFinite(n(E.hold.value)) && Number.isFinite(n(E.pgrow.value))) {
          const hold = n(E.hold.value) || 5, g = Math.max(n(E.pgrow.value) || 0, 0) / 100, scsell = clamp((n(E.sellc.value) || 0) / 100, 0, 0.20);
          const useExit = E.swExit.checked;
          const mode = useExit ? E.exit_mode.value : 'auto'; const manual = useExit ? (n(E.exit_price.value) || 0) : 0;
          const term = (mode === 'manual' && manual > 0) ? manual : P * Math.pow(1 + g, hold);
          const tax = useExit ? Math.max(n(E.tax_pct.value) || 0, 0) / 100 : 0;
          // need cost basis consistent with Investment switch:
          const useInv = E.swInv.checked; const acqPct = useInv ? (n(E.acq.value) || 3) / 100 : 0;
          const fit = useInv ? (n(E.fit.value) || 0) : 0; const other = useInv ? (n(E.other.value) || 0) : 0;
          const cost_basis = P + P * acqPct + fit + other;

          const sellCosts = term * scsell; const taxTHB = Math.max(term - cost_basis, 0) * tax;
          tval = term; npro = term - sellCosts - taxTHB; cgain = npro - cost_basis;
          // annual CF uses current scenario base (includes financing if on)
          const sc = computeScenario(n(E.rent.value) || 0, 0.0);
          const annualCF = sc.netMonthly * 12;
          const equity = sc.equity;
          if (equity > 0) { em = (annualCF * hold + npro) / equity; }
          const flows = [-equity]; for (let y = 1; y <= hold; y++) flows.push(annualCF + (y === hold ? npro : 0));
          irr = IRR(flows);
        }
        O.tval.textContent = Number.isFinite(tval) ? thb(tval) : '—';
        O.npro.textContent = Number.isFinite(npro) ? thb(npro) : '—';
        O.cgain.textContent = Number.isFinite(cgain) ? thb(cgain) : '—';
        O.irr.textContent = Number.isFinite(irr) ? (irr * 100).toFixed(1) + '%' : '—';
        O.emult.textContent = Number.isFinite(em) ? em.toFixed(2) + '×' : '—';

        // Status pills
        const pills = [];
        function Ppill(txt, cls) { pills.push('<span class="pill ' + cls + '">' + txt + '</span>'); }
        Ppill(sc.netYield >= 0.06 ? 'Net ≥ 6%' : 'Net < 6%', clsNetYield(sc.netYield));
        if (isFinite(dti)) { if (dti > 0.40) Ppill('DTI > 40%', 'bad'); else if (dti > 0.30) Ppill('DTI 30–40%', 'warn'); else Ppill('DTI ≤ 30%', 'good'); }
        Ppill(sc.netMonthly >= 0 ? 'Cashflow บวก' : 'Cashflow ติดลบ', clsCash(sc.netMonthly));
        document.getElementById('status_pills').innerHTML = pills.join(' ');

        // AI Note (no Exit)
        const lines = [];
        if (isFinite(sc.netYield)) lines.push('Net Yield = ' + pct(sc.netYield) + ' → ' + (sc.netYield >= 0.07 ? 'สูงกว่าค่าเฉลี่ยตลาด — น่าสนใจ' : (sc.netYield >= 0.06 ? 'ใกล้เคียงค่าเฉลี่ยตลาด — พอใช้' : 'ต่ำกว่าค่าเฉลี่ยตลาด — ควรปรับสมมติฐาน')));
        if (isFinite(sc.payback)) lines.push('Payback = ' + (isFinite(sc.payback) ? sc.payback.toFixed(1) : '—') + ' ปี → ' + (sc.payback < 12 ? 'เร็ว' : (sc.payback <= 18 ? 'ปานกลาง' : 'ช้า')));
        if (isFinite(dti)) lines.push('DTI = ' + pct(dti) + ' → ' + (dti <= 0.30 ? 'ปลอดภัย' : (dti <= 0.40 ? 'เฝ้าระวัง' : 'เกินเกณฑ์แบงก์')));
        lines.push('Revenue advance: ' + (E.swRev.checked ? 'ON' : 'OFF') + ' · Financing advance: ' + (E.swFin.checked ? 'ON' : 'OFF'));
        ai.innerHTML = lines.map(s => '<div>• ' + s + '</div>').join('');

      } catch (error) {
        console.error('Calculation error:', error);
        showError('เกิดข้อผิดพลาดในการคำนวณ: ' + error.message);
      } finally {
        isCalculating = false;
        showCalculating(false);
      }
    }

    function clearOutputs() {
      // Clear all output displays
      Object.values(O).forEach(el => {
        if (el && el.textContent !== undefined) {
          el.textContent = '—';
          el.className = 'kpi kval';
        }
      });
      el('status_pills').innerHTML = '';
    }

    function showCalculating(show) {
      // Add subtle loading indication
      const cards = document.querySelectorAll('.card');
      cards.forEach(card => {
        card.style.opacity = show ? '0.7' : '1';
      });
    }

    function showError(message) {
      // Show error in AI note area
      if (ai) {
        ai.textContent = `⚠️ ${message}`;
        ai.style.color = 'var(--bad)';
        setTimeout(() => {
          ai.style.color = '';
          ai.textContent = '—';
        }, 5000);
      }
    }

    // v1.5: Tooltips functions
    async function loadTooltips() {
      try {
        const response = await fetch(`${API_CONFIG.baseURL}/tooltips`);
        if (response.ok) {
          const data = await response.json();
          tooltipsData = data.data || {};
        } else {
          console.warn('Tooltips API failed, using defaults');
          tooltipsData = DEFAULT_TOOLTIPS;
        }
      } catch (error) {
        console.warn('Tooltips loading failed:', error);
        tooltipsData = DEFAULT_TOOLTIPS;
      }

      // Always inject tooltips after loading
      injectTooltips();
    }

    function injectTooltips() {
      document.querySelectorAll('.tooltip-icon').forEach(icon => {
        const field = icon.getAttribute('data-tooltip');
        let content = tooltipsData[field] || DEFAULT_TOOLTIPS[field] || 'ไม่มีข้อมูลช่วยเหลือ';

        // Remove existing tooltip content if any
        const existingTooltip = icon.querySelector('.tooltip-content');
        if (existingTooltip) {
          existingTooltip.remove();
        }

        // Create tooltip content element
        const tooltipDiv = document.createElement('div');
        tooltipDiv.className = 'tooltip-content';

        // Convert pipe (|) to line breaks for better formatting
        // This prevents awkward line breaks in the middle of phrases
        const lines = content.split('|');
        lines.forEach((line, index) => {
          const textNode = document.createTextNode(line.trim());
          tooltipDiv.appendChild(textNode);
          if (index < lines.length - 1) {
            tooltipDiv.appendChild(document.createElement('br'));
          }
        });

        icon.appendChild(tooltipDiv);

        // DO NOT set title attribute - it causes double tooltips (vertical + horizontal)
        // Remove title attribute if it exists
        icon.removeAttribute('title');

        // Add hover event listeners for better control
        icon.addEventListener('mouseenter', function () {
          const tooltip = this.querySelector('.tooltip-content');
          if (tooltip) {
            tooltip.style.opacity = '1';
            tooltip.style.visibility = 'visible';
          }
        });

        icon.addEventListener('mouseleave', function () {
          const tooltip = this.querySelector('.tooltip-content');
          if (tooltip) {
            tooltip.style.opacity = '0';
            tooltip.style.visibility = 'hidden';
          }
        });
      });
    }

    // v1.6: Help Modal functions with Accordion
    function openHelpModal() {
      document.getElementById('help-modal').style.display = 'flex';
    }

    function closeHelpModal() {
      document.getElementById('help-modal').style.display = 'none';
    }

    // Accordion functionality
    function toggleAccordion(header) {
      const content = header.nextElementSibling;
      const isActive = content.classList.contains('active');

      // Toggle active state
      header.classList.toggle('active');
      content.classList.toggle('active');

      // Smooth scroll to section when opened
      if (!isActive) {
        setTimeout(() => {
          header.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }, 100);
      }
    }

    // Close modal when clicking outside
    window.addEventListener('click', function (event) {
      const modal = document.getElementById('help-modal');
      if (event.target === modal) {
        closeHelpModal();
      }
    });

    // scenario card clicks
    ['card-low', 'card-base', 'card-high'].forEach((id, i) => {
      const name = i === 0 ? 'low' : (i === 1 ? 'base' : 'high');
      const node = document.getElementById(id);
      node.addEventListener('click', async () => { activeScenario = name; await recalc(); });
    });
    // mobile segmented
    const segL = document.getElementById('seg-low'), segB = document.getElementById('seg-base'), segH = document.getElementById('seg-high');
    if (segL) { segL.addEventListener('click', () => { activeScenario = 'low'; segL.classList.add('active'); segB.classList.remove('active'); segH.classList.remove('active'); recalc(); }); }
    if (segB) { segB.addEventListener('click', () => { activeScenario = 'base'; segB.classList.add('active'); segL.classList.remove('active'); segH.classList.remove('active'); recalc(); }); }
    if (segH) { segH.addEventListener('click', () => { activeScenario = 'high'; segH.classList.add('active'); segL.classList.remove('active'); segB.classList.remove('active'); recalc(); }); }

    // Inputs update
    ['acq_pct', 'fitout', 'other', 'occ', 'opex', 'agentm', 'salary', 'down', 'rate', 'tenor', 'exit_on', 'hold', 'pgrow', 'sellc', 'exit_mode', 'exit_price', 'tax_pct', 'rent', 'tgt_gross']
      .forEach(id => { const node = el(id); if (node) { node.addEventListener('input', () => recalc()); node.addEventListener('change', () => recalc()); } });

    // Initialize everything
    document.addEventListener('DOMContentLoaded', function () {
      // v1.5: Help button
      document.getElementById('help-btn')?.addEventListener('click', openHelpModal);

      // v1.5: Load tooltips on page load
      loadTooltips();

      // Initial calculation
      recalc();
    });

    // Fallback if DOMContentLoaded already fired
    if (document.readyState === 'loading') {
      // Do nothing, DOMContentLoaded will fire
    } else {
      // DOM is already ready
      document.getElementById('help-btn')?.addEventListener('click', openHelpModal);
      loadTooltips();
      recalc();
    }
  </script>
</body>

</html>
