<!doctype html>
<html lang="th">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PY‚ÄëD (PropYield‚ÄëD) ‚Äî Property Investment Tool ¬∑ v7.5 FINAL (Complete Asset Comparison)</title>
  <style>
    :root {
      --bg: #0b0e13;
      --card: #12161c;
      --text: #e9eef3;
      --muted: #a7b0bb;
      --lime: #b2df37;
      --teal: #15d4cf;
      --warn: #f59e0b;
      --bad: #ef4444;
      --good: #22c55e;
      --border: rgba(255, 255, 255, .08);
      --shadow: 0 10px 30px rgba(0, 0, 0, .35);
      --radius: 16px
    }

    * {
      box-sizing: border-box
    }

    html,
    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font: 15px/1.6 Inter, system-ui, Segoe UI, Arial
    }

    h1,
    h2 {
      margin: 0 0 8px
    }

    h1 {
      font-size: 28px
    }

    h2 {
      font-size: 20px
    }

    .wrap {
      max-width: 1200px;
      margin: 0 auto;
      padding: 18px
    }

    .topbar {
      display: flex;
      gap: 12px;
      align-items: center;
      margin: 6px 0 14px
    }

    .badge {
      padding: 6px 10px;
      border: 1px solid var(--border);
      border-radius: 999px;
      color: var(--lime);
      background: rgba(178, 223, 55, .12);
      font-size: 12px
    }

    .grid {
      display: grid;
      gap: 16px
    }

    .card {
      background: linear-gradient(180deg, rgba(255, 255, 255, .02), rgba(255, 255, 255, .0));
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 16px;
      box-shadow: var(--shadow)
    }

    .layout {
      display: grid;
      gap: 16px
    }

    @media(min-width:1024px) {
      .layout {
        grid-template-columns: 1.05fr .95fr
      }
    }

    label {
      display: block;
      font-weight: 600;
      margin: 6px 0 6px
    }

    input[type=number],
    input[type=text],
    select {
      width: 100%;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: #0f1418;
      color: var(--text)
    }

    input.err {
      border-color: var(--bad)
    }

    .help {
      color: var(--muted);
      font-size: 12px
    }

    .row {
      display: grid;
      gap: 12px
    }

    .row-2 {
      grid-template-columns: repeat(2, minmax(0, 1fr))
    }

    .row-3 {
      grid-template-columns: repeat(3, minmax(0, 1fr))
    }

    .kpi {
      font-size: 26px;
      font-weight: 800
    }

    .kpi.smaller {
      font-size: 20px;
    }

    .kpi-sub {
      font-size: 12px;
      color: var(--muted)
    }

    .kval {
      font-variant-numeric: tabular-nums
    }

    .kval.good {
      color: var(--good)
    }

    .kval.warn {
      color: var(--warn)
    }

    .kval.bad {
      color: var(--bad)
    }

    .small {
      font-size: 12px;
      color: var(--muted)
    }

    .adv-btn {
      appearance: none;
      border: 1px solid var(--border);
      background: #0f1418;
      color: var(--text);
      padding: 8px 12px;
      border-radius: 10px;
      cursor: pointer
    }

    .controls {
      display: flex;
      align-items: center;
      gap: 10px;
      justify-content: flex-start;
      margin-top: 10px
    }

    .controls .spacer {
      flex: 1
    }

    .controls .small {
      opacity: .9
    }

    .adv-box {
      display: none;
      margin-top: 10px;
      padding: 12px;
      border-radius: 12px;
      background: #151a20;
      border: 1px solid var(--border)
    }

    .footer {
      opacity: .7;
      margin: 24px 0 40px
    }

    .sep {
      height: 1px;
      background: var(--border);
      margin: 8px 0
    }

    .table-like {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 6px
    }

    .pill {
      display: inline-block;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid transparent;
      font-size: 12px;
      margin: 4px 6px 0 0;
      font-weight: 700
    }

    .pill.good {
      background: #163d2a;
      color: #7ef6a9;
      border-color: #235f40
    }

    .pill.warn {
      background: #3e2f0f;
      color: #ffd579;
      border-color: #6b5418
    }

    .pill.bad {
      background: #4a1714;
      color: #ffb4ab;
      border-color: #7d2b27
    }

    /* Scenarios */
    .scenario {
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px;
      cursor: pointer;
      user-select: none
    }

    .scenario.active {
      outline: 2px solid var(--teal)
    }

    .sc-low {
      background: rgba(245, 158, 11, .08)
    }

    .sc-base {
      background: rgba(21, 212, 207, .08)
    }

    .sc-high {
      background: rgba(34, 197, 94, .08)
    }

    .sc-head {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
      font-weight: 800
    }

    .sc-metric {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 4px 0;
      border-bottom: 1px dashed var(--border);
      font-size: 13px
    }

    .sc-metric .sc-val {
      font-size: 12px;
      white-space: nowrap;
    }

    .sc-metric:last-child {
      border-bottom: none
    }

    .sc-val {
      font-variant-numeric: tabular-nums
    }

    .sc-val.good {
      color: var(--good)
    }

    .sc-val.warn {
      color: var(--warn)
    }

    .sc-val.bad {
      color: var(--bad)
    }

    .sc-desktop {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 12px
    }

    .seg {
      display: none
    }

    @media(max-width:1023px) {
      .seg {
        display: flex;
        gap: 6px
      }

      .seg button {
        flex: 1;
        padding: 8px;
        border-radius: 10px;
        border: 1px solid var(--border);
        background: #0f1418;
        color: var(--text)
      }

      .seg .active {
        border-color: var(--teal)
      }

      .sc-desktop {
        display: none
      }
    }

    .status-card {
      display: flex;
      flex-wrap: wrap;
      gap: 6px
    }

    /* Side switch */
    .switch {
      position: relative;
      display: inline-block;
      width: 42px;
      height: 24px;
      vertical-align: middle
    }

    .switch input {
      opacity: 0;
      width: 0;
      height: 0
    }

    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: #25303a;
      transition: .2s;
      border-radius: 999px;
      border: 1px solid var(--border)
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 3px;
      bottom: 3px;
      background: white;
      transition: .2s;
      border-radius: 50%
    }

    .switch input:checked+.slider {
      background: #165e56
    }

    .switch input:checked+.slider:before {
      transform: translateX(18px)
    }

    .panel-head {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px
    }

    .badge-on {
      padding: 4px 8px;
      border-radius: 999px;
      background: #17332c;
      color: #7ef6a9;
      font-size: 11px;
      border: 1px solid #265a47
    }

    .dim {
      opacity: .6
    }

    /* v1.5: Tooltips - HORIZONTAL ONLY */
    .tooltip-icon {
      display: inline-block;
      width: 16px;
      height: 16px;
      background: var(--teal);
      color: white;
      border-radius: 50%;
      text-align: center;
      line-height: 16px;
      font-size: 12px;
      cursor: help;
      margin-left: 4px;
      position: relative;
      /* Disable browser default tooltip */
      pointer-events: auto;
    }

    .tooltip-icon:hover {
      background: var(--lime);
    }

    .tooltip-content {
      /* HORIZONTAL LAYOUT - Width > Height, readable 1-3 lines */
      position: absolute !important;
      left: calc(100% + 10px) !important;
      top: 50% !important;
      transform: translateY(-50%) !important;

      /* Size for horizontal layout */
      min-width: 250px !important;
      max-width: 400px !important;
      width: max-content !important;

      /* Styling */
      background: var(--card) !important;
      color: var(--text) !important;
      padding: 10px 14px !important;
      border-radius: 8px !important;
      font-size: 13px !important;
      line-height: 1.5 !important;

      /* Text alignment - LEFT aligned, not centered */
      text-align: left !important;

      /* Text wrapping - Better line breaking for Thai text */
      white-space: normal !important;
      word-break: normal !important;
      word-wrap: break-word !important;
      overflow-wrap: break-word !important;
      hyphens: none !important;
      line-break: strict !important;

      /* Visual */
      border: 1px solid var(--border) !important;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4) !important;

      /* Visibility */
      opacity: 0 !important;
      visibility: hidden !important;
      transition: opacity 0.2s ease, visibility 0.2s ease !important;
      z-index: 10000 !important;
      pointer-events: none !important;
    }

    /* Arrow pointing left */
    .tooltip-content::before {
      content: '' !important;
      position: absolute !important;
      right: 100% !important;
      top: 50% !important;
      transform: translateY(-50%) !important;
      border: 6px solid transparent !important;
      border-right-color: var(--card) !important;
    }

    .tooltip-icon:hover .tooltip-content {
      opacity: 1 !important;
      visibility: visible !important;
    }

    /* v1.5: Help Modal */
    .help-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      z-index: 2000;
      display: none;
      align-items: center;
      justify-content: center;
    }

    .help-modal-content {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 0;
      max-width: 900px;
      width: 95%;
      max-height: 90vh;
      overflow: hidden;
      position: relative;
      display: flex;
      flex-direction: column;
    }

    .help-header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: var(--card);
    }

    .help-header h2 {
      margin: 0;
      font-size: 20px;
    }

    .help-close {
      background: none;
      border: none;
      color: var(--text);
      font-size: 24px;
      cursor: pointer;
      padding: 0;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
    }

    .help-close:hover {
      background: var(--border);
    }

    .help-content {
      padding: 24px;
      overflow-y: auto;
      flex: 1;
    }

    /* Accordion Styles */
    .accordion {
      border: 1px solid var(--border);
      border-radius: 8px;
      overflow: hidden;
    }

    .accordion-section {
      border-bottom: 1px solid var(--border);
    }

    .accordion-section:last-child {
      border-bottom: none;
    }

    .accordion-header {
      padding: 16px 20px;
      background: var(--bg);
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: 600;
      transition: background-color 0.2s ease;
      user-select: none;
    }

    .accordion-header:hover {
      background: var(--border);
    }

    .accordion-icon {
      transition: transform 0.2s ease;
      font-size: 14px;
    }

    .accordion-header.active .accordion-icon {
      transform: rotate(90deg);
    }

    .accordion-content {
      padding: 0 20px;
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease, padding 0.3s ease;
    }

    .accordion-content.active {
      max-height: 2000px;
      padding: 20px;
    }

    /* Content Styles */
    .example-card {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 12px;
      margin: 12px 0;
      font-size: 13px;
      line-height: 1.6;
    }

    .glossary-item {
      padding: 10px 0;
      border-bottom: 1px solid var(--border);
      font-size: 14px;
      line-height: 1.6;
    }

    .glossary-item:last-child {
      border-bottom: none;
    }

    .glossary-term {
      font-weight: 600;
      color: var(--lime);
    }

    .threshold-table {
      width: 100%;
      border-collapse: collapse;
      margin: 12px 0;
      font-size: 13px;
    }

    .threshold-table th,
    .threshold-table td {
      padding: 8px 12px;
      text-align: left;
      border: 1px solid var(--border);
    }

    .threshold-table th {
      background: var(--bg);
      font-weight: 600;
    }

    .faq-item {
      margin-bottom: 16px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--border);
    }

    .faq-item:last-child {
      border-bottom: none;
    }

    .help-section {
      margin-bottom: 24px;
    }

    .help-section h3 {
      color: var(--lime);
      margin-bottom: 12px;
    }

    .help-section h4 {
      color: var(--text);
      margin: 16px 0 8px 0;
      font-size: 16px;
    }

    .help-section ul {
      margin-left: 20px;
    }

    .help-section li {
      margin-bottom: 8px;
      line-height: 1.5;
    }

    .accordion-content h4 {
      color: var(--lime);
      margin: 16px 0 12px 0;
      font-size: 15px;
      font-weight: 600;
    }

    .accordion-content h4:first-child {
      margin-top: 0;
    }

    /* Timeline Chart Responsive */
    @media (max-width: 768px) {
      #timeline-card {
        margin-left: -16px;
        margin-right: -16px;
        border-radius: 0;
      }

      #timeline-canvas {
        height: 300px !important;
      }

      #timeline-title {
        font-size: 16px;
      }

      #timeline-toggle-btn {
        font-size: 13px !important;
        padding: 10px 20px !important;
      }
    }

    /* ========================================
       ASSET COMPARISON STYLES (v7)
       ======================================== */

    /* Asset Manager Section */
    #asset-manager-section {
      margin-bottom: 24px;
    }

    .asset-manager-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .text-button {
      background: none;
      border: none;
      color: var(--muted);
      cursor: pointer;
      font-size: 13px;
      text-decoration: underline;
      padding: 4px 8px;
      transition: color 0.2s;
    }

    .text-button:hover {
      color: var(--bad);
    }

    /* Asset Cards Grid */
    .asset-cards-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
      gap: 16px;
      margin-bottom: 16px;
    }

    /* Asset Card */
    .asset-card {
      position: relative;
      border: 2px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      cursor: pointer;
      transition: all 0.2s;
      background: var(--card);
    }

    .asset-card:hover {
      border-color: var(--teal);
      box-shadow: 0 4px 12px rgba(21, 212, 207, 0.2);
    }

    .card-delete {
      position: absolute;
      top: 8px;
      right: 8px;
      opacity: 0;
      background: var(--bad);
      border: none;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      color: white;
      cursor: pointer;
      transition: opacity 0.2s;
      font-size: 18px;
      line-height: 1;
    }

    .asset-card:hover .card-delete {
      opacity: 1;
    }

    .card-name {
      font-size: 16px;
      font-weight: 600;
      margin: 0 0 12px 0;
      color: var(--text);
      padding-right: 24px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .card-metrics {
      display: flex;
      flex-direction: column;
      gap: 6px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--border);
      margin-bottom: 12px;
    }

    .metric-row {
      display: flex;
      justify-content: space-between;
      font-size: 13px;
    }

    .metric-row .label {
      color: var(--muted);
    }

    .metric-row .value {
      font-weight: 600;
      font-variant-numeric: tabular-nums;
    }

    .metric-row .value.good {
      color: var(--good);
    }

    .card-checkbox label {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      cursor: pointer;
    }

    .card-checkbox input[type="checkbox"] {
      accent-color: var(--teal);
      width: 16px;
      height: 16px;
      cursor: pointer;
    }

    /* Add New Card */
    .asset-card-add {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      border-style: dashed;
      gap: 8px;
      min-height: 180px;
    }

    .asset-card-add:hover {
      border-color: var(--lime);
      box-shadow: 0 4px 12px rgba(178, 223, 55, 0.2);
    }

    .add-icon {
      font-size: 32px;
      color: var(--teal);
    }

    /* Compare Actions */
    .compare-actions {
      padding-top: 16px;
      border-top: 1px solid var(--border);
    }

    #compare-selected-btn {
      width: 100%;
      background: linear-gradient(135deg, var(--lime), var(--teal));
      color: var(--bg);
      padding: 12px 24px;
      border-radius: 10px;
      border: none;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s;
    }

    #compare-selected-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    #compare-selected-btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(21, 212, 207, 0.4);
    }

    /* Modals */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      z-index: 9999;
      align-items: center;
      justify-content: center;
    }

    .modal.show {
      display: flex;
    }

    .modal-content {
      background: var(--card);
      border-radius: var(--radius);
      padding: 24px;
      max-width: 500px;
      width: 90%;
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
    }

    .modal-content h2 {
      margin-top: 0;
      margin-bottom: 20px;
    }

    .modal-field {
      margin-bottom: 16px;
    }

    .modal-field label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
    }

    .modal-field input[type="text"] {
      width: 100%;
      padding: 10px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-size: 14px;
    }

    .modal-hint {
      font-size: 12px;
      color: var(--muted);
      margin-top: 4px;
    }

    .checkbox-label {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
    }

    .checkbox-label input[type="checkbox"] {
      accent-color: var(--teal);
      width: 18px;
      height: 18px;
      cursor: pointer;
    }

    .modal-actions {
      display: flex;
      gap: 12px;
      margin-top: 20px;
    }

    .btn-primary {
      flex: 1;
      background: linear-gradient(135deg, #8b5cf6, #ec4899);
      color: white;
      padding: 12px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
    }

    .btn-secondary {
      flex: 1;
      background: var(--border);
      color: var(--text);
      padding: 12px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-size: 14px;
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4);
    }

    .btn-secondary:hover {
      background: rgba(255, 255, 255, 0.15);
    }

    /* Comparison Section (hidden by default) */
    #comparison-section {
      display: none;
    }

    /* Scenario Selector */
    .scenario-selector {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .scenario-radio {
      display: flex;
      gap: 12px;
    }

    .scenario-radio label {
      display: flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      padding: 8px 16px;
      border: 1px solid var(--border);
      border-radius: 8px;
      transition: all 0.2s;
    }

    .scenario-radio label:hover {
      border-color: var(--teal);
      background: rgba(21, 212, 207, 0.1);
    }

    .scenario-radio input[type="radio"] {
      accent-color: var(--teal);
    }

    .scenario-radio input[type="radio"]:checked + span {
      color: var(--lime);
      font-weight: 600;
    }

    /* Comparison Table */
    .table-container {
      overflow-x: auto;
    }

    .comparison-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }

    .comparison-table th {
      background: rgba(0, 0, 0, 0.2);
      padding: 12px;
      text-align: left;
      border-bottom: 2px solid var(--border);
      border-left: 1px solid var(--border);
      font-weight: 600;
      white-space: nowrap;
    }

    .comparison-table th:first-child {
      border-left: none;
    }

    .comparison-table td {
      padding: 10px 12px;
      border-bottom: 1px solid var(--border);
      border-left: 1px solid var(--border);
      font-variant-numeric: tabular-nums;
    }

    .comparison-table td:first-child {
      border-left: none;
    }

    .comparison-table tr:hover {
      background: rgba(21, 212, 207, 0.05);
    }

    .comparison-table .section-header td {
      background: rgba(0, 0, 0, 0.3);
      font-weight: 600;
      padding: 8px 12px;
      color: var(--lime);
    }

    .comparison-table td.good {
      color: var(--good);
      font-weight: 600;
    }

    .comparison-table td.warn {
      color: var(--warn);
      font-weight: 600;
    }

    .comparison-table td.bad {
      color: var(--bad);
      font-weight: 600;
    }

    /* Chart Controls */
    .chart-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .chart-mode-switch {
      display: flex;
      gap: 8px;
    }

    .chart-mode-switch label {
      padding: 6px 12px;
      border: 1px solid var(--border);
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .chart-mode-switch label:hover {
      border-color: var(--teal);
      background: rgba(21, 212, 207, 0.1);
    }

    .chart-mode-switch input[type="radio"] {
      display: none;
    }

    .chart-mode-switch input[type="radio"]:checked + span {
      color: var(--lime);
      font-weight: 600;
    }

    .chart-mode-switch input[type="radio"]:checked ~ span {
      background: var(--teal);
      color: var(--bg);
    }

    .scenario-indicator {
      font-size: 13px;
      color: var(--muted);
    }

    .scenario-indicator strong {
      color: var(--lime);
    }

    .chart-wrapper {
      position: relative;
      height: 400px;
    }

    /* AI Recommendations */
    .ai-recommendations {
      font-size: 14px;
      line-height: 1.6;
    }

    .rec-section h3 {
      margin: 0 0 12px 0;
      color: var(--lime);
      font-size: 16px;
    }

    .rec-divider {
      height: 1px;
      background: var(--border);
      margin: 12px 0;
    }

    .rec-item {
      margin-bottom: 16px;
      padding: 12px;
      background: rgba(21, 212, 207, 0.05);
      border-left: 3px solid var(--teal);
      border-radius: 4px;
    }

    .rec-item.rec-warning {
      background: rgba(245, 158, 11, 0.05);
      border-left-color: var(--warn);
    }

    .rec-item strong {
      display: block;
      margin-bottom: 6px;
      color: var(--teal);
    }

    .rec-item.rec-warning strong {
      color: var(--warn);
    }

    .rec-item ul {
      margin: 6px 0 0 20px;
      padding: 0;
    }

    .rec-item li {
      margin: 4px 0;
      color: var(--text);
    }

    /* Mobile Responsive */
    @media (max-width: 768px) {
      .asset-cards-grid {
        grid-template-columns: 1fr;
      }

      .scenario-selector {
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
      }

      .comparison-table {
        font-size: 12px;
      }

      .comparison-table th,
      .comparison-table td {
        padding: 8px 6px;
      }

      .chart-controls {
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
      }

      .chart-wrapper {
        height: 300px;
      }

      .ai-recommendations {
        font-size: 13px;
      }

      .rec-item {
        padding: 10px;
      }

      .rec-item ul {
        margin-left: 16px;
      }

      .scenario-radio {
        flex-direction: column;
        width: 100%;
      }

      .scenario-radio label {
        width: 100%;
      }

      .chart-mode-switch {
        width: 100%;
      }

      .chart-mode-switch label {
        flex: 1;
      }
    }
  </style>

  <!-- Chart.js for Timeline Chart -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3"></script>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div>
        <div class="badge">Property Investment Tool</div>
        <h1>PY-D | PropYield-D</h1>
      </div>
    </div>

    <!-- Help Button Above Asset Manager -->
    <div style="display: flex; justify-content: flex-end; margin-bottom: 12px;">
      <button id="help-btn" class="adv-btn" style="padding: 6px 10px; font-size: 12px;">‚ùì Help</button>
    </div>

    <!-- Asset Manager Section (v7) -->
    <div id="asset-manager-section" class="card">
      <div class="asset-manager-header">
        <h2>Your Assets (<span id="asset-count">0</span>)</h2>
        <button class="text-button" onclick="clearAllAssets()">Clear all assets</button>
      </div>
      <div id="asset-cards-container" class="asset-cards-grid"></div>
      <div class="compare-actions">
        <button id="compare-selected-btn" onclick="compareSelectedAssets()" disabled>
          üìä Compare Selected Assets (0)
        </button>
      </div>
    </div>

    <div class="layout">
      <!-- LEFT: Input Cards -->
      <div class="grid">

      <!-- Investment -->
      <div class="card">
        <div class="panel-head">
          <h2>1. Investment</h2>
        </div>
        <div class="row row-3">
          <div><label>Purchase Price (THB) <span class="tooltip-icon"
                data-tooltip="purchase_price">?</span></label><input type="text" id="purchase"
              placeholder="‡πÄ‡∏ä‡πà‡∏ô 4,000,000" /></div>
          <div><label>Avg / sqm (THB) <span class="tooltip-icon" data-tooltip="avg_psm">?</span></label><input
              type="text" id="avgpsm" placeholder="‡πÄ‡∏ä‡πà‡∏ô 120,000" /></div>
          <div><label>Area (sqm) <span class="tooltip-icon" data-tooltip="area_sqm">?</span></label><input type="text"
              id="area" placeholder="‡πÄ‡∏ä‡πà‡∏ô 35" /></div>
        </div>
        <div class="controls">
          <button class="adv-btn" data-target="#adv-invest">Show / Hide details</button>
          <div class="spacer"></div>
          <span class="small">Include in calc</span>
          <label class="switch"><input type="checkbox" id="swInv"><span class="slider"></span></label>
        </div>
        <div id="adv-invest" class="adv-box">
          <div class="row row-3">
            <div>
              <label>Acquisition Cost (%)</label><input type="number" id="acq_pct" value="3" inputmode="decimal" min="0" max="100" oninput="if(parseFloat(this.value)>100)this.value=100;if(parseFloat(this.value)<0)this.value=0;" />
              <div class="help">‚âà <span id="acq_thb">‚Äî</span> THB</div>
            </div>
            <div><label>Fit‚Äëout (THB)</label><input type="number" id="fitout" value="0" inputmode="numeric"
                placeholder="0" /></div>
            <div><label>Other Costs (THB)</label><input type="number" id="other" value="0" inputmode="numeric"
                placeholder="0" />
            </div>
          </div>
          <div class="small">‡∏™‡∏ß‡∏¥‡∏ï‡∏ä‡πå ‚ÄúInclude in calc‚Äù ‡πÄ‡∏õ‡∏¥‡∏î: ‡∏à‡∏∞‡∏ö‡∏ß‡∏Å Acq/Fit‚Äëout/Other ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô (Cost basis)</div>
        </div>
      </div>

      <!-- Revenue -->
      <div class="card">
        <div class="panel-head">
          <h2>2. Revenue</h2>
        </div>
        <div class="row row-2">
          <div>
            <label>Rent / month (THB) <span class="tooltip-icon" data-tooltip="monthly_rent">?</span></label>
            <input type="text" id="rent" placeholder="‡πÄ‡∏ä‡πà‡∏ô 20,000" />
            <div class="help">two‚Äëway with Target Gross Yield ¬∑ base = Purchase</div>
          </div>
          <div>
            <label>Target Gross Yield (%) <span class="tooltip-icon" data-tooltip="target_gross_yield">?</span></label>
            <input type="number" id="tgt_gross" placeholder="‡πÄ‡∏ä‡πà‡∏ô 5.0" inputmode="decimal" min="0" max="100" oninput="if(parseFloat(this.value)>100)this.value=100;if(parseFloat(this.value)<0)this.value=0;" />
          </div>
        </div>
        <div class="controls">
          <button class="adv-btn" data-target="#adv-rev">Show / Hide details</button>
          <div class="spacer"></div>
          <span class="small">Include in calc</span>
          <label class="switch"><input type="checkbox" id="swRev"><span class="slider"></span></label>
        </div>
        <div id="adv-rev" class="adv-box">
          <div class="row row-3">
            <div>
              <label>Occupancy (%)</label><input type="number" id="occ" value="90" inputmode="decimal" min="0" max="100" oninput="if(parseFloat(this.value)>100)this.value=100;if(parseFloat(this.value)<0)this.value=0;" />
              <div class="help">Effective rent ‚âà <span id="occ_eff">‚Äî</span> THB/mo</div>
            </div>
            <div>
              <label>Opex (%) (incl. common fee)</label><input type="number" id="opex" value="10" inputmode="decimal" min="0" max="100" oninput="if(parseFloat(this.value)>100)this.value=100;if(parseFloat(this.value)<0)this.value=0;" />
              <div class="help">Total opex ‚âà <span id="opex_thb">‚Äî</span> THB/mo</div>
            </div>
            <div>
              <label>Agent Fee (months/yr)</label><input type="number" id="agentm" value="1" inputmode="decimal" />
              <div class="help">‚âà <span id="agent_thb">‚Äî</span> THB/mo</div>
            </div>
          </div>
          <div class="small">‡∏™‡∏ß‡∏¥‡∏ï‡∏ä‡πå ‚ÄúInclude in calc‚Äù ‡πÄ‡∏õ‡∏¥‡∏î: ‡πÉ‡∏ä‡πâ Occ/Opex/Agent; ‡∏õ‡∏¥‡∏î: ‡πÉ‡∏ä‡πâ neutral baseline (100%/0%/0)
          </div>
        </div>
      </div>

      <!-- Financing -->
      <div class="card">
        <div class="panel-head">
          <h2>3. Financing</h2>
        </div>
        <div class="row row-2">
          <div><label>Gross Salary (THB/mo) <span class="tooltip-icon"
                data-tooltip="gross_salary">?</span></label><input type="text" id="salary" placeholder="‡πÄ‡∏ä‡πà‡∏ô 70,000" />
          </div>
          <div><label>Down Payment (%) <span class="tooltip-icon" data-tooltip="down_payment_pct">?</span></label><input
              type="number" id="down" value="10" inputmode="decimal" min="0" max="100" oninput="if(parseFloat(this.value)>100)this.value=100;if(parseFloat(this.value)<0)this.value=0;" /></div>
        </div>
        <div class="controls">
          <button class="adv-btn" data-target="#adv-fin">Show / Hide details</button>
          <div class="spacer"></div>
          <span class="small">Include in calc</span>
          <label class="switch"><input type="checkbox" id="swFin"><span class="slider"></span></label>
        </div>
        <div id="adv-fin" class="adv-box">
          <div class="row row-3">
            <div><label>Interest (APR %)</label><input type="number" id="rate" value="4.5" inputmode="decimal" min="0" max="100" oninput="if(parseFloat(this.value)>100)this.value=100;if(parseFloat(this.value)<0)this.value=0;" />
            </div>
            <div><label>Tenor (years)</label>
              <select id="tenor">
                <option value="30" selected>30</option>
                <option value="25">25</option>
                <option value="20">20</option>
              </select>
            </div>
            <div>
              <label>Equity Invested (auto)</label>
              <div id="equity_box" class="help">‚Äî</div>
            </div>
          </div>
          <div class="sep"></div>
          <div class="table-like small">
            <div>Down on Purchase</div>
            <div id="eq_down">‚Äî</div>
            <div>Acquisition Costs</div>
            <div id="eq_acq">‚Äî</div>
            <div>Fit‚Äëout + Other</div>
            <div id="eq_fo">‚Äî</div>
          </div>
          <div class="small">‡∏™‡∏ß‡∏¥‡∏ï‡∏ä‡πå ‚ÄúInclude in calc‚Äù ‡πÄ‡∏õ‡∏¥‡∏î: ‡πÉ‡∏ä‡πâ APR/Tenor ‡∏ï‡∏≤‡∏°‡∏ü‡∏¥‡∏•‡∏î‡πå; ‡∏õ‡∏¥‡∏î: ‡πÉ‡∏ä‡πâ neutral baseline APR
            4.5%, 30y</div>
        </div>
      </div>

      <!-- Exit -->
      <div class="card">
        <div class="panel-head">
          <h2>4. Exit (optional)</h2>
        </div>
        <div><input type="checkbox" id="exit_on" /> ‡∏£‡∏ß‡∏° Exit ‡πÉ‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•</div>
        <div class="row row-3" style="margin-top:10px">
          <div><label>Holding (yrs) <span class="tooltip-icon" data-tooltip="holding_years">?</span></label><input
              type="number" id="hold" placeholder="‡πÄ‡∏ä‡πà‡∏ô 5" inputmode="decimal" />
          </div>
          <div><label>Price growth (%/yr) <span class="tooltip-icon" data-tooltip="price_growth">?</span></label><input
              type="number" id="pgrow" placeholder="‡πÄ‡∏ä‡πà‡∏ô 3" inputmode="decimal" min="0" max="100" oninput="if(parseFloat(this.value)>100)this.value=100;if(parseFloat(this.value)<0)this.value=0;" /></div>
          <div><label>Selling cost (%) <span class="tooltip-icon" data-tooltip="selling_cost">?</span></label><input
              type="number" id="sellc" value="3" inputmode="decimal" min="0" max="100" oninput="if(parseFloat(this.value)>100)this.value=100;if(parseFloat(this.value)<0)this.value=0;" /></div>
        </div>
        <div class="controls">
          <button class="adv-btn" data-target="#adv-exit">Show / Hide details</button>
          <div class="spacer"></div>
          <span class="small">Include in calc</span>
          <label class="switch"><input type="checkbox" id="swExit"><span class="slider"></span></label>
        </div>
        <div id="adv-exit" class="adv-box">
          <div class="row row-3">
            <div><label>Exit Mode</label>
              <select id="exit_mode">
                <option value="auto" selected>Auto (growth-driven)</option>
                <option value="manual">Manual price</option>
              </select>
            </div>
            <div><label>Manual Exit Price (THB)</label><input type="number" id="exit_price" value="0"
                inputmode="numeric" placeholder="0" /></div>
            <div><label>Capital Gain Tax % (optional)</label><input type="number" id="tax_pct" value="0"
                inputmode="decimal" min="0" max="100" oninput="if(parseFloat(this.value)>100)this.value=100;if(parseFloat(this.value)<0)this.value=0;" /></div>
          </div>
          <div class="small">‡∏™‡∏ß‡∏¥‡∏ï‡∏ä‡πå ‚ÄúInclude in calc‚Äù ‡πÄ‡∏õ‡∏¥‡∏î: ‡πÉ‡∏ä‡πâ Exit Mode/Tax; ‡∏õ‡∏¥‡∏î: ‡πÉ‡∏ä‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Basic
            (Holding/Growth/Sell cost)</div>
        </div>
      </div>

      </div>
      <!-- End LEFT -->

      <!-- RIGHT: Output Cards -->
      <div class="grid">

      <!-- Status -->
      <div class="card">
        <h2>Status</h2>
        <div id="status_pills" class="status-card"></div>
      </div>

      <!-- Scenarios -->
      <div class="card">
        <h2>Scenario Analysis</h2>
        <div class="seg">
          <button id="seg-low">Low</button><button id="seg-base" class="active">Base</button><button
            id="seg-high">High</button>
        </div>
        <div class="sc-desktop">
          <div class="scenario sc-low" id="card-low">
            <div class="sc-head"><span>Low (‚àí10%)</span><span id="rent_low">‚Äî</span></div>
            <div class="sc-metric"><span>Net Yield</span><span id="ny_low" class="sc-val">‚Äî</span></div>
            <div class="sc-metric"><span>Cash Flow / mo</span><span id="cf_low" class="sc-val">‚Äî</span></div>
            <div class="sc-metric"><span>DTI</span><span id="dti_low" class="sc-val">‚Äî</span></div>
            <div class="sc-metric"><span>Payback (yrs)</span><span id="pb_low" class="sc-val">‚Äî</span></div>
            <div class="sc-metric"><span>CoC</span><span id="coc_low" class="sc-val">‚Äî</span></div>
          </div>
          <div class="scenario sc-base active" id="card-base">
            <div class="sc-head"><span>Base (0%)</span><span id="rent_base">‚Äî</span></div>
            <div class="sc-metric"><span>Net Yield</span><span id="ny_base" class="sc-val">‚Äî</span></div>
            <div class="sc-metric"><span>Cash Flow / mo</span><span id="cf_base" class="sc-val">‚Äî</span></div>
            <div class="sc-metric"><span>DTI</span><span id="dti_base" class="sc-val">‚Äî</span></div>
            <div class="sc-metric"><span>Payback (yrs)</span><span id="pb_base" class="sc-val">‚Äî</span></div>
            <div class="sc-metric"><span>CoC</span><span id="coc_base" class="sc-val">‚Äî</span></div>
          </div>
          <div class="scenario sc-high" id="card-high">
            <div class="sc-head"><span>High (+10%)</span><span id="rent_high">‚Äî</span></div>
            <div class="sc-metric"><span>Net Yield</span><span id="ny_high" class="sc-val">‚Äî</span></div>
            <div class="sc-metric"><span>Cash Flow / mo</span><span id="cf_high" class="sc-val">‚Äî</span></div>
            <div class="sc-metric"><span>DTI</span><span id="dti_high" class="sc-val">‚Äî</span></div>
            <div class="sc-metric"><span>Payback (yrs)</span><span id="pb_high" class="sc-val">‚Äî</span></div>
            <div class="sc-metric"><span>CoC</span><span id="coc_high" class="sc-val">‚Äî</span></div>
          </div>
        </div>
      </div>

      <!-- Key Metrics -->
      <div class="card">
        <h2>Key Metrics</h2>
        <div class="row row-3">
          <div>
            <div class="kpi kval" id="equity_invested">‚Äî</div>
            <div class="kpi-sub">Initial Investment (Equity)</div>
          </div>
          <div>
            <div class="kpi kval" id="gross">‚Äî</div>
            <div class="kpi-sub">Gross Yield</div>
          </div>
          <div>
            <div class="kpi kval" id="net">‚Äî</div>
            <div class="kpi-sub">Net Yield (unlevered)</div>
          </div>
        </div>
        <div class="row row-3" style="margin-top:10px">
          <div>
            <div class="kpi kval" id="coc">‚Äî</div>
            <div class="kpi-sub">CoC Return</div>
          </div>
          <div>
            <div class="kpi kval" id="netmo">‚Äî</div>
            <div class="kpi-sub">Net / month (after debt or NOI if Financing off)</div>
          </div>
          <div>
            <div class="kpi kval" id="dti">‚Äî</div>
            <div class="kpi-sub">DTI</div>
          </div>
        </div>
        <div class="row row-3" style="margin-top:10px">
          <div>
            <div class="kpi kval" id="payback">‚Äî</div>
            <div class="kpi-sub">Payback (yrs)</div>
          </div>
          <div>
            <div class="kpi kval" id="irr">‚Äî</div>
            <div class="kpi-sub">IRR (Exit ON)</div>
          </div>
          <div>
            <div class="kpi kval" id="emult">‚Äî</div>
            <div class="kpi-sub">Equity Multiple</div>
          </div>
        </div>
      </div>

      <!-- Affordability -->
      <div class="card">
        <h2>Affordability</h2>
        <div class="row row-3">
          <div>
            <div class="kpi smaller" id="loan_amt">‚Äî</div>
            <div class="kpi-sub">Loan Amount</div>
          </div>
          <div>
            <div class="kpi smaller" id="pmt2">‚Äî</div>
            <div class="kpi-sub">Monthly Payment</div>
          </div>
          <div>
            <div class="kpi smaller" id="tot_int">‚Äî</div>
            <div class="kpi-sub" id="tot_int_label">Total Interest</div>
          </div>
        </div>
        <div id="aff_warn" class="small" style="margin-top:8px">‚Äî</div>
      </div>

      <!-- Exit Summary -->
      <div class="card">
        <h2>Exit Summary</h2>
        <div class="row row-3">
          <div>
            <div class="kpi smaller" id="tval">‚Äî</div>
            <div class="kpi-sub">Terminal Value</div>
          </div>
          <div>
            <div class="kpi smaller" id="npro">‚Äî</div>
            <div class="kpi-sub">Net Proceeds</div>
          </div>
          <div>
            <div class="kpi smaller" id="cgain">‚Äî</div>
            <div class="kpi-sub">Capital Gain (incl. cashflow)</div>
          </div>
        </div>
      </div>

      <!-- AI Note -->
      <div class="card">
        <h2>AI Note:</h2>
        <div id="ai_note" class="small">‚Äî</div>
      </div>

      <!-- Timeline Chart Section -->
      <div class="card" id="timeline-card" style="display: none; margin-top: 20px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
          <h2 id="timeline-title">üìà 30-Year Investment Timeline</h2>
          <button id="timeline-hide-btn" onclick="toggleTimeline()" style="background: var(--border); padding: 6px 12px; border-radius: 6px; 
                           border: none; cursor: pointer; color: var(--text); font-size: 13px;">
            Hide
          </button>
        </div>

        <!-- Remark Message -->
        <div id="timeline-remark" style="background: rgba(21, 212, 207, 0.1); border-left: 3px solid var(--teal); 
                      padding: 10px 12px; margin-bottom: 16px; font-size: 13px; line-height: 1.5;">
          ‚ÑπÔ∏è Using default 3% property appreciation
        </div>

        <!-- Chart Canvas -->
        <div style="position: relative; height: 400px;">
          <canvas id="timeline-canvas"></canvas>
        </div>

        <!-- Payback Period Legend -->
        <div id="payback-legend" style="margin-top: 16px; padding: 12px; background: rgba(0,0,0,0.15); 
                      border-radius: 8px; border: 1px solid var(--border);">
          <div style="font-weight: 600; margin-bottom: 8px; color: var(--lime);">üí∞ Payback Period:</div>
          <div style="display: flex; gap: 20px; font-size: 14px; flex-wrap: wrap;">
            <span style="color: #ef4444;">‚óè Low: <span id="pb-legend-low">‚Äî</span> years</span>
            <span style="color: #15d4cf;">‚óè Base: <span id="pb-legend-base">‚Äî</span> years</span>
            <span style="color: #22c55e;">‚óè High: <span id="pb-legend-high">‚Äî</span> years</span>
          </div>
        </div>

        <!-- Toggle Controls -->
        <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border);">
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
              <input type="checkbox" id="show-payback" checked onchange="updateTimelineChart()">
              <span style="font-size: 13px;">üí∞ Show Payback Marker</span>
            </label>
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
              <input type="checkbox" id="show-loan-paid" onchange="updateTimelineChart()">
              <span style="font-size: 13px;">üè¶ Show Loan Paid Off</span>
            </label>
          </div>
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="card" style="margin-top: 16px;">
        <div style="display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">
          <button id="timeline-toggle-btn" onclick="toggleTimeline()" style="background: linear-gradient(135deg, var(--teal), var(--lime)); 
                         color: white; padding: 12px 24px; border-radius: 10px; border: none; 
                         cursor: pointer; font-size: 14px; font-weight: 600; flex: 1; 
                         min-width: 200px; max-width: 300px;">
            üìä Show Investment Timeline
          </button>
          <button id="save-asset-btn" onclick="handleSaveAsset()" style="background: linear-gradient(135deg, #8b5cf6, #ec4899); 
                         color: white; padding: 12px 24px; border-radius: 10px; border: none; 
                         cursor: pointer; font-size: 14px; font-weight: 600; flex: 1; 
                         min-width: 200px; max-width: 300px;">
            üíæ Save Asset
          </button>
        </div>
      </div>

      </div>
      <!-- End RIGHT -->
    </div>
    <!-- End layout -->

    <!-- ========================================
         COMPARISON SECTION (State B)
         ======================================== -->
    <div id="comparison-section" style="display: none;">
      
      <!-- Scenario Selector -->
      <div class="card">
        <div class="scenario-selector">
          <h2>üìä Comparing <span id="compare-count">0</span> Assets</h2>
          <div class="scenario-radio">
            <label>
              <input type="radio" name="scenario" value="low" onchange="updateComparison()">
              <span>Low (-10%)</span>
            </label>
            <label>
              <input type="radio" name="scenario" value="base" checked onchange="updateComparison()">
              <span>Base</span>
            </label>
            <label>
              <input type="radio" name="scenario" value="high" onchange="updateComparison()">
              <span>High (+10%)</span>
            </label>
          </div>
        </div>
      </div>

      <!-- Comparison Table -->
      <div class="card">
        <h2>Key Metrics</h2>
        <div class="table-container">
          <table id="comparison-table" class="comparison-table">
            <!-- Table will be generated here -->
          </table>
        </div>
      </div>

      <!-- AI Recommendations -->
      <div class="card" style="margin-top: 20px;">
        <div id="ai-recommendations" class="ai-recommendations">
          <!-- Recommendations will be generated here -->
        </div>
      </div>

      <!-- Timeline Chart (with Show/Hide) -->
      <div class="card" style="margin-top: 20px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
          <h2 style="margin: 0;">üìà 30-Year Investment Timeline</h2>
          <button id="toggle-comparison-chart-btn" onclick="toggleComparisonChart()" 
                  style="background: linear-gradient(135deg, var(--lime), var(--teal)); 
                         color: var(--bg); padding: 8px 16px; border-radius: 8px; 
                         border: none; cursor: pointer; font-size: 13px; font-weight: 600;">
            Show Chart
          </button>
        </div>
        
        <div id="comparison-chart-container" style="display: none;">
          <!-- Chart Controls -->
          <div class="chart-controls">
            <div class="chart-mode-switch">
              <label>
                <input type="radio" name="chart-mode" value="networth" checked onchange="updateComparisonChart()">
                <span>Net Worth</span>
              </label>
              <label>
                <input type="radio" name="chart-mode" value="property" onchange="updateComparisonChart()">
                <span>Property Value</span>
              </label>
            </div>
            <div class="scenario-indicator">
              Scenario: <strong id="current-scenario-chart">BASE</strong>
            </div>
          </div>
          
          <!-- Chart Canvas -->
          <div class="chart-wrapper">
            <canvas id="comparison-timeline-chart"></canvas>
          </div>

          <!-- Payback Period Legend -->
          <div id="comparison-payback-legend" style="margin-top: 16px; padding: 12px; background: rgba(0,0,0,0.15); 
                        border-radius: 8px; border: 1px solid var(--border); display: none;">
            <div style="font-weight: 600; margin-bottom: 8px; color: var(--lime);">üí∞ Payback Period:</div>
            <div id="comparison-payback-items" style="display: flex; gap: 20px; font-size: 14px; flex-wrap: wrap;">
              <!-- Payback items will be generated here -->
            </div>
          </div>

          <!-- Exit & Loan Paid Off Legend -->
          <div id="comparison-milestones-legend" style="margin-top: 16px; padding: 12px; background: rgba(0,0,0,0.15); 
                        border-radius: 8px; border: 1px solid var(--border); display: none;">
            <div id="comparison-exit-section" style="margin-bottom: 12px; display: none;">
              <div style="font-weight: 600; margin-bottom: 8px; color: var(--lime);">üèÅ Exit Points:</div>
              <div id="comparison-exit-items" style="display: flex; gap: 20px; font-size: 14px; flex-wrap: wrap;">
                <!-- Exit items will be generated here -->
              </div>
            </div>
            <div id="comparison-loan-section" style="display: none;">
              <div style="font-weight: 600; margin-bottom: 8px; color: var(--teal);">üè¶ Loan Paid Off:</div>
              <div id="comparison-loan-items" style="display: flex; gap: 20px; font-size: 14px; flex-wrap: wrap;">
                <!-- Loan items will be generated here -->
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Back to Calculator -->
      <div style="margin-top: 20px; text-align: center;">
        <button onclick="showCalculatorSection()" 
                style="background: var(--border); color: var(--text); padding: 10px 20px; 
                       border-radius: 8px; border: none; cursor: pointer;">
          ‚Üê Back to Calculator
        </button>
      </div>

    </div>
    <!-- End Comparison Section -->

  </div>

  <div class="footer small">¬©2025 PropYield‚ÄëD. v7.5 FINAL (Complete Asset Comparison)</div>
  </div>

  <!-- v1.5: Help Modal -->
  <!-- v1.6: Comprehensive Help Modal with Accordion -->
  <div id="help-modal" class="help-modal">
    <div class="help-modal-content">
      <div class="help-header">
        <h2>üè† Property Investment Tool - Complete Documentation</h2>
        <button class="help-close" onclick="closeHelpModal()">&times;</button>
      </div>

      <div class="help-content">
        <div class="accordion">

          <!-- Quick Start -->
          <div class="accordion-section">
            <div class="accordion-header" onclick="toggleAccordion(this)">
              <span>üöÄ Quick Start</span>
              <span class="accordion-icon">‚ñ∏</span>
            </div>
            <div class="accordion-content">
              <h4>3 Steps to Start</h4>
              <p><strong>Step 1: Enter Basic Info</strong></p>
              <ul>
                <li>Purchase Price: ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ã‡∏∑‡πâ‡∏≠‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô (‡πÄ‡∏ä‡πà‡∏ô 4,000,000 ‡∏ö‡∏≤‡∏ó)</li>
                <li>Monthly Rent: ‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡πÄ‡∏ä‡πà‡∏ô 20,000 ‡∏ö‡∏≤‡∏ó)</li>
                <li>‚Üí ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Gross Yield ‡πÉ‡∏´‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</li>
              </ul>
              <p><strong>Step 2: Turn On Switches (Optional)</strong></p>
              <ul>
                <li>Revenue Switch ON: ‡∏£‡∏ß‡∏°‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢ (occupancy 90%, opex 15%, agent 1 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏õ‡∏µ)</li>
                <li>Financing Switch ON: ‡∏£‡∏ß‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡∏π‡πâ (‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏™‡πà Salary)</li>
                <li>‚Üí ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á Net Yield, DTI, Cashflow</li>
              </ul>
              <p><strong>Step 3: Compare Scenarios</strong></p>
              <ul>
                <li>‡∏Ñ‡∏•‡∏¥‡∏Å Low/Base/High cards</li>
                <li>‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô ¬±10%</li>
              </ul>
              <div class="example-card">
                <strong>Example:</strong><br>
                Purchase = 4,000,000 | Rent = 20,000 | Salary = 70,000<br>
                ‚Üí Gross Yield = 6.0%<br>
                ‚Üí Net Yield = 4.9% (with switches ON)<br>
                ‚Üí DTI = 26.1% (‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢)
              </div>
            </div>
          </div>

          <!-- Timeline Chart -->
          <div class="accordion-section">
            <div class="accordion-header" onclick="toggleAccordion(this)">
              <span>üìà Timeline Chart Features</span>
              <span class="accordion-icon">‚ñ∏</span>
            </div>
            <div class="accordion-content">
              <h4>Interactive Timeline Chart</h4>
              <p>‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏¥‡∏ö‡πÇ‡∏ï‡∏Ç‡∏≠‡∏á‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏•‡∏á‡∏ó‡∏∏‡∏ô‡∏ï‡∏•‡∏≠‡∏î‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏ñ‡∏∑‡∏≠‡∏Ñ‡∏£‡∏≠‡∏á (0-30 ‡∏õ‡∏µ)</p>

              <h4>Features</h4>
              <ul>
                <li><strong>Crosshair Tooltip:</strong> ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÄ‡∏°‡∏≤‡∏™‡πå‡∏ö‡∏ô‡∏Å‡∏£‡∏≤‡∏ü‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏Ñ‡πà‡∏≤‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏õ‡∏µ‡πÅ‡∏ö‡∏ö‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</li>
                <li><strong>Payback Marker (‚óè):</strong> ‡∏à‡∏∏‡∏î‡∏Å‡∏•‡∏°‡∏™‡∏µ‡∏ö‡∏ô‡πÄ‡∏™‡πâ‡∏ô‡∏Å‡∏£‡∏≤‡∏ü = ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏ô‡∏ó‡∏∏‡∏ô (Cumulative Cashflow = 0)
                </li>
                <li><strong>Loan Paid Off (üè†):</strong> ‡πÄ‡∏™‡πâ‡∏ô‡∏õ‡∏£‡∏∞‡∏™‡∏µ‡∏™‡πâ‡∏° = ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡∏π‡πâ‡∏´‡∏°‡∏î (‡∏ï‡∏≤‡∏°‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏ú‡πà‡∏≠‡∏ô)</li>
                <li><strong>Exit Line (üèÅ):</strong> ‡πÄ‡∏™‡πâ‡∏ô‡∏™‡∏µ‡∏°‡πà‡∏ß‡∏á = ‡∏à‡∏∏‡∏î‡∏Ç‡∏≤‡∏¢‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡∏¥‡∏î Exit ON</li>
                <li><strong>3 Scenarios:</strong> ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö Low/Base/High ‡πÉ‡∏ô‡∏Å‡∏£‡∏≤‡∏ü‡πÄ‡∏î‡∏µ‡∏¢‡∏ß</li>
              </ul>

              <h4>How to Use</h4>
              <ul>
                <li>‡∏Ñ‡∏•‡∏¥‡∏Å "Show Chart" ‡πÉ‡∏ï‡πâ Key Metrics</li>
                <li>‡∏Å‡∏£‡∏≤‡∏ü‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≤‡∏°‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏ú‡πà‡∏≠‡∏ô (Tenor) ‡πÅ‡∏•‡∏∞ Holding Years ‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</li>
                <li>‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÄ‡∏°‡∏≤‡∏™‡πå‡∏ö‡∏ô‡∏Å‡∏£‡∏≤‡∏ü‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏õ‡∏µ</li>
                <li>‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î Payback Marker ‡πÅ‡∏•‡∏∞ Loan Paid Off ‡πÑ‡∏î‡πâ‡∏ï‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£</li>
              </ul>

              <div class="example-card">
                <strong>Tip:</strong> ‡πÉ‡∏ä‡πâ‡∏Å‡∏£‡∏≤‡∏ü‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏ß‡πà‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏à‡∏∞‡∏Ñ‡∏∑‡∏ô‡∏ó‡∏∏‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏´‡∏£‡πà ‡πÅ‡∏•‡∏∞‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô‡∏à‡∏∞‡πÄ‡∏ï‡∏¥‡∏ö‡πÇ‡∏ï‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏£‡πà‡πÉ‡∏ô‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï
              </div>
            </div>
          </div>

          <!-- Switch Logic -->
          <div class="accordion-section">
            <div class="accordion-header" onclick="toggleAccordion(this)">
              <span>üîß Switch Logic</span>
              <span class="accordion-icon">‚ñ∏</span>
            </div>
            <div class="accordion-content">
              <h4>Switch ‡∏Ñ‡∏∑‡∏≠‡∏≠‡∏∞‡πÑ‡∏£?</h4>
              <p>‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î ‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏£‡∏ß‡∏°‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢/‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡∏π‡πâ ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà</p>

              <div class="glossary-item">
                <strong>Investment Switch</strong><br>
                ‚Ä¢ ‡πÄ‡∏õ‡∏¥‡∏î (ON): ‡∏£‡∏ß‡∏° Acquisition Cost 3%, Fit-out, Other Costs<br>
                ‚Ä¢ ‡∏õ‡∏¥‡∏î (OFF): ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≤‡∏Å Purchase Price ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
              </div>

              <div class="glossary-item">
                <strong>Revenue Switch</strong><br>
                ‚Ä¢ ‡πÄ‡∏õ‡∏¥‡∏î (ON): ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡∏à‡∏£‡∏¥‡∏á - Occupancy 90%, Opex 15%, Agent 1 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏õ‡∏µ<br>
                ‚Ä¢ ‡∏õ‡∏¥‡∏î (OFF): ‡πÉ‡∏ä‡πâ neutral baseline - Occupancy 100%, Opex 0%, Agent 0 (Gross Yield ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î)
              </div>

              <div class="glossary-item">
                <strong>Financing Switch</strong><br>
                ‚Ä¢ ‡πÄ‡∏õ‡∏¥‡∏î (ON): ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡∏à‡∏£‡∏¥‡∏á - Interest 4.5%, Tenor 30 ‡∏õ‡∏µ<br>
                ‚Ä¢ ‡∏õ‡∏¥‡∏î (OFF): ‡πÉ‡∏ä‡πâ neutral baseline - APR 4.5%, 30 ‡∏õ‡∏µ (‡πÅ‡∏ï‡πà‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏™‡πà Salary ‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì PMT/DTI)
              </div>

              <div class="glossary-item">
                <strong>Exit Switch</strong><br>
                ‚Ä¢ ‡πÄ‡∏õ‡∏¥‡∏î (ON): ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤ Tax, Exit Mode ‡∏ï‡∏≤‡∏° Advanced panel<br>
                ‚Ä¢ ‡∏õ‡∏¥‡∏î (OFF): ‡πÉ‡∏ä‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Basic (Holding, Growth, Selling Cost)
              </div>

              <h4>‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏´‡∏£‡πà‡∏Ñ‡∏ß‡∏£‡πÄ‡∏õ‡∏¥‡∏î Switch?</h4>
              <ul>
                <li>‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏π‡∏ú‡∏•‡∏ï‡∏≠‡∏ö‡πÅ‡∏ó‡∏ô‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î (best case) ‚Üí <strong>‡∏õ‡∏¥‡∏î‡∏ó‡∏∏‡∏Å switch</strong></li>
                <li>‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏π‡∏ú‡∏•‡∏à‡∏£‡∏¥‡∏á (realistic) ‚Üí <strong>‡πÄ‡∏õ‡∏¥‡∏î Revenue + Financing</strong></li>
                <li>‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏Ç‡∏≤‡∏¢ ‚Üí <strong>‡πÄ‡∏õ‡∏¥‡∏î Exit</strong></li>
              </ul>
            </div>
          </div>

          <!-- Glossary - Input Fields -->
          <div class="accordion-section">
            <div class="accordion-header" onclick="toggleAccordion(this)">
              <span>üìö Glossary - Input Fields</span>
              <span class="accordion-icon">‚ñ∏</span>
            </div>
            <div class="accordion-content">
              <h4>Investment Layer</h4>
              <div class="glossary-item">
                <span class="glossary-term">Purchase Price:</span> ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≤‡∏¢ = ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô‡∏£‡∏ß‡∏° VAT (‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Yield,
                Payback)
              </div>
              <div class="glossary-item">
                <span class="glossary-term">Avg/sqm:</span> ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏°‡∏ï‡∏£ = Purchase √∑ Area
              </div>
              <div class="glossary-item">
                <span class="glossary-term">Area:</span> ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏™‡∏≠‡∏¢ (‡∏ï‡∏£.‡∏°.) = Purchase √∑ Avg/sqm
              </div>
              <div class="glossary-item">
                <span class="glossary-term">Acquisition Cost:</span> ‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏°‡πÇ‡∏≠‡∏ô+‡∏à‡∏î‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô (% ‡∏Ç‡∏≠‡∏á Purchase, ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ
                2-3%)
              </div>
              <div class="glossary-item">
                <span class="glossary-term">Fit-out:</span> ‡∏Ñ‡πà‡∏≤‡∏ï‡∏Å‡πÅ‡∏ï‡πà‡∏á‡∏´‡πâ‡∏≠‡∏á (‡∏ö‡∏≤‡∏ó, ‡∏£‡∏ß‡∏°‡πÄ‡∏ü‡∏≠‡∏£‡πå‡∏ô‡∏¥‡πÄ‡∏à‡∏≠‡∏£‡πå)
              </div>
              <div class="glossary-item">
                <span class="glossary-term">Other Costs:</span> ‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏∑‡πà‡∏ô‡πÜ (‡∏ö‡∏≤‡∏ó)
              </div>

              <h4>Revenue Layer</h4>
              <div class="glossary-item">
                <span class="glossary-term">Rent:</span> ‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡∏ö‡∏≤‡∏ó, ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Yield ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)
              </div>
              <div class="glossary-item">
                <span class="glossary-term">Target Gross Yield:</span> ‡∏ú‡∏•‡∏ï‡∏≠‡∏ö‡πÅ‡∏ó‡∏ô‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ = (Rent √ó 12 √∑ Purchase) √ó 100
                (two-way binding ‡∏Å‡∏±‡∏ö Rent)
              </div>
              <div class="glossary-item">
                <span class="glossary-term">Occupancy:</span> ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ (%, ‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û 85-95%, ‡∏ß‡πà‡∏≤‡∏á 1 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏õ‡∏µ =
                92%)
              </div>
              <div class="glossary-item">
                <span class="glossary-term">Opex:</span> ‡∏Ñ‡πà‡∏≤‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏á‡∏≤‡∏ô (% ‡∏Ç‡∏≠‡∏á Rent, ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ 12-18%,
                ‡∏£‡∏ß‡∏°‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á+‡∏ã‡πà‡∏≠‡∏°‡πÅ‡∏ã‡∏°)
              </div>
              <div class="glossary-item">
                <span class="glossary-term">Agent Fee:</span> ‡∏Ñ‡πà‡∏≤‡∏ô‡∏≤‡∏¢‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏≤‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡πà‡∏≤ (‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏õ‡∏µ, ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ 1 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏õ‡∏µ, REPEAT
                ‡∏ó‡∏∏‡∏Å‡∏õ‡∏µ)
              </div>

              <h4>Financing Layer</h4>
              <div class="glossary-item">
                <span class="glossary-term">Salary:</span> ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏£‡∏ß‡∏°‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏±‡∏Å‡∏†‡∏≤‡∏©‡∏µ (‡∏ö‡∏≤‡∏ó/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô, ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì DTI)
              </div>
              <div class="glossary-item">
                <span class="glossary-term">Down Payment:</span> ‡πÄ‡∏á‡∏¥‡∏ô‡∏î‡∏≤‡∏ß‡∏ô‡πå (% ‡∏Ç‡∏≠‡∏á Purchase, ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ 10-30%, ‡∏¢‡∏¥‡πà‡∏á‡∏™‡∏π‡∏á DTI
                ‡∏¢‡∏¥‡πà‡∏á‡∏ï‡πà‡∏≥)
              </div>
              <div class="glossary-item">
                <span class="glossary-term">Interest Rate:</span> ‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏ï‡πà‡∏≠‡∏õ‡∏µ (APR %, ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô 4.0-5.5%)
              </div>
              <div class="glossary-item">
                <span class="glossary-term">Tenor:</span> ‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏ú‡πà‡∏≠‡∏ô (‡∏õ‡∏µ, ‡∏ó‡∏≤‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å 20/25/30, ‡∏¢‡∏≤‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô = ‡∏ú‡πà‡∏≠‡∏ô‡∏ô‡πâ‡∏≠‡∏¢‡∏•‡∏á
                ‡πÅ‡∏ï‡πà‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏£‡∏ß‡∏°‡∏°‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô)
              </div>

              <h4>Exit Layer</h4>
              <div class="glossary-item">
                <span class="glossary-term">Holding Years:</span> ‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏ñ‡∏∑‡∏≠‡∏Ñ‡∏£‡∏≠‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏Ç‡∏≤‡∏¢ (‡∏õ‡∏µ, ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ 5-10)
              </div>
              <div class="glossary-item">
                <span class="glossary-term">Price Growth:</span> ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡πÄ‡∏ï‡∏¥‡∏ö‡πÇ‡∏ï‡∏£‡∏≤‡∏Ñ‡∏≤ (% ‡∏ï‡πà‡∏≠‡∏õ‡∏µ, ‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ 2-4%)
              </div>
              <div class="glossary-item">
                <span class="glossary-term">Selling Cost:</span> ‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏Ç‡∏≤‡∏¢ (% ‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢, ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ 2-4%,
                ‡∏£‡∏ß‡∏°‡∏ô‡∏≤‡∏¢‡∏´‡∏ô‡πâ‡∏≤+‡πÇ‡∏≠‡∏ô)
              </div>
              <div class="glossary-item">
                <span class="glossary-term">Capital Gains Tax:</span> ‡∏†‡∏≤‡∏©‡∏µ‡∏Å‡∏≥‡πÑ‡∏£‡∏Ç‡∏≤‡∏¢ (% ‡∏Ç‡∏≠‡∏á‡∏Å‡∏≥‡πÑ‡∏£, ‡∏Ç‡∏∂‡πâ‡∏ô‡∏Å‡∏±‡∏ö‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏ñ‡∏∑‡∏≠‡∏Ñ‡∏£‡∏≠‡∏á >5
                ‡∏õ‡∏µ ‡∏≠‡∏≤‡∏à‡∏•‡∏î‡∏´‡∏¢‡πà‡∏≠‡∏ô)
              </div>
            </div>
          </div>

          <!-- Glossary - Output Metrics -->
          <div class="accordion-section">
            <div class="accordion-header" onclick="toggleAccordion(this)">
              <span>üìä Glossary - Output Metrics</span>
              <span class="accordion-icon">‚ñ∏</span>
            </div>
            <div class="accordion-content">
              <h4>Basic Metrics</h4>
              <div class="glossary-item">
                <span class="glossary-term">Initial Investment (Equity):</span> ‡πÄ‡∏á‡∏¥‡∏ô‡∏•‡∏á‡∏ó‡∏∏‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô = Down Payment +
                Acquisition Cost + Fit-out + Other Costs
                (‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏™‡πà‡∏à‡∏≤‡∏Å‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡∏à‡∏£‡∏¥‡∏á)
              </div>
              <div class="glossary-item">
                <span class="glossary-term">Gross Yield:</span> ‡∏ú‡∏•‡∏ï‡∏≠‡∏ö‡πÅ‡∏ó‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πâ‡∏ô = (Rent √ó 12 √∑ Purchase) √ó 100
                (‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏±‡∏Å‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢, ‚â•6% = ‡∏î‡∏µ)
              </div>
              <div class="glossary-item">
                <span class="glossary-term">Net Yield:</span> ‡∏ú‡∏•‡∏ï‡∏≠‡∏ö‡πÅ‡∏ó‡∏ô‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ (unlevered) = (NOI √ó 12 √∑ Purchase) √ó 100
                (‡∏´‡∏•‡∏±‡∏á‡∏´‡∏±‡∏Å‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢ ‡πÑ‡∏°‡πà‡∏£‡∏ß‡∏°‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢, ‚â•6% = ‡∏î‡∏µ)
              </div>
              <div class="glossary-item">
                <span class="glossary-term">NOI:</span> Net Operating Income = Rent √ó Occ% - Agent - Opex
                (‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏™‡∏∏‡∏ó‡∏ò‡∏¥‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏±‡∏Å‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢)
              </div>
              <div class="glossary-item">
                <span class="glossary-term">CoC Return:</span> Cash-on-Cash = (Net Cashflow √ó 12 √∑ Equity) √ó 100
                (‡∏ú‡∏•‡∏ï‡∏≠‡∏ö‡πÅ‡∏ó‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î ‡∏£‡∏ß‡∏° leverage, >10% = ‡∏î‡∏µ)
              </div>
              <div class="glossary-item">
                <span class="glossary-term">DTI:</span> Debt-to-Income = (PMT √∑ Salary) √ó 100 (‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏´‡∏ô‡∏µ‡πâ‡∏ï‡πà‡∏≠‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ, ‚â§30%
                = ‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢, >40% = ‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á)
              </div>
              <div class="glossary-item">
                <span class="glossary-term">Payback:</span> ‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏Ñ‡∏∑‡∏ô‡∏ó‡∏∏‡∏ô = Cost Basis √∑ (NOI √ó 12) (‡∏õ‡∏µ, <12=‡πÄ‡∏£‡πá‡∏ß,>18 =
                  ‡∏ä‡πâ‡∏≤)
              </div>
              <div class="glossary-item">
                <span class="glossary-term">PMT:</span> Monthly Payment = Annuity formula (‡∏Ñ‡πà‡∏≤‡∏ú‡πà‡∏≠‡∏ô‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
                ‡∏£‡∏ß‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô+‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢)
              </div>
              <div class="glossary-item">
                <span class="glossary-term">Net Cashflow:</span> ‡∏Å‡∏£‡∏∞‡πÅ‡∏™‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ = NOI - PMT (‡∏ö‡∏≤‡∏ó/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô, ‡∏ö‡∏ß‡∏Å =
                ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏Å‡πá‡∏ö, ‡∏•‡∏ö = ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ï‡∏¥‡∏°)
              </div>

              <h4>Exit Metrics (‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î Exit)</h4>
              <div class="glossary-item">
                <span class="glossary-term">IRR:</span> Internal Rate of Return (% ‡∏ï‡πà‡∏≠‡∏õ‡∏µ, ‡∏ú‡∏•‡∏ï‡∏≠‡∏ö‡πÅ‡∏ó‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏£‡∏ß‡∏°
                cashflow+‡∏Ç‡∏≤‡∏¢, >10% = ‡∏î‡∏µ)
              </div>
              <div class="glossary-item">
                <span class="glossary-term">Equity Multiple:</span> ‡∏ï‡∏±‡∏ß‡∏Ñ‡∏π‡∏ì‡∏ú‡∏•‡∏ï‡∏≠‡∏ö‡πÅ‡∏ó‡∏ô = (Total Cashflow + Net Proceeds) √∑
                Equity (‡πÄ‡∏ó‡πà‡∏≤, 2.0√ó = ‡∏Å‡∏≥‡πÑ‡∏£ 100%, >2√ó = ‡∏î‡∏µ)
              </div>
              <div class="glossary-item">
                <span class="glossary-term">Terminal Value:</span> ‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î = Purchase √ó (1 + Growth%)^Years
                (‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏Å‡∏≤‡∏£)
              </div>
              <div class="glossary-item">
                <span class="glossary-term">Net Proceeds:</span> ‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏±‡∏ö‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ = Terminal - Selling Cost - CGT
                (‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏à‡∏£‡∏¥‡∏á‡∏´‡∏•‡∏±‡∏á‡∏´‡∏±‡∏Å‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢+‡∏†‡∏≤‡∏©‡∏µ)
              </div>
              <div class="glossary-item">
                <span class="glossary-term">Capital Gain:</span> ‡∏Å‡∏≥‡πÑ‡∏£‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢ = Net Proceeds - Initial Equity
                (‡∏Å‡∏≥‡πÑ‡∏£‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡πÑ‡∏°‡πà‡∏£‡∏ß‡∏°‡∏Å‡∏£‡∏∞‡πÅ‡∏™‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ñ‡∏∑‡∏≠‡∏Ñ‡∏£‡∏≠‡∏á)
              </div>
              <div class="glossary-item">
                <span class="glossary-term">Capital Gain (incl. cashflow):</span> ‡∏Å‡∏≥‡πÑ‡∏£‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î = Net Proceeds +
                Cumulative Cashflow - Initial Equity
                (‡∏Å‡∏≥‡πÑ‡∏£‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢ + ‡∏Å‡∏£‡∏∞‡πÅ‡∏™‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î‡∏™‡∏∞‡∏™‡∏°‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ñ‡∏∑‡∏≠‡∏Ñ‡∏£‡∏≠‡∏á - ‡πÄ‡∏á‡∏¥‡∏ô‡∏•‡∏á‡∏ó‡∏∏‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô, ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ï‡∏≠‡∏ö‡πÅ‡∏ó‡∏ô‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∏‡∏ô)
              </div>
            </div>
          </div>

          <!-- Key Metrics Explained (NEW v6.1) -->
          <div class="accordion-section">
            <div class="accordion-header" onclick="toggleAccordion(this)">
              <span>üí° Key Metrics Explained</span>
              <span class="accordion-icon">‚ñ∏</span>
            </div>
            <div class="accordion-content">

              <!-- CoC Section -->
              <h4>CoC (Cash-on-Cash Return)</h4>

              <div class="glossary-item">
                <strong>‡∏´‡∏•‡∏±‡∏Å‡∏Ñ‡∏¥‡∏î: ‡∏ß‡∏±‡∏î‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û‡πÄ‡∏á‡∏¥‡∏ô‡∏•‡∏á‡∏ó‡∏∏‡∏ô‡∏à‡∏£‡∏¥‡∏á</strong><br>
                CoC = ‡∏ú‡∏•‡∏ï‡∏≠‡∏ö‡πÅ‡∏ó‡∏ô‡∏ï‡πà‡∏≠‡∏õ‡∏µ √∑ ‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏™‡πà‡∏à‡∏≤‡∏Å‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡∏à‡∏£‡∏¥‡∏á<br>
                <em>‡∏ï‡πà‡∏≤‡∏á‡∏à‡∏≤‡∏Å Net Yield ‡∏ó‡∏µ‡πà‡∏î‡∏π‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ã‡∏∑‡πâ‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‚Üí CoC ‡∏î‡∏π‡πÅ‡∏Ñ‡πà‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡πÉ‡∏™‡πà‡∏à‡∏£‡∏¥‡∏á</em>
              </div>

              <h4>üî¢ ‡∏™‡∏π‡∏ï‡∏£</h4>
              <div class="example-card">
                <strong>CoC (%) = (‡∏Å‡∏£‡∏∞‡πÅ‡∏™‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î‡∏ï‡πà‡∏≠‡∏õ‡∏µ √∑ ‡πÄ‡∏á‡∏¥‡∏ô‡∏•‡∏á‡∏ó‡∏∏‡∏ô‡∏à‡∏£‡∏¥‡∏á) √ó 100</strong><br><br>
                ‡πÇ‡∏î‡∏¢‡∏ó‡∏µ‡πà:<br>
                ‚Ä¢ ‡∏Å‡∏£‡∏∞‡πÅ‡∏™‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î‡∏ï‡πà‡∏≠‡∏õ‡∏µ = (NOI - ‡∏Ñ‡πà‡∏≤‡∏ú‡πà‡∏≠‡∏ô‡∏ö‡πâ‡∏≤‡∏ô) √ó 12 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô<br>
                ‚Ä¢ ‡πÄ‡∏á‡∏¥‡∏ô‡∏•‡∏á‡∏ó‡∏∏‡∏ô‡∏à‡∏£‡∏¥‡∏á = Down + ‡∏Ñ‡πà‡∏≤‡πÇ‡∏≠‡∏ô + ‡∏Ñ‡πà‡∏≤‡∏ï‡∏Å‡πÅ‡∏ï‡πà‡∏á + ‡∏≠‡∏∑‡πà‡∏ô‡πÜ
              </div>

              <h4>üìä 3 ‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö</h4>

              <div class="example-card">
                <strong>‡∏Å‡∏£‡∏ì‡∏µ 1: ‡πÑ‡∏°‡πà‡∏Å‡∏π‡πâ (‡∏à‡πà‡∏≤‡∏¢‡∏™‡∏î 100%)</strong><br>
                ‚Ä¢ Purchase: 4,000,000 ‡∏ö‡∏≤‡∏ó<br>
                ‚Ä¢ ‡πÄ‡∏á‡∏¥‡∏ô‡∏•‡∏á‡∏ó‡∏∏‡∏ô: 4,000,000 ‡∏ö‡∏≤‡∏ó (‡∏à‡πà‡∏≤‡∏¢‡∏™‡∏î)<br>
                ‚Ä¢ NOI: 16,400/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô<br>
                ‚Ä¢ ‡∏Ñ‡πà‡∏≤‡∏ú‡πà‡∏≠‡∏ô: 0 ‡∏ö‡∏≤‡∏ó<br>
                ‚Ä¢ Cashflow: +16,400/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô<br>
                ‚Ä¢ <strong>CoC = 4.9%</strong><br><br>
                üí° <em>CoC ‚âà Net Yield (‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÑ‡∏°‡πà‡∏°‡∏µ leverage)</em>
              </div>

              <div class="example-card">
                <strong>‡∏Å‡∏£‡∏ì‡∏µ 2: ‡∏Å‡∏π‡πâ 90% (Down 10%)</strong><br>
                ‚Ä¢ Purchase: 4,000,000 ‡∏ö‡∏≤‡∏ó<br>
                ‚Ä¢ ‡πÄ‡∏á‡∏¥‡∏ô‡∏•‡∏á‡∏ó‡∏∏‡∏ô: 420,000 ‡∏ö‡∏≤‡∏ó (Down + ‡∏Ñ‡πà‡∏≤‡πÇ‡∏≠‡∏ô)<br>
                ‚Ä¢ NOI: 16,400/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô<br>
                ‚Ä¢ ‡∏Ñ‡πà‡∏≤‡∏ú‡πà‡∏≠‡∏ô: 18,241/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô<br>
                ‚Ä¢ Cashflow: -1,841/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô<br>
                ‚Ä¢ <strong>CoC = -5.3%</strong><br><br>
                üí° <em>‡∏ï‡∏¥‡∏î‡∏•‡∏ö = ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô 1,841 ‡∏ö‡∏≤‡∏ó/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô<br>
                  ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÅ‡∏õ‡∏•‡∏ß‡πà‡∏≤‡πÅ‡∏¢‡πà!</em><br>
                ‚úÖ ‡πÑ‡∏î‡πâ asset ‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤ 4 ‡∏•‡πâ‡∏≤‡∏ô<br>
                ‚úÖ ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏≠‡∏≠‡∏° (‡∏ú‡πà‡∏≠‡∏ô‡∏ö‡πâ‡∏≤‡∏ô = ‡πÄ‡∏û‡∏¥‡πà‡∏° equity)<br>
                ‚úÖ ‡∏£‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏∂‡πâ‡∏ô (capital gain)<br>
                ‚úÖ ‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î‡∏†‡∏≤‡∏©‡∏µ (‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏•‡∏î‡∏´‡∏¢‡πà‡∏≠‡∏ô‡πÑ‡∏î‡πâ)
              </div>

              <div class="example-card">
                <strong>‡∏Å‡∏£‡∏ì‡∏µ 3: ‡∏Å‡∏π‡πâ 70% + ‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤‡∏™‡∏π‡∏á (Down 30%)</strong><br>
                ‚Ä¢ Purchase: 4,000,000 ‡∏ö‡∏≤‡∏ó<br>
                ‚Ä¢ ‡πÄ‡∏á‡∏¥‡∏ô‡∏•‡∏á‡∏ó‡∏∏‡∏ô: 1,220,000 ‡∏ö‡∏≤‡∏ó<br>
                ‚Ä¢ NOI: 20,000/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤‡∏™‡∏π‡∏á‡∏Ç‡∏∂‡πâ‡∏ô)<br>
                ‚Ä¢ ‡∏Ñ‡πà‡∏≤‡∏ú‡πà‡∏≠‡∏ô: 12,769/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô<br>
                ‚Ä¢ Cashflow: +7,231/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô<br>
                ‚Ä¢ <strong>CoC = 7.1%</strong><br><br>
                üí° <em>CoC ‡∏ö‡∏ß‡∏Å = ‡∏°‡∏µ passive income ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏•‡∏∞ 7,231 ‡∏ö‡∏≤‡∏ó</em>
              </div>

              <h4>üéØ ‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£?</h4>

              <div class="glossary-item">
                <strong>‚úÖ CoC ‡∏ö‡∏ß‡∏Å (+)</strong><br>
                ‚Ä¢ ‡∏°‡∏µ passive income ‡∏à‡∏£‡∏¥‡∏á<br>
                ‚Ä¢ ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏Å‡∏±‡∏ö: ‡∏ô‡∏±‡∏Å‡∏•‡∏á‡∏ó‡∏∏‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡πÅ‡∏™‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î
              </div>

              <div class="glossary-item">
                <strong>‚ö†Ô∏è CoC ‡∏ï‡∏¥‡∏î‡∏•‡∏ö (-) ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÅ‡∏¢‡πà‡πÄ‡∏™‡∏°‡∏≠‡πÑ‡∏õ</strong><br>
                ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢:<br>
                ‚Ä¢ ‡∏™‡∏£‡πâ‡∏≤‡∏á asset (‡πÑ‡∏î‡πâ‡∏ö‡πâ‡∏≤‡∏ô/‡∏Ñ‡∏≠‡∏ô‡πÇ‡∏î)<br>
                ‚Ä¢ ‡∏£‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏∂‡πâ‡∏ô (‡πÄ‡∏Å‡πá‡∏á‡∏Å‡∏≥‡πÑ‡∏£‡∏£‡∏∞‡∏¢‡∏∞‡∏¢‡∏≤‡∏ß)<br>
                ‚Ä¢ ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏≠‡∏≠‡∏° (‡∏ú‡πà‡∏≠‡∏ô‡∏ö‡πâ‡∏≤‡∏ô = ‡πÄ‡∏û‡∏¥‡πà‡∏° equity)<br>
                ‚Ä¢ ‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î‡∏†‡∏≤‡∏©‡∏µ (‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏•‡∏î‡∏´‡∏¢‡πà‡∏≠‡∏ô‡πÑ‡∏î‡πâ)
              </div>

              <h4>üí° ‡∏ó‡∏≥‡πÑ‡∏° CoC ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç?</h4>

              <ul>
                <li><strong>‡∏ß‡∏±‡∏î leverage effect:</strong> ‡∏ñ‡πâ‡∏≤‡∏Å‡∏π‡πâ‡πÄ‡∏¢‡∏≠‡∏∞ ‚Üí CoC ‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤ Net Yield</li>
                <li><strong>‡∏ß‡∏±‡∏î‡∏™‡∏†‡∏≤‡∏û‡∏Ñ‡∏•‡πà‡∏≠‡∏á‡∏à‡∏£‡∏¥‡∏á:</strong> ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏î‡πâ‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏•‡∏∞‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏£</li>
                <li><strong>‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∏‡∏ô‡∏≠‡∏∑‡πà‡∏ô:</strong> CoC 7% vs ‡∏´‡∏∏‡πâ‡∏ô 8-10% vs ‡∏û‡∏±‡∏ô‡∏ò‡∏ö‡∏±‡∏ï‡∏£ 3-5%</li>
              </ul>

              <h4>üîÑ ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡∏Å‡∏±‡∏ö Net Yield</h4>

              <table class="threshold-table">
                <tr>
                  <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå</th>
                  <th>‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå</th>
                </tr>
                <tr>
                  <td>‡πÑ‡∏°‡πà‡∏Å‡∏π‡πâ (‡∏à‡πà‡∏≤‡∏¢‡∏™‡∏î)</td>
                  <td>CoC ‚âà Net Yield</td>
                </tr>
                <tr>
                  <td>‡∏Å‡∏π‡πâ‡πÄ‡∏¢‡∏≠‡∏∞ (Down ‡∏ô‡πâ‡∏≠‡∏¢)</td>
                  <td>CoC > Net Yield (leverage effect)</td>
                </tr>
                <tr>
                  <td>‡∏Å‡∏π‡πâ‡∏ô‡πâ‡∏≠‡∏¢ (Down ‡πÄ‡∏¢‡∏≠‡∏∞)</td>
                  <td>CoC ‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á Net Yield</td>
                </tr>
              </table>

            </div>
          </div>

          <!-- Examples -->
          <div class="accordion-section">
            <div class="accordion-header" onclick="toggleAccordion(this)">
              <span>üí° Examples (Real Scenarios)</span>
              <span class="accordion-icon">‚ñ∏</span>
            </div>
            <div class="accordion-content">
              <div class="example-card">
                <strong>Example 1: ‡∏Ñ‡∏≠‡∏ô‡πÇ‡∏î‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û (‡πÉ‡∏Å‡∏•‡πâ BTS)</strong><br><br>
                <strong>Input:</strong><br>
                Purchase 4,000,000 | Area 35 sqm | Rent 20,000/mo | Salary 70,000 | Down 10% | Switches: Revenue ON,
                Financing ON<br><br>
                <strong>Output:</strong><br>
                ‚Ä¢ Gross Yield: 6.0%<br>
                ‚Ä¢ Net Yield: 4.9% ‚ö†Ô∏è<br>
                ‚Ä¢ Net Cashflow: -1,824 ‡∏ö‡∏≤‡∏ó/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ï‡∏¥‡∏°)<br>
                ‚Ä¢ DTI: 26.1% ‚úÖ<br>
                ‚Ä¢ Payback: 24.8 ‡∏õ‡∏µ<br>
                ‚Ä¢ CoC: -5.2%<br><br>
                <strong>Verdict:</strong><br>
                ‚ö†Ô∏è ‡∏û‡∏≠‡πÉ‡∏ä‡πâ - Net Yield ‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô (‡∏Ñ‡∏ß‡∏£ ‚â•6%)<br>
                ‚ö†Ô∏è Cashflow ‡∏ï‡∏¥‡∏î‡∏•‡∏ö ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏•‡∏∞ 1,824 ‡∏ö‡∏≤‡∏ó<br>
                ‚úÖ DTI ‡∏î‡∏µ ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢<br>
                ‚ùå Payback ‡∏ô‡∏≤‡∏ô ‡πÄ‡∏Å‡∏∑‡∏≠‡∏ö 25 ‡∏õ‡∏µ<br><br>
                <strong>‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥:</strong> ‡πÄ‡∏à‡∏£‡∏à‡∏≤‡∏•‡∏î‡∏£‡∏≤‡∏Ñ‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏≤‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤ (‚â•22,000)
              </div>

              <div class="example-card">
                <strong>Example 2: ‡∏Ñ‡∏≠‡∏ô‡πÇ‡∏î‡πÉ‡∏´‡∏°‡πà (‡πÉ‡∏Å‡∏•‡πâ‡∏£‡∏ñ‡πÑ‡∏ü‡∏ü‡πâ‡∏≤)</strong><br><br>
                <strong>Input:</strong><br>
                Purchase 3,500,000 | Area 32 sqm | Rent 22,000/mo | Salary 80,000 | Down 20% | Switches: Revenue ON,
                Financing ON<br><br>
                <strong>Output:</strong><br>
                ‚Ä¢ Gross Yield: 7.5% ‚úÖ<br>
                ‚Ä¢ Net Yield: 6.2% ‚úÖ<br>
                ‚Ä¢ Net Cashflow: +1,450 ‡∏ö‡∏≤‡∏ó/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏Å‡πá‡∏ö)<br>
                ‚Ä¢ DTI: 21.8% ‚úÖ<br>
                ‚Ä¢ Payback: 18.2 ‡∏õ‡∏µ<br>
                ‚Ä¢ CoC: 5.1%<br><br>
                <strong>Verdict:</strong><br>
                ‚úÖ ‡∏î‡∏µ - Net Yield ‡πÄ‡∏Å‡∏¥‡∏ô 6%<br>
                ‚úÖ Cashflow ‡∏ö‡∏ß‡∏Å ‡∏°‡∏µ passive income<br>
                ‚úÖ DTI ‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢ ‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤ 30%<br>
                ‚ö†Ô∏è Payback ‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á 18 ‡∏õ‡∏µ<br><br>
                <strong>‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥:</strong> ‡πÇ‡∏≠‡πÄ‡∏Ñ ‡∏•‡∏á‡∏ó‡∏∏‡∏ô‡πÑ‡∏î‡πâ ‡∏ú‡∏•‡∏ï‡∏≠‡∏ö‡πÅ‡∏ó‡∏ô‡∏î‡∏µ ‡∏°‡∏µ cashflow ‡∏ö‡∏ß‡∏Å
              </div>

              <div class="example-card">
                <strong>Example 3: ‡∏ó‡∏≤‡∏ß‡∏ô‡πå‡πÄ‡∏Æ‡πâ‡∏≤‡∏™‡πå‡∏ä‡∏≤‡∏ô‡πÄ‡∏°‡∏∑‡∏≠‡∏á</strong><br><br>
                <strong>Input:</strong><br>
                Purchase 2,800,000 | Area 80 sqm | Rent 15,000/mo | Salary 60,000 | Down 15% | Switches: Revenue ON,
                Financing ON<br><br>
                <strong>Output:</strong><br>
                ‚Ä¢ Gross Yield: 6.4% ‚úÖ<br>
                ‚Ä¢ Net Yield: 5.4% ‚ö†Ô∏è<br>
                ‚Ä¢ Net Cashflow: -1,200 ‡∏ö‡∏≤‡∏ó/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô<br>
                ‚Ä¢ DTI: 27.5% ‚úÖ<br>
                ‚Ä¢ Payback: 21.5 ‡∏õ‡∏µ<br>
                ‚Ä¢ CoC: -3.4%<br><br>
                <strong>Verdict:</strong><br>
                ‚ö†Ô∏è ‡∏û‡∏≠‡πÉ‡∏ä‡πâ - Net Yield ‡πÉ‡∏Å‡∏•‡πâ 6% ‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏∂‡∏á<br>
                ‚ö†Ô∏è Cashflow ‡∏ï‡∏¥‡∏î‡∏•‡∏ö‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢<br>
                ‚úÖ DTI ‡∏î‡∏µ ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢<br>
                ‚ùå Payback ‡∏Ñ‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≤‡∏á‡∏ô‡∏≤‡∏ô<br><br>
                <strong>‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥:</strong> ‡∏ï‡πà‡∏≠‡∏£‡∏≠‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤‡πÉ‡∏´‡πâ‡∏™‡∏π‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏õ‡πá‡∏ô 16,500 ‡∏à‡∏∞‡πÑ‡∏î‡πâ Net ‚â•6%
              </div>
            </div>
          </div>

          <!-- Threshold Guide -->
          <div class="accordion-section">
            <div class="accordion-header" onclick="toggleAccordion(this)">
              <span>üìè Threshold Guide</span>
              <span class="accordion-icon">‚ñ∏</span>
            </div>
            <div class="accordion-content">
              <h4>Quick Reference Table</h4>
              <table class="threshold-table">
                <tr>
                  <th>Metric</th>
                  <th>Excellent (‡∏î‡∏µ‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°)</th>
                  <th>Good (‡∏î‡∏µ)</th>
                  <th>Fair (‡∏û‡∏≠‡πÉ‡∏ä‡πâ)</th>
                  <th>Poor (‡∏Ñ‡∏ß‡∏£‡∏ó‡∏ö‡∏ó‡∏ß‡∏ô)</th>
                </tr>
                <tr>
                  <td>Gross Yield</td>
                  <td>‚Äî</td>
                  <td>‚â•6%</td>
                  <td>5-6%</td>
                  <td>&lt;5%</td>
                </tr>
                <tr>
                  <td>Net Yield</td>
                  <td>‚Äî</td>
                  <td>‚â•6%</td>
                  <td>5-6%</td>
                  <td>&lt;5%</td>
                </tr>
                <tr>
                  <td>DTI</td>
                  <td>&lt;20% üü¢</td>
                  <td>20-30%</td>
                  <td>30-40% üü°</td>
                  <td>&gt;40% üî¥</td>
                </tr>
                <tr>
                  <td>Payback</td>
                  <td>&lt;12 ‡∏õ‡∏µ</td>
                  <td>12-18 ‡∏õ‡∏µ</td>
                  <td>&gt;18 ‡∏õ‡∏µ</td>
                </tr>
                <tr>
                  <td>CoC Return</td>
                  <td>&gt;10%</td>
                  <td>5-10%</td>
                  <td>&lt;5%</td>
                </tr>
                <tr>
                  <td>IRR (5-10y)</td>
                  <td>&gt;10%</td>
                  <td>6-10%</td>
                  <td>&lt;6%</td>
                </tr>
                <tr>
                  <td>Equity Multiple</td>
                  <td>&gt;2.0√ó</td>
                  <td>1.5-2.0√ó</td>
                  <td>&lt;1.5√ó</td>
                </tr>
                <tr>
                  <td>Cashflow/mo</td>
                  <td>&gt;0 (‡∏ö‡∏ß‡∏Å)</td>
                  <td>-2K to 0</td>
                  <td>&lt;-2K (‡∏ï‡∏¥‡∏î‡∏•‡∏ö‡∏°‡∏≤‡∏Å)</td>
                </tr>
              </table>

              <h4>Context Notes</h4>
              <div class="glossary-item">
                <strong>Gross/Net Yield:</strong><br>
                ‚Ä¢ ‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏Ø ‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ 4-8%, ‡∏ï‡πà‡∏≤‡∏á‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î 6-12%<br>
                ‚Ä¢ Net Yield ‡∏Ñ‡∏ß‡∏£‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤ Fixed Deposit (1-2%) ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 3-4%
              </div>
              <div class="glossary-item">
                <strong>DTI (Debt-to-Income):</strong><br>
                ‚Ä¢ ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏™‡πà‡∏ß‡∏ô‡πÉ‡∏´‡∏ç‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÑ‡∏î‡πâ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 40-45%<br>
                ‚Ä¢ ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ ‚â§30% ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏°‡∏µ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢
              </div>
              <div class="glossary-item">
                <strong>Payback Period:</strong><br>
                ‚Ä¢ ‡∏¢‡∏¥‡πà‡∏á‡πÄ‡∏£‡πá‡∏ß‡∏¢‡∏¥‡πà‡∏á‡∏î‡∏µ ‡πÅ‡∏ï‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏î‡∏π quality ‡∏Ç‡∏≠‡∏á‡∏ó‡∏≥‡πÄ‡∏•<br>
                ‚Ä¢ &gt;20 ‡∏õ‡∏µ = ‡∏Ñ‡∏ß‡∏£‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤‡∏ß‡πà‡∏≤‡∏Ñ‡∏∏‡πâ‡∏°‡∏Ñ‡πà‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
              </div>
              <div class="glossary-item">
                <strong>CoC Return:</strong><br>
                ‚Ä¢ CoC ‡∏ï‡∏¥‡∏î‡∏•‡∏ö‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÅ‡∏õ‡∏•‡∏ß‡πà‡∏≤‡πÅ‡∏¢‡πà‡πÄ‡∏™‡∏°‡∏≠ - ‡∏≠‡∏≤‡∏à‡πÅ‡∏•‡∏Å‡∏Å‡∏±‡∏ö capital gain<br>
                ‚Ä¢ ‡∏î‡∏π IRR ‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏ñ‡πâ‡∏≤‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏Ç‡∏≤‡∏¢
              </div>
              <div class="glossary-item">
                <strong>IRR vs Stock Market:</strong><br>
                ‚Ä¢ Stock market average ~8-10%<br>
                ‚Ä¢ Bond ~3-5%<br>
                ‚Ä¢ Real estate ‡∏Ñ‡∏ß‡∏£ &gt;6% ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ä‡∏î‡πÄ‡∏ä‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á
              </div>
              <div class="glossary-item">
                <strong>Equity Multiple:</strong><br>
                ‚Ä¢ 2.5√ó = ‡∏•‡∏á‡∏ó‡∏∏‡∏ô 1 ‡∏•‡πâ‡∏≤‡∏ô ‡πÑ‡∏î‡πâ‡∏Å‡∏•‡∏±‡∏ö 2.5 ‡∏•‡πâ‡∏≤‡∏ô (‡∏Å‡∏≥‡πÑ‡∏£ 1.5 ‡∏•‡πâ‡∏≤‡∏ô)
              </div>
              <div class="glossary-item">
                <strong>Net Cashflow Strategy:</strong><br>
                ‚Ä¢ Cashflow ‡∏ï‡∏¥‡∏î‡∏•‡∏ö = ‡πÅ‡∏•‡∏Å‡∏Å‡∏±‡∏ö capital gain + forced savings
              </div>
            </div>
          </div>

          <!-- Asset Comparison (NEW v7.5) -->
          <div class="accordion-section">
            <div class="accordion-header" onclick="toggleAccordion(this)">
              <span>üìä Asset Comparison (v7.5)</span>
              <span class="accordion-icon">‚ñ∏</span>
            </div>
            <div class="accordion-content">
              <h4>üíæ Asset Management</h4>
              <div class="glossary-item">
                <strong>Save Assets:</strong> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏≠‡∏á<br>
                ‚Ä¢ ‡∏Ñ‡∏•‡∏¥‡∏Å "Save Asset" ‡∏´‡∏•‡∏±‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏™‡∏£‡πá‡∏à<br>
                ‚Ä¢ ‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠ ‡∏´‡∏£‡∏∑‡∏≠‡∏õ‡∏•‡πà‡∏≠‡∏¢‡∏ß‡πà‡∏≤‡∏á‡πÉ‡∏´‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (‡πÄ‡∏ä‡πà‡∏ô "Asset 4.0M @ 6.2%")<br>
                ‚Ä¢ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å "Add to comparison immediately" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
              </div>

              <div class="glossary-item">
                <strong>Load Assets:</strong> ‡πÇ‡∏´‡∏•‡∏î‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ<br>
                ‚Ä¢ ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà asset card ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏û‡∏≤‡∏£‡∏≤‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‡πÄ‡∏Ç‡πâ‡∏≤ calculator<br>
                ‚Ä¢ ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å ‡∏à‡∏∞‡∏°‡∏µ modal ‡∏ñ‡∏≤‡∏°‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡∏ó‡∏¥‡πâ‡∏á
              </div>

              <div class="glossary-item">
                <strong>Delete Assets:</strong> ‡∏•‡∏ö‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£<br>
                ‚Ä¢ Hover ‡∏ö‡∏ô card ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏•‡∏¥‡∏Å √ó ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏ö‡∏ó‡∏µ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£<br>
                ‚Ä¢ ‡∏Ñ‡∏•‡∏¥‡∏Å "Clear all assets" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
              </div>

              <h4>üìä Comparison Features</h4>
              <div class="glossary-item">
                <strong>Compare 2-3 Assets:</strong><br>
                ‚Ä¢ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å checkbox "Compare" ‡πÉ‡∏ô asset cards (2-3 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)<br>
                ‚Ä¢ ‡∏Ñ‡∏•‡∏¥‡∏Å "üìä Compare Selected Assets" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö<br>
                ‚Ä¢ ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á comparison table, timeline chart, ‡πÅ‡∏•‡∏∞ AI recommendations
              </div>

              <div class="glossary-item">
                <strong>15 Key Metrics Comparison:</strong><br>
                ‚Ä¢ <strong>Key Metrics (9):</strong> Initial Investment, Gross Yield, Net Yield, CoC Return, Net/Month, DTI, Payback, IRR, Equity Multiple<br>
                ‚Ä¢ <strong>Affordability (3):</strong> Loan Amount, Monthly Payment, Total Interest<br>
                ‚Ä¢ <strong>Exit (3):</strong> Terminal Value, Net Proceeds, Capital Gain<br>
                ‚Ä¢ ‡πÅ‡∏ï‡πà‡∏•‡∏∞ metric ‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á "Best" asset ‡∏î‡πâ‡∏ß‡∏¢‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô üèÜ
              </div>

              <div class="glossary-item">
                <strong>Ranking System:</strong><br>
                ‚Ä¢ ü•á <span style="color: #22c55e;">Best</span> - ‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß (‡∏Ñ‡πà‡∏≤‡∏î‡∏µ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î)<br>
                ‚Ä¢ ü•à <span style="color: #f59e0b;">Mid</span> - ‡∏™‡∏µ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á (‡∏Ñ‡πà‡∏≤‡∏Å‡∏•‡∏≤‡∏á)<br>
                ‚Ä¢ ü•â <span style="color: #ef4444;">Worst</span> - ‡∏™‡∏µ‡πÅ‡∏î‡∏á (‡∏Ñ‡πà‡∏≤‡∏ï‡πà‡∏≥‡∏™‡∏∏‡∏î)
              </div>

              <div class="glossary-item">
                <strong>Scenario Analysis:</strong><br>
                ‚Ä¢ ‡∏™‡∏•‡∏±‡∏ö‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á Low/Base/High scenarios<br>
                ‚Ä¢ <strong>Low (-10%):</strong> ‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤‡∏•‡∏î‡∏•‡∏á 10% (worst case)<br>
                ‚Ä¢ <strong>Base:</strong> ‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á‡πÑ‡∏ß‡πâ (expected case)<br>
                ‚Ä¢ <strong>High (+10%):</strong> ‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô 10% (best case)<br>
                ‚Ä¢ ‡∏ï‡∏≤‡∏£‡∏≤‡∏á, ‡∏Å‡∏£‡∏≤‡∏ü, ‡πÅ‡∏•‡∏∞ recommendations ‡∏à‡∏∞‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏ï‡∏≤‡∏° scenario ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
              </div>

              <h4>üìà Timeline Chart (Multi-Asset)</h4>
              <div class="glossary-item">
                <strong>Interactive Comparison Chart:</strong><br>
                ‚Ä¢ ‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏£‡∏≤‡∏ü 3 ‡πÄ‡∏™‡πâ‡∏ô (1 ‡πÄ‡∏™‡πâ‡∏ô‡∏ï‡πà‡∏≠ asset)<br>
                ‚Ä¢ ‡∏™‡∏µ‡πÄ‡∏™‡πâ‡∏ô‡∏Å‡∏£‡∏≤‡∏ü‡∏ï‡∏≤‡∏° ranking: Best = ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß, Mid = ‡∏™‡πâ‡∏°, Worst = ‡πÅ‡∏î‡∏á<br>
                ‚Ä¢ Crosshair tooltip ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡πà‡∏≤‡∏ó‡∏∏‡∏Å asset ‡∏ó‡∏µ‡πà‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô<br>
                ‚Ä¢ Intersection points (‡∏à‡∏∏‡∏î‡∏Å‡∏•‡∏°‡πÇ‡∏õ‡∏£‡πà‡∏á‡πÉ‡∏™) ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á crosshair
              </div>

              <div class="glossary-item">
                <strong>Chart Modes:</strong><br>
                ‚Ä¢ <strong>Net Worth:</strong> ‡πÅ‡∏™‡∏î‡∏á‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ (equity + cumulative cashflow)<br>
                ‚Ä¢ <strong>Property Value:</strong> ‡πÅ‡∏™‡∏î‡∏á‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô (appreciation over time)<br>
                ‚Ä¢ ‡∏™‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ‡∏î‡πâ‡∏ß‡∏¢ radio buttons ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡∏Å‡∏£‡∏≤‡∏ü
              </div>

              <div class="glossary-item">
                <strong>Labels & Annotations:</strong><br>
                ‚Ä¢ <strong>Exit Point:</strong> ‡πÄ‡∏™‡πâ‡∏ô‡∏õ‡∏£‡∏∞‡∏™‡∏µ‡∏°‡πà‡∏ß‡∏á + label "Exit (Xy)" ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡∏¥‡∏î exit<br>
                ‚Ä¢ <strong>Loan Paid Off:</strong> label "Loan Paid Off (Xy)" ‡∏ó‡∏µ‡πà‡∏õ‡∏µ‡∏ó‡∏µ‡πà‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡∏π‡πâ‡∏´‡∏°‡∏î<br>
                ‚Ä¢ Collision detection ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô labels ‡∏ó‡∏±‡∏ö‡∏Å‡∏±‡∏ô
              </div>

              <h4>ü§ñ AI Recommendations</h4>
              <div class="glossary-item">
                <strong>üèÜ Best Overall:</strong><br>
                ‚Ä¢ ‡∏£‡∏∞‡∏ö‡∏∏ asset ‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ Net Yield ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î<br>
                ‚Ä¢ ‡πÅ‡∏™‡∏î‡∏á Net Yield, Payback Period, CoC Return
              </div>

              <div class="glossary-item">
                <strong>üí∞ Lowest Entry Cost:</strong><br>
                ‚Ä¢ ‡∏£‡∏∞‡∏ö‡∏∏ asset ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡∏•‡∏á‡∏ó‡∏∏‡∏ô‡∏ô‡πâ‡∏≠‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î<br>
                ‚Ä¢ ‡πÅ‡∏™‡∏î‡∏á Equity Required (‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏™‡πà‡∏à‡∏≤‡∏Å‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤)
              </div>

              <div class="glossary-item">
                <strong>‚ö†Ô∏è DTI Risk Warning:</strong><br>
                ‚Ä¢ ‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ñ‡πâ‡∏≤‡∏°‡∏µ asset ‡∏ó‡∏µ‡πà DTI > 30%<br>
                ‚Ä¢ ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ asset ‡πÅ‡∏•‡∏∞‡∏Ñ‡πà‡∏≤ DTI ‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á
              </div>

              <div class="glossary-item">
                <strong>üìà Best Long-term Growth:</strong><br>
                ‚Ä¢ ‡∏£‡∏∞‡∏ö‡∏∏ asset ‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ IRR ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î (‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡∏¥‡∏î exit)<br>
                ‚Ä¢ ‡πÅ‡∏™‡∏î‡∏á IRR ‡πÅ‡∏•‡∏∞ Equity Multiple
              </div>

              <div class="glossary-item">
                <strong>üè¶ Financing Strategy:</strong><br>
                ‚Ä¢ ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Å‡∏•‡∏¢‡∏∏‡∏ó‡∏ò‡πå‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏´‡∏≤‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏∏‡∏ô<br>
                ‚Ä¢ ‡πÅ‡∏™‡∏î‡∏á‡∏à‡∏≥‡∏ô‡∏ß‡∏ô asset ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏™‡∏¥‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠ vs ‡∏à‡πà‡∏≤‡∏¢‡∏™‡∏î
              </div>

              <h4>üí° Pro Tips</h4>
              <ul>
                <li><strong>Save Variations:</strong> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏´‡∏•‡∏≤‡∏¢‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡∏Ç‡∏≠‡∏á‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏û‡∏≤‡∏£‡∏≤‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏ï‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ô (‡πÄ‡∏ä‡πà‡∏ô Down 10% vs 30%)</li>
                <li><strong>Cash vs Financing:</strong> ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢‡∏™‡∏î‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏Å‡∏π‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö asset ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô</li>
                <li><strong>Exit Strategies:</strong> ‡∏ó‡∏î‡∏™‡∏≠‡∏ö holding period ‡∏ï‡πà‡∏≤‡∏á‡πÜ (5, 10, 15+ ‡∏õ‡∏µ)</li>
                <li><strong>Scenario Analysis:</strong> ‡πÉ‡∏ä‡πâ Low/Base/High ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏à‡∏≤‡∏Å‡∏ï‡∏•‡∏≤‡∏î</li>
                <li><strong>DTI Warnings:</strong> ‡πÉ‡∏™‡πà‡πÉ‡∏à‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô DTI ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏õ‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏™‡∏¥‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠</li>
                <li><strong>Balanced View:</strong> ‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤‡∏ó‡∏±‡πâ‡∏á cash flow ‡πÅ‡∏•‡∏∞ capital appreciation</li>
              </ul>

              <div class="example-card">
                <strong>Example Workflow:</strong><br>
                1. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Condo A (4M, Down 10%)<br>
                2. Save as "Condo A - Low Down"<br>
                3. ‡πÅ‡∏Å‡πâ Down ‡πÄ‡∏õ‡πá‡∏ô 30%<br>
                4. Save as "Condo A - High Down"<br>
                5. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Condo B (3.5M, Down 20%)<br>
                6. Save as "Condo B"<br>
                7. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á 3 assets ‚Üí Compare<br>
                8. ‡∏î‡∏π table, chart, recommendations<br>
                9. ‡∏™‡∏•‡∏±‡∏ö scenarios ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á<br>
                10. ‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à‡∏ß‡πà‡∏≤ asset ‡πÑ‡∏´‡∏ô‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î
              </div>
            </div>
          </div>

          <!-- Common Mistakes -->
          <div class="accordion-section">
            <div class="accordion-header" onclick="toggleAccordion(this)">
              <span>‚ö†Ô∏è Common Mistakes</span>
              <span class="accordion-icon">‚ñ∏</span>
            </div>
            <div class="accordion-content">
              <div class="glossary-item">
                <strong>1. ‡∏•‡∏∑‡∏°‡∏£‡∏ß‡∏°‡∏Ñ‡πà‡∏≤ Acquisition Cost</strong><br>
                ‚ùå ‡∏ú‡∏¥‡∏î: ‡∏Ñ‡∏¥‡∏î‡πÅ‡∏Ñ‡πà‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ã‡∏∑‡πâ‡∏≠ 4,000,000<br>
                ‚úÖ ‡∏ñ‡∏π‡∏Å: ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ã‡∏∑‡πâ‡∏≠ 4,000,000 + ‡πÇ‡∏≠‡∏ô 3% (120,000) = 4,120,000<br>
                <em>‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö:</em> Payback ‡∏ô‡∏≤‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô, CoC ‡∏ï‡πà‡∏≥‡∏•‡∏á<br>
                <em>‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏Å‡πâ:</em> ‡πÄ‡∏õ‡∏¥‡∏î Investment Switch ON
              </div>
              <div class="glossary-item">
                <strong>2. ‡∏ï‡∏±‡πâ‡∏á Occupancy 100% (‡πÑ‡∏°‡πà‡∏™‡∏°‡∏à‡∏£‡∏¥‡∏á)</strong><br>
                ‚ùå ‡∏ú‡∏¥‡∏î: ‡∏Ñ‡∏¥‡∏î‡∏ß‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤‡πÄ‡∏ï‡πá‡∏° 12 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏∏‡∏Å‡∏õ‡∏µ<br>
                ‚úÖ ‡∏ñ‡∏π‡∏Å: ‡πÉ‡∏ä‡πâ 85-95% (‡∏°‡∏µ‡∏ä‡πà‡∏ß‡∏á‡∏ß‡πà‡∏≤‡∏á‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡πà‡∏≤)<br>
                <em>‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö:</em> Net Yield ‡∏™‡∏π‡∏á‡πÄ‡∏Å‡∏¥‡∏ô‡∏à‡∏£‡∏¥‡∏á, ‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î<br>
                <em>‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏Å‡πâ:</em> ‡πÉ‡∏ä‡πâ 90% (‡∏ß‡πà‡∏≤‡∏á ~1 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏õ‡∏µ)
              </div>
              <div class="glossary-item">
                <strong>3. ‡∏•‡∏∑‡∏°‡∏Ñ‡∏¥‡∏î‡∏Ñ‡πà‡∏≤ Agent Fee</strong><br>
                ‚ùå ‡∏ú‡∏¥‡∏î: ‡∏Ñ‡∏¥‡∏î‡∏ß‡πà‡∏≤‡∏´‡∏≤‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡πà‡∏≤‡πÑ‡∏î‡πâ‡πÄ‡∏≠‡∏á ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢<br>
                ‚úÖ ‡∏ñ‡∏π‡∏Å: ‡πÉ‡∏ä‡πâ‡∏ô‡∏≤‡∏¢‡∏´‡∏ô‡πâ‡∏≤ ~1 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤/‡∏õ‡∏µ<br>
                <em>‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö:</em> NOI ‡∏™‡∏π‡∏á‡πÄ‡∏Å‡∏¥‡∏ô‡∏à‡∏£‡∏¥‡∏á ~8%<br>
                <em>‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏Å‡πâ:</em> ‡∏ï‡∏±‡πâ‡∏á Agent Fee = 1 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏õ‡∏µ
              </div>
              <div class="glossary-item">
                <strong>4. DTI ‡πÄ‡∏Å‡∏¥‡∏ô 40% (‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏¢‡∏≤‡∏Å)</strong><br>
                ‚ùå ‡∏ú‡∏¥‡∏î: ‡∏Å‡∏π‡πâ‡πÄ‡∏ï‡πá‡∏°‡∏ó‡∏µ‡πà Down 10% ‡πÅ‡∏ï‡πà‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÑ‡∏°‡πà‡∏û‡∏≠<br>
                ‚úÖ ‡∏ñ‡∏π‡∏Å: ‡πÄ‡∏ä‡πá‡∏Ñ DTI ‡∏Å‡πà‡∏≠‡∏ô‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à ‡∏Ñ‡∏ß‡∏£ ‚â§30%<br>
                <em>‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö:</em> ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏™‡∏¥‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠<br>
                <em>‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏Å‡πâ:</em> ‡πÄ‡∏û‡∏¥‡πà‡∏° Down payment ‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡πà‡∏≠‡∏£‡∏≠‡∏á‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ã‡∏∑‡πâ‡∏≠
              </div>
              <div class="glossary-item">
                <strong>5. ‡πÑ‡∏°‡πà‡∏Ñ‡∏¥‡∏î Two-way Binding</strong><br>
                ‚ùå ‡∏ú‡∏¥‡∏î: ‡∏Å‡∏£‡∏≠‡∏Å Purchase, Avg/sqm, Area ‡πÅ‡∏¢‡∏Å‡∏Å‡∏±‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô<br>
                ‚úÖ ‡∏ñ‡∏π‡∏Å: Purchase ‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏±‡∏Å ‚Üí ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Avg/sqm ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥<br>
                <em>‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö:</em> ‡∏™‡∏±‡∏ö‡∏™‡∏ô ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏Ç‡∏±‡∏î‡πÅ‡∏¢‡πâ‡∏á‡∏Å‡∏±‡∏ô<br>
                <em>‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏Å‡πâ:</em> ‡∏õ‡∏•‡πà‡∏≠‡∏¢‡πÉ‡∏´‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì 1 ‡πÉ‡∏ô 3 ‡∏ä‡πà‡∏≠‡∏á
              </div>
              <div class="glossary-item">
                <strong>6. ‡πÉ‡∏ä‡πâ Gross Yield ‡πÅ‡∏ó‡∏ô Net Yield ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à</strong><br>
                ‚ùå ‡∏ú‡∏¥‡∏î: Gross 6% ‡∏î‡∏π‡∏î‡∏µ ‡πÄ‡∏•‡∏¢‡∏•‡∏á‡∏ó‡∏∏‡∏ô<br>
                ‚úÖ ‡∏ñ‡∏π‡∏Å: ‡∏ï‡πâ‡∏≠‡∏á‡∏î‡∏π Net Yield (‡∏´‡∏•‡∏±‡∏á‡∏´‡∏±‡∏Å‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢)<br>
                <em>‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö:</em> ‡∏ú‡∏•‡∏ï‡∏≠‡∏ö‡πÅ‡∏ó‡∏ô‡∏à‡∏£‡∏¥‡∏á‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏Ñ‡∏¥‡∏î<br>
                <em>‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏Å‡πâ:</em> ‡πÄ‡∏õ‡∏¥‡∏î Revenue Switch ON ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π Net Yield
              </div>
              <div class="glossary-item">
                <strong>7. ‡∏Ñ‡∏¥‡∏î‡∏ß‡πà‡∏≤ CoC ‡∏ï‡∏¥‡∏î‡∏•‡∏ö = ‡πÅ‡∏¢‡πà‡πÄ‡∏™‡∏°‡∏≠</strong><br>
                ‚ùå ‡∏ú‡∏¥‡∏î: CoC -5% ‡πÄ‡∏•‡∏¢‡πÑ‡∏°‡πà‡∏•‡∏á‡∏ó‡∏∏‡∏ô<br>
                ‚úÖ ‡∏ñ‡∏π‡∏Å: CoC ‡∏ï‡∏¥‡∏î‡∏•‡∏ö‡∏≠‡∏≤‡∏à‡πÄ‡∏õ‡πá‡∏ô forced savings + ‡∏£‡∏≠ capital gain<br>
                <em>Context:</em> ‡∏ñ‡πâ‡∏≤ IRR ‡∏î‡∏µ (&gt;10%) ‡πÅ‡∏°‡πâ CoC ‡∏ï‡∏¥‡∏î‡∏•‡∏ö‡∏Å‡πá‡∏¢‡∏±‡∏á‡∏Ñ‡∏∏‡πâ‡∏°<br>
                <em>‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏Å‡πâ:</em> ‡∏î‡∏π IRR ‡πÅ‡∏•‡∏∞ Equity Multiple ‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö
              </div>
            </div>
          </div>

          <!-- FAQ -->
          <div class="accordion-section">
            <div class="accordion-header" onclick="toggleAccordion(this)">
              <span>‚ùì FAQ</span>
              <span class="accordion-icon">‚ñ∏</span>
            </div>
            <div class="accordion-content">
              <div class="faq-item">
                <strong>Q1: ‡∏ó‡∏≥‡πÑ‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å Purchase ‡∏Å‡πà‡∏≠‡∏ô?</strong><br>
                A: Purchase ‡πÄ‡∏õ‡πá‡∏ô "‡∏´‡∏±‡∏ß‡πÉ‡∏à" ‡∏Ç‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Yield ‡πÅ‡∏•‡∏∞ Payback - ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ Purchase ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Yield ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ (‡πÅ‡∏ï‡πà‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
                Avg/sqm + Area ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Purchase ‡πÉ‡∏´‡πâ)
              </div>
              <div class="faq-item">
                <strong>Q2: ‡∏ó‡∏≥‡πÑ‡∏° DTI ‡πÅ‡∏™‡∏î‡∏á "‚Äî"?</strong><br>
                A: ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å Salary ‡∏Å‡πà‡∏≠‡∏ô - DTI = PMT √∑ Salary, ‡πÑ‡∏°‡πà‡∏°‡∏µ Salary ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ
              </div>
              <div class="faq-item">
                <strong>Q3: Switch ‡∏Ñ‡∏∑‡∏≠‡∏≠‡∏∞‡πÑ‡∏£? ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏´‡∏£‡πà‡∏Ñ‡∏ß‡∏£‡πÄ‡∏õ‡∏¥‡∏î?</strong><br>
                A: Switch = ‡∏õ‡∏∏‡πà‡∏°‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏ß‡πà‡∏≤‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡∏à‡∏£‡∏¥‡∏á‡∏´‡∏£‡∏∑‡∏≠ neutral baseline<br>
                ‚Ä¢ OFF = ‡∏ú‡∏•‡∏ï‡∏≠‡∏ö‡πÅ‡∏ó‡∏ô‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î (best case)<br>
                ‚Ä¢ ON = ‡∏ú‡∏•‡∏ï‡∏≠‡∏ö‡πÅ‡∏ó‡∏ô‡∏à‡∏£‡∏¥‡∏á (realistic)<br>
                ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: ‡∏°‡∏∑‡∏≠‡πÉ‡∏´‡∏°‡πà‡∏õ‡∏¥‡∏î‡∏ó‡∏∏‡∏Å switch ‡∏î‡∏π Gross ‡∏Å‡πà‡∏≠‡∏ô, ‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à‡∏à‡∏£‡∏¥‡∏á‡πÄ‡∏õ‡∏¥‡∏î Revenue + Financing
              </div>
              <div class="faq-item">
                <strong>Q4: ‡∏ó‡∏≥‡πÑ‡∏° Net Yield ‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤ Gross Yield ‡πÄ‡∏¢‡∏≠‡∏∞?</strong><br>
                A: ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏´‡∏±‡∏Å‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß - Occupancy 90% + Opex 15% + Agent Fee 1 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏õ‡∏µ (‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì 1-2%)
              </div>
              <div class="faq-item">
                <strong>Q5: CoC ‡∏ï‡∏¥‡∏î‡∏•‡∏ö‡πÅ‡∏õ‡∏•‡∏ß‡πà‡∏≤‡πÅ‡∏¢‡πà‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°?</strong><br>
                A: ‡πÑ‡∏°‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô! CoC ‡∏ï‡∏¥‡∏î‡∏•‡∏ö = ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏∏‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ‡πÅ‡∏ï‡πà‡πÑ‡∏î‡πâ asset + forced savings - ‡∏ñ‡πâ‡∏≤ IRR &gt;10% + EM
                &gt;2√ó ‡∏¢‡∏±‡∏á‡∏Ñ‡∏∏‡πâ‡∏°
              </div>
              <div class="faq-item">
                <strong>Q6: Scenario Low/Base/High ‡∏Ñ‡∏∑‡∏≠‡∏≠‡∏∞‡πÑ‡∏£?</strong><br>
                A: ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô ¬±10% - Low (-10%) = worst case, Base (0%) = expected, High
                (+10%) = best case
              </div>
              <div class="faq-item">
                <strong>Q7: Payback 25 ‡∏õ‡∏µ ‡∏ô‡∏≤‡∏ô‡πÑ‡∏õ‡πÑ‡∏´‡∏°?</strong><br>
                A: ‡∏Ç‡∏∂‡πâ‡∏ô‡∏Å‡∏±‡∏ö‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ - ‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∑‡∏ô‡∏ó‡∏∏‡∏ô‡πÄ‡∏£‡πá‡∏ß (&lt;12 ‡∏õ‡∏µ) ‡∏ô‡∏≤‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ, ‡∏ñ‡πâ‡∏≤‡∏ñ‡∏∑‡∏≠‡∏¢‡∏≤‡∏ß + ‡∏£‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏∂‡πâ‡∏ô ‡∏£‡∏±‡∏ö‡πÑ‡∏î‡πâ
                (‡πÇ‡∏î‡∏¢‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ &lt;18 ‡∏õ‡∏µ = ‡∏î‡∏µ, &gt;20 ‡∏õ‡∏µ = ‡∏Ñ‡∏ß‡∏£‡∏ó‡∏ö‡∏ó‡∏ß‡∏ô)
              </div>
              <div class="faq-item">
                <strong>Q8: ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡∏¥‡∏î Exit Switch ‡πÄ‡∏™‡∏°‡∏≠‡πÑ‡∏´‡∏°?</strong><br>
                A: ‡πÑ‡∏°‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô - ‡πÄ‡∏õ‡∏¥‡∏î‡∏ñ‡πâ‡∏≤‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏Ç‡∏≤‡∏¢‡πÉ‡∏ô 5-10 ‡∏õ‡∏µ (‡∏î‡∏π IRR, EM), ‡∏õ‡∏¥‡∏î‡∏ñ‡πâ‡∏≤‡∏ñ‡∏∑‡∏≠‡∏¢‡∏≤‡∏ß‡πÑ‡∏°‡πà‡∏Ñ‡∏¥‡∏î‡∏Ç‡∏≤‡∏¢ (‡∏î‡∏π Net Yield, Cashflow)
              </div>
              <div class="faq-item">
                <strong>Q9: Two-way binding ‡∏Ñ‡∏∑‡∏≠‡∏≠‡∏∞‡πÑ‡∏£?</strong><br>
                A: ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á Purchase ‚áÑ Avg/sqm ‚áÑ Area - ‡∏Å‡∏£‡∏≠‡∏Å 2 ‡πÉ‡∏ô 3 ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà 3 ‡πÉ‡∏´‡πâ (‡∏Å‡∏é: Purchase
                ‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏±‡∏Å ‡∏ñ‡πâ‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏£‡∏ö 3 ‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á ‡∏¢‡∏∂‡∏î Purchase ‡∏õ‡∏£‡∏±‡∏ö Avg/sqm)
              </div>
              <div class="faq-item">
                <strong>Q10: ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏°‡∏∑‡∏≠‡πÉ‡∏´‡∏°‡πà?</strong><br>
                A: ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏ö‡∏ö‡∏á‡πà‡∏≤‡∏¢ - (1) ‡∏Å‡∏£‡∏≠‡∏Å Purchase + Rent ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß (2) ‡∏î‡∏π Gross Yield (‡∏Ñ‡∏ß‡∏£ ‚â•6%) (3) ‡πÄ‡∏õ‡∏¥‡∏î Revenue
                Switch ‚Üí ‡∏î‡∏π Net Yield (4) ‡∏°‡∏µ‡πÅ‡∏ú‡∏ô‡∏Å‡∏π‡πâ ‡∏Å‡∏£‡∏≠‡∏Å Salary ‚Üí ‡∏î‡∏π DTI (5) ‡∏û‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à ‡∏Ñ‡πà‡∏≠‡∏¢‡∏•‡∏≠‡∏á‡πÄ‡∏õ‡∏¥‡∏î Exit
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>

  <script>
    function clamp(v, min, max) { return Math.min(Math.max(v, min), max); }
    function n(v) {
      if (typeof v === 'string') {
        // Remove commas and convert to number
        v = v.replace(/,/g, '');
      }
      const x = Number(v);
      return Number.isFinite(x) ? x : NaN;
    }
    function thb(nu) { return Number.isFinite(nu) ? nu.toLocaleString('th-TH', { maximumFractionDigits: 0 }) + ' ‡∏ø' : '‚Äî'; }
    function pct(nu) { return Number.isFinite(nu) ? (nu * 100).toFixed(1) + '%' : '‚Äî'; }
    function formatNumber(num) {
      if (!Number.isFinite(num)) return '';
      return num.toLocaleString('en-US');
    }
    function isValidNumber(str) {
      if (!str || str.trim() === '') return true; // Empty is valid
      const cleanStr = str.replace(/,/g, '');
      const num = Number(cleanStr);
      return Number.isFinite(num) && num >= 0;
    }
    const el = (id) => document.getElementById(id);

    const E = {
      purchase: el('purchase'), avgpsm: el('avgpsm'), area: el('area'),
      acq: el('acq_pct'), fit: el('fitout'), other: el('other'),
      rent: el('rent'), tgt_gross: el('tgt_gross'),
      occ: el('occ'), opex: el('opex'), agentm: el('agentm'),
      salary: el('salary'), down: el('down'), rate: el('rate'), tenor: el('tenor'),
      exit_on: el('exit_on'), hold: el('hold'), pgrow: el('pgrow'), sellc: el('sellc'),
      exit_mode: el('exit_mode'), exit_price: el('exit_price'), tax_pct: el('tax_pct'),
      swInv: el('swInv'), swRev: el('swRev'), swFin: el('swFin'), swExit: el('swExit')
    };

    const O = {
      gross: el('gross'), net: el('net'), coc: el('coc'), dti: el('dti'),
      netmo: el('netmo'), pmt: el('pmt'), payback: el('payback'),
      tval: el('tval'), npro: el('npro'), cgain: el('cgain'),
      irr: el('irr'), emult: el('emult'),
      loan_amt: el('loan_amt'), pmt2: el('pmt2'), tot_int: el('tot_int'), aff_warn: el('aff_warn')
    };

    const H = { acq_thb: el('acq_thb'), occ_eff: el('occ_eff'), opex_thb: el('opex_thb'), agent_thb: el('agent_thb') };
    const ai = el('ai_note');
    let activeScenario = 'base';

    document.querySelectorAll('.adv-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const t = document.querySelector(btn.dataset.target);
        t.style.display = (t.style.display === 'none' || t.style.display === '') ? 'block' : 'none'; recalc();
      });
    });

    ['swInv', 'swRev', 'swFin', 'swExit'].forEach(id => { const s = E[id]; s.addEventListener('change', async () => await recalc()); });

    function setErr(node, bad, msg = '') { if (!node) return; node.classList.toggle('err', !!bad); if (bad && msg) node.title = msg; else node.removeAttribute('title'); }

    // Add number formatting to all numeric input fields (NOT percentage fields)
    const numericFields = ['rent', 'salary', 'fitout', 'other', 'exit_price'];
    numericFields.forEach(id => {
      const field = E[id];
      if (field) {
        field.addEventListener('input', (e) => {
          const cursorPos = e.target.selectionStart;
          const oldValue = e.target.value;
          const newValue = formatInputNumber(oldValue);

          if (newValue !== oldValue) {
            e.target.value = newValue;
            const commasAdded = (newValue.match(/,/g) || []).length - (oldValue.match(/,/g) || []).length;
            e.target.setSelectionRange(cursorPos + commasAdded, cursorPos + commasAdded);
          }

          // Validate number format
          if (e.target.value !== '' && !isValidNumber(e.target.value)) {
            setErr(e.target, true, '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
          } else {
            setErr(e.target, false);
          }
        });

        field.addEventListener('blur', () => {
          if (field.value !== '' && !isValidNumber(field.value)) {
            setErr(field, true, '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
          } else {
            setErr(field, false);
          }
        });
      }
    });

    // Investment two-way - LAST-CHANGED-WINS logic
    let lastChanged = null;
    let isUpdating = false;

    ['purchase', 'avgpsm', 'area'].forEach(id => {
      E[id].addEventListener('input', (e) => {
        if (isUpdating) return;
        lastChanged = id;

        // Format number with commas as user types
        const cursorPos = e.target.selectionStart;
        const oldValue = e.target.value;
        const newValue = formatInputNumber(oldValue);

        if (newValue !== oldValue) {
          e.target.value = newValue;
          const commasAdded = (newValue.match(/,/g) || []).length - (oldValue.match(/,/g) || []).length;
          e.target.setSelectionRange(cursorPos + commasAdded, cursorPos + commasAdded);
        }

        // Instant two-way sync but debounce recalc
        twoWayInvestment();
        
        clearTimeout(recalcTimer);
        recalcTimer = setTimeout(() => recalc(), 500);
      });
    });

    function formatInputNumber(value) {
      if (!value) return '';
      // Remove all non-digits and decimal points
      const cleanValue = value.replace(/[^\d.]/g, '');
      const parts = cleanValue.split('.');

      // Format integer part with commas
      if (parts[0]) {
        parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ',');
      }

      // Return formatted number (with decimal if exists)
      return parts.length > 1 ? parts[0] + '.' + parts[1] : parts[0];
    }

    function twoWayInvestment() {
      if (isUpdating) return;

      const P = n(E.purchase.value);
      const A = n(E.area.value);
      const U = n(E.avgpsm.value);

      console.log('üîÑ twoWayInvestment:', { P, A, U, lastChanged });

      const hasP = Number.isFinite(P) && P > 0;
      const hasA = Number.isFinite(A) && A > 0;
      const hasU = Number.isFinite(U) && U > 0;

      // Clear all error states
      setErr(E.purchase, false);
      setErr(E.area, false);
      setErr(E.avgpsm, false);

      // Validate number format
      if (E.purchase.value !== '' && !isValidNumber(E.purchase.value)) {
        setErr(E.purchase, true, '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
        return;
      }
      if (E.area.value !== '' && !isValidNumber(E.area.value)) {
        setErr(E.area, true, '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
        return;
      }
      if (E.avgpsm.value !== '' && !isValidNumber(E.avgpsm.value)) {
        setErr(E.avgpsm, true, '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
        return;
      }

      // LAST-CHANGED-WINS LOGIC
      // Last field edited = source of truth, calculate other 2 fields from it
      // Formula: Purchase = Avg/sqm √ó Area

      isUpdating = true;

      if (lastChanged === 'purchase' && hasP) {
        // User edited Purchase ‚Üí calculate Avg (if Area exists) OR Area (if Avg exists)
        if (hasA && !hasU) {
          // Calculate Avg from Purchase / Area
          E.avgpsm.value = formatNumber(Math.round(P / A));
        }
        else if (hasU && !hasA) {
          // Calculate Area from Purchase / Avg
          E.area.value = formatNumber((P / U).toFixed(2));
        }
        else if (hasA && hasU) {
          // Both exist, recalculate Avg to maintain Purchase as source
          E.avgpsm.value = formatNumber(Math.round(P / A));
        }
      }
      else if (lastChanged === 'avgpsm' && hasU) {
        // User edited Avg ‚Üí calculate Purchase (if Area exists) OR Area (if Purchase exists)
        if (hasA && !hasP) {
          // Calculate Purchase from Avg √ó Area
          E.purchase.value = formatNumber(Math.round(U * A));
        }
        else if (hasP && !hasA) {
          // Calculate Area from Purchase / Avg
          E.area.value = formatNumber((P / U).toFixed(2));
        }
        else if (hasP && hasA) {
          // Both exist, recalculate Purchase to maintain Avg as source
          E.purchase.value = formatNumber(Math.round(U * A));
        }
      }
      else if (lastChanged === 'area' && hasA) {
        // User edited Area ‚Üí calculate Purchase (if Avg exists) OR Avg (if Purchase exists)
        if (hasU && !hasP) {
          // Calculate Purchase from Avg √ó Area
          E.purchase.value = formatNumber(Math.round(U * A));
        }
        else if (hasP && !hasU) {
          // Calculate Avg from Purchase / Area
          E.avgpsm.value = formatNumber(Math.round(P / A));
        }
        else if (hasP && hasU) {
          // Both exist, recalculate Purchase to maintain Area as source
          E.purchase.value = formatNumber(Math.round(U * A));
        }
      }

      // Handle single non-Purchase field errors
      const filledCount = (hasP ? 1 : 0) + (hasA ? 1 : 0) + (hasU ? 1 : 0);
      if (filledCount === 1) {
        if (hasU && !hasP && !hasA) {
          setErr(E.purchase, true, '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ã‡∏∑‡πâ‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà');
          setErr(E.area, true, '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ã‡∏∑‡πâ‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà');
        }
        else if (hasA && !hasP && !hasU) {
          setErr(E.purchase, true, '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ã‡∏∑‡πâ‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏ï‡∏£.‡∏°.');
          setErr(E.avgpsm, true, '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ã‡∏∑‡πâ‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏ï‡∏£.‡∏°.');
        }
      }

      isUpdating = false;
    }

    // Debounce timer for recalc
    let recalcTimer = null;
    
    // Revenue two-way (base = Purchase)
    E.rent.addEventListener('input', () => { 
      if (isUpdating) {
        console.log('‚è∏Ô∏è Rent input blocked by isUpdating');
        return;
      }
      twoWayRevenue('rent');
      
      // Debounce recalc to avoid excessive calculations while typing
      clearTimeout(recalcTimer);
      recalcTimer = setTimeout(() => recalc(), 500);
    });
    E.tgt_gross.addEventListener('input', () => { 
      if (isUpdating) {
        console.log('‚è∏Ô∏è Target Gross input blocked by isUpdating');
        return;
      }
      twoWayRevenue('tgt');
      
      // Debounce recalc
      clearTimeout(recalcTimer);
      recalcTimer = setTimeout(() => recalc(), 500);
    });
    function twoWayRevenue(changed) {
      const P = n(E.purchase.value);
      const rent = n(E.rent.value), tgt = (n(E.tgt_gross.value)) / 100;
      const hasP = Number.isFinite(P);
      
      console.log('üîÑ twoWayRevenue:', { changed, P, rent, tgt });

      // Validate number format
      if (E.rent.value !== '' && !isValidNumber(E.rent.value)) {
        setErr(E.rent, true, '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
        return;
      }
      if (E.tgt_gross.value !== '' && !isValidNumber(E.tgt_gross.value)) {
        setErr(E.tgt_gross, true, '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
        return;
      }

      if (!hasP) {
        setErr(E.tgt_gross, true, '‡∏Å‡∏£‡∏≠‡∏Å Purchase ‡∏Å‡πà‡∏≠‡∏ô');
        setErr(E.rent, !Number.isFinite(rent) && E.rent.value !== '');
        return;
      }

      setErr(E.tgt_gross, false);
      setErr(E.rent, false);

      if (changed === 'tgt' && Number.isFinite(tgt)) {
        E.rent.value = formatNumber(Math.round((tgt * P) / 12));
      }
      else if (changed === 'rent' && Number.isFinite(rent) && P > 0) {
        E.tgt_gross.value = ((rent * 12) / P * 100).toFixed(2);
      }
    }

    // Helpers
    function PMT(rateAPR, years, principal) {
      const i = rateAPR / 1200, n = years * 12; return (i > 0) ? principal * i / (1 - Math.pow(1 + i, -n)) : (n > 0 ? principal / n : 0);
    }
    function IRR(flows) {
      function npv(r) { let s = 0; for (let t = 0; t < flows.length; t++) s += flows[t] / Math.pow(1 + r, t); return s; }
      let r0 = 0.1, r1 = 0.11, f0 = npv(r0), f1 = npv(r1);
      for (let i = 0; i < 50; i++) {
        const r2 = r1 - f1 * (r1 - r0) / (f1 - f0); if (!isFinite(r2)) return NaN;
        r0 = r1; f0 = f1; r1 = r2; f1 = npv(r1); if (Math.abs(f1) < 1e-8) break;
      }
      return r1;
    }

    // Global variables for API integration
    const API_CONFIG = {
      baseURL: window.location.hostname === 'localhost'
        ? 'http://localhost:8000'
        : 'https://your-api-domain.com',
      timeout: 10000
    };

    let apiCache = {};
    let isCalculating = false;
    let tooltipsData = {};

    // v1.5: Default tooltips (fallback if API fails)
    const DEFAULT_TOOLTIPS = {
      purchase_price: "‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≤‡∏¢‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô ‡∏£‡∏ß‡∏° VAT (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)|‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: 4,000,000 ‡∏ö‡∏≤‡∏ó|‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Yield ‡πÅ‡∏•‡∏∞ Payback",
      avg_psm: "‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ï‡πà‡∏≠‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏°‡∏ï‡∏£|‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≤‡∏Å ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ã‡∏∑‡πâ‡∏≠ √∑ ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà|‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏±‡∏ö‡∏ï‡∏•‡∏≤‡∏î",
      area_sqm: "‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏™‡∏≠‡∏¢‡∏Ç‡∏≠‡∏á‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô|‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: 35 ‡∏ï‡∏£.‡∏°.|‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏ï‡πà‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏°‡∏ï‡∏£",
      monthly_rent: "‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏±‡∏Å‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢|‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: 20,000 ‡∏ö‡∏≤‡∏ó|‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Gross Yield",
      target_gross_yield: "‡∏ú‡∏•‡∏ï‡∏≠‡∏ö‡πÅ‡∏ó‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£|‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≤‡∏Å (‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤√ó12)√∑‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ã‡∏∑‡πâ‡∏≠√ó100|‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ 5-8%",
      gross_salary: "‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏£‡∏ß‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏±‡∏Å‡∏†‡∏≤‡∏©‡∏µ|‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: 70,000 ‡∏ö‡∏≤‡∏ó|‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì DTI Ratio",
      down_payment_pct: "‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå‡πÄ‡∏á‡∏¥‡∏ô‡∏î‡∏≤‡∏ß‡∏ô‡πå‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ã‡∏∑‡πâ‡∏≠|‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: 10%|‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏ï‡πà‡∏≠‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡∏π‡πâ‡πÅ‡∏•‡∏∞ CoC",
      holding_years: "‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏ñ‡∏∑‡∏≠‡∏Ñ‡∏£‡∏≠‡∏á‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏Ç‡∏≤‡∏¢|‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: 5 ‡∏õ‡∏µ|‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì IRR ‡πÅ‡∏•‡∏∞ Capital Gain",
      price_growth: "‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏¥‡∏ö‡πÇ‡∏ï‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô‡∏ï‡πà‡∏≠‡∏õ‡∏µ|‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: 3%|‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ï‡∏•‡∏≤‡∏î 2-5% ‡∏ï‡πà‡∏≠‡∏õ‡∏µ",
      selling_cost: "‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢ ‡πÄ‡∏ä‡πà‡∏ô ‡∏Ñ‡πà‡∏≤‡∏ô‡∏≤‡∏¢‡∏´‡∏ô‡πâ‡∏≤ ‡∏†‡∏≤‡∏©‡∏µ|‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: 3%|‡∏õ‡∏Å‡∏ï‡∏¥ 2-5% ‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢"
    };

    async function computeScenario(rentBase, delta) {
      const rent = (rentBase || 0) * (1 + delta);
      console.log(`üßÆ computeScenario: rentBase=${rentBase}, delta=${delta}, rent=${rent}`);
      
      const cacheKey = `${rentBase}_${delta}_${JSON.stringify(getInputValues())}`;

      // Return cached result if available
      if (apiCache[cacheKey]) {
        console.log('üíæ Using cached result');
        return apiCache[cacheKey];
      }

      try {
        const requestData = prepareApiRequest(rent);
        const response = await apiCall('/calc/scenario', requestData);

        if (response.status === 'success') {
          console.log('‚úÖ API call successful');
          const result = parseApiResponse(response.data, rent);
          apiCache[cacheKey] = result;
          return result;
        } else {
          console.error('‚ùå API returned error:', response.error);
          throw new Error(response.error?.message || 'Calculation failed');
        }
      } catch (error) {
        console.warn('‚ö†Ô∏è API call failed, using fallback calculation:', error);
        const fallbackResult = computeScenarioFallback(rentBase, delta);
        console.log('üîß Fallback result:', fallbackResult);
        return fallbackResult;
      }
    }

    function computeScenarioFallback(rentBase, delta) {
      const P = n(E.purchase.value) || 0;

      // INVESTMENT
      const useInv = E.swInv.checked; // side switch
      const acqPct = useInv ? (n(E.acq.value) || 3) / 100 : 0;
      const fit = useInv ? (n(E.fit.value) || 0) : 0;
      const other = useInv ? (n(E.other.value) || 0) : 0;
      const cost_basis = P + P * acqPct + fit + other;

      // REVENUE
      const useRev = E.swRev.checked;
      const occ = useRev ? clamp((n(E.occ.value) || 90) / 100, 0.5, 1) : 1.0;   // neutral 100%
      const opex = useRev ? clamp((n(E.opex.value) || 10) / 100, 0, 0.6) : 0.0; // neutral 0%
      const agentm = useRev ? clamp(n(E.agentm.value) || 1, 0, 12) : 0;       // neutral 0

      // FINANCING
      const down = clamp((n(E.down.value) || 10) / 100, 0, 0.9),
        rate = (E.swFin.checked ? (n(E.rate.value) || 4.5) : 4.5), // neutral APR 4.5
        years = (E.swFin.checked ? +(E.tenor.value || 30) : 30);   // neutral 30y
      const salary = n(E.salary.value);
      const financeOn = Number.isFinite(salary) && salary > 0;

      const rent = (rentBase || 0) * (1 + delta);
      const acqCost = P * acqPct;
      const loan = Number.isFinite(P) ? Math.max(P - P * down, 0) : NaN;
      const pmt = financeOn && Number.isFinite(loan) ? PMT(rate, years, loan) : 0;
      const rentEff = rent * occ;
      const agentTHB = rent * (agentm / 12);
      const opexTHB = rent * opex;
      const noiMonthly = rentEff - agentTHB - opexTHB;
      const netMonthly = noiMonthly - pmt;

      // Yields on Purchase
      const grossYield = P > 0 ? (rent * 12) / P : NaN;
      const netYield = P > 0 ? (noiMonthly * 12) / P : NaN;

      const downAmount = Number.isFinite(P) && Number.isFinite(down) ? P * down : 0;
      const equity = downAmount + acqCost + fit + other;
      const coc = equity > 0 ? (netMonthly * 12) / equity : NaN;
      const dti = financeOn && Number.isFinite(pmt) && salary > 0 ? pmt / salary : NaN;
      const payback = (noiMonthly > 0 && cost_basis > 0) ? (cost_basis / (noiMonthly * 12)) : NaN;

      return {
        rent, noiMonthly, netMonthly, grossYield, netYield, coc, dti, payback, pmt, loan, cost_basis, equity, financeOn,
        P, occ, opex
      };
    }

    function getInputValues() {
      return {
        purchase: n(E.purchase.value),
        rent: n(E.rent.value),
        salary: n(E.salary.value),
        swInv: E.swInv.checked,
        swRev: E.swRev.checked,
        swFin: E.swFin.checked,
        swExit: E.swExit.checked
      };
    }

    function prepareApiRequest(rent) {
      const P = n(E.purchase.value) || 0;
      const salary = n(E.salary.value);

      console.log('üì§ prepareApiRequest: rent =', rent, 'purchase =', P);

      return {
        purchase_price: P,
        monthly_rent: rent,
        area_sqm: n(E.area.value) || null,
        gross_salary: Number.isFinite(salary) ? salary : null,
        loan_tenor_years: E.swFin.checked ? parseInt(E.tenor.value) || 30 : 30,
        interest_rate_annual: E.swFin.checked ? (n(E.rate.value) || 4.5) : 4.5,
        down_payment_pct: n(E.down.value) || 10,
        occupancy_rate: E.swRev.checked ? (n(E.occ.value) || 90) : 100,
        opex_rate: E.swRev.checked ? (n(E.opex.value) || 10) : 0,
        agent_fee_months: E.swRev.checked ? (n(E.agentm.value) || 1) : 0,
        target_net_yield: 6,
        currency_code: 'THB',
        trace_id: `v5d_${Date.now()}`
      };
    }

    async function apiCall(endpoint, data) {
      const url = `${API_CONFIG.baseURL}${endpoint}`;
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), API_CONFIG.timeout);

      try {
        const response = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data),
          signal: controller.signal
        });

        clearTimeout(timeoutId);

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        return await response.json();
      } catch (error) {
        clearTimeout(timeoutId);
        if (error.name === 'AbortError') {
          throw new Error('Request timeout - please try again');
        }
        throw error;
      }
    }

    function parseApiResponse(data, rent) {
      const combined = data.combined_results || {};
      const yieldResults = combined.yield_results || {};
      const affordabilityResults = combined.affordability_results || {};

      const parseVal = (v) => parseFloat(v) || 0;

      const noiMonthly = parseVal(yieldResults.net_monthly_income);
      const pmt = parseVal(affordabilityResults.monthly_payment);
      const netMonthly = noiMonthly - pmt;

      console.log('üì• parseApiResponse: rent =', rent, 'netYield =', yieldResults.net_yield);

      return {
        rent: rent,
        noiMonthly: noiMonthly,
        netMonthly: netMonthly,
        grossYield: parseVal(yieldResults.gross_yield),
        netYield: parseVal(yieldResults.net_yield),
        coc: 0, // TODO: Calculate from equity
        dti: parseVal(affordabilityResults.dti_ratio),
        payback: parseVal(yieldResults.payback_years),
        pmt: pmt,
        loan: parseVal(affordabilityResults.loan_amount),
        cost_basis: 0, // TODO: Calculate
        equity: 0, // TODO: Calculate
        financeOn: pmt > 0,
        P: n(E.purchase.value) || 0,
        occ: E.swRev.checked ? (n(E.occ.value) || 90) / 100 : 1.0,
        opex: E.swRev.checked ? (n(E.opex.value) || 10) / 100 : 0.0
      };
    }

    function clsNetYield(v) { if (!isFinite(v)) return ''; return v >= 0.06 ? 'good' : (v >= 0.05 ? 'warn' : 'bad'); }
    function clsPayback(y) { if (!isFinite(y)) return ''; return y < 12 ? 'good' : (y <= 18 ? 'warn' : 'bad'); }
    function clsDTI(v) { if (!isFinite(v)) return ''; return v <= 0.30 ? 'good' : (v <= 0.40 ? 'warn' : 'bad'); }
    function clsCash(nu) { if (!isFinite(nu)) return ''; return nu >= 0 ? 'good' : 'bad'; }
    function clsCoC(v) { if (!isFinite(v)) return ''; return v < 0 ? 'bad' : (v > 0.10 ? 'good' : (v > 0.05 ? 'warn' : '')); }
    function setKpiClass(elm, cls) {
      if (!elm) return;
      elm.className = 'kpi kval ' + (cls || '');
      // Set color based on class
      if (cls === 'good') {
        elm.style.color = 'var(--good)';
      } else if (cls === 'warn') {
        elm.style.color = 'var(--warn)';
      } else if (cls === 'bad') {
        elm.style.color = 'var(--bad)';
      } else {
        elm.style.color = 'var(--text)';
      }
    }

    // ============================================================================
    // CAPITAL GAIN AI NOTE
    // ============================================================================

    /**
     * Generate AI Note for Capital Gain based on exit scenario
     * @param {Object} data - Calculation results
     * @returns {string} HTML formatted AI note
     */
    function generateCapitalGainAINote(data) {
      const {
        capitalGain,
        equity,
        priceGrowth,
        hasRevenue,
        holdingYears,
        purchase,
        terminalValue,
        cumulativeCF
      } = data;

      // Calculate metrics
      const roi = (capitalGain / equity) * 100;
      const actualGrowth = ((terminalValue / purchase - 1) / holdingYears * 100).toFixed(1);
      const appreciation = ((terminalValue / purchase - 1) * 100).toFixed(0);

      // === SCENARIO 1: NEGATIVE CAPITAL GAIN ===
      if (capitalGain < 0) {

        // Sub-case A: Low price growth + no revenue
        if (priceGrowth < 3 && !hasRevenue) {
          return `‚ùå Capital Gain ‡∏ï‡∏¥‡∏î‡∏•‡∏ö ${thb(capitalGain)} ‚Üí Exit price ‡∏ï‡πà‡∏≥‡πÄ‡∏Å‡∏¥‡∏ô (growth ${priceGrowth}%/‡∏õ‡∏µ) + ‡πÑ‡∏°‡πà‡∏°‡∏µ revenue ‡∏ä‡∏î‡πÄ‡∏ä‡∏¢ PMT ‚Üí ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: ‡∏õ‡∏£‡∏±‡∏ö Price Growth 4-5% ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡∏¥‡∏î Revenue`;
        }

        // Sub-case B: Normal growth but no revenue
        if (priceGrowth >= 3 && !hasRevenue) {
          const monthlyOut = Math.abs(cumulativeCF) / holdingYears / 12;
          return `‚ùå Capital Gain ‡∏ï‡∏¥‡∏î‡∏•‡∏ö ${thb(capitalGain)} ‚Üí Price growth ‡∏ï‡∏≤‡∏°‡∏Ñ‡∏≤‡∏î (${actualGrowth}%/‡∏õ‡∏µ) ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ revenue ‡∏ä‡∏î‡πÄ‡∏ä‡∏¢ ‚Üí ‡∏à‡πà‡∏≤‡∏¢‡∏ú‡πà‡∏≠‡∏ô ${thb(monthlyOut)}/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö ‚Üí ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: ‡∏´‡∏≤ tenant ‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤ exit ‡πÄ‡∏£‡πá‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏î‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡∏Ç‡∏≤‡∏î‡∏ó‡∏∏‡∏ô`;
        }

        // Sub-case C: Has revenue but short holding
        if (hasRevenue && holdingYears < 7) {
          return `‚ö†Ô∏è Capital Gain ‡∏ï‡∏¥‡∏î‡∏•‡∏ö ${thb(capitalGain)} ‚Üí Hold ‡πÄ‡∏û‡∏µ‡∏¢‡∏á ${holdingYears} ‡∏õ‡∏µ loan balance ‡∏¢‡∏±‡∏á‡∏™‡∏π‡∏á (${appreciation}% appreciation) ‚Üí ‡∏°‡∏µ revenue ‡∏ä‡πà‡∏ß‡∏¢‡πÅ‡∏•‡πâ‡∏ß Hold ‡∏ô‡∏≤‡∏ô 10-15 ‡∏õ‡∏µ‡∏à‡∏∞‡∏Ñ‡∏∏‡πâ‡∏°‡∏ó‡∏∏‡∏ô`;
        }

        // Sub-case D: Default negative
        return `‚ùå Capital Gain ‡∏ï‡∏¥‡∏î‡∏•‡∏ö ${thb(capitalGain)} ‚Üí ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö: Price Growth ${priceGrowth}%/‡∏õ‡∏µ ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏´‡∏°? | ‡∏°‡∏µ tenant ‡πÑ‡∏´‡∏°? | ‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏¢‡∏π‡πà‡πÄ‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏Ç‡∏≤‡∏¢?`;
      }

      // === SCENARIO 2: POSITIVE BUT LOW ===
      if (capitalGain > 0 && roi < 50) {
        return `‚ö†Ô∏è Capital Gain ‡∏ï‡πà‡∏≥ ${thb(capitalGain)} (ROI ${roi.toFixed(0)}%) ‚Üí ‡∏ú‡∏•‡∏ï‡∏≠‡∏ö‡πÅ‡∏ó‡∏ô‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏£ ‚Üí ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: ‡πÄ‡∏û‡∏¥‡πà‡∏° Price Growth ‡∏´‡∏£‡∏∑‡∏≠ Revenue ‡πÄ‡∏û‡∏∑‡πà‡∏≠ ROI >100%`;
      }

      // === SCENARIO 3: GOOD RETURN ===
      if (roi >= 50 && roi < 200) {
        return `‚úÖ Capital Gain ‡∏î‡∏µ ${thb(capitalGain)} (ROI ${roi.toFixed(0)}%) ‚Üí ‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏≤‡∏°‡πÄ‡∏õ‡πâ‡∏≤ (${actualGrowth}%/‡∏õ‡∏µ)${hasRevenue ? ' + ‡∏°‡∏µ revenue ‡∏ä‡πà‡∏ß‡∏¢' : ''} ‚Üí ‡∏ú‡∏•‡∏ï‡∏≠‡∏ö‡πÅ‡∏ó‡∏ô‡∏î‡∏µ ‡∏ñ‡πâ‡∏≤‡∏û‡∏≠‡πÉ‡∏à‡∏Ñ‡∏ß‡∏£ Hold ‡∏ï‡πà‡∏≠`;
      }

      // === SCENARIO 4: EXCELLENT RETURN ===
      if (roi >= 200) {
        return `üéâ Capital Gain ‡∏™‡∏π‡∏á ${thb(capitalGain)} (ROI ${roi.toFixed(0)}%!) ‚Üí ‡∏ú‡∏•‡∏ï‡∏≠‡∏ö‡πÅ‡∏ó‡∏ô‡∏î‡∏µ‡∏°‡∏≤‡∏Å${hasRevenue ? ' + ‡∏°‡∏µ revenue ‡πÄ‡∏™‡∏£‡∏¥‡∏°' : ''} ‚Üí Hold ‡∏ï‡πà‡∏≠‡∏Å‡πá‡∏î‡∏µ exit ‡∏Ç‡∏≤‡∏¢‡∏Å‡πá‡∏Ñ‡∏∏‡πâ‡∏°‡∏Ñ‡πà‡∏≤`;
      }

      // Fallback (should not reach here)
      return `‚ÑπÔ∏è Capital Gain: ${thb(capitalGain)} (ROI ${roi.toFixed(0)}%)`;
    }

    // ============================================================================
    // TIMELINE CHART FUNCTIONS
    // ============================================================================

    let timelineChart = null;

    function getTimelineDuration() {
      const tenorYears = parseInt(E.tenor?.value) || 30;
      const exitEnabled = E.exit_on?.checked || false;
      const exitYears = exitEnabled ? (parseInt(E.hold?.value) || 5) : 0;
      return Math.min(Math.max(tenorYears, exitYears, 30), 50);
    }

    function calculateTimelineScenario(rentMultiplier, displayYears) {
      const purchase = n(E.purchase.value) || 0;
      const rent = (n(E.rent.value) || 0) * rentMultiplier;
      const downPct = (n(E.down.value) || 10) / 100;
      const acqPct = (n(E.acq.value) || 3) / 100;
      const fitout = n(E.fit.value) || 0;
      const other = n(E.other.value) || 0;
      const occ = (n(E.occ.value) || 90) / 100;
      const opex = (n(E.opex.value) || 10) / 100;
      const agentMonths = n(E.agentm.value) || 1;
      const apr = n(E.rate.value) || 4.5;
      const tenor = parseInt(E.tenor.value) || 30;

      const exitEnabled = E.exit_on?.checked || false;
      const priceGrowth = exitEnabled ? (n(E.pgrow.value) || 3) : 3;
      const growthRate = priceGrowth / 100;

      // Check if financing is enabled
      const financingEnabled = E.swFin?.checked && n(E.salary.value) > 0;

      const costBasis = purchase * (1 + acqPct) + fitout + other;
      const equity = purchase * downPct + (purchase * acqPct) + fitout + other;
      const loan = financingEnabled ? (purchase - (purchase * downPct)) : 0;
      const pmt = financingEnabled ? PMT(apr, tenor, loan) : 0;

      // Initial values logged for debugging

      // Check if revenue is enabled
      const revenueEnabled = E.swRev?.checked || false;

      const rentEffective = revenueEnabled ? (rent * occ) : 0;
      const agentFee = revenueEnabled ? (rent * (agentMonths / 12)) : 0;
      const opexCost = revenueEnabled ? (rent * opex) : 0;
      const noiMonthly = rentEffective - agentFee - opexCost;
      const noiAnnual = noiMonthly * 12;

      const netMonthly = noiMonthly - pmt;
      const netAnnual = netMonthly * 12;

      // Cashflow calculations completed

      const timeline = [];
      let cumulativeCashflow = -equity;
      let cumulativeNOI = 0;
      let loanBalance = loan;
      let paybackYear = null;

      const annualPrincipal = (pmt * 12) * 0.45;

      for (let year = 0; year <= displayYears; year++) {
        if (year === 0) {
          // Year 0 initialization

          timeline.push({
            year: 0,
            netWorth: -equity,
            propertyValue: purchase,
            loanBalance: loan,
            cumulativeCashflow: -equity,
            cumulativeNOI: 0
          });
          continue;
        }

        // Year calculation in progress

        cumulativeCashflow += netAnnual;
        cumulativeNOI += noiAnnual;

        if (paybackYear === null && cumulativeNOI >= costBasis) {
          const prevCumNOI = cumulativeNOI - noiAnnual;
          const fraction = (costBasis - prevCumNOI) / noiAnnual;
          paybackYear = year - 1 + fraction;
        }

        if (year <= tenor) {
          loanBalance = Math.max(0, loanBalance - annualPrincipal);
        } else {
          loanBalance = 0;
        }

        const propertyValue = purchase * Math.pow(1 + growthRate, year);

        const currentEquity = propertyValue - loanBalance;

        let netWorth = cumulativeCashflow + currentEquity;
        // Year calculation completed

        const isExit = exitEnabled && year === (parseInt(E.hold.value) || 5);
        if (isExit) {
          const sellingCost = propertyValue * 0.03;
          const netProceeds = propertyValue - loanBalance - sellingCost;
          netWorth = cumulativeCashflow + netProceeds;

          // Exit year calculation completed
        }

        timeline.push({
          year,
          netWorth,
          propertyValue,
          loanBalance,
          cumulativeCashflow,
          cumulativeNOI,
          isExit
        });
      }

      return { timeline, paybackYear };
    }

    function calculateAllScenarios() {
      const displayYears = getTimelineDuration();
      const rent = n(E.rent.value) || 0;

      // If no revenue, all scenarios are the same
      if (rent === 0 || !(E.swRev?.checked)) {
        const scenario = calculateTimelineScenario(1.0, displayYears);
        return {
          displayYears,
          scenarios: {
            low: scenario,
            base: scenario,
            high: scenario
          }
        };
      }

      // Normal case with revenue
      const low = calculateTimelineScenario(0.9, displayYears);
      const base = calculateTimelineScenario(1.0, displayYears);
      const high = calculateTimelineScenario(1.1, displayYears);
      return { displayYears, scenarios: { low, base, high } };
    }

    // Helper function to get Y value at specific year (with interpolation)
    function getYValueAtYear(data, year) {
      if (!data || data.length === 0) return null;

      const index = Math.round(year);
      if (index < 0 || index >= data.length) return null;

      // For fractional years, use linear interpolation
      const floor = Math.floor(year);
      const ceil = Math.ceil(year);

      if (floor === ceil || ceil >= data.length) {
        return data[floor];
      }

      const fraction = year - floor;
      return data[floor] + (data[ceil] - data[floor]) * fraction;
    }

    function renderTimelineChart() {
      const data = calculateAllScenarios();
      const { displayYears, scenarios } = data;

      const years = scenarios.base.timeline.map(d => d.year);
      const lowData = scenarios.low.timeline.map(d => d.netWorth);
      const baseData = scenarios.base.timeline.map(d => d.netWorth);
      const highData = scenarios.high.timeline.map(d => d.netWorth);

      // Store payback data globally for tooltip and legend
      window.paybackYears = {
        low: scenarios.low.paybackYear || null,
        base: scenarios.base.paybackYear || null,
        high: scenarios.high.paybackYear || null
      };

      // Update Legend
      const pbLegendLow = document.getElementById('pb-legend-low');
      const pbLegendBase = document.getElementById('pb-legend-base');
      const pbLegendHigh = document.getElementById('pb-legend-high');

      if (pbLegendLow) pbLegendLow.textContent = window.paybackYears.low ? window.paybackYears.low.toFixed(1) : '‚Äî';
      if (pbLegendBase) pbLegendBase.textContent = window.paybackYears.base ? window.paybackYears.base.toFixed(1) : '‚Äî';
      if (pbLegendHigh) pbLegendHigh.textContent = window.paybackYears.high ? window.paybackYears.high.toFixed(1) : '‚Äî';

      // Property Value data (same for all scenarios - based on purchase price growth)
      const propertyValueData = scenarios.base.timeline.map(d => d.propertyValue);

      // Loan Balance data (decreasing over time)
      const loanBalanceData = scenarios.base.timeline.map(d => d.loanBalance);

      const canvas = document.getElementById('timeline-canvas');
      if (!canvas) return;
      const ctx = canvas.getContext('2d');

      if (timelineChart) timelineChart.destroy();

      const annotations = {};

      // Crosshair - vertical line that follows mouse
      annotations.crosshair = {
        type: 'line',
        xMin: 0,
        xMax: 0,
        borderColor: 'rgba(167, 176, 187, 0.3)',
        borderWidth: 1,
        borderDash: [5, 5],
        display: false
      };

      // Payback markers - circular points on the Net Worth lines
      if (document.getElementById('show-payback')?.checked) {
        const paybackLow = scenarios.low.paybackYear;
        if (paybackLow && paybackLow <= displayYears) {
          const yValue = getYValueAtYear(lowData, paybackLow);
          if (yValue !== null) {
            annotations.paybackLow = {
              type: 'point',
              xValue: paybackLow,
              yValue: yValue,
              backgroundColor: '#ef4444',
              borderColor: '#ef4444',
              borderWidth: 2,
              radius: 6,
              pointStyle: 'circle'
            };
          }
        }

        const paybackBase = scenarios.base.paybackYear;
        if (paybackBase && paybackBase <= displayYears) {
          const yValue = getYValueAtYear(baseData, paybackBase);
          if (yValue !== null) {
            annotations.paybackBase = {
              type: 'point',
              xValue: paybackBase,
              yValue: yValue,
              backgroundColor: '#15d4cf',
              borderColor: '#15d4cf',
              borderWidth: 2,
              radius: 7,
              pointStyle: 'circle'
            };
          }
        }

        const paybackHigh = scenarios.high.paybackYear;
        if (paybackHigh && paybackHigh <= displayYears) {
          const yValue = getYValueAtYear(highData, paybackHigh);
          if (yValue !== null) {
            annotations.paybackHigh = {
              type: 'point',
              xValue: paybackHigh,
              yValue: yValue,
              backgroundColor: '#22c55e',
              borderColor: '#22c55e',
              borderWidth: 2,
              radius: 6,
              pointStyle: 'circle'
            };
          }
        }
      }

      // Loan Paid Off marker - always show (not controlled by toggle)
      const tenorYears = parseInt(E.tenor.value) || 30;
      if (tenorYears <= displayYears) {
        annotations.loanPaid = {
          type: 'line',
          xMin: tenorYears,
          xMax: tenorYears,
          borderColor: '#f59e0b',
          borderWidth: 2,
          borderDash: [8, 4],
          label: {
            display: true,
            content: `üè† Loan Paid Off`,
            position: 'end',
            backgroundColor: 'rgba(245, 158, 11, 0.9)',
            color: 'white',
            font: { size: 11 }
          }
        };
      }

      const exitEnabled = E.exit_on?.checked || false;
      if (exitEnabled) {
        const exitYear = parseInt(E.hold.value) || 5;
        if (exitYear <= displayYears) {
          annotations.exit = {
            type: 'line',
            xMin: exitYear,
            xMax: exitYear,
            borderColor: '#8b5cf6',
            borderWidth: 3,
            label: {
              display: true,
              content: `üèÅ Exit (${exitYear}y)`,
              position: 'center',
              backgroundColor: '#8b5cf6',
              color: 'white',
              font: { size: 12, weight: 'bold' }
            }
          };
        }
      }

      // Prepare datasets array
      const datasets = [
        {
          label: 'Property Value',
          data: propertyValueData,
          borderColor: '#8b5cf6',
          backgroundColor: 'rgba(139, 92, 246, 0.1)',
          borderWidth: 2,
          borderDash: [8, 4],
          tension: 0.4,
          fill: false,
          pointRadius: 0,
          pointHoverRadius: 4
        }
      ];

      // Add Loan Balance line only if toggle is checked
      if (document.getElementById('show-loan-paid')?.checked) {
        datasets.push({
          label: 'üè¶ Loan Balance',
          data: loanBalanceData,
          borderColor: '#f59e0b',
          backgroundColor: 'rgba(245, 158, 11, 0.1)',
          borderWidth: 2,
          borderDash: [5, 5],
          tension: 0.4,
          fill: false,
          pointRadius: 0,
          pointHoverRadius: 4
        });
      }

      // Add Net Worth scenarios
      datasets.push(
        {
          label: 'High (+10%)',
          data: highData,
          borderColor: '#22c55e',
          borderWidth: 2.5,
          tension: 0.4,
          fill: false,
          pointRadius: 0,
          pointHoverRadius: 5
        },
        {
          label: 'Base',
          data: baseData,
          borderColor: '#15d4cf',
          borderWidth: 3,
          tension: 0.4,
          fill: false,
          pointRadius: 0,
          pointHoverRadius: 6
        },
        {
          label: 'Low (-10%)',
          data: lowData,
          borderColor: '#ef4444',
          borderWidth: 2.5,
          tension: 0.4,
          fill: false,
          pointRadius: 0,
          pointHoverRadius: 5
        }
      );

      // Custom plugin for colored tooltip labels
      const coloredTooltipPlugin = {
        id: 'coloredTooltip',
        beforeDraw: (chart) => {
          const tooltip = chart.tooltip;
          if (tooltip && tooltip._active && tooltip._active.length) {
            const ctx = chart.ctx;
            ctx.save();

            // Custom rendering will be handled by labelTextColor callback

            ctx.restore();
          }
        }
      };

      timelineChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: years,
          datasets: datasets
        },
        plugins: [coloredTooltipPlugin],
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { mode: 'index', intersect: false },
          plugins: {
            legend: {
              display: true,
              position: 'top',
              labels: { color: '#e9eef3', font: { size: 12 }, usePointStyle: true, padding: 15 }
            },
            tooltip: {
              backgroundColor: 'rgba(0, 0, 0, 0.95)',
              titleColor: '#15d4cf',
              bodyColor: '#e9eef3',
              borderColor: 'rgba(255, 255, 255, 0.1)',
              borderWidth: 1,
              padding: 14,
              cornerRadius: 10,
              bodySpacing: 6,
              footerMarginTop: 10,
              displayColors: false,
              titleFont: {
                size: 14,
                weight: 'bold',
                family: 'system-ui, -apple-system, sans-serif'
              },
              bodyFont: {
                size: 12,
                family: 'system-ui, -apple-system, sans-serif',
                lineHeight: 1.8
              },
              footerColor: '#a7b0bb',
              footerFont: {
                size: 11,
                family: 'system-ui, -apple-system, sans-serif'
              },
              callbacks: {
                title: (items) => {
                  return `Year ${items[0].label}`;
                },
                label: (context) => {
                  const datasetLabel = context.dataset.label;
                  const value = context.parsed.y;

                  // Show all datasets (Net Worth, Property Value, Loan Balance)
                  let label = '';

                  if (datasetLabel.includes('High')) {
                    label = 'High Net Worth:';
                  } else if (datasetLabel.includes('Base')) {
                    label = 'Base Net Worth:';
                  } else if (datasetLabel.includes('Low')) {
                    label = 'Low Net Worth:';
                  } else if (datasetLabel === 'Property Value') {
                    label = 'Property Value:';
                  } else if (datasetLabel && datasetLabel.includes('Loan Balance')) {
                    label = 'Loan Balance:';
                  } else {
                    return null;
                  }

                  // Format value in millions with proper spacing
                  const valueInM = (value / 1000000).toFixed(2);
                  const spacing = ' '.repeat(Math.max(0, 20 - label.length));

                  // Add emoji for Property and Loan
                  let icon = '‚óè';
                  if (datasetLabel === 'Property Value') icon = 'üè†';
                  else if (datasetLabel && datasetLabel.includes('Loan Balance')) icon = 'üí≥';

                  return `${icon} ${label}${spacing}${valueInM}M ‡∏ø`;
                },
                labelTextColor: (context) => {
                  const label = context.dataset.label;
                  if (label && label.includes('High')) return '#22c55e';
                  if (label && label.includes('Base')) return '#15d4cf';
                  if (label && label.includes('Low')) return '#ef4444';
                  if (label === 'Property Value') return '#8b5cf6';
                  if (label && label.includes('Loan Balance')) return '#f59e0b';
                  return '#e9eef3';
                },
                labelPointStyle: () => {
                  return {
                    pointStyle: 'circle',
                    rotation: 0
                  };
                },
                afterBody: (tooltipItems) => {
                  // No need for afterBody anymore since we show everything in label
                  return [];
                },
                footer: (tooltipItems) => {
                  // Calculate range from Net Worth scenarios only
                  const values = tooltipItems
                    .filter(item => item.dataset.label && item.dataset.label.includes('Net Worth'))
                    .map(item => item.parsed.y);

                  if (values.length === 0) return '';

                  const high = Math.max(...values);
                  const low = Math.min(...values);
                  const range = ((high - low) / 1000000).toFixed(2);

                  return `\nRange: ${range}M ‡∏ø`;
                }
              }
            },
            annotation: { annotations: annotations }
          },
          scales: {
            x: {
              title: { display: true, text: 'Years', color: '#a7b0bb', font: { size: 12 } },
              grid: { color: 'rgba(255, 255, 255, 0.05)' },
              ticks: { color: '#a7b0bb', font: { size: 11 } }
            },
            y: {
              title: { display: true, text: 'Net Worth (‡∏ø)', color: '#a7b0bb', font: { size: 12 } },
              grid: { color: 'rgba(255, 255, 255, 0.05)' },
              ticks: {
                color: '#a7b0bb',
                font: { size: 11 },
                callback: (value) => {
                  if (value >= 1000000) return (value / 1000000).toFixed(1) + 'M';
                  if (value >= 1000) return (value / 1000).toFixed(0) + 'K';
                  return value;
                }
              }
            }
          },
          onHover: (event, activeElements, chart) => {
            const canvasPosition = Chart.helpers.getRelativePosition(event, chart);
            const dataX = chart.scales.x.getValueForPixel(canvasPosition.x);

            if (dataX !== null && dataX >= 0 && dataX <= displayYears) {
              chart.options.plugins.annotation.annotations.crosshair.xMin = dataX;
              chart.options.plugins.annotation.annotations.crosshair.xMax = dataX;
              chart.options.plugins.annotation.annotations.crosshair.display = true;
              chart.update('none');
            }
          }
        }
      });

      // Add mouse leave handler to hide crosshair
      canvas.addEventListener('mouseleave', () => {
        if (timelineChart && timelineChart.options.plugins.annotation.annotations.crosshair) {
          timelineChart.options.plugins.annotation.annotations.crosshair.display = false;
          timelineChart.update('none');
        }
      });
    }

    function toggleTimeline() {
      const card = document.getElementById('timeline-card');
      const toggleBtn = document.getElementById('timeline-toggle-btn');
      const hideBtn = document.getElementById('timeline-hide-btn');
      const isVisible = card.style.display !== 'none';

      if (!isVisible) {
        // Show chart
        card.style.display = 'block';
        toggleBtn.textContent = 'üìä Hide Timeline';
        if (hideBtn) hideBtn.textContent = 'Hide';
        card.scrollIntoView({ behavior: 'smooth', block: 'start' });
        updateTimelineChart();
      } else {
        // Hide chart
        card.style.display = 'none';
        toggleBtn.textContent = 'üìä Show Investment Timeline';
      }
    }

    function closeTimeline() {
      document.getElementById('timeline-card').style.display = 'none';
      document.getElementById('timeline-toggle-btn').textContent = 'üìä Show Investment Timeline';
    }

    function updateTimelineChart() {
      const displayYears = getTimelineDuration();
      document.getElementById('timeline-title').textContent = `üìà ${displayYears}-Year Investment Timeline`;
      updateTimelineRemark();
      renderTimelineChart();
    }

    function updateTimelineRemark() {
      const exitEnabled = E.exit_on?.checked || false;
      const priceGrowth = exitEnabled ? (n(E.pgrow.value) || 3) : 3;
      const tenorYears = parseInt(E.tenor.value) || 30;
      const displayYears = getTimelineDuration();

      let remark = '';

      if (exitEnabled) {
        const exitYears = parseInt(E.hold.value) || 5;
        remark = `‚ÑπÔ∏è Using ${priceGrowth}% property appreciation from Exit settings. `;
        remark += `Exit at Year ${exitYears}. Loan tenor: ${tenorYears} years.`;
      } else {
        remark = `‚ÑπÔ∏è Using default ${priceGrowth}% property appreciation. `;
        remark += `Loan tenor: ${tenorYears} years.`;
      }

      document.getElementById('timeline-remark').innerHTML = remark;
    }

    /**
     * Generate AI Note comment for CoC Return
     * @param {number} coc - CoC value (decimal, e.g., 0.071 for 7.1%)
     * @param {number} netYield - Net Yield value (decimal)
     * @param {boolean} hasLeverage - True if Financing switch is ON
     * @returns {string} Formatted CoC comment
     */
    function getCoCComment(coc, netYield, hasLeverage) {
      const cocPct = (coc * 100).toFixed(1) + '%';

      // Case 1: Excellent (‚â•10%)
      if (coc >= 0.10) {
        return `CoC = ${cocPct} ‚Üí ‡∏î‡∏µ‡∏°‡∏≤‡∏Å, ‡∏°‡∏µ passive income ‡∏™‡∏π‡∏á (leverage ‡πÑ‡∏î‡πâ‡∏ú‡∏•)`;
      }

      // Case 2: Good (5-10%)
      if (coc >= 0.05) {
        return `CoC = ${cocPct} ‚Üí ‡∏î‡∏µ, ‡∏°‡∏µ passive income ‡∏™‡∏°‡πà‡∏≥‡πÄ‡∏™‡∏°‡∏≠`;
      }

      // Case 3: Fair (0-5%)
      if (coc >= 0) {
        // Special case: CoC ‚âà Net Yield (no leverage)
        if (!hasLeverage || Math.abs(coc - netYield) < 0.005) {
          return `CoC = ${cocPct} ‚Üí ‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á Net Yield (‡πÑ‡∏°‡πà‡∏°‡∏µ leverage)`;
        }
        return `CoC = ${cocPct} ‚Üí ‡∏û‡∏≠‡πÉ‡∏ä‡πâ, cashflow ‡∏ö‡∏ß‡∏Å‡∏ô‡πâ‡∏≠‡∏¢ (‡∏£‡∏≠ capital gain)`;
      }

      // Case 4: Slightly Negative (0 to -5%)
      if (coc >= -0.05) {
        return `CoC = ${cocPct} ‚Üí ‡∏ï‡∏¥‡∏î‡∏•‡∏ö‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢, ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö ‡πÅ‡∏ï‡πà‡πÑ‡∏î‡πâ asset (‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏≠‡∏≠‡∏°)`;
      }

      // Case 5: Very Negative (<-5%)
      return `CoC = ${cocPct} ‚Üí ‡∏ï‡∏¥‡∏î‡∏•‡∏ö‡∏°‡∏≤‡∏Å, ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡πÄ‡∏¢‡∏≠‡∏∞ (‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤‡∏•‡∏î loan ‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏≤ rent ‡∏™‡∏π‡∏á‡∏Ç‡∏∂‡πâ‡∏ô)`;
    }

    async function recalc() {
      console.log('üîÑ recalc() called');
      
      if (isCalculating) {
        console.log('‚è∏Ô∏è Already calculating, skipping');
        return;
      }

      // Don't call twoWayInvestment here as it's already called in input handlers

      const rentBase = n(E.rent.value);
      const purchaseVal = n(E.purchase.value);
      
      console.log('üìä Input values:', { rentBase, purchaseVal });

      // Skip calculation if no basic inputs
      if (!rentBase && !purchaseVal) {
        console.log('‚ö†Ô∏è No inputs, clearing outputs');
        clearOutputs();
        return;
      }

      isCalculating = true;
      showCalculating(true);
      console.log('‚úÖ Starting calculation...');

      try {
        const scLow = await computeScenario(rentBase, -0.10);
        const scBase = await computeScenario(rentBase, 0.00);
        const scHigh = await computeScenario(rentBase, +0.10);

        function setCard(sc, id) {
          const rentId = id === 'low' ? 'rent_low' : (id === 'high' ? 'rent_high' : 'rent_base');
          const nyId = id === 'low' ? 'ny_low' : (id === 'high' ? 'ny_high' : 'ny_base');
          const cfId = id === 'low' ? 'cf_low' : (id === 'high' ? 'cf_high' : 'cf_base');
          const dtiId = id === 'low' ? 'dti_low' : (id === 'high' ? 'dti_high' : 'dti_base');
          const pbId = id === 'low' ? 'pb_low' : (id === 'high' ? 'pb_high' : 'pb_base');
          const cocId = id === 'low' ? 'coc_low' : (id === 'high' ? 'coc_high' : 'coc_base');
          document.getElementById(rentId).textContent = thb(sc.rent);
          const nyEl = el(nyId), cfEl = el(cfId), dtiEl = el(dtiId), pbEl = el(pbId), cocEl = el(cocId);
          nyEl.textContent = pct(sc.netYield); nyEl.className = 'sc-val ' + clsNetYield(sc.netYield);
          cfEl.textContent = thb(sc.netMonthly); cfEl.className = 'sc-val ' + clsCash(sc.netMonthly);
          dtiEl.textContent = pct(sc.dti); dtiEl.className = 'sc-val ' + clsDTI(sc.dti);
          pbEl.textContent = isFinite(sc.payback) ? sc.payback.toFixed(1) + 'y' : '‚Äî'; pbEl.className = 'sc-val ' + clsPayback(sc.payback);
          cocEl.textContent = pct(sc.coc); cocEl.className = 'sc-val ' + clsCoC(sc.coc);
        }
        setCard(scLow, 'low'); setCard(scBase, 'base'); setCard(scHigh, 'high');

        const sc = activeScenario === 'low' ? scLow : (activeScenario === 'high' ? scHigh : scBase);
        document.getElementById('card-low').classList.toggle('active', activeScenario === 'low');
        document.getElementById('card-base').classList.toggle('active', activeScenario === 'base');
        document.getElementById('card-high').classList.toggle('active', activeScenario === 'high');

        // Investment details & equity box (for display hints)
        const useInv = E.swInv.checked;
        const P = n(E.purchase.value);
        const acqPct = useInv ? (n(E.acq.value) || 3) / 100 : 0;
        const fit = useInv ? (n(E.fit.value) || 0) : 0;
        const other = useInv ? (n(E.other.value) || 0) : 0;
        const acqCost = (Number.isFinite(P) ? P : 0) * acqPct;
        if (Number.isFinite(P)) {
          el('equity_box')?.classList?.toggle('dim', !useInv);
          el('equity_box').textContent = thb((P * (n(E.down.value) || 10) / 100) + fit + other);
          el('eq_down')?.classList?.toggle('dim', !useInv); el('eq_acq')?.classList?.toggle('dim', !useInv); el('eq_fo')?.classList?.toggle('dim', !useInv);
          el('eq_down').textContent = thb(P * (n(E.down.value) || 10) / 100);
          el('eq_acq').textContent = thb(acqCost);
          el('eq_fo').textContent = thb(fit + other);
          if (H.acq_thb) H.acq_thb.textContent = thb(acqCost).replace(' ‡∏ø', '');
        } else {
          if (el('equity_box')) el('equity_box').textContent = '‚Äî';
          if (el('eq_down')) el('eq_down').textContent = '‚Äî';
          if (el('eq_acq')) el('eq_acq').textContent = '‚Äî';
          if (el('eq_fo')) el('eq_fo').textContent = '‚Äî';
          if (H.acq_thb) H.acq_thb.textContent = '‚Äî';
        }

        // Revenue adv helpers for hints (dim if off)
        const useRev = E.swRev.checked;
        const occ = useRev ? clamp((n(E.occ.value) || 90) / 100, 0.5, 1) : 1.0;
        const opex = useRev ? clamp((n(E.opex.value) || 10) / 100, 0, 0.6) : 0.0;
        const agentm = useRev ? clamp(n(E.agentm.value) || 1, 0, 12) : 0;
        const rentEff = (n(E.rent.value) || 0) * occ; const agentTHB = (n(E.rent.value) || 0) * (agentm / 12); const opexTHB = (n(E.rent.value) || 0) * opex;
        ;['occ_eff', 'agent_thb', 'opex_thb'].forEach(id => { const k = el(id); if (k) k.parentElement.parentElement.classList.toggle('dim', !useRev); });
        if (H.occ_eff) H.occ_eff.textContent = Number.isFinite(rentEff) ? rentEff.toLocaleString('th-TH', { maximumFractionDigits: 0 }) : '‚Äî';
        if (H.agent_thb) H.agent_thb.textContent = Number.isFinite(agentTHB) ? agentTHB.toLocaleString('th-TH', { maximumFractionDigits: 0 }) : '‚Äî';
        if (H.opex_thb) H.opex_thb.textContent = Number.isFinite(opexTHB) ? opexTHB.toLocaleString('th-TH', { maximumFractionDigits: 0 }) : '‚Äî';

        // Key Metrics (with colors)
        // Initial Investment (Equity)
        const equityInvested = (P * (n(E.down.value) || 10) / 100) + acqCost + fit + other;
        const equityEl = document.getElementById('equity_invested');
        if (equityEl) {
          equityEl.textContent = Number.isFinite(equityInvested) && equityInvested > 0 ? thb(equityInvested) : '‚Äî';
          equityEl.style.color = 'var(--text)';
          equityEl.classList.remove('good', 'warn', 'bad');
        }

        // Set white color for 0, 0.0%, or - values
        const grossText = pct(sc.grossYield);
        O.gross.textContent = grossText;
        if (grossText === '‚Äî' || grossText === '0.0%' || sc.grossYield === 0) {
          O.gross.style.color = 'var(--text)';
          O.gross.classList.remove('good', 'warn', 'bad');
        } else {
          setKpiClass(O.gross, clsNetYield(sc.grossYield));
        }

        const netText = pct(sc.netYield);
        O.net.textContent = netText;
        if (netText === '‚Äî' || netText === '0.0%' || sc.netYield === 0) {
          O.net.style.color = 'var(--text)';
          O.net.classList.remove('good', 'warn', 'bad');
        } else {
          setKpiClass(O.net, clsNetYield(sc.netYield));
        }

        const cocText = pct(sc.coc);
        O.coc.textContent = cocText;
        if (cocText === '‚Äî' || !isFinite(sc.coc)) {
          O.coc.style.color = 'var(--text)';
          O.coc.classList.remove('good', 'warn', 'bad');
        } else {
          setKpiClass(O.coc, clsCoC(sc.coc));
        }
        O.netmo.textContent = thb(sc.netMonthly); setKpiClass(O.netmo, clsCash(sc.netMonthly));
        const dti = sc.dti; O.dti.textContent = pct(dti); setKpiClass(O.dti, clsDTI(dti));
        O.payback.textContent = isFinite(sc.payback) ? sc.payback.toFixed(1) + ' yrs' : '‚Äî'; setKpiClass(O.payback, clsPayback(sc.payback));

        // Affordability (clear if financing off)
        if (sc.financeOn && Number.isFinite(sc.loan)) {
          const pmt = sc.pmt;
          const tenorYears = E.swFin.checked ? +(E.tenor.value || 30) : 30;
          const totInterest = pmt * tenorYears * 12 - sc.loan;
          O.loan_amt.textContent = thb(sc.loan);
          O.pmt2.textContent = thb(pmt);
          O.tot_int.textContent = thb(totInterest);
          // Update Total Interest label with tenor years
          document.getElementById('tot_int_label').textContent = `Total Interest (${tenorYears}y)`;

          // DTI color coding
          if (isFinite(dti)) {
            if (dti > 0.4) {
              O.aff_warn.textContent = 'High Risk: DTI > 40%.';
              O.aff_warn.style.color = 'var(--bad)';
            } else if (dti > 0.3) {
              O.aff_warn.textContent = 'Caution: DTI 30‚Äì40%.';
              O.aff_warn.style.color = 'var(--warn)';
            } else if (dti < 0.2) {
              O.aff_warn.textContent = 'Excellent: DTI < 20%.';
              O.aff_warn.style.color = 'var(--good)';
            } else {
              O.aff_warn.textContent = 'OK: DTI ‚â§ 30%.';
              O.aff_warn.style.color = 'var(--text)';
            }
          } else {
            O.aff_warn.textContent = '‚Äî';
            O.aff_warn.style.color = 'var(--muted)';
          }
        } else {
          O.loan_amt.textContent = '‚Äî';
          O.pmt2.textContent = '‚Äî';
          O.tot_int.textContent = '‚Äî';
          document.getElementById('tot_int_label').textContent = 'Total Interest';
          O.aff_warn.textContent = '‡∏Å‡∏£‡∏≠‡∏Å Salary ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô DTI/PMT';
          O.aff_warn.style.color = 'var(--muted)';
        }

        // Exit & IRR (uses active scenario for cashflow-dependent calculations)
        let tval = NaN, npro = NaN, cgain = NaN, irr = NaN, em = NaN;

        if (E.exit_on.checked && Number.isFinite(P) && Number.isFinite(n(E.hold.value)) && Number.isFinite(n(E.pgrow.value))) {
          const hold = n(E.hold.value) || 5, g = Math.max(n(E.pgrow.value) || 0, 0) / 100, scsell = clamp((n(E.sellc.value) || 0) / 100, 0, 0.20);
          const useExit = E.swExit.checked;
          const manual = useExit ? (n(E.exit_price.value) || 0) : 0;
          const term = (manual > 0) ? manual : P * Math.pow(1 + g, hold);
          const tax = useExit ? Math.max(n(E.tax_pct.value) || 0, 0) / 100 : 0;
          // need cost basis consistent with Investment switch:
          const useInv = E.swInv.checked; const acqPct = useInv ? (n(E.acq.value) || 3) / 100 : 0;
          const fit = useInv ? (n(E.fit.value) || 0) : 0; const other = useInv ? (n(E.other.value) || 0) : 0;
          const cost_basis = P + P * acqPct + fit + other;

          const sellCosts = term * scsell; const taxTHB = Math.max(term - cost_basis, 0) * tax;
          tval = term;

          // Calculate remaining loan balance at exit
          const annualCF = sc.netMonthly * 12;
          const equity = sc.equity;
          const loan = sc.loan || 0;
          const pmt = sc.pmt || 0;
          const annualPrincipal = (pmt * 12) * 0.45; // Approximate principal portion
          let remainingLoan = loan;
          for (let y = 1; y <= hold; y++) {
            if (y <= 30) { // tenor
              remainingLoan = Math.max(0, remainingLoan - annualPrincipal);
            } else {
              remainingLoan = 0;
            }
          }

          // Net Proceeds = Terminal Value - Loan Balance - Selling Costs - Tax
          npro = term - remainingLoan - sellCosts - taxTHB;

          // Capital Gain = Net Proceeds + Cumulative Cashflow - Initial Equity
          // Net Proceeds already has loan balance deducted
          // Cumulative Cashflow is negative (cash out for loan payments)
          const cumulativeCF = annualCF * hold;
          cgain = npro + cumulativeCF - equity;

          if (equity > 0) { em = (annualCF * hold + npro) / equity; }
          const flows = [-equity];
          for (let y = 1; y <= hold; y++) {
            flows.push(y === hold ? (annualCF + npro) : annualCF);
          }

          irr = IRR(flows);
        }
        O.tval.textContent = Number.isFinite(tval) ? thb(tval) : '‚Äî';
        O.npro.textContent = Number.isFinite(npro) ? thb(npro) : '‚Äî';
        O.cgain.textContent = Number.isFinite(cgain) ? thb(cgain) : '‚Äî';

        // Capital Gain color: red if negative
        if (Number.isFinite(cgain)) {
          O.cgain.style.color = cgain < 0 ? 'var(--bad)' : 'var(--text)';
        } else {
          O.cgain.style.color = 'var(--text)';
        }

        // IRR color: white for 0/-, red if negative
        if (Number.isFinite(irr)) {
          O.irr.textContent = (irr * 100).toFixed(1) + '%';
          if (irr < 0) {
            O.irr.style.color = 'var(--bad)';
          } else if (irr === 0) {
            O.irr.style.color = 'var(--text)';
          } else {
            O.irr.style.color = 'var(--text)';
          }
        } else {
          O.irr.textContent = '‚Äî';
          O.irr.style.color = 'var(--text)';
        }

        O.emult.textContent = Number.isFinite(em) ? em.toFixed(2) + '√ó' : '‚Äî';

        // Status pills
        const pills = [];
        function Ppill(txt, cls) { pills.push('<span class="pill ' + cls + '">' + txt + '</span>'); }
        Ppill(sc.netYield >= 0.06 ? 'Net ‚â• 6%' : 'Net < 6%', clsNetYield(sc.netYield));
        if (isFinite(dti)) { if (dti > 0.40) Ppill('DTI > 40%', 'bad'); else if (dti > 0.30) Ppill('DTI 30‚Äì40%', 'warn'); else Ppill('DTI ‚â§ 30%', 'good'); }
        Ppill(sc.netMonthly >= 0 ? 'Cashflow ‡∏ö‡∏ß‡∏Å' : 'Cashflow ‡∏ï‡∏¥‡∏î‡∏•‡∏ö', clsCash(sc.netMonthly));
        document.getElementById('status_pills').innerHTML = pills.join(' ');

        // AI Note
        const lines = [];

        // Build default AI Note lines
        if (isFinite(sc.netYield)) lines.push('Net Yield = ' + pct(sc.netYield) + ' ‚Üí ' + (sc.netYield >= 0.07 ? '‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ï‡∏•‡∏≤‡∏î ‚Äî ‡∏ô‡πà‡∏≤‡∏™‡∏ô‡πÉ‡∏à' : (sc.netYield >= 0.06 ? '‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ï‡∏•‡∏≤‡∏î ‚Äî ‡∏û‡∏≠‡πÉ‡∏ä‡πâ' : '‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ï‡∏•‡∏≤‡∏î ‚Äî ‡∏Ñ‡∏ß‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏°‡∏ï‡∏¥‡∏ê‡∏≤‡∏ô')));

        // CoC Comment (NEW v6.1)
        if (isFinite(sc.coc)) {
          lines.push(getCoCComment(sc.coc, sc.netYield, E.swFin.checked));
        }

        if (isFinite(sc.payback)) lines.push('Payback = ' + (isFinite(sc.payback) ? sc.payback.toFixed(1) : '‚Äî') + ' ‡∏õ‡∏µ ‚Üí ' + (sc.payback < 12 ? '‡πÄ‡∏£‡πá‡∏ß' : (sc.payback <= 18 ? '‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á' : '‡∏ä‡πâ‡∏≤')));
        if (isFinite(dti)) lines.push('DTI = ' + pct(dti) + ' ‚Üí ' + (dti <= 0.30 ? '‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢' : (dti <= 0.40 ? '‡πÄ‡∏ù‡πâ‡∏≤‡∏£‡∏∞‡∏ß‡∏±‡∏á' : '‡πÄ‡∏Å‡∏¥‡∏ô‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡πÅ‡∏ö‡∏á‡∏Å‡πå')));
        lines.push('Revenue advance: ' + (E.swRev.checked ? 'ON' : 'OFF') + ' ¬∑ Financing advance: ' + (E.swFin.checked ? 'ON' : 'OFF'));

        // If Exit is enabled and Capital Gain is calculated, add Capital Gain AI Note
        if (E.exit_on.checked && Number.isFinite(cgain)) {
          const capitalGainNote = generateCapitalGainAINote({
            capitalGain: cgain,
            equity: sc.equity,
            priceGrowth: n(E.pgrow.value) || 3,
            hasRevenue: E.swRev.checked,
            holdingYears: n(E.hold.value) || 5,
            purchase: P,
            terminalValue: tval,
            cumulativeCF: (sc.netMonthly * 12) * (n(E.hold.value) || 5)
          });

          // Combine default AI Note with Capital Gain analysis
          const defaultNote = lines.map(s => '<div>‚Ä¢ ' + s + '</div>').join('');
          const exitNote = '<div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border);"><strong>üìä Exit Analysis:</strong><br><div style="margin-top: 6px; line-height: 1.6;">' + capitalGainNote + '</div></div>';
          ai.innerHTML = defaultNote + exitNote;
        } else {
          // Default AI Note only (no Exit)
          ai.innerHTML = lines.map(s => '<div>‚Ä¢ ' + s + '</div>').join('');
        }

        // Update timeline if visible
        const timelineCard = document.getElementById('timeline-card');
        if (timelineCard && timelineCard.style.display !== 'none') {
          updateTimelineChart();
        }

      } catch (error) {
        console.error('Calculation error:', error);
        showError('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì: ' + error.message);
      } finally {
        isCalculating = false;
        showCalculating(false);
      }
    }

    function clearOutputs() {
      // Clear all output displays
      Object.values(O).forEach(el => {
        if (el && el.textContent !== undefined) {
          el.textContent = '‚Äî';
          el.className = 'kpi kval';
          el.style.color = ''; // Reset color
        }
      });
      
      // Clear equity_invested (not in O object)
      const equityEl = document.getElementById('equity_invested');
      if (equityEl) {
        equityEl.textContent = '‚Äî';
        equityEl.className = 'kpi kval';
        equityEl.style.color = '';
      }
      
      // Clear status pills
      el('status_pills').innerHTML = '';
    }

    function showCalculating(show) {
      // Add subtle loading indication
      const cards = document.querySelectorAll('.card');
      cards.forEach(card => {
        card.style.opacity = show ? '0.7' : '1';
      });
    }

    function showError(message) {
      // Show error in AI note area
      if (ai) {
        ai.textContent = `‚ö†Ô∏è ${message}`;
        ai.style.color = 'var(--bad)';
        setTimeout(() => {
          ai.style.color = '';
          ai.textContent = '‚Äî';
        }, 5000);
      }
    }

    // v1.5: Tooltips functions
    async function loadTooltips() {
      try {
        const response = await fetch(`${API_CONFIG.baseURL}/tooltips`);
        if (response.ok) {
          const data = await response.json();
          tooltipsData = data.data || {};
        } else {
          console.warn('Tooltips API failed, using defaults');
          tooltipsData = DEFAULT_TOOLTIPS;
        }
      } catch (error) {
        console.warn('Tooltips loading failed:', error);
        tooltipsData = DEFAULT_TOOLTIPS;
      }

      // Always inject tooltips after loading
      injectTooltips();
    }

    function injectTooltips() {
      document.querySelectorAll('.tooltip-icon').forEach(icon => {
        const field = icon.getAttribute('data-tooltip');
        let content = tooltipsData[field] || DEFAULT_TOOLTIPS[field] || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠';

        // Remove existing tooltip content if any
        const existingTooltip = icon.querySelector('.tooltip-content');
        if (existingTooltip) {
          existingTooltip.remove();
        }

        // Create tooltip content element
        const tooltipDiv = document.createElement('div');
        tooltipDiv.className = 'tooltip-content';

        // Convert pipe (|) to line breaks for better formatting
        // This prevents awkward line breaks in the middle of phrases
        const lines = content.split('|');
        lines.forEach((line, index) => {
          const textNode = document.createTextNode(line.trim());
          tooltipDiv.appendChild(textNode);
          if (index < lines.length - 1) {
            tooltipDiv.appendChild(document.createElement('br'));
          }
        });

        icon.appendChild(tooltipDiv);

        // DO NOT set title attribute - it causes double tooltips (vertical + horizontal)
        // Remove title attribute if it exists
        icon.removeAttribute('title');

        // Add hover event listeners for better control
        icon.addEventListener('mouseenter', function () {
          const tooltip = this.querySelector('.tooltip-content');
          if (tooltip) {
            tooltip.style.opacity = '1';
            tooltip.style.visibility = 'visible';
          }
        });

        icon.addEventListener('mouseleave', function () {
          const tooltip = this.querySelector('.tooltip-content');
          if (tooltip) {
            tooltip.style.opacity = '0';
            tooltip.style.visibility = 'hidden';
          }
        });
      });
    }

    // v1.6: Help Modal functions with Accordion
    function openHelpModal() {
      document.getElementById('help-modal').style.display = 'flex';
    }

    function closeHelpModal() {
      document.getElementById('help-modal').style.display = 'none';
    }

    // Accordion functionality
    function toggleAccordion(header) {
      const content = header.nextElementSibling;
      const isActive = content.classList.contains('active');

      // Toggle active state
      header.classList.toggle('active');
      content.classList.toggle('active');

      // Smooth scroll to section when opened
      if (!isActive) {
        setTimeout(() => {
          header.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }, 100);
      }
    }

    // Close modal when clicking outside
    window.addEventListener('click', function (event) {
      const modal = document.getElementById('help-modal');
      if (event.target === modal) {
        closeHelpModal();
      }
    });

    // scenario card clicks
    ['card-low', 'card-base', 'card-high'].forEach((id, i) => {
      const name = i === 0 ? 'low' : (i === 1 ? 'base' : 'high');
      const node = document.getElementById(id);
      node.addEventListener('click', async () => { activeScenario = name; await recalc(); });
    });
    // mobile segmented
    const segL = document.getElementById('seg-low'), segB = document.getElementById('seg-base'), segH = document.getElementById('seg-high');
    if (segL) { segL.addEventListener('click', () => { activeScenario = 'low'; segL.classList.add('active'); segB.classList.remove('active'); segH.classList.remove('active'); recalc(); }); }
    if (segB) { segB.addEventListener('click', () => { activeScenario = 'base'; segB.classList.add('active'); segL.classList.remove('active'); segH.classList.remove('active'); recalc(); }); }
    if (segH) { segH.addEventListener('click', () => { activeScenario = 'high'; segH.classList.add('active'); segL.classList.remove('active'); segB.classList.remove('active'); recalc(); }); }

    // Exit price Last-Edit-Wins logic
    let lastExitFieldEdited = null;

    if (E.exit_price) {
      E.exit_price.addEventListener('input', () => {
        lastExitFieldEdited = 'manual';
        // If user enters manual price, clear price growth to avoid confusion
        if (n(E.exit_price.value) > 0 && E.pgrow) {
          E.pgrow.value = '';
        }
      });
    }

    if (E.pgrow) {
      E.pgrow.addEventListener('input', () => {
        lastExitFieldEdited = 'growth';
        // If user enters price growth, clear manual price to avoid confusion
        if (n(E.pgrow.value) > 0 && E.exit_price) {
          E.exit_price.value = '0';
        }
      });
    }

    // Add percentage validation for fields that should not exceed 100
    // Using multiple event listeners to ensure validation works
    const percentageFields = ['acq_pct', 'occ', 'opex', 'down', 'rate', 'pgrow', 'sellc', 'tax_pct', 'tgt_gross'];
    
    function validatePercentage(field) {
      if (!field || !field.value) return;
      
      let rawValue = field.value.replace(/,/g, '');
      let value = parseFloat(rawValue);
      
      if (!isNaN(value)) {
        if (value > 100) {
          field.value = '100';
          setErr(field, true, '‡∏Ñ‡πà‡∏≤‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡∏Ñ‡∏∑‡∏≠ 100%');
          setTimeout(() => setErr(field, false), 2000);
          return true;
        } else if (value < 0) {
          field.value = '0';
          setErr(field, true, '‡∏Ñ‡πà‡∏≤‡∏ï‡πà‡∏≥‡∏™‡∏∏‡∏î‡∏Ñ‡∏∑‡∏≠ 0%');
          setTimeout(() => setErr(field, false), 2000);
          return true;
        }
      }
      setErr(field, false);
      return false;
    }
    
    percentageFields.forEach(id => {
      const field = E[id];
      if (field) {
        // Validate on input (as user types)
        field.addEventListener('input', (e) => {
          validatePercentage(e.target);
        });
        
        // Validate on change (after input loses focus or value changes)
        field.addEventListener('change', (e) => {
          validatePercentage(e.target);
        });
        
        // Validate on blur (when user leaves the field)
        field.addEventListener('blur', (e) => {
          validatePercentage(e.target);
        });
        
        // Validate on paste
        field.addEventListener('paste', (e) => {
          setTimeout(() => validatePercentage(e.target), 10);
        });
      }
    });

    // Inputs update
    ['acq_pct', 'fitout', 'other', 'occ', 'opex', 'agentm', 'salary', 'down', 'rate', 'tenor', 'exit_on', 'hold', 'pgrow', 'sellc', 'exit_mode', 'exit_price', 'tax_pct', 'rent', 'tgt_gross']
      .forEach(id => { const node = el(id); if (node) { node.addEventListener('input', () => recalc()); node.addEventListener('change', () => recalc()); } });

    // ========================================
    // ASSET COMPARISON FUNCTIONS (v7)
    // ========================================

    const STORAGE_KEY = 'pyd_saved_assets';
    let savedAssets = [];
    let currentAssetId = null;
    let originalInputs = null;
    let pendingSwitchAssetId = null;

    // Calculator states
    const CALC_STATE = {
      BLANK: 'blank',           // No data
      NEW_FILLED: 'new_filled', // Has data, not saved
      SAVED: 'saved',           // Showing saved asset, no changes
      MODIFIED: 'modified'      // Showing saved asset, has changes
    };

    // Get current calculator state
    function getCalculatorState() {
      const hasInputs = E.purchase.value || E.rent.value;

      if (!hasInputs) {
        return CALC_STATE.BLANK;
      }

      if (!currentAssetId) {
        return CALC_STATE.NEW_FILLED;
      }

      if (calculatorIsModified()) {
        return CALC_STATE.MODIFIED;
      }

      return CALC_STATE.SAVED;
    }

    // Check if calculator has unsaved changes
    function calculatorHasUnsavedChanges() {
      const state = getCalculatorState();
      return state === CALC_STATE.NEW_FILLED || state === CALC_STATE.MODIFIED;
    }

    // Check if calculator is modified
    function calculatorIsModified() {
      if (!currentAssetId || !originalInputs) return false;

      const current = getAllInputs();
      return JSON.stringify(current) !== JSON.stringify(originalInputs);
    }

    // Update save button based on state
    function updateSaveButton() {
      const state = getCalculatorState();
      const btn = document.getElementById('save-asset-btn');

      if (!btn) return;

      switch (state) {
        case CALC_STATE.BLANK:
          btn.textContent = 'üíæ Save Asset';
          btn.disabled = true;
          btn.style.opacity = '0.5';
          break;

        case CALC_STATE.NEW_FILLED:
          btn.textContent = 'üíæ Save Asset';
          btn.disabled = false;
          btn.style.opacity = '1';
          break;

        case CALC_STATE.SAVED:
          btn.textContent = 'üíæ Save Changes';
          btn.disabled = true;
          btn.style.opacity = '0.5';
          break;

        case CALC_STATE.MODIFIED:
          btn.textContent = 'üíæ Save Changes';
          btn.disabled = false;
          btn.style.opacity = '1';
          break;
      }
    }

    // Handle save asset button click
    function handleSaveAsset() {
      const state = getCalculatorState();

      if (state === CALC_STATE.NEW_FILLED) {
        showSaveAssetModal();
      } else if (state === CALC_STATE.MODIFIED) {
        saveChanges();
      }
    }

    // Save changes to existing asset
    async function saveChanges() {
      if (!currentAssetId) {
        showSaveAssetModal();
        return;
      }

      const index = savedAssets.findIndex(a => a.id === currentAssetId);
      if (index === -1) return;

      // Get fresh calculation data for all 3 scenarios
      const rentBase = n(E.rent.value);
      console.log('üíæ saveChanges - Computing all scenarios with rent:', rentBase);
      
      const scLow = await computeScenario(rentBase, -0.10);
      const scBase = await computeScenario(rentBase, 0.00);
      const scHigh = await computeScenario(rentBase, 0.10);
      
      console.log('üíæ saveChanges - Results:', { 
        low: scLow.netYield, 
        base: scBase.netYield, 
        high: scHigh.netYield 
      });

      // Update asset
      savedAssets[index].inputs = getAllInputs();
      savedAssets[index].switches = getAllSwitches();
      savedAssets[index].results = {
        low: extractMetrics(scLow),
        base: extractMetrics(scBase),
        high: extractMetrics(scHigh)
      };
      savedAssets[index].timestamp = new Date().toISOString();

      localStorage.setItem(STORAGE_KEY, JSON.stringify(savedAssets));

      // Update original inputs
      originalInputs = getAllInputs();

      // Re-render cards
      renderAssetCards();

      // Update button
      updateSaveButton();

      // Show toast (optional)
      console.log('‚úÖ Changes saved successfully!');
    }

    function getSavedAssets() {
      try {
        const json = localStorage.getItem(STORAGE_KEY);
        return json ? JSON.parse(json) : [];
      } catch (e) {
        return [];
      }
    }

    function renderAssetCards() {
      savedAssets = getSavedAssets();
      const container = document.getElementById('asset-cards-container');
      if (!container) return;

      // Save current checkbox states before re-rendering
      const checkedAssets = new Set();
      container.querySelectorAll('input[name="compare"]:checked').forEach(cb => {
        checkedAssets.add(cb.value);
      });

      container.innerHTML = '';

      savedAssets.forEach(asset => {
        const card = createAssetCard(asset);
        container.appendChild(card);
        
        // Restore checkbox state
        if (checkedAssets.has(asset.id)) {
          const checkbox = card.querySelector('input[name="compare"]');
          if (checkbox) checkbox.checked = true;
        }
      });

      const addCard = createAddAssetCard();
      container.appendChild(addCard);

      document.getElementById('asset-count').textContent = savedAssets.length;
      updateCompareButtons();
    }

    function createAssetCard(asset) {
      const card = document.createElement('div');
      card.className = 'asset-card';
      card.dataset.id = asset.id;
      card.onclick = () => loadAsset(asset.id);

      const purchaseM = (asset.inputs.purchase_price / 1000000).toFixed(1);
      const netYield = (asset.results.base.net_yield * 100).toFixed(1);
      const payback = asset.results.base.payback_years?.toFixed(1) || '‚Äî';
      const yieldClass = netYield >= 6 ? 'good' : '';

      card.innerHTML = `
        <button class="card-delete" onclick="deleteAsset('${asset.id}', event)">√ó</button>
        <div class="card-header">
          <h3 class="card-name">${asset.name}</h3>
        </div>
        <div class="card-metrics">
          <div class="metric-row">
            <span class="label">Purchase:</span>
            <span class="value">${purchaseM}M</span>
          </div>
          <div class="metric-row">
            <span class="label">Net Yield:</span>
            <span class="value ${yieldClass}">${netYield}%</span>
          </div>
          <div class="metric-row">
            <span class="label">Payback:</span>
            <span class="value">${payback}y</span>
          </div>
        </div>
        <div class="card-checkbox">
          <label onclick="event.stopPropagation()">
            <input type="checkbox" name="compare" value="${asset.id}" onchange="updateCompareButtons()">
            <span>Compare</span>
          </label>
        </div>
      `;

      return card;
    }

    function createAddAssetCard() {
      const card = document.createElement('div');
      card.className = 'asset-card asset-card-add';
      card.onclick = () => handleAddAsset();

      card.innerHTML = `
        <div class="add-icon">+</div>
        <span>Add Asset</span>
      `;

      return card;
    }

    function updateCompareButtons() {
      const checked = document.querySelectorAll('input[name="compare"]:checked');
      const count = checked.length;
      const enabled = count >= 2 && count <= 3;

      const btn = document.getElementById('compare-selected-btn');
      btn.disabled = !enabled;
      btn.textContent = `üìä Compare Selected Assets (${count})`;

      if (count === 3) {
        document.querySelectorAll('input[name="compare"]:not(:checked)').forEach(cb => {
          cb.disabled = true;
        });
      } else {
        document.querySelectorAll('input[name="compare"]').forEach(cb => {
          cb.disabled = false;
        });
      }
    }

    function handleAddAsset() {
      if (calculatorHasUnsavedChanges()) {
        showSwitchAssetModal(null);
        return;
      }

      clearCalculator();
      currentAssetId = null;
      originalInputs = null;
      updateSaveButton();
      E.purchase.focus();
    }

    function clearCalculator() {
      // Clear all inputs
      Object.values(E).forEach(el => {
        if (el && el.value !== undefined) {
          if (el.type === 'checkbox') {
            el.checked = false;
          } else {
            el.value = '';
          }
        }
      });

      // Reset to defaults
      if (E.acq) E.acq.value = 3;
      if (E.fit) E.fit.value = 0;
      if (E.other) E.other.value = 0;
      if (E.occ) E.occ.value = 90;
      if (E.opex) E.opex.value = 10;
      if (E.agentm) E.agentm.value = 1;
      E.down.value = 10;
      E.rate.value = 4.5;
      E.tenor.value = 30;
      if (E.hold) E.hold.value = 5;
      if (E.pgrow) E.pgrow.value = 3;
      if (E.sellc) E.sellc.value = 3;

      // Clear all outputs
      clearOutputs();

      // Clear scenario analysis cards
      ['low', 'base', 'high'].forEach(id => {
        const rentId = id === 'low' ? 'rent_low' : (id === 'high' ? 'rent_high' : 'rent_base');
        const nyId = id === 'low' ? 'ny_low' : (id === 'high' ? 'ny_high' : 'ny_base');
        const cfId = id === 'low' ? 'cf_low' : (id === 'high' ? 'cf_high' : 'cf_base');
        const dtiId = id === 'low' ? 'dti_low' : (id === 'high' ? 'dti_high' : 'dti_base');
        const pbId = id === 'low' ? 'pb_low' : (id === 'high' ? 'pb_high' : 'pb_base');
        const cocId = id === 'low' ? 'coc_low' : (id === 'high' ? 'coc_high' : 'coc_base');
        
        if (document.getElementById(rentId)) document.getElementById(rentId).textContent = '‚Äî';
        const nyEl = el(nyId), cfEl = el(cfId), dtiEl = el(dtiId), pbEl = el(pbId), cocEl = el(cocId);
        if (nyEl) { nyEl.textContent = '‚Äî'; nyEl.className = 'sc-val'; }
        if (cfEl) { cfEl.textContent = '‚Äî'; cfEl.className = 'sc-val'; }
        if (dtiEl) { dtiEl.textContent = '‚Äî'; dtiEl.className = 'sc-val'; }
        if (pbEl) { pbEl.textContent = '‚Äî'; pbEl.className = 'sc-val'; }
        if (cocEl) { cocEl.textContent = '‚Äî'; cocEl.className = 'sc-val'; }
      });

      // Clear AI Note
      if (ai) {
        ai.textContent = '‚Äî';
        ai.style.color = '';
      }

      // Clear/destroy timeline chart
      if (timelineChart) {
        timelineChart.destroy();
        timelineChart = null;
      }

      // Clear payback legend values
      const pbLegendLow = document.getElementById('pb-legend-low');
      const pbLegendBase = document.getElementById('pb-legend-base');
      const pbLegendHigh = document.getElementById('pb-legend-high');
      if (pbLegendLow) pbLegendLow.textContent = '‚Äî';
      if (pbLegendBase) pbLegendBase.textContent = '‚Äî';
      if (pbLegendHigh) pbLegendHigh.textContent = '‚Äî';

      // Clear global payback data
      if (window.paybackYears) {
        window.paybackYears = { low: null, base: null, high: null };
      }

      currentAssetId = null;
      originalInputs = null;
      updateSaveButton();
    }

    function getAllInputs() {
      return {
        // Investment
        purchase_price: n(E.purchase.value) || 0,
        area: n(E.area.value) || 0,
        avg_psm: n(E.avgpsm.value) || 0,
        acquisition_pct: n(E.acq.value) || 3,
        fitout: n(E.fit.value) || 0,
        other_costs: n(E.other.value) || 0,

        // Revenue
        monthly_rent: n(E.rent.value) || 0,
        target_gross_yield: n(E.tgt_gross.value) || 0,
        occupancy_rate: n(E.occ.value) || 90,
        opex_rate: n(E.opex.value) || 10,
        agent_fee_months: n(E.agentm.value) || 1,

        // Financing
        gross_salary: n(E.salary.value) || 0,
        down_payment_pct: n(E.down.value) || 10,
        interest_rate_annual: n(E.rate.value) || 4.5,
        loan_tenor_years: n(E.tenor.value) || 30,

        // Exit
        exit_enabled: E.exit_on.checked,
        holding_years: n(E.hold.value) || 5,
        price_growth_pct: n(E.pgrow.value) || 3,
        selling_cost_pct: n(E.sellc.value) || 3,
        exit_mode: E.swExit?.checked ? 'manual' : 'auto',
        manual_exit_price: n(E.exit_price.value) || 0,
        capital_gains_tax_pct: n(E.tax_pct.value) || 0
      };
    }

    function getAllSwitches() {
      return {
        investment_adv: E.swInv?.checked || false,
        revenue_adv: E.swRev?.checked || false,
        financing_adv: E.swFin?.checked || false
      };
    }

    function showSaveAssetModal() {
      const modal = document.getElementById('save-asset-modal');
      const input = document.getElementById('asset-name-input');
      const checkbox = document.getElementById('use-in-comparison-checkbox');

      const purchase = n(E.purchase.value) || 0;
      const purchaseM = (purchase / 1000000).toFixed(1);
      input.placeholder = `Asset ${purchaseM}M`;
      input.value = '';
      checkbox.checked = true;

      modal.classList.add('show');
      input.focus();
    }

    function closeSaveAssetModal() {
      document.getElementById('save-asset-modal').classList.remove('show');
    }

    async function saveAndNew() {
      const nameInput = document.getElementById('asset-name-input').value.trim();
      const addToCompare = document.getElementById('use-in-comparison-checkbox').checked;

      const purchase = n(E.purchase.value) || 0;
      const purchaseM = (purchase / 1000000).toFixed(1);

      // Get fresh calculation data for all 3 scenarios
      const rentBase = n(E.rent.value);
      console.log('üíæ saveAndNew - Computing all scenarios with rent:', rentBase);
      
      const scLow = await computeScenario(rentBase, -0.10);
      const scBase = await computeScenario(rentBase, 0.00);
      const scHigh = await computeScenario(rentBase, 0.10);
      
      const netYield = scBase.netYield || 0;
      const yieldPct = (netYield * 100).toFixed(1);
      
      console.log('üíæ saveAndNew - Results:', { 
        low: scLow.netYield, 
        base: scBase.netYield, 
        high: scHigh.netYield 
      });

      const name = nameInput || `Asset ${purchaseM}M @ ${yieldPct}%`;

      const asset = {
        id: `asset_${Date.now()}`,
        name: name,
        timestamp: new Date().toISOString(),
        inputs: getAllInputs(),
        switches: getAllSwitches(),
        results: {
          low: extractMetrics(scLow),
          base: extractMetrics(scBase),
          high: extractMetrics(scHigh)
        }
      };

      savedAssets.push(asset);
      localStorage.setItem(STORAGE_KEY, JSON.stringify(savedAssets));

      closeSaveAssetModal();
      renderAssetCards();

      if (addToCompare) {
        setTimeout(() => {
          const checkbox = document.querySelector(`input[name="compare"][value="${asset.id}"]`);
          if (checkbox) {
            checkbox.checked = true;
            updateCompareButtons();
          }
        }, 100);
      }

      clearCalculator();
      currentAssetId = null;
      originalInputs = null;
      updateSaveButton();
      E.purchase.focus();
    }

    function showSwitchAssetModal(targetAssetId) {
      pendingSwitchAssetId = targetAssetId;

      const modal = document.getElementById('switch-asset-modal');
      const input = document.getElementById('switch-asset-name-input');
      const checkbox = document.getElementById('switch-use-comparison-checkbox');

      const purchase = n(E.purchase.value) || 0;
      const purchaseM = (purchase / 1000000).toFixed(1);
      input.placeholder = `Asset ${purchaseM}M`;
      input.value = '';
      checkbox.checked = true;

      modal.classList.add('show');
      input.focus();
    }

    function closeSwitchModal() {
      document.getElementById('switch-asset-modal').classList.remove('show');
      pendingSwitchAssetId = null;
    }

    async function saveAndSwitch() {
      // Save current asset first
      await saveChanges();
      closeSwitchModal();

      if (pendingSwitchAssetId) {
        // Switch to another asset
        loadAsset(pendingSwitchAssetId);
      } else {
        // Clear calculator for new asset
        clearCalculator();
        currentAssetId = null;
        originalInputs = null;
        updateSaveButton();
        E.purchase.focus();
      }
    }

    function discardAndSwitch() {
      closeSwitchModal();

      if (pendingSwitchAssetId) {
        // Switch to another asset without saving
        loadAsset(pendingSwitchAssetId);
      } else {
        // Clear calculator for new asset
        clearCalculator();
        currentAssetId = null;
        originalInputs = null;
        updateSaveButton();
        E.purchase.focus();
      }
    }

    function loadAsset(assetId) {
      // Check if we're in comparison view
      const inComparisonView = document.getElementById('comparison-section').style.display !== 'none';
      
      // If in comparison view, switch to calculator directly (no modal)
      if (inComparisonView) {
        const asset = savedAssets.find(a => a.id === assetId);
        if (!asset) return;
        
        // Switch to calculator view first
        showCalculatorSection();
        
        // Then load the asset
        loadAssetData(asset);
        return;
      }
      
      // Check if calculator has unsaved changes (only when in calculator view)
      if (calculatorHasUnsavedChanges() && currentAssetId !== assetId) {
        showSwitchAssetModal(assetId);
        return;
      }

      const asset = savedAssets.find(a => a.id === assetId);
      if (!asset) return;
      
      loadAssetData(asset);
    }
    
    // Separate function to load asset data
    function loadAssetData(asset) {

      // Helper to format numbers for display
      const fmt = (val) => val ? formatInputNumber(String(val)) : '';

      // Disable event handlers during load to prevent unwanted recalculations
      console.log('üîí loadAsset - Setting isUpdating = true');
      isUpdating = true;
      
      // Reset lastChanged to prevent two-way sync issues
      lastChanged = null;

      // Investment
      E.purchase.value = fmt(asset.inputs.purchase_price);
      E.area.value = fmt(asset.inputs.area);
      E.avgpsm.value = fmt(asset.inputs.avg_psm);
      E.acq.value = asset.inputs.acquisition_pct || 3;
      E.fit.value = fmt(asset.inputs.fitout);
      E.other.value = fmt(asset.inputs.other_costs);

      // Revenue
      E.rent.value = fmt(asset.inputs.monthly_rent);
      E.tgt_gross.value = asset.inputs.target_gross_yield || '';
      E.occ.value = asset.inputs.occupancy_rate || 90;
      E.opex.value = asset.inputs.opex_rate || 10;
      E.agentm.value = asset.inputs.agent_fee_months || 1;

      // Financing
      E.salary.value = fmt(asset.inputs.gross_salary);
      E.down.value = asset.inputs.down_payment_pct || 10;
      E.rate.value = asset.inputs.interest_rate_annual || 4.5;
      E.tenor.value = asset.inputs.loan_tenor_years || 30;

      // Exit
      E.exit_on.checked = asset.inputs.exit_enabled || false;
      E.hold.value = asset.inputs.holding_years || 5;
      E.pgrow.value = asset.inputs.price_growth_pct || 3;
      E.sellc.value = asset.inputs.selling_cost_pct || 3;
      if (E.swExit) E.swExit.checked = asset.inputs.exit_mode === 'manual';
      E.exit_price.value = fmt(asset.inputs.manual_exit_price);
      E.tax_pct.value = asset.inputs.capital_gains_tax_pct || 0;

      // Switches
      if (E.swInv) E.swInv.checked = asset.switches?.investment_adv || false;
      if (E.swRev) E.swRev.checked = asset.switches?.revenue_adv || false;
      if (E.swFin) E.swFin.checked = asset.switches?.financing_adv || false;

      // Set current asset ID BEFORE setting originalInputs
      currentAssetId = asset.id;

      console.log('üìÇ loadAsset - Loaded asset:', asset.id);
      console.log('üìÇ loadAsset - Inputs:', { 
        purchase: E.purchase.value, 
        rent: E.rent.value 
      });

      // Re-enable event handlers and recalc
      setTimeout(async () => {
        console.log('üîì loadAsset - Setting isUpdating = false');
        isUpdating = false;
        
        // Force recalculation to show outputs
        await recalc();
        
        // Set originalInputs AFTER recalc to capture the correct state
        originalInputs = getAllInputs();
        
        // Update save button
        updateSaveButton();
        
        console.log('‚úÖ loadAsset - Complete with outputs displayed');
      }, 100);
      
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function deleteAsset(assetId, event) {
      event.stopPropagation();

      const asset = savedAssets.find(a => a.id === assetId);
      if (!confirm(`Delete "${asset.name}"?`)) return;

      savedAssets = savedAssets.filter(a => a.id !== assetId);
      localStorage.setItem(STORAGE_KEY, JSON.stringify(savedAssets));

      renderAssetCards();

      if (currentAssetId === assetId) {
        clearCalculator();
        currentAssetId = null;
      }
    }

    function clearAllAssets() {
      if (!confirm('‚ö†Ô∏è Delete all assets? This cannot be undone.')) return;

      localStorage.removeItem(STORAGE_KEY);
      renderAssetCards();

      if (currentAssetId) {
        clearCalculator();
        currentAssetId = null;
      }
    }

    function showCalculatorSection() {
      document.getElementById('calculator-section').style.display = 'block';
      document.getElementById('comparison-section').style.display = 'none';
    }

    function showComparisonSection() {
      document.getElementById('calculator-section').style.display = 'none';
      document.getElementById('comparison-section').style.display = 'block';
    }

    // Initialize everything
    document.addEventListener('DOMContentLoaded', function () {
      // v1.5: Help button
      document.getElementById('help-btn')?.addEventListener('click', openHelpModal);

      // v1.5: Load tooltips on page load
      loadTooltips();

      // v7: Load saved assets
      renderAssetCards();

      // v7.1: Add input change listeners to update save button
      Object.values(E).forEach(el => {
        if (el && el.addEventListener) {
          el.addEventListener('input', updateSaveButton);
          el.addEventListener('change', updateSaveButton);
        }
      });

      // Initial calculation
      recalc();
      updateSaveButton();
    });

    // Fallback if DOMContentLoaded already fired
    if (document.readyState === 'loading') {
      // Do nothing, DOMContentLoaded will fire
    } else {
      // DOM is already ready
      document.getElementById('help-btn')?.addEventListener('click', openHelpModal);
      loadTooltips();
      renderAssetCards();

      // Add input change listeners
      Object.values(E).forEach(el => {
        if (el && el.addEventListener) {
          el.addEventListener('input', updateSaveButton);
          el.addEventListener('change', updateSaveButton);
        }
      });

      recalc();
      updateSaveButton();
    }

    // ========================================
    // COMPARISON FUNCTIONS (Day 2)
    // ========================================

    // Calculate exit metrics
    function calculateExitMetrics(sc) {
      if (!E.exit_on.checked) {
        return { tval: 0, npro: 0, cgain: 0, irr: 0, em: 0 };
      }

      const P = n(E.purchase.value) || 0;
      const hold = n(E.hold.value) || 5;
      const g = Math.max(n(E.pgrow.value) || 0, 0) / 100;
      const scsell = clamp((n(E.sellc.value) || 0) / 100, 0, 0.20);
      const useExit = E.swExit?.checked || false;
      const manual = useExit ? (n(E.exit_price.value) || 0) : 0;
      const term = (manual > 0) ? manual : P * Math.pow(1 + g, hold);
      const tax = useExit ? Math.max(n(E.tax_pct.value) || 0, 0) / 100 : 0;

      // Cost basis
      const useInv = E.swInv.checked;
      const acqPct = useInv ? (n(E.acq.value) || 3) / 100 : 0;
      const fit = useInv ? (n(E.fit.value) || 0) : 0;
      const other = useInv ? (n(E.other.value) || 0) : 0;
      const cost_basis = P + P * acqPct + fit + other;

      const sellCosts = term * scsell;
      const taxTHB = Math.max(term - cost_basis, 0) * tax;
      const tval = term;

      // Calculate remaining loan balance
      const annualCF = sc.netMonthly * 12;
      const equity = sc.equity;
      const loan = sc.loan || 0;
      const pmt = sc.pmt || 0;
      const annualPrincipal = (pmt * 12) * 0.45;
      let remainingLoan = loan;
      for (let y = 1; y <= hold; y++) {
        if (y <= 30) {
          remainingLoan = Math.max(0, remainingLoan - annualPrincipal);
        } else {
          remainingLoan = 0;
        }
      }

      // Net Proceeds
      const npro = term - remainingLoan - sellCosts - taxTHB;

      // Capital Gain
      const cumulativeCF = annualCF * hold;
      const cgain = npro + cumulativeCF - equity;

      // Equity Multiple
      const em = equity > 0 ? (annualCF * hold + npro) / equity : 0;

      // IRR
      const flows = [-equity];
      for (let y = 1; y <= hold; y++) {
        flows.push(y === hold ? (annualCF + npro) : annualCF);
      }
      const irr = IRR(flows);

      return { tval, npro, cgain, irr, em };
    }

    // Helper to extract all metrics from scenario
    function extractMetrics(sc) {
      const years = E.swFin.checked ? +(E.tenor.value || 30) : 30;
      const totalInterest = sc.loan > 0 && sc.pmt > 0 ? (sc.pmt * 12 * years) - sc.loan : 0;
      
      // Calculate exit metrics
      const exitMetrics = calculateExitMetrics(sc);
      console.log('üìä extractMetrics - Exit metrics:', exitMetrics);
      console.log('üìä extractMetrics - Exit enabled:', E.exit_on.checked);
      
      return {
        equity: sc.equity || 0,
        gross_yield: sc.grossYield || 0,
        net_yield: sc.netYield || 0,
        coc_return: sc.coc || 0,
        net_monthly: sc.netMonthly || 0,
        dti: sc.dti || 0,
        payback_years: sc.payback || 0,
        irr: exitMetrics.irr || 0,
        equity_multiple: exitMetrics.em || 0,
        loan: sc.loan || 0,
        pmt: sc.pmt || 0,
        total_interest: totalInterest,
        terminal_value: exitMetrics.tval || 0,
        net_proceeds: exitMetrics.npro || 0,
        capital_gain: exitMetrics.cgain || 0
      };
    }

    // State switching functions
    function showCalculatorSection() {
      document.querySelector('.layout').style.display = 'grid';
      document.getElementById('comparison-section').style.display = 'none';
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function showComparisonSection() {
      document.querySelector('.layout').style.display = 'none';
      document.getElementById('comparison-section').style.display = 'block';
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // Toggle comparison chart visibility
    let comparisonChartVisible = false;
    
    function toggleComparisonChart() {
      const container = document.getElementById('comparison-chart-container');
      const btn = document.getElementById('toggle-comparison-chart-btn');
      
      comparisonChartVisible = !comparisonChartVisible;
      
      if (comparisonChartVisible) {
        container.style.display = 'block';
        btn.textContent = 'Hide Chart';
        
        // Render chart if not already rendered
        const selected = getSelectedAssets();
        const scenario = document.querySelector('input[name="scenario"]:checked')?.value || 'base';
        if (selected.length >= 2) {
          setTimeout(() => {
            renderComparisonTimeline(selected, scenario);
          }, 100);
        }
      } else {
        container.style.display = 'none';
        btn.textContent = 'Show Chart';
      }
    }

    // Get selected assets for comparison
    function getSelectedAssets() {
      const checked = Array.from(document.querySelectorAll('input[name="compare"]:checked'));
      const assetIds = checked.map(cb => cb.value);
      return assetIds.map(id => savedAssets.find(a => a.id === id)).filter(Boolean);
    }

    // Main comparison handler
    function compareSelectedAssets() {
      try {
        const selected = getSelectedAssets();
        
        if (selected.length < 2 || selected.length > 3) {
          alert('Please select 2-3 assets to compare');
          return;
        }

        // Validate that all selected assets have valid results
        const invalidAssets = selected.filter(asset => 
          !asset.results || !asset.results.base || 
          typeof asset.results.base.net_yield !== 'number'
        );
        
        if (invalidAssets.length > 0) {
          alert(`Some assets have invalid data. Please recalculate: ${invalidAssets.map(a => a.name).join(', ')}`);
          return;
        }

        // Get current scenario
        const scenario = document.querySelector('input[name="scenario"]:checked')?.value || 'base';
        
        // Update count
        document.getElementById('compare-count').textContent = selected.length;
        
        // Show loading state
        document.getElementById('ai-recommendations').innerHTML = `
          <div class="rec-section">
            <h3>üí° Investment Insights</h3>
            <div class="rec-divider"></div>
            <p style="color: var(--muted); text-align: center; padding: 20px;">
              üîÑ Generating recommendations...
            </p>
          </div>
        `;
        
        // Reset chart visibility
        comparisonChartVisible = false;
        document.getElementById('comparison-chart-container').style.display = 'none';
        document.getElementById('toggle-comparison-chart-btn').textContent = 'Show Chart';
        
        // Switch to comparison view first
        showComparisonSection();
        
        // Generate comparison with slight delay for smooth UX
        setTimeout(() => {
          generateComparisonTable(selected, scenario);
          generateRecommendations(selected, scenario);
          // Don't render chart until user clicks "Show Chart"
        }, 100);
        
      } catch (error) {
        console.error('Error in compareSelectedAssets:', error);
        alert('An error occurred while comparing assets. Please try again.');
      }
    }

    // Debounce timer for scenario updates
    let updateTimer = null;
    
    // Update comparison when scenario changes
    function updateComparison() {
      // Clear existing timer
      if (updateTimer) {
        clearTimeout(updateTimer);
      }
      
      // Debounce updates to prevent rapid firing
      updateTimer = setTimeout(() => {
        try {
          const selected = getSelectedAssets();
          const scenario = document.querySelector('input[name="scenario"]:checked')?.value || 'base';
          
          if (selected.length >= 2) {
            generateComparisonTable(selected, scenario);
            generateRecommendations(selected, scenario);
            
            // Only update chart if it's visible
            if (comparisonChartVisible) {
              renderComparisonTimeline(selected, scenario);
            }
          }
        } catch (error) {
          console.error('Error in updateComparison:', error);
        }
      }, 150); // 150ms debounce
    }

    // Generate comparison table
    function generateComparisonTable(assets, scenario) {
      const table = document.getElementById('comparison-table');
      table.innerHTML = '';

      // Header row
      const thead = document.createElement('thead');
      const headerRow = document.createElement('tr');
      headerRow.innerHTML = `
        <th>Metric</th>
        ${assets.map((a, i) => `<th>${a.name}</th>`).join('')}
        <th>Best</th>
      `;
      thead.appendChild(headerRow);
      table.appendChild(thead);

      // Body
      const tbody = document.createElement('tbody');

      // Define metrics
      const metrics = [
        // KEY METRICS (9)
        { section: 'KEY METRICS' },
        { key: 'equity', label: 'Initial Investment', format: 'thb', best: 'min' },
        { key: 'gross_yield', label: 'Gross Yield', format: 'percent', best: 'max', status: true },
        { key: 'net_yield', label: 'Net Yield', format: 'percent', best: 'max', status: true },
        { key: 'coc_return', label: 'CoC Return', format: 'percent', best: 'max', status: true },
        { key: 'net_monthly', label: 'Net/Month', format: 'thb', best: 'max', status: true },
        { key: 'dti', label: 'DTI Ratio', format: 'percent', best: 'min', status: true },
        { key: 'payback_years', label: 'Payback Period', format: 'years', best: 'min', status: true },
        { key: 'irr', label: 'IRR', format: 'percent', best: 'max', status: true },
        { key: 'equity_multiple', label: 'Equity Multiple', format: 'multiple', best: 'max' },
        
        // AFFORDABILITY (3)
        { section: 'AFFORDABILITY' },
        { key: 'loan', label: 'Loan Amount', format: 'million', best: null },
        { key: 'pmt', label: 'Monthly Payment', format: 'thb', best: 'min' },
        { key: 'total_interest', label: 'Total Interest', format: 'million', best: 'min' },
        
        // EXIT (3)
        { section: 'EXIT (if enabled)' },
        { key: 'terminal_value', label: 'Terminal Value', format: 'million', best: null },
        { key: 'net_proceeds', label: 'Net Proceeds', format: 'million', best: 'max' },
        { key: 'capital_gain', label: 'Capital Gain', format: 'million', best: 'max' }
      ];

      metrics.forEach(metric => {
        if (metric.section) {
          // Section header
          const row = document.createElement('tr');
          row.className = 'section-header';
          row.innerHTML = `<td colspan="${assets.length + 2}"><strong>${metric.section}</strong></td>`;
          tbody.appendChild(row);
        } else {
          // Metric row
          const row = document.createElement('tr');
          
          // Metric label
          const labelCell = document.createElement('td');
          labelCell.textContent = metric.label;
          row.appendChild(labelCell);
          
          // Get values
          const values = assets.map(a => a.results[scenario][metric.key]);
          
          // Value cells
          values.forEach((val, i) => {
            const cell = document.createElement('td');
            cell.textContent = formatValue(val, metric.format);
            
            // Apply status class
            if (metric.status) {
              cell.className = getStatusClass(metric.key, val);
            }
            
            row.appendChild(cell);
          });
          
          // Best cell
          const bestCell = document.createElement('td');
          if (metric.best) {
            const bestIndex = findBestIndex(values, metric.best);
            if (bestIndex !== -1) {
              // Extract short name (first 2 words or first word if only one)
              const nameParts = assets[bestIndex].name.split(' ');
              const shortName = nameParts.length > 2 
                ? `${nameParts[0]} ${nameParts[1]}` 
                : assets[bestIndex].name;
              bestCell.innerHTML = `<strong>${shortName}</strong> üèÜ`;
              bestCell.style.color = 'var(--lime)';
            }
          } else {
            bestCell.textContent = '‚Äî';
          }
          row.appendChild(bestCell);
          
          tbody.appendChild(row);
        }
      });

      table.appendChild(tbody);
    }

    // Format value helper
    function formatValue(val, format) {
      // Check if value is not a finite number OR is exactly 0 (for exit metrics)
      if (!Number.isFinite(val) || val === 0) {
        // For exit metrics, show "‚Äî" if value is 0
        if (format === 'million' && val === 0) return '‚Äî';
        if (!Number.isFinite(val)) return '‚Äî';
      }
      
      switch (format) {
        case 'million':
          return (val / 1000000).toFixed(2) + 'M';
        case 'percent':
          return (val * 100).toFixed(1) + '%';
        case 'thb':
          return val.toLocaleString('th-TH', { maximumFractionDigits: 0 }) + ' ‡∏ø';
        case 'years':
          return val.toFixed(1) + 'y';
        case 'multiple':
          return val.toFixed(2) + 'x';
        default:
          return val.toString();
      }
    }

    // Get status class
    function getStatusClass(key, value) {
      if (!Number.isFinite(value)) return '';
      
      const thresholds = {
        gross_yield: { good: 0.06, warn: 0.04 },
        net_yield: { good: 0.06, warn: 0.04 },
        coc_return: { good: 0.08, warn: 0.05 },
        dti: { good: 0.30, warn: 0.40, inverse: true },
        payback_years: { good: 15, warn: 20, inverse: true },
        irr: { good: 0.10, warn: 0.06 },
        net_monthly: { good: 0, warn: -5000, inverse: false }
      };
      
      const t = thresholds[key];
      if (!t) return '';
      
      if (t.inverse) {
        if (value <= t.good) return 'good';
        if (value <= t.warn) return 'warn';
        return 'bad';
      } else {
        if (value >= t.good) return 'good';
        if (value >= t.warn) return 'warn';
        return 'bad';
      }
    }

    // Find best index
    function findBestIndex(values, direction) {
      const validValues = values.map((v, i) => ({ value: v, index: i }))
        .filter(v => Number.isFinite(v.value));
      
      if (validValues.length === 0) return -1;
      
      if (direction === 'max') {
        return validValues.reduce((max, v) => v.value > max.value ? v : max).index;
      } else {
        return validValues.reduce((min, v) => v.value < min.value ? v : min).index;
      }
    }

    // ========================================
    // TIMELINE CHART FUNCTIONS (Day 3)
    // ========================================

    let comparisonTimelineChart = null;

    // Crosshair plugin for Chart.js
    const crosshairPlugin = {
      id: 'crosshair',
      afterDraw: (chart) => {
        if (chart.tooltip?._active?.length) {
          const ctx = chart.ctx;
          const activePoint = chart.tooltip._active[0];
          const x = activePoint.element.x;
          const topY = chart.scales.y.top;
          const bottomY = chart.scales.y.bottom;

          // Draw vertical line
          ctx.save();
          ctx.beginPath();
          ctx.moveTo(x, topY);
          ctx.lineTo(x, bottomY);
          ctx.lineWidth = 1;
          ctx.strokeStyle = 'rgba(255, 255, 255, 0.2)';
          ctx.setLineDash([5, 5]);
          ctx.stroke();
          ctx.restore();

          // Draw intersection points on all datasets
          chart.data.datasets.forEach((dataset, i) => {
            const meta = chart.getDatasetMeta(i);
            if (!meta.hidden) {
              const point = meta.data[activePoint.index];
              if (point) {
                ctx.save();
                ctx.beginPath();
                ctx.arc(point.x, point.y, 6, 0, 2 * Math.PI);
                // No fill - transparent inside
                ctx.strokeStyle = dataset.borderColor;  // Border color matches dataset
                ctx.lineWidth = 3;  // Thicker border for visibility
                ctx.stroke();
                ctx.restore();
              }
            }
          });
        }
      }
    };

    // Rank assets by Net Yield and assign colors
    function rankAssetsByNetYield(assets, scenario) {
      const ranked = [...assets].sort((a, b) => 
        b.results[scenario].net_yield - a.results[scenario].net_yield
      );
      
      const colors = ['#22c55e', '#f59e0b', '#ef4444']; // Green, Orange, Red
      ranked.forEach((asset, i) => {
        asset.chartColor = colors[i];
        asset.rank = i === 0 ? 'Best' : (i === 1 ? 'Mid' : 'Worst');
      });
      
      return ranked;
    }

    // Generate timeline data for asset
    function generateTimelineData(asset, scenario) {
      const inputs = asset.inputs;
      const results = asset.results[scenario];
      
      const purchase = inputs.purchase_price;
      const rent = inputs.monthly_rent * (scenario === 'low' ? 0.9 : scenario === 'high' ? 1.1 : 1.0);
      const downPct = inputs.down_payment_pct / 100;
      const equity = purchase * downPct;
      const loan = purchase - equity;
      const rate = inputs.interest_rate_annual / 100 / 12;
      const tenor = inputs.loan_tenor_years;
      const pmt = PMT(rate, tenor, loan);
      
      const occ = inputs.occupancy_rate / 100;
      const opex = inputs.opex_rate / 100;
      const agentMonths = inputs.agent_fee_months;
      
      const rentEffective = rent * occ;
      const agentFee = rent * (agentMonths / 12);
      const opexCost = rent * opex;
      const noiMonthly = rentEffective - agentFee - opexCost;
      const netMonthly = noiMonthly - pmt;
      const netAnnual = netMonthly * 12;
      
      const growthRate = inputs.price_growth_pct / 100;
      const annualPrincipal = (pmt * 12) * 0.45;
      
      const netWorth = [];
      const propertyValue = [];
      
      let cumulativeCF = -equity;
      let loanBalance = loan;
      
      for (let year = 0; year <= 30; year++) {
        if (year === 0) {
          netWorth.push(-equity);
          propertyValue.push(purchase);
          continue;
        }
        
        cumulativeCF += netAnnual;
        
        if (year <= tenor) {
          loanBalance = Math.max(0, loanBalance - annualPrincipal);
        } else {
          loanBalance = 0;
        }
        
        const propValue = purchase * Math.pow(1 + growthRate, year);
        const currentEquity = propValue - loanBalance;
        
        let nw = cumulativeCF + currentEquity;
        
        // Exit handling
        if (inputs.exit_enabled && year === inputs.holding_years) {
          const sellingCost = propValue * 0.03;
          const netProceeds = propValue - loanBalance - sellingCost;
          nw = cumulativeCF + netProceeds;
        }
        
        netWorth.push(nw);
        propertyValue.push(propValue);
      }
      
      return { netWorth, propertyValue };
    }

    // Render comparison timeline chart
    function renderComparisonTimeline(assets, scenario) {
      if (!assets || assets.length < 2) return;
      
      // Rank assets and assign colors
      const ranked = rankAssetsByNetYield(assets, scenario);
      
      // Get chart mode
      const mode = document.querySelector('input[name="chart-mode"]:checked')?.value || 'networth';
      
      // Generate datasets
      const datasets = ranked.map(asset => {
        const timelineData = generateTimelineData(asset, scenario);
        
        return {
          label: `${asset.name} (${asset.rank})`,
          data: mode === 'networth' ? timelineData.netWorth : timelineData.propertyValue,
          borderColor: asset.chartColor,
          borderWidth: asset.rank === 'Best' ? 4 : 3,
          tension: 0.4,
          fill: false,
          pointRadius: 0,
          pointHoverRadius: 6
        };
      });
      
      // Generate annotations
      const annotations = {};
      
      // Payback markers (only in networth mode)
      if (mode === 'networth') {
        ranked.forEach((asset, i) => {
          const payback = asset.results[scenario].payback_years;
          if (payback && payback <= 30) {
            const timelineData = generateTimelineData(asset, scenario);
            const yValue = timelineData.netWorth[Math.round(payback)];
            
            annotations[`payback-${i}`] = {
              type: 'point',
              xValue: payback,
              yValue: yValue,
              backgroundColor: asset.chartColor,
              radius: 8,
              borderWidth: 2,
              borderColor: 'white'
            };
          }
        });
      }
      
      // Track labels by year to detect collisions
      const exitLabelsByYear = {};
      const paidOffLabelsByYear = {};
      
      // Exit lines (vertical dashed) - per asset with matching colors
      // RANK-BASED POSITIONING (Best at top, Worst at bottom)
      ranked.forEach((asset, i) => {
        if (asset.inputs.exit_enabled) {
          const year = asset.inputs.holding_years;
          
          // Use rank-based offset for consistent positioning in upper area
          // Best = 0 (top), Mid = 1 (middle), Worst = 2 (bottom)
          const rankOffset = i; // i is already 0, 1, 2 based on ranking
          
          // Calculate yAdjust based on rank (in upper area of chart)
          // position: 'end' = top of line, positive yAdjust = move up
          // Best has smallest offset (closest to top)
          const yAdjust = 10 + (rankOffset * 28);
          
          annotations[`exit-${asset.id}-${year}`] = {
            type: 'line',
            xMin: year,
            xMax: year,
            borderColor: asset.chartColor,
            borderWidth: 2,
            borderDash: [5, 5],
            label: {
              display: true,
              content: `Exit: ${year}Y`,
              position: 'end',
              yAdjust: yAdjust,
              backgroundColor: asset.chartColor,
              color: 'white',
              font: {
                size: 10,
                weight: 'bold'
              },
              padding: 4
            }
          };
        }
      });

      // Loan Paid Off lines (vertical dashed) - per asset with matching colors
      // WITH COLLISION DETECTION
      ranked.forEach((asset, i) => {
        // Check if Financing switch is enabled
        if (asset.switches?.financing_adv) {
          const tenor = asset.inputs.loan_tenor_years;
          if (tenor && tenor <= 30) {
            // Count how many labels at this year
            if (!paidOffLabelsByYear[tenor]) paidOffLabelsByYear[tenor] = 0;
            const offset = paidOffLabelsByYear[tenor];
            paidOffLabelsByYear[tenor]++;
            
            // Calculate yAdjust based on offset (stack in upper area)
            // position: 'end' = top of line, positive yAdjust = move up
            // Stack downwards: first label closest to top
            const yAdjust = 10 + (offset * 28);
            
            annotations[`loan-paid-${asset.id}-${tenor}`] = {
              type: 'line',
              xMin: tenor,
              xMax: tenor,
              borderColor: asset.chartColor,
              borderWidth: 1.5,
              borderDash: [3, 3],
              label: {
                display: true,
                content: `Paid off: ${tenor}Y`,
                position: 'end',
                yAdjust: yAdjust,
                backgroundColor: asset.chartColor,
                color: 'white',
                font: {
                  size: 9,
                  weight: '600'
                },
                padding: 4
              }
            };
          }
        }
      });
      
      // Create/update chart
      const canvas = document.getElementById('comparison-timeline-chart');
      if (!canvas) return;
      
      const ctx = canvas.getContext('2d');
      
      if (comparisonTimelineChart) {
        comparisonTimelineChart.destroy();
      }
      
      comparisonTimelineChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: Array.from({ length: 31 }, (_, i) => i),
          datasets: datasets
        },
        plugins: [crosshairPlugin],
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            mode: 'index',
            intersect: false
          },
          plugins: {
            legend: {
              display: true,
              position: 'top',
              align: 'start',
              labels: {
                color: '#e9eef3',
                font: {
                  size: 13,
                  weight: '600'
                },
                usePointStyle: false,
                padding: 15,
                boxWidth: 40,
                boxHeight: 3
              }
            },
            tooltip: {
              mode: 'index',
              intersect: false,
              backgroundColor: 'rgba(18, 22, 28, 0.95)',
              titleColor: '#b2df37',
              borderColor: 'rgba(255, 255, 255, 0.08)',
              borderWidth: 1,
              padding: 12,
              displayColors: true,
              usePointStyle: true,
              callbacks: {
                title: (items) => `Year ${items[0].label}`,
                labelTextColor: (context) => {
                  // Return the color of the dataset (asset color)
                  return context.dataset.borderColor;
                },
                label: (context) => {
                  const valueM = (context.parsed.y / 1000000).toFixed(2);
                  return `${context.dataset.label}: ${valueM}M ‡∏ø`;
                }
              }
            },
            annotation: {
              annotations: annotations
            }
          },
          scales: {
            x: {
              title: {
                display: true,
                text: 'Years',
                color: '#a7b0bb'
              },
              grid: {
                color: 'rgba(255, 255, 255, 0.05)'
              },
              ticks: {
                color: '#a7b0bb'
              }
            },
            y: {
              title: {
                display: true,
                text: mode === 'networth' ? 'Net Worth (‡∏ø)' : 'Property Value (‡∏ø)',
                color: '#a7b0bb'
              },
              grid: {
                color: 'rgba(255, 255, 255, 0.05)'
              },
              ticks: {
                color: '#a7b0bb',
                callback: (value) => {
                  return (value / 1000000).toFixed(1) + 'M';
                }
              }
            }
          }
        }
      });
      
      // Update scenario indicator
      document.getElementById('current-scenario-chart').textContent = scenario.toUpperCase();

      // Update payback legend
      const legendContainer = document.getElementById('comparison-payback-legend');
      const legendItems = document.getElementById('comparison-payback-items');
      
      if (mode === 'networth') {
        let hasPayback = false;
        let html = '';
        
        ranked.forEach(asset => {
          const payback = asset.results[scenario].payback_years;
          if (payback && payback <= 30) {
            hasPayback = true;
            html += `<span style="color: ${asset.chartColor};">‚óè ${asset.name}: ${payback.toFixed(1)} years</span>`;
          }
        });
        
        if (hasPayback) {
          legendItems.innerHTML = html;
          legendContainer.style.display = 'block';
        } else {
          legendContainer.style.display = 'none';
        }
      } else {
        legendContainer.style.display = 'none';
      }

      // Update Exit & Loan Paid Off legend
      const milestonesContainer = document.getElementById('comparison-milestones-legend');
      const exitSection = document.getElementById('comparison-exit-section');
      const exitItems = document.getElementById('comparison-exit-items');
      const loanSection = document.getElementById('comparison-loan-section');
      const loanItems = document.getElementById('comparison-loan-items');
      
      let hasExit = false;
      let hasLoan = false;
      let exitHtml = '';
      let loanHtml = '';
      
      ranked.forEach(asset => {
        // Exit points
        if (asset.inputs.exit_enabled) {
          hasExit = true;
          const year = asset.inputs.holding_years;
          exitHtml += `<span style="color: ${asset.chartColor};">‚óè ${asset.name}: Year ${year}</span>`;
        }
        
        // Loan paid off
        if (asset.switches?.financing_adv) {
          const tenor = asset.inputs.loan_tenor_years;
          if (tenor && tenor <= 30) {
            hasLoan = true;
            loanHtml += `<span style="color: ${asset.chartColor};">‚óè ${asset.name}: Year ${tenor}</span>`;
          }
        }
      });
      
      if (hasExit) {
        exitItems.innerHTML = exitHtml;
        exitSection.style.display = 'block';
      } else {
        exitSection.style.display = 'none';
      }
      
      if (hasLoan) {
        loanItems.innerHTML = loanHtml;
        loanSection.style.display = 'block';
      } else {
        loanSection.style.display = 'none';
      }
      
      if (hasExit || hasLoan) {
        milestonesContainer.style.display = 'block';
      } else {
        milestonesContainer.style.display = 'none';
      }
    }

    // Update chart when mode or scenario changes
    function updateComparisonChart() {
      const scenario = document.querySelector('input[name="scenario"]:checked')?.value || 'base';
      const selected = getSelectedAssets();
      
      if (selected.length >= 2) {
        renderComparisonTimeline(selected, scenario);
      }
    }

    // ========================================
    // AI RECOMMENDATIONS (Day 4)
    // ========================================

    function generateRecommendations(assets, scenario) {
      const ranked = [...assets].sort((a, b) => 
        b.results[scenario].net_yield - a.results[scenario].net_yield
      );
      
      const best = ranked[0];
      const results = best.results[scenario];
      
      let html = `
        <div class="rec-section">
          <h3>üí° Investment Insights (${scenario.toUpperCase()} Scenario)</h3>
          <div class="rec-divider"></div>
        </div>
      `;
      
      // Best Overall
      html += `
        <div class="rec-item">
          <strong>üèÜ Best Overall:</strong> ${best.name}
          <ul>
            <li>Net Yield: ${(results.net_yield * 100).toFixed(1)}%</li>
            <li>Payback: ${results.payback_years?.toFixed(1) || '‚Äî'} years</li>
            <li>CoC Return: ${(results.coc_return * 100).toFixed(1)}%</li>
          </ul>
        </div>
      `;
      
      // Lowest Entry Cost
      const lowestEntry = [...assets].sort((a, b) => 
        a.results[scenario].equity - b.results[scenario].equity
      )[0];
      
      if (lowestEntry.id !== best.id) {
        html += `
          <div class="rec-item">
            <strong>üí∞ Lowest Entry Cost:</strong> ${lowestEntry.name}
            <ul>
              <li>Equity Required: ${(lowestEntry.results[scenario].equity / 1000000).toFixed(2)}M ‡∏ø</li>
            </ul>
          </div>
        `;
      }
      
      // Risk Warnings
      const highDTI = assets.filter(a => a.results[scenario].dti > 0.30);
      if (highDTI.length > 0) {
        html += `
          <div class="rec-item rec-warning">
            <strong>‚ö†Ô∏è DTI Risk Warning:</strong>
            <ul>
              ${highDTI.map(a => `<li>${a.name}: ${(a.results[scenario].dti * 100).toFixed(1)}% (>30%)</li>`).join('')}
            </ul>
          </div>
        `;
      }
      
      // Long-term Growth (if exit enabled)
      const exitAssets = assets.filter(a => a.inputs.exit_enabled);
      if (exitAssets.length > 0) {
        const bestIRR = [...exitAssets].sort((a, b) => 
          b.results[scenario].irr - a.results[scenario].irr
        )[0];
        
        html += `
          <div class="rec-item">
            <strong>üìà Best Long-term Growth:</strong> ${bestIRR.name}
            <ul>
              <li>IRR: ${(bestIRR.results[scenario].irr * 100).toFixed(1)}%</li>
              <li>Equity Multiple: ${bestIRR.results[scenario].equity_multiple?.toFixed(2)}x</li>
            </ul>
          </div>
        `;
      }
      
      // Summary
      html += `
        <div class="rec-section">
          <div class="rec-divider"></div>
          <p style="font-size: 13px; color: var(--muted); margin: 0;">
            üí° <strong>Tip:</strong> Switch between Low/Base/High scenarios to see how market conditions affect your investments.
          </p>
        </div>
      `;
      
      document.getElementById('ai-recommendations').innerHTML = html;
    }

  </script>

  <!-- Save Asset Modal (v7) -->
  <div id="save-asset-modal" class="modal">
    <div class="modal-content">
      <h2>üíæ Save Asset</h2>
      <div class="modal-field">
        <label>Asset Name:</label>
        <input type="text" id="asset-name-input" placeholder="Asset 4.0M" autocomplete="off">
        <div class="modal-hint">Leave blank for auto-name (e.g., "Asset 4.0M @ 6.0%")</div>
      </div>
      <div class="modal-field">
        <label class="checkbox-label">
          <input type="checkbox" id="use-in-comparison-checkbox" checked>
          <span>Add to comparison immediately</span>
        </label>
      </div>
      <div class="modal-actions">
        <button class="btn-primary" onclick="saveAndNew()">Save & New</button>
        <button class="btn-secondary" onclick="closeSaveAssetModal()">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Switch Asset Modal (v7) -->
  <div id="switch-asset-modal" class="modal">
    <div class="modal-content">
      <h2>üíæ Save Current Asset?</h2>
      <div class="modal-field">
        <label>Asset Name:</label>
        <input type="text" id="switch-asset-name-input" placeholder="Asset 5.0M" autocomplete="off">
        <div class="modal-hint">Leave blank for auto-name</div>
      </div>
      <div class="modal-field">
        <label class="checkbox-label">
          <input type="checkbox" id="switch-use-comparison-checkbox" checked>
          <span>Add to comparison immediately</span>
        </label>
      </div>
      <div class="modal-actions">
        <button class="btn-primary" onclick="saveAndSwitch()">Save & Switch</button>
        <button class="btn-secondary" onclick="discardAndSwitch()">Discard</button>
        <button class="btn-secondary" onclick="closeSwitchModal()">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Comparison Section (v7 - hidden by default) -->
  <div id="comparison-section">
    <div class="card">
      <h2>üìä Asset Comparison</h2>
      <p style="color: var(--muted); margin-top: 8px;">
        Comparison table, timeline chart, and AI recommendations will appear here (Day 2).
      </p>
      <button onclick="showCalculatorSection()" style="margin-top: 16px; background: var(--border); color: var(--text); 
                     padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer;">
        ‚Üê Back to Calculator
      </button>
    </div>
  </div>

</body>

</html>