<!doctype html><html lang="th"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>PY‑D (PropYield‑D) — Property Investment Tool · v5d (controls under Basic)</title>
<style>
:root { --bg:#0b0e13;--card:#12161c;--text:#e9eef3;--muted:#a7b0bb;
  --lime:#b2df37;--teal:#15d4cf;--warn:#f59e0b;--bad:#ef4444;--good:#22c55e;
  --border:rgba(255,255,255,.08);--shadow:0 10px 30px rgba(0,0,0,.35);--radius:16px }
*{box-sizing:border-box} html,body{margin:0;background:var(--bg);color:var(--text);
  font:15px/1.6 Inter,system-ui,Segoe UI,Arial}
h1,h2{margin:0 0 8px} h1{font-size:28px} h2{font-size:20px}
.wrap{max-width:1200px;margin:0 auto;padding:18px}
.topbar{display:flex;gap:12px;align-items:center;margin:6px 0 14px}
.badge{padding:6px 10px;border:1px solid var(--border);border-radius:999px;color:var(--lime);
  background:rgba(178,223,55,.12);font-size:12px}
.grid{display:grid;gap:16px}
.card{background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,.0));
  border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:var(--shadow)}
.layout{display:grid;gap:16px} @media(min-width:1024px){.layout{grid-template-columns:1.05fr .95fr}}
label{display:block;font-weight:600;margin:6px 0 6px}
input[type=number],select{width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--border);
  background:#0f1418;color:var(--text)}
input.err{border-color:var(--bad)}
.help{color:var(--muted);font-size:12px}
.row{display:grid;gap:12px} .row-2{grid-template-columns:repeat(2,minmax(0,1fr))}
.row-3{grid-template-columns:repeat(3,minmax(0,1fr))}
.kpi{font-size:26px;font-weight:800} .kpi-sub{font-size:12px;color:var(--muted)}
.kval{font-variant-numeric:tabular-nums}
.kval.good{color:var(--good)} .kval.warn{color:var(--warn)} .kval.bad{color:var(--bad)}
.small{font-size:12px;color:var(--muted)}
.adv-btn{appearance:none;border:1px solid var(--border);background:#0f1418;
  color:var(--text);padding:8px 12px;border-radius:10px;cursor:pointer}
.controls{display:flex;align-items:center;gap:10px;justify-content:flex-start;margin-top:10px}
.controls .spacer{flex:1}
.controls .small{opacity:.9}
.adv-box{display:none;margin-top:10px;padding:12px;border-radius:12px;background:#151a20;border:1px solid var(--border)}
.footer{opacity:.7;margin:24px 0 40px}
.sep{height:1px;background:var(--border);margin:8px 0}
.table-like{display:grid;grid-template-columns:1fr auto;gap:6px}
.pill{display:inline-block;padding:6px 10px;border-radius:999px;border:1px solid transparent;
  font-size:12px;margin:4px 6px 0 0;font-weight:700}
.pill.good{background:#163d2a;color:#7ef6a9;border-color:#235f40}
.pill.warn{background:#3e2f0f;color:#ffd579;border-color:#6b5418}
.pill.bad{background:#4a1714;color:#ffb4ab;border-color:#7d2b27}
/* Scenarios */
.scenario{border:1px solid var(--border);border-radius:12px;padding:12px;cursor:pointer;user-select:none}
.scenario.active{outline:2px solid var(--teal)}
.sc-low{background:rgba(245,158,11,.08)} .sc-base{background:rgba(21,212,207,.08)} .sc-high{background:rgba(34,197,94,.08)}
.sc-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;font-weight:800}
.sc-metric{display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px dashed var(--border);font-size:13px}
.sc-metric:last-child{border-bottom:none}
.sc-val{font-variant-numeric:tabular-nums}
.sc-val.good{color:var(--good)} .sc-val.warn{color:var(--warn)} .sc-val.bad{color:var(--bad)}
.sc-desktop{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px}
.seg{display:none}@media(max-width:1023px){.seg{display:flex;gap:6px} .seg button{flex:1;padding:8px;border-radius:10px;border:1px solid var(--border);background:#0f1418;color:var(--text)} .seg .active{border-color:var(--teal)} .sc-desktop{display:none}}
.status-card{display:flex;flex-wrap:wrap;gap:6px}
/* Side switch */
.switch {position:relative; display:inline-block; width:42px; height:24px; vertical-align:middle}
.switch input {opacity:0; width:0; height:0}
.slider {position:absolute; cursor:pointer; top:0; left:0; right:0; bottom:0; background:#25303a; transition:.2s; border-radius:999px; border:1px solid var(--border)}
.slider:before {position:absolute; content:""; height:18px; width:18px; left:3px; bottom:3px; background:white; transition:.2s; border-radius:50%}
.switch input:checked + .slider {background:#165e56}
.switch input:checked + .slider:before {transform:translateX(18px)}
.panel-head {display:flex; justify-content:space-between; align-items:center; gap:8px}
.badge-on {padding:4px 8px; border-radius:999px; background:#17332c; color:#7ef6a9; font-size:11px; border:1px solid #265a47}
.dim {opacity:.6}
</style></head>
<body><div class="wrap">
  <div class="topbar"><div><div class="badge">PY‑D (PropYield‑D)</div><h1>Property Investment Tool</h1></div></div>

  <div class="layout">
    <!-- LEFT -->
    <div class="grid">

      <!-- Investment -->
      <div class="card">
        <div class="panel-head"><h2>Investment</h2></div>
        <div class="row row-3">
          <div><label>Purchase Price (THB)</label><input type="number" id="purchase" placeholder="เช่น 4,000,000" inputmode="decimal"/></div>
          <div><label>Avg / sqm (THB)</label><input type="number" id="avgpsm" placeholder="เช่น 120,000" inputmode="decimal"/></div>
          <div><label>Area (sqm)</label><input type="number" id="area" placeholder="เช่น 35" inputmode="decimal"/></div>
        </div>
        <div class="controls">
          <button class="adv-btn" data-target="#adv-invest">Show / Hide details</button>
          <div class="spacer"></div>
          <span class="small">Include in calc</span>
          <label class="switch"><input type="checkbox" id="swInv"><span class="slider"></span></label>
        </div>
        <div id="adv-invest" class="adv-box">
          <div class="row row-3">
            <div>
              <label>Acquisition Cost (%)</label><input type="number" id="acq_pct" value="3" inputmode="decimal"/>
              <div class="help">≈ <span id="acq_thb">—</span> THB</div>
            </div>
            <div><label>Fit‑out (THB)</label><input type="number" id="fitout" value="0" inputmode="decimal"/></div>
            <div><label>Other Costs (THB)</label><input type="number" id="other" value="0" inputmode="decimal"/></div>
          </div>
          <div class="small">สวิตช์ “Include in calc” เปิด: จะบวก Acq/Fit‑out/Other เข้าต้นทุน (Cost basis)</div>
        </div>
      </div>

      <!-- Revenue -->
      <div class="card">
        <div class="panel-head"><h2>Revenue</h2></div>
        <div class="row row-2">
          <div>
            <label>Rent / month (THB)</label>
            <input type="number" id="rent" placeholder="เช่น 20,000" inputmode="decimal"/>
            <div class="help">two‑way with Target Gross Yield · base = Purchase</div>
          </div>
          <div>
            <label>Target Gross Yield (%)</label>
            <input type="number" id="tgt_gross" placeholder="เช่น 5.0" inputmode="decimal"/>
          </div>
        </div>
        <div class="controls">
          <button class="adv-btn" data-target="#adv-rev">Show / Hide details</button>
          <div class="spacer"></div>
          <span class="small">Include in calc</span>
          <label class="switch"><input type="checkbox" id="swRev"><span class="slider"></span></label>
        </div>
        <div id="adv-rev" class="adv-box">
          <div class="row row-3">
            <div>
              <label>Occupancy (%)</label><input type="number" id="occ" value="90" inputmode="decimal"/>
              <div class="help">Effective rent ≈ <span id="occ_eff">—</span> THB/mo</div>
            </div>
            <div>
              <label>Opex (%) (incl. common fee)</label><input type="number" id="opex" value="15" inputmode="decimal"/>
              <div class="help">Total opex ≈ <span id="opex_thb">—</span> THB/mo</div>
            </div>
            <div>
              <label>Agent Fee (months/yr)</label><input type="number" id="agentm" value="1" inputmode="decimal"/>
              <div class="help">≈ <span id="agent_thb">—</span> THB/mo</div>
            </div>
          </div>
          <div class="small">สวิตช์ “Include in calc” เปิด: ใช้ Occ/Opex/Agent; ปิด: ใช้ neutral baseline (100%/0%/0)</div>
        </div>
      </div>

      <!-- Financing -->
      <div class="card">
        <div class="panel-head"><h2>Financing</h2></div>
        <div class="row row-2">
          <div><label>Gross Salary (THB/mo)</label><input type="number" id="salary" placeholder="เช่น 70,000" inputmode="decimal"/></div>
          <div><label>Down Payment (%)</label><input type="number" id="down" value="10" inputmode="decimal"/></div>
        </div>
        <div class="controls">
          <button class="adv-btn" data-target="#adv-fin">Show / Hide details</button>
          <div class="spacer"></div>
          <span class="small">Include in calc</span>
          <label class="switch"><input type="checkbox" id="swFin"><span class="slider"></span></label>
        </div>
        <div id="adv-fin" class="adv-box">
          <div class="row row-3">
            <div><label>Interest (APR %)</label><input type="number" id="rate" value="4.5" inputmode="decimal"/></div>
            <div><label>Tenor (years)</label>
              <select id="tenor"><option value="30" selected>30</option><option value="25">25</option><option value="20">20</option></select>
            </div>
            <div>
              <label>Equity Invested (auto)</label>
              <div id="equity_box" class="help">—</div>
            </div>
          </div>
          <div class="sep"></div>
          <div class="table-like small">
            <div>Down on Purchase</div><div id="eq_down">—</div>
            <div>Acquisition Costs</div><div id="eq_acq">—</div>
            <div>Fit‑out + Other</div><div id="eq_fo">—</div>
          </div>
          <div class="small">สวิตช์ “Include in calc” เปิด: ใช้ APR/Tenor ตามฟิลด์; ปิด: ใช้ neutral baseline APR 4.5%, 30y</div>
        </div>
      </div>

      <!-- Exit -->
      <div class="card">
        <div class="panel-head"><h2>Exit (optional)</h2></div>
        <div><input type="checkbox" id="exit_on"/> รวม Exit ในสรุปผล</div>
        <div class="row row-3" style="margin-top:10px">
          <div><label>Holding (yrs)</label><input type="number" id="hold" placeholder="เช่น 5" inputmode="decimal"/></div>
          <div><label>Price growth (%/yr)</label><input type="number" id="pgrow" placeholder="เช่น 3" inputmode="decimal"/></div>
          <div><label>Selling cost (%)</label><input type="number" id="sellc" value="3" inputmode="decimal"/></div>
        </div>
        <div class="controls">
          <button class="adv-btn" data-target="#adv-exit">Show / Hide details</button>
          <div class="spacer"></div>
          <span class="small">Include in calc</span>
          <label class="switch"><input type="checkbox" id="swExit"><span class="slider"></span></label>
        </div>
        <div id="adv-exit" class="adv-box">
          <div class="row row-3">
            <div><label>Exit Mode</label>
              <select id="exit_mode"><option value="auto" selected>Auto (growth-driven)</option><option value="manual">Manual price</option></select>
            </div>
            <div><label>Manual Exit Price (THB)</label><input type="number" id="exit_price" value="0" inputmode="decimal"/></div>
            <div><label>Capital Gain Tax % (optional)</label><input type="number" id="tax_pct" value="0" inputmode="decimal"/></div>
          </div>
          <div class="small">สวิตช์ “Include in calc” เปิด: ใช้ Exit Mode/Tax; ปิด: ใช้เฉพาะ Basic (Holding/Growth/Sell cost)</div>
        </div>
      </div>

    </div>

    <!-- RIGHT -->
    <div class="grid">

      <!-- Status -->
      <div class="card">
        <h2>Status</h2>
        <div id="status_pills" class="status-card"></div>
      </div>

      <!-- Scenarios -->
      <div class="card">
        <h2>Scenario Analysis</h2>
        <div class="seg">
          <button id="seg-low">Low</button><button id="seg-base" class="active">Base</button><button id="seg-high">High</button>
        </div>
        <div class="sc-desktop">
          <div class="scenario sc-low" id="card-low">
            <div class="sc-head"><span>Low (−10%)</span><span id="rent_low">—</span></div>
            <div class="sc-metric"><span>Net Yield</span><span id="ny_low" class="sc-val">—</span></div>
            <div class="sc-metric"><span>Cash Flow / mo</span><span id="cf_low" class="sc-val">—</span></div>
            <div class="sc-metric"><span>DTI</span><span id="dti_low" class="sc-val">—</span></div>
            <div class="sc-metric"><span>Payback (yrs)</span><span id="pb_low" class="sc-val">—</span></div>
            <div class="sc-metric"><span>CoC</span><span id="coc_low" class="sc-val">—</span></div>
          </div>
          <div class="scenario sc-base active" id="card-base">
            <div class="sc-head"><span>Base (0%)</span><span id="rent_base">—</span></div>
            <div class="sc-metric"><span>Net Yield</span><span id="ny_base" class="sc-val">—</span></div>
            <div class="sc-metric"><span>Cash Flow / mo</span><span id="cf_base" class="sc-val">—</span></div>
            <div class="sc-metric"><span>DTI</span><span id="dti_base" class="sc-val">—</span></div>
            <div class="sc-metric"><span>Payback (yrs)</span><span id="pb_base" class="sc-val">—</span></div>
            <div class="sc-metric"><span>CoC</span><span id="coc_base" class="sc-val">—</span></div>
          </div>
          <div class="scenario sc-high" id="card-high">
            <div class="sc-head"><span>High (+10%)</span><span id="rent_high">—</span></div>
            <div class="sc-metric"><span>Net Yield</span><span id="ny_high" class="sc-val">—</span></div>
            <div class="sc-metric"><span>Cash Flow / mo</span><span id="cf_high" class="sc-val">—</span></div>
            <div class="sc-metric"><span>DTI</span><span id="dti_high" class="sc-val">—</span></div>
            <div class="sc-metric"><span>Payback (yrs)</span><span id="pb_high" class="sc-val">—</span></div>
            <div class="sc-metric"><span>CoC</span><span id="coc_high" class="sc-val">—</span></div>
          </div>
        </div>
      </div>

      <!-- Key Metrics -->
      <div class="card">
        <h2>Key Metrics</h2>
        <div class="row row-3">
          <div><div class="kpi kval" id="gross">—</div><div class="kpi-sub">Gross Yield</div></div>
          <div><div class="kpi kval" id="net">—</div><div class="kpi-sub">Net Yield (unlevered)</div></div>
          <div><div class="kpi kval" id="coc">—</div><div class="kpi-sub">CoC Return</div></div>
        </div>
        <div class="row row-3" style="margin-top:10px">
          <div><div class="kpi kval" id="netmo">—</div><div class="kpi-sub">Net / month (after debt or NOI if Financing off)</div></div>
          <div><div class="kpi kval" id="pmt">—</div><div class="kpi-sub">PMT / month</div></div>
          <div><div class="kpi kval" id="dti">—</div><div class="kpi-sub">DTI</div></div>
        </div>
        <div class="row row-3" style="margin-top:10px">
          <div><div class="kpi kval" id="payback">—</div><div class="kpi-sub">Payback (yrs)</div></div>
          <div><div class="kpi kval" id="irr">—</div><div class="kpi-sub">IRR (Exit ON)</div></div>
          <div><div class="kpi kval" id="emult">—</div><div class="kpi-sub">Equity Multiple</div></div>
        </div>
      </div>

      <!-- Affordability -->
      <div class="card">
        <h2>Affordability</h2>
        <div class="row row-3">
          <div><div class="kpi" id="loan_amt">—</div><div class="kpi-sub">Loan Amount</div></div>
          <div><div class="kpi" id="pmt2">—</div><div class="kpi-sub">Monthly Payment</div></div>
          <div><div class="kpi" id="tot_int">—</div><div class="kpi-sub">Total Interest</div></div>
        </div>
        <div id="aff_warn" class="small" style="margin-top:8px">—</div>
      </div>

      <!-- Exit Summary -->
      <div class="card">
        <h2>Exit Summary</h2>
        <div class="row row-3">
          <div><div class="kpi" id="tval">—</div><div class="kpi-sub">Terminal Value</div></div>
          <div><div class="kpi" id="npro">—</div><div class="kpi-sub">Net Proceeds</div></div>
          <div><div class="kpi" id="cgain">—</div><div class="kpi-sub">Capital Gain</div></div>
        </div>
      </div>

      <!-- AI Note -->
      <div class="card">
        <h2>AI Note:</h2>
        <div id="ai_note" class="small">—</div>
      </div>

    </div>
  </div>

  <div class="footer small">©2025 PropYield‑D. Prototype v5d (controls under Basic, side‑switch, neutral baseline, blank Basic)</div>
</div>

<script>
function clamp(v,min,max){return Math.min(Math.max(v,min),max);}
function n(v){const x=Number(v); return Number.isFinite(x)? x : NaN;}
function thb(nu){return Number.isFinite(nu)? nu.toLocaleString('th-TH',{maximumFractionDigits:0})+' ฿':'—';}
function pct(nu){return Number.isFinite(nu)? (nu*100).toFixed(1)+'%':'—';}
const el=(id)=>document.getElementById(id);

const E={purchase:el('purchase'), avgpsm:el('avgpsm'), area:el('area'),
          acq:el('acq_pct'), fit:el('fitout'), other:el('other'),
          rent:el('rent'), tgt_gross:el('tgt_gross'),
          occ:el('occ'), opex:el('opex'), agentm:el('agentm'),
          salary:el('salary'), down:el('down'), rate:el('rate'), tenor:el('tenor'),
          exit_on:el('exit_on'), hold:el('hold'), pgrow:el('pgrow'), sellc:el('sellc'),
          exit_mode:el('exit_mode'), exit_price:el('exit_price'), tax_pct:el('tax_pct'),
          swInv:el('swInv'), swRev:el('swRev'), swFin:el('swFin'), swExit:el('swExit')};

const O={gross:el('gross'), net:el('net'), coc:el('coc'), dti:el('dti'),
          netmo:el('netmo'), pmt:el('pmt'), payback:el('payback'),
          tval:el('tval'), npro:el('npro'), cgain:el('cgain'),
          irr:el('irr'), emult:el('emult'),
          loan_amt:el('loan_amt'), pmt2:el('pmt2'), tot_int:el('tot_int'), aff_warn:el('aff_warn')};

const H={acq_thb:el('acq_thb'), occ_eff:el('occ_eff'), opex_thb:el('opex_thb'), agent_thb:el('agent_thb')};
const ai = el('ai_note');
let activeScenario = 'base';

document.querySelectorAll('.adv-btn').forEach(btn => {
  btn.addEventListener('click', ()=>{ const t=document.querySelector(btn.dataset.target);
    t.style.display = (t.style.display==='none' || t.style.display==='') ? 'block' : 'none'; recalc(); });
});

['swInv','swRev','swFin','swExit'].forEach(id=>{ const s=E[id]; s.addEventListener('change', ()=>recalc()); });

function setErr(node, bad, msg=''){ if(!node) return; node.classList.toggle('err', !!bad); if(bad && msg) node.title=msg; else node.removeAttribute('title'); }

// Investment two-way (Purchase ↔ Avg/sqm ↔ Area)
['purchase','avgpsm','area'].forEach(id=>{
  E[id].addEventListener('input', ()=>{ twoWayInvestment(); recalc(); });
  E[id].addEventListener('change', ()=>{ twoWayInvestment(); recalc(); });
});
function twoWayInvestment(){
  const P=n(E.purchase.value), A=n(E.area.value), U=n(E.avgpsm.value);
  const hasP=Number.isFinite(P), hasA=Number.isFinite(A), hasU=Number.isFinite(U);
  setErr(E.purchase, !hasP && E.purchase.value!=='');
  setErr(E.area, !hasA && E.area.value!=='');
  setErr(E.avgpsm, !hasU && E.avgpsm.value!=='');
  if(hasP && hasA && !hasU && A>0){ E.avgpsm.value = (P/A).toFixed(0); }
  else if(hasU && hasA && !hasP){ E.purchase.value = Math.round(U*A); }
  else if(hasP && hasU && !hasA && U>0){ E.area.value = (P/U).toFixed(2); }
}

// Revenue two-way (base = Purchase)
E.rent.addEventListener('input', ()=>{ twoWayRevenue('rent'); recalc(); });
E.tgt_gross.addEventListener('input', ()=>{ twoWayRevenue('tgt'); recalc(); });
function twoWayRevenue(changed){
  const P=n(E.purchase.value);
  const rent = n(E.rent.value), tgt=(n(E.tgt_gross.value))/100;
  const hasP=Number.isFinite(P);
  if(!hasP){ setErr(E.tgt_gross, true, 'กรอก Purchase ก่อน'); setErr(E.rent, !Number.isFinite(rent) && E.rent.value!==''); return; }
  setErr(E.tgt_gross, !Number.isFinite(tgt) && E.tgt_gross.value!=='');
  setErr(E.rent, !Number.isFinite(rent) && E.rent.value!=='');
  if(changed==='tgt' && Number.isFinite(tgt)){ E.rent.value = Math.round((tgt * P)/12); }
  else if(changed==='rent' && Number.isFinite(rent) && P>0){ E.tgt_gross.value = ((rent*12)/P*100).toFixed(2); }
}

// Helpers
function PMT(rateAPR, years, principal){
  const i=rateAPR/1200, n=years*12; return (i>0)? principal*i/(1-Math.pow(1+i,-n)) : (n>0? principal/n : 0);
}
function IRR(flows){
  function npv(r){let s=0; for(let t=0;t<flows.length;t++) s += flows[t]/Math.pow(1+r,t); return s;}
  let r0=0.1, r1=0.11, f0=npv(r0), f1=npv(r1);
  for(let i=0;i<50;i++){ const r2=r1 - f1*(r1-r0)/(f1-f0); if(!isFinite(r2)) return NaN;
    r0=r1; f0=f1; r1=r2; f1=npv(r1); if(Math.abs(f1)<1e-8) break; }
  return r1;
}

function computeScenario(rentBase, delta){
  const P=n(E.purchase.value)||0;

  // INVESTMENT
  const useInv = E.swInv.checked; // side switch
  const acqPct = useInv ? (n(E.acq.value)||3)/100 : 0;
  const fit = useInv ? (n(E.fit.value)||0) : 0;
  const other = useInv ? (n(E.other.value)||0) : 0;
  const cost_basis = P + P*acqPct + fit + other;

  // REVENUE
  const useRev = E.swRev.checked;
  const occ = useRev ? clamp((n(E.occ.value)||90)/100,0.5,1) : 1.0;   // neutral 100%
  const opex = useRev ? clamp((n(E.opex.value)||15)/100,0,0.6) : 0.0; // neutral 0%
  const agentm = useRev ? clamp(n(E.agentm.value)||1,0,12) : 0;       // neutral 0

  // FINANCING
  const down=clamp((n(E.down.value)||10)/100,0,0.9),
        rate=(E.swFin.checked? (n(E.rate.value)||4.5) : 4.5), // neutral APR 4.5
        years=(E.swFin.checked? +(E.tenor.value||30) : 30);   // neutral 30y
  const salary=n(E.salary.value);
  const financeOn = Number.isFinite(salary) && salary>0;

  const rent = (rentBase||0)*(1+delta);
  const acqCost=P*acqPct;
  const loan = Number.isFinite(P) ? Math.max(P - P*down, 0) : NaN;
  const pmt = financeOn && Number.isFinite(loan) ? PMT(rate, years, loan) : 0;
  const rentEff = rent*occ;
  const agentTHB = rent*(agentm/12);
  const opexTHB  = rent*opex;
  const noiMonthly = rentEff - agentTHB - opexTHB;
  const netMonthly = noiMonthly - pmt;

  // Yields on Purchase
  const grossYield = P>0 ? (rent*12)/P : NaN;
  const netYield   = P>0 ? (noiMonthly*12)/P : NaN;

  const equity = (Number.isFinite(P)? P*down : NaN) + acqCost + fit + other;
  const coc = equity>0 ? (netMonthly*12)/equity : NaN;
  const dti = financeOn && Number.isFinite(pmt) && salary>0 ? pmt/salary : NaN;
  const payback = (noiMonthly>0 && cost_basis>0) ? (cost_basis/(noiMonthly*12)) : NaN;

  return {rent, noiMonthly, netMonthly, grossYield, netYield, coc, dti, payback, pmt, loan, cost_basis, equity, financeOn,
          P, occ, opex};
}

function clsNetYield(v){ if(!isFinite(v)) return ''; return v>=0.06?'good':(v>=0.05?'warn':'bad'); }
function clsPayback(y){ if(!isFinite(y)) return ''; return y<12?'good':(y<=18?'warn':'bad'); }
function clsDTI(v){ if(!isFinite(v)) return ''; return v<=0.30?'good':(v<=0.40?'warn':'bad'); }
function clsCash(nu){ if(!isFinite(nu)) return ''; return nu>=0?'good':'bad'; }
function setKpiClass(elm, cls){ if(!elm) return; elm.className = 'kpi kval ' + (cls||''); }

function recalc(){
  twoWayInvestment();

  const rentBase = n(E.rent.value);
  const scLow = computeScenario(rentBase, -0.10);
  const scBase= computeScenario(rentBase,  0.00);
  const scHigh= computeScenario(rentBase, +0.10);

  function setCard(sc, id){
    const rentId = id==='low'?'rent_low':(id==='high'?'rent_high':'rent_base');
    const nyId   = id==='low'?'ny_low'  :(id==='high'?'ny_high'  :'ny_base');
    const cfId   = id==='low'?'cf_low'  :(id==='high'?'cf_high'  :'cf_base');
    const dtiId  = id==='low'?'dti_low' :(id==='high'?'dti_high' :'dti_base');
    const pbId   = id==='low'?'pb_low'  :(id==='high'?'pb_high'  :'pb_base');
    const cocId  = id==='low'?'coc_low' :(id==='high'?'coc_high' :'coc_base');
    document.getElementById(rentId).textContent = thb(sc.rent);
    const nyEl=el(nyId), cfEl=el(cfId), dtiEl=el(dtiId), pbEl=el(pbId), cocEl=el(cocId);
    nyEl.textContent=pct(sc.netYield); nyEl.className='sc-val '+clsNetYield(sc.netYield);
    cfEl.textContent=thb(sc.netMonthly); cfEl.className='sc-val '+clsCash(sc.netMonthly);
    dtiEl.textContent=pct(sc.dti); dtiEl.className='sc-val '+clsDTI(sc.dti);
    pbEl.textContent=isFinite(sc.payback)? sc.payback.toFixed(1)+'y':'—'; pbEl.className='sc-val '+clsPayback(sc.payback);
    cocEl.textContent=pct(sc.coc); cocEl.className='sc-val '+clsCash(sc.netMonthly);
  }
  setCard(scLow,'low'); setCard(scBase,'base'); setCard(scHigh,'high');

  const sc = activeScenario==='low'? scLow : (activeScenario==='high'? scHigh : scBase);
  document.getElementById('card-low').classList.toggle('active', activeScenario==='low');
  document.getElementById('card-base').classList.toggle('active', activeScenario==='base');
  document.getElementById('card-high').classList.toggle('active', activeScenario==='high');

  // Investment details & equity box (for display hints)
  const useInv = E.swInv.checked;
  const P=n(E.purchase.value);
  const acqPct = useInv ? (n(E.acq.value)||3)/100 : 0;
  const fit = useInv ? (n(E.fit.value)||0) : 0;
  const other = useInv ? (n(E.other.value)||0) : 0;
  const acqCost = (Number.isFinite(P)?P:0)*acqPct;
  if(Number.isFinite(P)){
    el('equity_box')?.classList?.toggle('dim', !useInv);
    el('equity_box').textContent = thb((P*(n(E.down.value)||10)/100) + acqCost + fit + other);
    el('eq_down')?.classList?.toggle('dim', !useInv); el('eq_acq')?.classList?.toggle('dim', !useInv); el('eq_fo')?.classList?.toggle('dim', !useInv);
    el('eq_down').textContent=thb(P*(n(E.down.value)||10)/100);
    el('eq_acq').textContent=thb(acqCost);
    el('eq_fo').textContent=thb(fit+other);
    if(H.acq_thb) H.acq_thb.textContent = thb(acqCost).replace(' ฿','');
  } else {
    if(el('equity_box')) el('equity_box').textContent = '—';
    if(el('eq_down')) el('eq_down').textContent='—';
    if(el('eq_acq')) el('eq_acq').textContent='—';
    if(el('eq_fo')) el('eq_fo').textContent='—';
    if(H.acq_thb) H.acq_thb.textContent = '—';
  }

  // Revenue adv helpers for hints (dim if off)
  const useRev = E.swRev.checked;
  const occ = useRev ? clamp((n(E.occ.value)||90)/100,0.5,1) : 1.0;
  const opex = useRev ? clamp((n(E.opex.value)||15)/100,0,0.6) : 0.0;
  const agentm = useRev ? clamp(n(E.agentm.value)||1,0,12) : 0;
  const rentEff = (n(E.rent.value)||0)*occ; const agentTHB = (n(E.rent.value)||0)*(agentm/12); const opexTHB = (n(E.rent.value)||0)*opex;
  ;['occ_eff','agent_thb','opex_thb'].forEach(id=>{ const k=el(id); if(k) k.parentElement.parentElement.classList.toggle('dim', !useRev); });
  if(H.occ_eff) H.occ_eff.textContent = Number.isFinite(rentEff)? rentEff.toLocaleString('th-TH',{maximumFractionDigits:0}) : '—';
  if(H.agent_thb) H.agent_thb.textContent = Number.isFinite(agentTHB)? agentTHB.toLocaleString('th-TH',{maximumFractionDigits:0}) : '—';
  if(H.opex_thb) H.opex_thb.textContent = Number.isFinite(opexTHB)? opexTHB.toLocaleString('th-TH',{maximumFractionDigits:0}) : '—';

  // Key Metrics (with colors)
  O.gross.textContent = pct(sc.grossYield); setKpiClass(O.gross, clsNetYield(sc.grossYield));
  O.net.textContent   = pct(sc.netYield);  setKpiClass(O.net,   clsNetYield(sc.netYield));
  O.coc.textContent   = pct(sc.coc);       setKpiClass(O.coc,   clsCash(sc.netMonthly));
  O.netmo.textContent = thb(sc.netMonthly);setKpiClass(O.netmo, clsCash(sc.netMonthly));
  O.pmt.textContent   = thb(sc.pmt);       setKpiClass(O.pmt,   '');
  const dti = sc.dti; O.dti.textContent   = pct(dti); setKpiClass(O.dti,   clsDTI(dti));
  O.payback.textContent = isFinite(sc.payback)? sc.payback.toFixed(1)+' yrs':'—'; setKpiClass(O.payback, clsPayback(sc.payback));

  // Affordability (clear if financing off)
  if(sc.financeOn && Number.isFinite(sc.loan)){
    const pmt = sc.pmt; const totInterest = pmt*(E.swFin.checked? +(E.tenor.value||30) : 30)*12 - sc.loan;
    O.loan_amt.textContent = thb(sc.loan);
    O.pmt2.textContent = thb(pmt);
    O.tot_int.textContent = thb(totInterest);
    O.aff_warn.textContent = isFinite(dti) ? (dti>0.4 ? 'High Risk: DTI > 40%.' : (dti>0.3 ? 'Caution: DTI 30–40%.' : 'OK: DTI ≤ 30%.')) : '—';
  }else{
    O.loan_amt.textContent = '—';
    O.pmt2.textContent = '—';
    O.tot_int.textContent = '—';
    O.aff_warn.textContent = 'กรอก Salary เพื่อประเมิน DTI/PMT';
  }

  // Exit & IRR
  let tval=NaN, npro=NaN, cgain=NaN, irr=NaN, em=NaN;
  if(E.exit_on.checked && Number.isFinite(P) && Number.isFinite(n(E.hold.value)) && Number.isFinite(n(E.pgrow.value))){
    const hold=n(E.hold.value)||5, g=Math.max(n(E.pgrow.value)||0,0)/100, scsell=clamp((n(E.sellc.value)||0)/100,0,0.20);
    const useExit = E.swExit.checked;
    const mode=useExit ? E.exit_mode.value : 'auto'; const manual=useExit ? (n(E.exit_price.value)||0) : 0;
    const term = (mode==='manual' && manual>0)? manual : P*Math.pow(1+g,hold);
    const tax = useExit ? Math.max(n(E.tax_pct.value)||0,0)/100 : 0;
    // need cost basis consistent with Investment switch:
    const useInv = E.swInv.checked; const acqPct = useInv ? (n(E.acq.value)||3)/100 : 0;
    const fit = useInv ? (n(E.fit.value)||0) : 0; const other = useInv ? (n(E.other.value)||0) : 0;
    const cost_basis = P + P*acqPct + fit + other;

    const sellCosts = term*scsell; const taxTHB = Math.max(term - cost_basis, 0)*tax;
    tval=term; npro = term - sellCosts - taxTHB; cgain = npro - cost_basis;
    // annual CF uses current scenario base (includes financing if on)
    const sc = computeScenario(n(E.rent.value)||0, 0.0);
    const annualCF = sc.netMonthly*12;
    const equity = sc.equity;
    if(equity>0){ em = (annualCF*hold + npro)/equity; }
    const flows = [-equity]; for(let y=1;y<=hold;y++) flows.push(annualCF + (y===hold ? npro : 0));
    irr = IRR(flows);
  }
  O.tval.textContent = Number.isFinite(tval)? thb(tval):'—';
  O.npro.textContent = Number.isFinite(npro)? thb(npro):'—';
  O.cgain.textContent= Number.isFinite(cgain)? thb(cgain):'—';
  O.irr.textContent  = Number.isFinite(irr)? (irr*100).toFixed(1)+'%':'—';
  O.emult.textContent= Number.isFinite(em)? em.toFixed(2)+'×':'—';

  // Status pills
  const pills = [];
  function Ppill(txt,cls){ pills.push('<span class="pill '+cls+'">'+txt+'</span>'); }
  Ppill(sc.netYield>=0.06?'Net ≥ 6%':'Net < 6%', clsNetYield(sc.netYield));
  if(isFinite(dti)){ if(dti>0.40) Ppill('DTI > 40%','bad'); else if(dti>0.30) Ppill('DTI 30–40%','warn'); else Ppill('DTI ≤ 30%','good'); }
  Ppill(sc.netMonthly>=0?'Cashflow บวก':'Cashflow ติดลบ', clsCash(sc.netMonthly));
  document.getElementById('status_pills').innerHTML = pills.join(' ');

  // AI Note (no Exit)
  const lines=[];
  if(isFinite(sc.netYield)) lines.push('Net Yield = '+pct(sc.netYield)+' → '+(sc.netYield>=0.07?'สูงกว่าค่าเฉลี่ยตลาด — น่าสนใจ':(sc.netYield>=0.06?'ใกล้เคียงค่าเฉลี่ยตลาด — พอใช้':'ต่ำกว่าค่าเฉลี่ยตลาด — ควรปรับสมมติฐาน')));
  if(isFinite(sc.payback)) lines.push('Payback = '+(isFinite(sc.payback)? sc.payback.toFixed(1):'—')+' ปี → '+(sc.payback<12?'เร็ว':(sc.payback<=18?'ปานกลาง':'ช้า')));
  if(isFinite(dti)) lines.push('DTI = '+pct(dti)+' → '+(dti<=0.30?'ปลอดภัย':(dti<=0.40?'เฝ้าระวัง':'เกินเกณฑ์แบงก์')));
  lines.push('Revenue advance: '+(E.swRev.checked?'ON':'OFF')+' · Financing advance: '+(E.swFin.checked?'ON':'OFF'));
  ai.innerHTML = lines.map(s=>'<div>• '+s+'</div>').join('');
}

// scenario card clicks
['card-low','card-base','card-high'].forEach((id,i)=>{
  const name = i===0?'low':(i===1?'base':'high');
  const node = document.getElementById(id);
  node.addEventListener('click', ()=>{ activeScenario=name; recalc(); });
});
// mobile segmented
const segL=document.getElementById('seg-low'), segB=document.getElementById('seg-base'), segH=document.getElementById('seg-high');
if(segL){ segL.addEventListener('click', ()=>{ activeScenario='low'; segL.classList.add('active'); segB.classList.remove('active'); segH.classList.remove('active'); recalc(); }); }
if(segB){ segB.addEventListener('click', ()=>{ activeScenario='base'; segB.classList.add('active'); segL.classList.remove('active'); segH.classList.remove('active'); recalc(); }); }
if(segH){ segH.addEventListener('click', ()=>{ activeScenario='high'; segH.classList.add('active'); segL.classList.remove('active'); segB.classList.remove('active'); recalc(); }); }

// Inputs update
['acq_pct','fitout','other','occ','opex','agentm','salary','down','rate','tenor','exit_on','hold','pgrow','sellc','exit_mode','exit_price','tax_pct','rent','tgt_gross']
  .forEach(id=>{ const node=el(id); if(node){ node.addEventListener('input', ()=>recalc()); node.addEventListener('change', ()=>recalc()); }});

recalc();
</script>
</body></html>
