<!doctype html>
<html lang="th">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PY‚ÄëD (PropYield‚ÄëD) ‚Äî Property Investment Tool ¬∑ v5d (controls under Basic)</title>
  <style>
    :root {
      --bg: #0b0e13;
      --card: #12161c;
      --text: #e9eef3;
      --muted: #a7b0bb;
      --lime: #b2df37;
      --teal: #15d4cf;
      --warn: #f59e0b;
      --bad: #ef4444;
      --good: #22c55e;
      --border: rgba(255, 255, 255, .08);
      --shadow: 0 10px 30px rgba(0, 0, 0, .35);
      --radius: 16px
    }

    * {
      box-sizing: border-box
    }

    html,
    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font: 15px/1.6 Inter, system-ui, Segoe UI, Arial
    }

    h1,
    h2 {
      margin: 0 0 8px
    }

    h1 {
      font-size: 28px
    }

    h2 {
      font-size: 20px
    }

    .wrap {
      max-width: 1200px;
      margin: 0 auto;
      padding: 18px
    }

    .topbar {
      display: flex;
      gap: 12px;
      align-items: center;
      margin: 6px 0 14px
    }

    .badge {
      padding: 6px 10px;
      border: 1px solid var(--border);
      border-radius: 999px;
      color: var(--lime);
      background: rgba(178, 223, 55, .12);
      font-size: 12px
    }

    .grid {
      display: grid;
      gap: 16px
    }

    .card {
      background: linear-gradient(180deg, rgba(255, 255, 255, .02), rgba(255, 255, 255, .0));
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 16px;
      box-shadow: var(--shadow)
    }

    .layout {
      display: grid;
      gap: 16px
    }

    @media(min-width:1024px) {
      .layout {
        grid-template-columns: 1.05fr .95fr
      }
    }

    label {
      display: block;
      font-weight: 600;
      margin: 6px 0 6px
    }

    input[type=number],
    input[type=text],
    select {
      width: 100%;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: #0f1418;
      color: var(--text)
    }

    input.err {
      border-color: var(--bad)
    }

    .help {
      color: var(--muted);
      font-size: 12px
    }

    .row {
      display: grid;
      gap: 12px
    }

    .row-2 {
      grid-template-columns: repeat(2, minmax(0, 1fr))
    }

    .row-3 {
      grid-template-columns: repeat(3, minmax(0, 1fr))
    }

    .kpi {
      font-size: 26px;
      font-weight: 800
    }

    .kpi.smaller {
      font-size: 20px;
    }

    .kpi-sub {
      font-size: 12px;
      color: var(--muted)
    }

    .kval {
      font-variant-numeric: tabular-nums
    }

    .kval.good {
      color: var(--good)
    }

    .kval.warn {
      color: var(--warn)
    }

    .kval.bad {
      color: var(--bad)
    }

    .small {
      font-size: 12px;
      color: var(--muted)
    }

    .adv-btn {
      appearance: none;
      border: 1px solid var(--border);
      background: #0f1418;
      color: var(--text);
      padding: 8px 12px;
      border-radius: 10px;
      cursor: pointer
    }

    .controls {
      display: flex;
      align-items: center;
      gap: 10px;
      justify-content: flex-start;
      margin-top: 10px
    }

    .controls .spacer {
      flex: 1
    }

    .controls .small {
      opacity: .9
    }

    .adv-box {
      display: none;
      margin-top: 10px;
      padding: 12px;
      border-radius: 12px;
      background: #151a20;
      border: 1px solid var(--border)
    }

    .footer {
      opacity: .7;
      margin: 24px 0 40px
    }

    .sep {
      height: 1px;
      background: var(--border);
      margin: 8px 0
    }

    .table-like {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 6px
    }

    .pill {
      display: inline-block;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid transparent;
      font-size: 12px;
      margin: 4px 6px 0 0;
      font-weight: 700
    }

    .pill.good {
      background: #163d2a;
      color: #7ef6a9;
      border-color: #235f40
    }

    .pill.warn {
      background: #3e2f0f;
      color: #ffd579;
      border-color: #6b5418
    }

    .pill.bad {
      background: #4a1714;
      color: #ffb4ab;
      border-color: #7d2b27
    }

    /* Scenarios */
    .scenario {
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px;
      cursor: pointer;
      user-select: none
    }

    .scenario.active {
      outline: 2px solid var(--teal)
    }

    .sc-low {
      background: rgba(245, 158, 11, .08)
    }

    .sc-base {
      background: rgba(21, 212, 207, .08)
    }

    .sc-high {
      background: rgba(34, 197, 94, .08)
    }

    .sc-head {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
      font-weight: 800
    }

    .sc-metric {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 4px 0;
      border-bottom: 1px dashed var(--border);
      font-size: 13px
    }

    .sc-metric .sc-val {
      font-size: 12px;
      white-space: nowrap;
    }

    .sc-metric:last-child {
      border-bottom: none
    }

    .sc-val {
      font-variant-numeric: tabular-nums
    }

    .sc-val.good {
      color: var(--good)
    }

    .sc-val.warn {
      color: var(--warn)
    }

    .sc-val.bad {
      color: var(--bad)
    }

    .sc-desktop {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 12px
    }

    .seg {
      display: none
    }

    @media(max-width:1023px) {
      .seg {
        display: flex;
        gap: 6px
      }

      .seg button {
        flex: 1;
        padding: 8px;
        border-radius: 10px;
        border: 1px solid var(--border);
        background: #0f1418;
        color: var(--text)
      }

      .seg .active {
        border-color: var(--teal)
      }

      .sc-desktop {
        display: none
      }
    }

    .status-card {
      display: flex;
      flex-wrap: wrap;
      gap: 6px
    }

    /* Side switch */
    .switch {
      position: relative;
      display: inline-block;
      width: 42px;
      height: 24px;
      vertical-align: middle
    }

    .switch input {
      opacity: 0;
      width: 0;
      height: 0
    }

    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: #25303a;
      transition: .2s;
      border-radius: 999px;
      border: 1px solid var(--border)
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 3px;
      bottom: 3px;
      background: white;
      transition: .2s;
      border-radius: 50%
    }

    .switch input:checked+.slider {
      background: #165e56
    }

    .switch input:checked+.slider:before {
      transform: translateX(18px)
    }

    .panel-head {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px
    }

    .badge-on {
      padding: 4px 8px;
      border-radius: 999px;
      background: #17332c;
      color: #7ef6a9;
      font-size: 11px;
      border: 1px solid #265a47
    }

    .dim {
      opacity: .6
    }

    /* v1.5: Tooltips - HORIZONTAL ONLY */
    .tooltip-icon {
      display: inline-block;
      width: 16px;
      height: 16px;
      background: var(--teal);
      color: white;
      border-radius: 50%;
      text-align: center;
      line-height: 16px;
      font-size: 12px;
      cursor: help;
      margin-left: 4px;
      position: relative;
      /* Disable browser default tooltip */
      pointer-events: auto;
    }

    .tooltip-icon:hover {
      background: var(--lime);
    }

    .tooltip-content {
      /* HORIZONTAL LAYOUT - Width > Height, readable 1-3 lines */
      position: absolute !important;
      left: calc(100% + 10px) !important;
      top: 50% !important;
      transform: translateY(-50%) !important;

      /* Size for horizontal layout */
      min-width: 250px !important;
      max-width: 400px !important;
      width: max-content !important;

      /* Styling */
      background: var(--card) !important;
      color: var(--text) !important;
      padding: 10px 14px !important;
      border-radius: 8px !important;
      font-size: 13px !important;
      line-height: 1.5 !important;

      /* Text alignment - LEFT aligned, not centered */
      text-align: left !important;

      /* Text wrapping - Better line breaking for Thai text */
      white-space: normal !important;
      word-break: normal !important;
      word-wrap: break-word !important;
      overflow-wrap: break-word !important;
      hyphens: none !important;
      line-break: strict !important;

      /* Visual */
      border: 1px solid var(--border) !important;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4) !important;

      /* Visibility */
      opacity: 0 !important;
      visibility: hidden !important;
      transition: opacity 0.2s ease, visibility 0.2s ease !important;
      z-index: 10000 !important;
      pointer-events: none !important;
    }

    /* Arrow pointing left */
    .tooltip-content::before {
      content: '' !important;
      position: absolute !important;
      right: 100% !important;
      top: 50% !important;
      transform: translateY(-50%) !important;
      border: 6px solid transparent !important;
      border-right-color: var(--card) !important;
    }

    .tooltip-icon:hover .tooltip-content {
      opacity: 1 !important;
      visibility: visible !important;
    }

    /* v1.5: Help Modal */
    .help-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      z-index: 2000;
      display: none;
      align-items: center;
      justify-content: center;
    }

    .help-modal-content {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 0;
      max-width: 900px;
      width: 95%;
      max-height: 90vh;
      overflow: hidden;
      position: relative;
      display: flex;
      flex-direction: column;
    }

    .help-header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: var(--card);
    }

    .help-header h2 {
      margin: 0;
      font-size: 20px;
    }

    .help-close {
      background: none;
      border: none;
      color: var(--text);
      font-size: 24px;
      cursor: pointer;
      padding: 0;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
    }

    .help-close:hover {
      background: var(--border);
    }

    .help-content {
      padding: 24px;
      overflow-y: auto;
      flex: 1;
    }

    /* Accordion Styles */
    .accordion {
      border: 1px solid var(--border);
      border-radius: 8px;
      overflow: hidden;
    }

    .accordion-section {
      border-bottom: 1px solid var(--border);
    }

    .accordion-section:last-child {
      border-bottom: none;
    }

    .accordion-header {
      padding: 16px 20px;
      background: var(--bg);
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: 600;
      transition: background-color 0.2s ease;
      user-select: none;
    }

    .accordion-header:hover {
      background: var(--border);
    }

    .accordion-icon {
      transition: transform 0.2s ease;
      font-size: 14px;
    }

    .accordion-header.active .accordion-icon {
      transform: rotate(90deg);
    }

    .accordion-content {
      padding: 0 20px;
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease, padding 0.3s ease;
    }

    .accordion-content.active {
      max-height: 2000px;
      padding: 20px;
    }

    /* Content Styles */
    .example-card {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 12px;
      margin: 12px 0;
      font-size: 13px;
      line-height: 1.6;
    }

    .glossary-item {
      padding: 10px 0;
      border-bottom: 1px solid var(--border);
      font-size: 14px;
      line-height: 1.6;
    }

    .glossary-item:last-child {
      border-bottom: none;
    }

    .glossary-term {
      font-weight: 600;
      color: var(--lime);
    }

    .threshold-table {
      width: 100%;
      border-collapse: collapse;
      margin: 12px 0;
      font-size: 13px;
    }

    .threshold-table th,
    .threshold-table td {
      padding: 8px 12px;
      text-align: left;
      border: 1px solid var(--border);
    }

    .threshold-table th {
      background: var(--bg);
      font-weight: 600;
    }

    .faq-item {
      margin-bottom: 16px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--border);
    }

    .faq-item:last-child {
      border-bottom: none;
    }

    .help-section {
      margin-bottom: 24px;
    }

    .help-section h3 {
      color: var(--lime);
      margin-bottom: 12px;
    }

    .help-section h4 {
      color: var(--text);
      margin: 16px 0 8px 0;
      font-size: 16px;
    }

    .help-section ul {
      margin-left: 20px;
    }

    .help-section li {
      margin-bottom: 8px;
      line-height: 1.5;
    }

    .accordion-content h4 {
      color: var(--lime);
      margin: 16px 0 12px 0;
      font-size: 15px;
      font-weight: 600;
    }

    .accordion-content h4:first-child {
      margin-top: 0;
    }

    /* Timeline Chart Responsive */
    @media (max-width: 768px) {
      #timeline-card {
        margin-left: -16px;
        margin-right: -16px;
        border-radius: 0;
      }

      #timeline-canvas {
        height: 300px !important;
      }

      #timeline-title {
        font-size: 16px;
      }

      #timeline-toggle-btn {
        font-size: 13px !important;
        padding: 10px 20px !important;
      }
    }
  </style>

  <!-- Chart.js for Timeline Chart -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3"></script>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div>
        <div class="badge">Property Investment Tool</div>
        <h1>PY-D | PropYield-D</h1>
      </div>
    </div>

    <div class="layout">
      <!-- LEFT -->
      <div class="grid">

        <!-- Investment -->
        <div class="card">
          <div class="panel-head">
            <h2>1. Investment</h2>
            <button id="help-btn" class="adv-btn" style="padding: 6px 10px; font-size: 12px;">‚ùì Help</button>
          </div>
          <div class="row row-3">
            <div><label>Purchase Price (THB) <span class="tooltip-icon"
                  data-tooltip="purchase_price">?</span></label><input type="text" id="purchase"
                placeholder="‡πÄ‡∏ä‡πà‡∏ô 4,000,000" /></div>
            <div><label>Avg / sqm (THB) <span class="tooltip-icon" data-tooltip="avg_psm">?</span></label><input
                type="text" id="avgpsm" placeholder="‡πÄ‡∏ä‡πà‡∏ô 120,000" /></div>
            <div><label>Area (sqm) <span class="tooltip-icon" data-tooltip="area_sqm">?</span></label><input type="text"
                id="area" placeholder="‡πÄ‡∏ä‡πà‡∏ô 35" /></div>
          </div>
          <div class="controls">
            <button class="adv-btn" data-target="#adv-invest">Show / Hide details</button>
            <div class="spacer"></div>
            <span class="small">Include in calc</span>
            <label class="switch"><input type="checkbox" id="swInv"><span class="slider"></span></label>
          </div>
          <div id="adv-invest" class="adv-box">
            <div class="row row-3">
              <div>
                <label>Acquisition Cost (%)</label><input type="number" id="acq_pct" value="3" inputmode="decimal" />
                <div class="help">‚âà <span id="acq_thb">‚Äî</span> THB</div>
              </div>
              <div><label>Fit‚Äëout (THB)</label><input type="text" id="fitout" value="0" inputmode="numeric"
                  placeholder="0" /></div>
              <div><label>Other Costs (THB)</label><input type="text" id="other" value="0" inputmode="numeric"
                  placeholder="0" />
              </div>
            </div>
            <div class="small">‡∏™‡∏ß‡∏¥‡∏ï‡∏ä‡πå ‚ÄúInclude in calc‚Äù ‡πÄ‡∏õ‡∏¥‡∏î: ‡∏à‡∏∞‡∏ö‡∏ß‡∏Å Acq/Fit‚Äëout/Other ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô (Cost basis)</div>
          </div>
        </div>

        <!-- Revenue -->
        <div class="card">
          <div class="panel-head">
            <h2>2. Revenue</h2>
          </div>
          <div class="row row-2">
            <div>
              <label>Rent / month (THB) <span class="tooltip-icon" data-tooltip="monthly_rent">?</span></label>
              <input type="text" id="rent" placeholder="‡πÄ‡∏ä‡πà‡∏ô 20,000" />
              <div class="help">two‚Äëway with Target Gross Yield ¬∑ base = Purchase</div>
            </div>
            <div>
              <label>Target Gross Yield (%) <span class="tooltip-icon"
                  data-tooltip="target_gross_yield">?</span></label>
              <input type="text" id="tgt_gross" placeholder="‡πÄ‡∏ä‡πà‡∏ô 5.0" />
            </div>
          </div>
          <div class="controls">
            <button class="adv-btn" data-target="#adv-rev">Show / Hide details</button>
            <div class="spacer"></div>
            <span class="small">Include in calc</span>
            <label class="switch"><input type="checkbox" id="swRev"><span class="slider"></span></label>
          </div>
          <div id="adv-rev" class="adv-box">
            <div class="row row-3">
              <div>
                <label>Occupancy (%)</label><input type="number" id="occ" value="90" inputmode="decimal" />
                <div class="help">Effective rent ‚âà <span id="occ_eff">‚Äî</span> THB/mo</div>
              </div>
              <div>
                <label>Opex (%) (incl. common fee)</label><input type="number" id="opex" value="10"
                  inputmode="decimal" />
                <div class="help">Total opex ‚âà <span id="opex_thb">‚Äî</span> THB/mo</div>
              </div>
              <div>
                <label>Agent Fee (months/yr)</label><input type="number" id="agentm" value="1" inputmode="decimal" />
                <div class="help">‚âà <span id="agent_thb">‚Äî</span> THB/mo</div>
              </div>
            </div>
            <div class="small">‡∏™‡∏ß‡∏¥‡∏ï‡∏ä‡πå ‚ÄúInclude in calc‚Äù ‡πÄ‡∏õ‡∏¥‡∏î: ‡πÉ‡∏ä‡πâ Occ/Opex/Agent; ‡∏õ‡∏¥‡∏î: ‡πÉ‡∏ä‡πâ neutral baseline (100%/0%/0)
            </div>
          </div>
        </div>

        <!-- Financing -->
        <div class="card">
          <div class="panel-head">
            <h2>3. Financing</h2>
          </div>
          <div class="row row-2">
            <div><label>Gross Salary (THB/mo) <span class="tooltip-icon"
                  data-tooltip="gross_salary">?</span></label><input type="text" id="salary"
                placeholder="‡πÄ‡∏ä‡πà‡∏ô 70,000" /></div>
            <div><label>Down Payment (%) <span class="tooltip-icon"
                  data-tooltip="down_payment_pct">?</span></label><input type="number" id="down" value="10"
                inputmode="decimal" /></div>
          </div>
          <div class="controls">
            <button class="adv-btn" data-target="#adv-fin">Show / Hide details</button>
            <div class="spacer"></div>
            <span class="small">Include in calc</span>
            <label class="switch"><input type="checkbox" id="swFin"><span class="slider"></span></label>
          </div>
          <div id="adv-fin" class="adv-box">
            <div class="row row-3">
              <div><label>Interest (APR %)</label><input type="number" id="rate" value="4.5" inputmode="decimal" />
              </div>
              <div><label>Tenor (years)</label>
                <select id="tenor">
                  <option value="30" selected>30</option>
                  <option value="25">25</option>
                  <option value="20">20</option>
                </select>
              </div>
              <div>
                <label>Equity Invested (auto)</label>
                <div id="equity_box" class="help">‚Äî</div>
              </div>
            </div>
            <div class="sep"></div>
            <div class="table-like small">
              <div>Down on Purchase</div>
              <div id="eq_down">‚Äî</div>
              <div>Acquisition Costs</div>
              <div id="eq_acq">‚Äî</div>
              <div>Fit‚Äëout + Other</div>
              <div id="eq_fo">‚Äî</div>
            </div>
            <div class="small">‡∏™‡∏ß‡∏¥‡∏ï‡∏ä‡πå ‚ÄúInclude in calc‚Äù ‡πÄ‡∏õ‡∏¥‡∏î: ‡πÉ‡∏ä‡πâ APR/Tenor ‡∏ï‡∏≤‡∏°‡∏ü‡∏¥‡∏•‡∏î‡πå; ‡∏õ‡∏¥‡∏î: ‡πÉ‡∏ä‡πâ neutral baseline APR
              4.5%, 30y</div>
          </div>
        </div>

        <!-- Exit -->
        <div class="card">
          <div class="panel-head">
            <h2>4. Exit (optional)</h2>
          </div>
          <div><input type="checkbox" id="exit_on" /> ‡∏£‡∏ß‡∏° Exit ‡πÉ‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•</div>
          <div class="row row-3" style="margin-top:10px">
            <div><label>Holding (yrs) <span class="tooltip-icon" data-tooltip="holding_years">?</span></label><input
                type="number" id="hold" placeholder="‡πÄ‡∏ä‡πà‡∏ô 5" inputmode="decimal" />
            </div>
            <div><label>Price growth (%/yr) <span class="tooltip-icon"
                  data-tooltip="price_growth">?</span></label><input type="number" id="pgrow" placeholder="‡πÄ‡∏ä‡πà‡∏ô 3"
                inputmode="decimal" /></div>
            <div><label>Selling cost (%) <span class="tooltip-icon" data-tooltip="selling_cost">?</span></label><input
                type="number" id="sellc" value="3" inputmode="decimal" /></div>
          </div>
          <div class="controls">
            <button class="adv-btn" data-target="#adv-exit">Show / Hide details</button>
            <div class="spacer"></div>
            <span class="small">Include in calc</span>
            <label class="switch"><input type="checkbox" id="swExit"><span class="slider"></span></label>
          </div>
          <div id="adv-exit" class="adv-box">
            <div class="row row-3">
              <div><label>Exit Mode</label>
                <select id="exit_mode">
                  <option value="auto" selected>Auto (growth-driven)</option>
                  <option value="manual">Manual price</option>
                </select>
              </div>
              <div><label>Manual Exit Price (THB)</label><input type="text" id="exit_price" value="0"
                  inputmode="numeric" placeholder="0" /></div>
              <div><label>Capital Gain Tax % (optional)</label><input type="number" id="tax_pct" value="0"
                  inputmode="decimal" /></div>
            </div>
            <div class="small">‡∏™‡∏ß‡∏¥‡∏ï‡∏ä‡πå ‚ÄúInclude in calc‚Äù ‡πÄ‡∏õ‡∏¥‡∏î: ‡πÉ‡∏ä‡πâ Exit Mode/Tax; ‡∏õ‡∏¥‡∏î: ‡πÉ‡∏ä‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Basic
              (Holding/Growth/Sell cost)</div>
          </div>
        </div>

      </div>

      <!-- RIGHT -->
      <div class="grid">

        <!-- Status -->
        <div class="card">
          <h2>Status</h2>
          <div id="status_pills" class="status-card"></div>
        </div>

        <!-- Scenarios -->
        <div class="card">
          <h2>Scenario Analysis</h2>
          <div class="seg">
            <button id="seg-low">Low</button><button id="seg-base" class="active">Base</button><button
              id="seg-high">High</button>
          </div>
          <div class="sc-desktop">
            <div class="scenario sc-low" id="card-low">
              <div class="sc-head"><span>Low (‚àí10%)</span><span id="rent_low">‚Äî</span></div>
              <div class="sc-metric"><span>Net Yield</span><span id="ny_low" class="sc-val">‚Äî</span></div>
              <div class="sc-metric"><span>Cash Flow / mo</span><span id="cf_low" class="sc-val">‚Äî</span></div>
              <div class="sc-metric"><span>DTI</span><span id="dti_low" class="sc-val">‚Äî</span></div>
              <div class="sc-metric"><span>Payback (yrs)</span><span id="pb_low" class="sc-val">‚Äî</span></div>
              <div class="sc-metric"><span>CoC</span><span id="coc_low" class="sc-val">‚Äî</span></div>
            </div>
            <div class="scenario sc-base active" id="card-base">
              <div class="sc-head"><span>Base (0%)</span><span id="rent_base">‚Äî</span></div>
              <div class="sc-metric"><span>Net Yield</span><span id="ny_base" class="sc-val">‚Äî</span></div>
              <div class="sc-metric"><span>Cash Flow / mo</span><span id="cf_base" class="sc-val">‚Äî</span></div>
              <div class="sc-metric"><span>DTI</span><span id="dti_base" class="sc-val">‚Äî</span></div>
              <div class="sc-metric"><span>Payback (yrs)</span><span id="pb_base" class="sc-val">‚Äî</span></div>
              <div class="sc-metric"><span>CoC</span><span id="coc_base" class="sc-val">‚Äî</span></div>
            </div>
            <div class="scenario sc-high" id="card-high">
              <div class="sc-head"><span>High (+10%)</span><span id="rent_high">‚Äî</span></div>
              <div class="sc-metric"><span>Net Yield</span><span id="ny_high" class="sc-val">‚Äî</span></div>
              <div class="sc-metric"><span>Cash Flow / mo</span><span id="cf_high" class="sc-val">‚Äî</span></div>
              <div class="sc-metric"><span>DTI</span><span id="dti_high" class="sc-val">‚Äî</span></div>
              <div class="sc-metric"><span>Payback (yrs)</span><span id="pb_high" class="sc-val">‚Äî</span></div>
              <div class="sc-metric"><span>CoC</span><span id="coc_high" class="sc-val">‚Äî</span></div>
            </div>
          </div>
        </div>

        <!-- Key Metrics -->
        <div class="card">
          <h2>Key Metrics</h2>
          <div class="row row-3">
            <div>
              <div class="kpi kval" id="gross">‚Äî</div>
              <div class="kpi-sub">Gross Yield</div>
            </div>
            <div>
              <div class="kpi kval" id="net">‚Äî</div>
              <div class="kpi-sub">Net Yield (unlevered)</div>
            </div>
            <div>
              <div class="kpi kval" id="coc">‚Äî</div>
              <div class="kpi-sub">CoC Return</div>
            </div>
          </div>
          <div class="row row-3" style="margin-top:10px">
            <div>
              <div class="kpi kval" id="netmo">‚Äî</div>
              <div class="kpi-sub">Net / month (after debt or NOI if Financing off)</div>
            </div>
            <div>
              <div class="kpi kval" id="pmt">‚Äî</div>
              <div class="kpi-sub">PMT / month</div>
            </div>
            <div>
              <div class="kpi kval" id="dti">‚Äî</div>
              <div class="kpi-sub">DTI</div>
            </div>
          </div>
          <div class="row row-3" style="margin-top:10px">
            <div>
              <div class="kpi kval" id="payback">‚Äî</div>
              <div class="kpi-sub">Payback (yrs)</div>
            </div>
            <div>
              <div class="kpi kval" id="irr">‚Äî</div>
              <div class="kpi-sub">IRR (Exit ON)</div>
            </div>
            <div>
              <div class="kpi kval" id="emult">‚Äî</div>
              <div class="kpi-sub">Equity Multiple</div>
            </div>
          </div>
        </div>

        <!-- Affordability -->
        <div class="card">
          <h2>Affordability</h2>
          <div class="row row-3">
            <div>
              <div class="kpi smaller" id="loan_amt">‚Äî</div>
              <div class="kpi-sub">Loan Amount</div>
            </div>
            <div>
              <div class="kpi smaller" id="pmt2">‚Äî</div>
              <div class="kpi-sub">Monthly Payment</div>
            </div>
            <div>
              <div class="kpi smaller" id="tot_int">‚Äî</div>
              <div class="kpi-sub" id="tot_int_label">Total Interest</div>
            </div>
          </div>
          <div id="aff_warn" class="small" style="margin-top:8px">‚Äî</div>
        </div>

        <!-- Exit Summary -->
        <div class="card">
          <h2>Exit Summary</h2>
          <div class="row row-3">
            <div>
              <div class="kpi smaller" id="tval">‚Äî</div>
              <div class="kpi-sub">Terminal Value</div>
            </div>
            <div>
              <div class="kpi smaller" id="npro">‚Äî</div>
              <div class="kpi-sub">Net Proceeds</div>
            </div>
            <div>
              <div class="kpi smaller" id="cgain">‚Äî</div>
              <div class="kpi-sub">Capital Gain (incl. cashflow)</div>
            </div>
          </div>
        </div>

        <!-- AI Note -->
        <div class="card">
          <h2>AI Note:</h2>
          <div id="ai_note" class="small">‚Äî</div>
        </div>

        <!-- Timeline Chart Section -->
        <div class="card" id="timeline-card" style="display: none; margin-top: 20px;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
            <h2 id="timeline-title">üìà 30-Year Investment Timeline</h2>
            <button id="timeline-hide-btn" onclick="toggleTimeline()" style="background: var(--border); padding: 6px 12px; border-radius: 6px; 
                           border: none; cursor: pointer; color: var(--text); font-size: 13px;">
              Hide
            </button>
          </div>

          <!-- Remark Message -->
          <div id="timeline-remark" style="background: rgba(21, 212, 207, 0.1); border-left: 3px solid var(--teal); 
                      padding: 10px 12px; margin-bottom: 16px; font-size: 13px; line-height: 1.5;">
            ‚ÑπÔ∏è Using default 3% property appreciation
          </div>

          <!-- Chart Canvas -->
          <div style="position: relative; height: 400px;">
            <canvas id="timeline-canvas"></canvas>
          </div>

          <!-- Payback Period Legend -->
          <div id="payback-legend" style="margin-top: 16px; padding: 12px; background: rgba(0,0,0,0.15); 
                      border-radius: 8px; border: 1px solid var(--border);">
            <div style="font-weight: 600; margin-bottom: 8px; color: var(--lime);">üí∞ Payback Period:</div>
            <div style="display: flex; gap: 20px; font-size: 14px; flex-wrap: wrap;">
              <span style="color: #ef4444;">‚óè Low: <span id="pb-legend-low">‚Äî</span> years</span>
              <span style="color: #15d4cf;">‚óè Base: <span id="pb-legend-base">‚Äî</span> years</span>
              <span style="color: #22c55e;">‚óè High: <span id="pb-legend-high">‚Äî</span> years</span>
            </div>
          </div>

          <!-- Toggle Controls -->
          <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border);">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
              <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                <input type="checkbox" id="show-payback" checked onchange="updateTimelineChart()">
                <span style="font-size: 13px;">üí∞ Show Payback Marker</span>
              </label>
              <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                <input type="checkbox" id="show-loan-paid" onchange="updateTimelineChart()">
                <span style="font-size: 13px;">üè¶ Show Loan Paid Off</span>
              </label>
            </div>
          </div>
        </div>

        <!-- Timeline Toggle Button -->
        <div class="card" style="text-align: center; margin-top: 16px;">
          <button id="timeline-toggle-btn" onclick="toggleTimeline()" style="background: linear-gradient(135deg, var(--teal), var(--lime)); 
                         color: white; padding: 12px 24px; border-radius: 10px; border: none; 
                         cursor: pointer; font-size: 14px; font-weight: 600; width: 100%; 
                         max-width: 400px;">
            üìä Show Investment Timeline
          </button>
        </div>

      </div>
    </div>

    <div class="footer small">¬©2025 PropYield‚ÄëD. Prototype v5d (controls under Basic, side‚Äëswitch, neutral baseline,
      blank Basic)</div>
  </div>

  <!-- v1.5: Help Modal -->
  <!-- v1.6: Comprehensive Help Modal with Accordion -->
  <div id="help-modal" class="help-modal">
    <div class="help-modal-content">
      <div class="help-header">
        <h2>üè† Property Investment Tool - Complete Documentation</h2>
        <button class="help-close" onclick="closeHelpModal()">&times;</button>
      </div>

      <div class="help-content">
        <div class="accordion">

          <!-- Quick Start -->
          <div class="accordion-section">
            <div class="accordion-header" onclick="toggleAccordion(this)">
              <span>üöÄ Quick Start</span>
              <span class="accordion-icon">‚ñ∏</span>
            </div>
            <div class="accordion-content">
              <h4>3 Steps to Start</h4>
              <p><strong>Step 1: Enter Basic Info</strong></p>
              <ul>
                <li>Purchase Price: ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ã‡∏∑‡πâ‡∏≠‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô (‡πÄ‡∏ä‡πà‡∏ô 4,000,000 ‡∏ö‡∏≤‡∏ó)</li>
                <li>Monthly Rent: ‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡πÄ‡∏ä‡πà‡∏ô 20,000 ‡∏ö‡∏≤‡∏ó)</li>
                <li>‚Üí ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Gross Yield ‡πÉ‡∏´‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</li>
              </ul>
              <p><strong>Step 2: Turn On Switches (Optional)</strong></p>
              <ul>
                <li>Revenue Switch ON: ‡∏£‡∏ß‡∏°‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢ (occupancy 90%, opex 15%, agent 1 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏õ‡∏µ)</li>
                <li>Financing Switch ON: ‡∏£‡∏ß‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡∏π‡πâ (‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏™‡πà Salary)</li>
                <li>‚Üí ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á Net Yield, DTI, Cashflow</li>
              </ul>
              <p><strong>Step 3: Compare Scenarios</strong></p>
              <ul>
                <li>‡∏Ñ‡∏•‡∏¥‡∏Å Low/Base/High cards</li>
                <li>‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô ¬±10%</li>
              </ul>
              <div class="example-card">
                <strong>Example:</strong><br>
                Purchase = 4,000,000 | Rent = 20,000 | Salary = 70,000<br>
                ‚Üí Gross Yield = 6.0%<br>
                ‚Üí Net Yield = 4.9% (with switches ON)<br>
                ‚Üí DTI = 26.1% (‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢)
              </div>
            </div>
          </div>

          <!-- Timeline Chart -->
          <div class="accordion-section">
            <div class="accordion-header" onclick="toggleAccordion(this)">
              <span>üìà Timeline Chart Features</span>
              <span class="accordion-icon">‚ñ∏</span>
            </div>
            <div class="accordion-content">
              <h4>Interactive Timeline Chart</h4>
              <p>‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏¥‡∏ö‡πÇ‡∏ï‡∏Ç‡∏≠‡∏á‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏•‡∏á‡∏ó‡∏∏‡∏ô‡∏ï‡∏•‡∏≠‡∏î‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏ñ‡∏∑‡∏≠‡∏Ñ‡∏£‡∏≠‡∏á (0-30 ‡∏õ‡∏µ)</p>

              <h4>Features</h4>
              <ul>
                <li><strong>Crosshair Tooltip:</strong> ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÄ‡∏°‡∏≤‡∏™‡πå‡∏ö‡∏ô‡∏Å‡∏£‡∏≤‡∏ü‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏Ñ‡πà‡∏≤‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏õ‡∏µ‡πÅ‡∏ö‡∏ö‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</li>
                <li><strong>Payback Marker (‚óè):</strong> ‡∏à‡∏∏‡∏î‡∏Å‡∏•‡∏°‡∏™‡∏µ‡∏ö‡∏ô‡πÄ‡∏™‡πâ‡∏ô‡∏Å‡∏£‡∏≤‡∏ü = ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏ô‡∏ó‡∏∏‡∏ô (Cumulative Cashflow = 0)
                </li>
                <li><strong>Loan Paid Off (üè†):</strong> ‡πÄ‡∏™‡πâ‡∏ô‡∏õ‡∏£‡∏∞‡∏™‡∏µ‡∏™‡πâ‡∏° = ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡∏π‡πâ‡∏´‡∏°‡∏î (‡∏ï‡∏≤‡∏°‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏ú‡πà‡∏≠‡∏ô)</li>
                <li><strong>Exit Line (üèÅ):</strong> ‡πÄ‡∏™‡πâ‡∏ô‡∏™‡∏µ‡∏°‡πà‡∏ß‡∏á = ‡∏à‡∏∏‡∏î‡∏Ç‡∏≤‡∏¢‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡∏¥‡∏î Exit ON</li>
                <li><strong>3 Scenarios:</strong> ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö Low/Base/High ‡πÉ‡∏ô‡∏Å‡∏£‡∏≤‡∏ü‡πÄ‡∏î‡∏µ‡∏¢‡∏ß</li>
              </ul>

              <h4>How to Use</h4>
              <ul>
                <li>‡∏Ñ‡∏•‡∏¥‡∏Å "Show Chart" ‡πÉ‡∏ï‡πâ Key Metrics</li>
                <li>‡∏Å‡∏£‡∏≤‡∏ü‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≤‡∏°‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏ú‡πà‡∏≠‡∏ô (Tenor) ‡πÅ‡∏•‡∏∞ Holding Years ‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</li>
                <li>‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÄ‡∏°‡∏≤‡∏™‡πå‡∏ö‡∏ô‡∏Å‡∏£‡∏≤‡∏ü‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏õ‡∏µ</li>
                <li>‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î Payback Marker ‡πÅ‡∏•‡∏∞ Loan Paid Off ‡πÑ‡∏î‡πâ‡∏ï‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£</li>
              </ul>

              <div class="example-card">
                <strong>Tip:</strong> ‡πÉ‡∏ä‡πâ‡∏Å‡∏£‡∏≤‡∏ü‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏ß‡πà‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏à‡∏∞‡∏Ñ‡∏∑‡∏ô‡∏ó‡∏∏‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏´‡∏£‡πà ‡πÅ‡∏•‡∏∞‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô‡∏à‡∏∞‡πÄ‡∏ï‡∏¥‡∏ö‡πÇ‡∏ï‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏£‡πà‡πÉ‡∏ô‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï
              </div>
            </div>
          </div>

          <!-- Switch Logic -->
          <div class="accordion-section">
            <div class="accordion-header" onclick="toggleAccordion(this)">
              <span>üîß Switch Logic</span>
              <span class="accordion-icon">‚ñ∏</span>
            </div>
            <div class="accordion-content">
              <h4>Switch ‡∏Ñ‡∏∑‡∏≠‡∏≠‡∏∞‡πÑ‡∏£?</h4>
              <p>‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î ‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏£‡∏ß‡∏°‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢/‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡∏π‡πâ ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà</p>

              <div class="glossary-item">
                <strong>Investment Switch</strong><br>
                ‚Ä¢ ‡πÄ‡∏õ‡∏¥‡∏î (ON): ‡∏£‡∏ß‡∏° Acquisition Cost 3%, Fit-out, Other Costs<br>
                ‚Ä¢ ‡∏õ‡∏¥‡∏î (OFF): ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≤‡∏Å Purchase Price ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
              </div>

              <div class="glossary-item">
                <strong>Revenue Switch</strong><br>
                ‚Ä¢ ‡πÄ‡∏õ‡∏¥‡∏î (ON): ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡∏à‡∏£‡∏¥‡∏á - Occupancy 90%, Opex 15%, Agent 1 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏õ‡∏µ<br>
                ‚Ä¢ ‡∏õ‡∏¥‡∏î (OFF): ‡πÉ‡∏ä‡πâ neutral baseline - Occupancy 100%, Opex 0%, Agent 0 (Gross Yield ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î)
              </div>

              <div class="glossary-item">
                <strong>Financing Switch</strong><br>
                ‚Ä¢ ‡πÄ‡∏õ‡∏¥‡∏î (ON): ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡∏à‡∏£‡∏¥‡∏á - Interest 4.5%, Tenor 30 ‡∏õ‡∏µ<br>
                ‚Ä¢ ‡∏õ‡∏¥‡∏î (OFF): ‡πÉ‡∏ä‡πâ neutral baseline - APR 4.5%, 30 ‡∏õ‡∏µ (‡πÅ‡∏ï‡πà‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏™‡πà Salary ‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì PMT/DTI)
              </div>

              <div class="glossary-item">
                <strong>Exit Switch</strong><br>
                ‚Ä¢ ‡πÄ‡∏õ‡∏¥‡∏î (ON): ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤ Tax, Exit Mode ‡∏ï‡∏≤‡∏° Advanced panel<br>
                ‚Ä¢ ‡∏õ‡∏¥‡∏î (OFF): ‡πÉ‡∏ä‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Basic (Holding, Growth, Selling Cost)
              </div>

              <h4>‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏´‡∏£‡πà‡∏Ñ‡∏ß‡∏£‡πÄ‡∏õ‡∏¥‡∏î Switch?</h4>
              <ul>
                <li>‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏π‡∏ú‡∏•‡∏ï‡∏≠‡∏ö‡πÅ‡∏ó‡∏ô‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î (best case) ‚Üí <strong>‡∏õ‡∏¥‡∏î‡∏ó‡∏∏‡∏Å switch</strong></li>
                <li>‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏π‡∏ú‡∏•‡∏à‡∏£‡∏¥‡∏á (realistic) ‚Üí <strong>‡πÄ‡∏õ‡∏¥‡∏î Revenue + Financing</strong></li>
                <li>‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏Ç‡∏≤‡∏¢ ‚Üí <strong>‡πÄ‡∏õ‡∏¥‡∏î Exit</strong></li>
              </ul>
            </div>
          </div>

          <!-- Glossary - Input Fields -->
          <div class="accordion-section">
            <div class="accordion-header" onclick="toggleAccordion(this)">
              <span>üìö Glossary - Input Fields</span>
              <span class="accordion-icon">‚ñ∏</span>
            </div>
            <div class="accordion-content">
              <h4>Investment Layer</h4>
              <div class="glossary-item">
                <span class="glossary-term">Purchase Price:</span> ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≤‡∏¢ = ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô‡∏£‡∏ß‡∏° VAT (‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Yield,
                Payback)
              </div>
              <div class="glossary-item">
                <span class="glossary-term">Avg/sqm:</span> ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏°‡∏ï‡∏£ = Purchase √∑ Area
              </div>
              <div class="glossary-item">
                <span class="glossary-term">Area:</span> ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏™‡∏≠‡∏¢ (‡∏ï‡∏£.‡∏°.) = Purchase √∑ Avg/sqm
              </div>
              <div class="glossary-item">
                <span class="glossary-term">Acquisition Cost:</span> ‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏°‡πÇ‡∏≠‡∏ô+‡∏à‡∏î‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô (% ‡∏Ç‡∏≠‡∏á Purchase, ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ
                2-3%)
              </div>
              <div class="glossary-item">
                <span class="glossary-term">Fit-out:</span> ‡∏Ñ‡πà‡∏≤‡∏ï‡∏Å‡πÅ‡∏ï‡πà‡∏á‡∏´‡πâ‡∏≠‡∏á (‡∏ö‡∏≤‡∏ó, ‡∏£‡∏ß‡∏°‡πÄ‡∏ü‡∏≠‡∏£‡πå‡∏ô‡∏¥‡πÄ‡∏à‡∏≠‡∏£‡πå)
              </div>
              <div class="glossary-item">
                <span class="glossary-term">Other Costs:</span> ‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏∑‡πà‡∏ô‡πÜ (‡∏ö‡∏≤‡∏ó)
              </div>

              <h4>Revenue Layer</h4>
              <div class="glossary-item">
                <span class="glossary-term">Rent:</span> ‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡∏ö‡∏≤‡∏ó, ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Yield ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)
              </div>
              <div class="glossary-item">
                <span class="glossary-term">Target Gross Yield:</span> ‡∏ú‡∏•‡∏ï‡∏≠‡∏ö‡πÅ‡∏ó‡∏ô‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ = (Rent √ó 12 √∑ Purchase) √ó 100
                (two-way binding ‡∏Å‡∏±‡∏ö Rent)
              </div>
              <div class="glossary-item">
                <span class="glossary-term">Occupancy:</span> ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ (%, ‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û 85-95%, ‡∏ß‡πà‡∏≤‡∏á 1 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏õ‡∏µ =
                92%)
              </div>
              <div class="glossary-item">
                <span class="glossary-term">Opex:</span> ‡∏Ñ‡πà‡∏≤‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏á‡∏≤‡∏ô (% ‡∏Ç‡∏≠‡∏á Rent, ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ 12-18%,
                ‡∏£‡∏ß‡∏°‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á+‡∏ã‡πà‡∏≠‡∏°‡πÅ‡∏ã‡∏°)
              </div>
              <div class="glossary-item">
                <span class="glossary-term">Agent Fee:</span> ‡∏Ñ‡πà‡∏≤‡∏ô‡∏≤‡∏¢‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏≤‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡πà‡∏≤ (‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏õ‡∏µ, ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ 1 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏õ‡∏µ, REPEAT
                ‡∏ó‡∏∏‡∏Å‡∏õ‡∏µ)
              </div>

              <h4>Financing Layer</h4>
              <div class="glossary-item">
                <span class="glossary-term">Salary:</span> ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏£‡∏ß‡∏°‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏±‡∏Å‡∏†‡∏≤‡∏©‡∏µ (‡∏ö‡∏≤‡∏ó/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô, ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì DTI)
              </div>
              <div class="glossary-item">
                <span class="glossary-term">Down Payment:</span> ‡πÄ‡∏á‡∏¥‡∏ô‡∏î‡∏≤‡∏ß‡∏ô‡πå (% ‡∏Ç‡∏≠‡∏á Purchase, ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ 10-30%, ‡∏¢‡∏¥‡πà‡∏á‡∏™‡∏π‡∏á DTI
                ‡∏¢‡∏¥‡πà‡∏á‡∏ï‡πà‡∏≥)
              </div>
              <div class="glossary-item">
                <span class="glossary-term">Interest Rate:</span> ‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏ï‡πà‡∏≠‡∏õ‡∏µ (APR %, ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô 4.0-5.5%)
              </div>
              <div class="glossary-item">
                <span class="glossary-term">Tenor:</span> ‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏ú‡πà‡∏≠‡∏ô (‡∏õ‡∏µ, ‡∏ó‡∏≤‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å 20/25/30, ‡∏¢‡∏≤‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô = ‡∏ú‡πà‡∏≠‡∏ô‡∏ô‡πâ‡∏≠‡∏¢‡∏•‡∏á
                ‡πÅ‡∏ï‡πà‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏£‡∏ß‡∏°‡∏°‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô)
              </div>

              <h4>Exit Layer</h4>
              <div class="glossary-item">
                <span class="glossary-term">Holding Years:</span> ‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏ñ‡∏∑‡∏≠‡∏Ñ‡∏£‡∏≠‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏Ç‡∏≤‡∏¢ (‡∏õ‡∏µ, ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ 5-10)
              </div>
              <div class="glossary-item">
                <span class="glossary-term">Price Growth:</span> ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡πÄ‡∏ï‡∏¥‡∏ö‡πÇ‡∏ï‡∏£‡∏≤‡∏Ñ‡∏≤ (% ‡∏ï‡πà‡∏≠‡∏õ‡∏µ, ‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ 2-4%)
              </div>
              <div class="glossary-item">
                <span class="glossary-term">Selling Cost:</span> ‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏Ç‡∏≤‡∏¢ (% ‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢, ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ 2-4%,
                ‡∏£‡∏ß‡∏°‡∏ô‡∏≤‡∏¢‡∏´‡∏ô‡πâ‡∏≤+‡πÇ‡∏≠‡∏ô)
              </div>
              <div class="glossary-item">
                <span class="glossary-term">Capital Gains Tax:</span> ‡∏†‡∏≤‡∏©‡∏µ‡∏Å‡∏≥‡πÑ‡∏£‡∏Ç‡∏≤‡∏¢ (% ‡∏Ç‡∏≠‡∏á‡∏Å‡∏≥‡πÑ‡∏£, ‡∏Ç‡∏∂‡πâ‡∏ô‡∏Å‡∏±‡∏ö‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏ñ‡∏∑‡∏≠‡∏Ñ‡∏£‡∏≠‡∏á >5
                ‡∏õ‡∏µ ‡∏≠‡∏≤‡∏à‡∏•‡∏î‡∏´‡∏¢‡πà‡∏≠‡∏ô)
              </div>
            </div>
          </div>

          <!-- Glossary - Output Metrics -->
          <div class="accordion-section">
            <div class="accordion-header" onclick="toggleAccordion(this)">
              <span>üìä Glossary - Output Metrics</span>
              <span class="accordion-icon">‚ñ∏</span>
            </div>
            <div class="accordion-content">
              <h4>Basic Metrics</h4>
              <div class="glossary-item">
                <span class="glossary-term">Gross Yield:</span> ‡∏ú‡∏•‡∏ï‡∏≠‡∏ö‡πÅ‡∏ó‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πâ‡∏ô = (Rent √ó 12 √∑ Purchase) √ó 100
                (‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏±‡∏Å‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢, ‚â•6% = ‡∏î‡∏µ)
              </div>
              <div class="glossary-item">
                <span class="glossary-term">Net Yield:</span> ‡∏ú‡∏•‡∏ï‡∏≠‡∏ö‡πÅ‡∏ó‡∏ô‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ (unlevered) = (NOI √ó 12 √∑ Purchase) √ó 100
                (‡∏´‡∏•‡∏±‡∏á‡∏´‡∏±‡∏Å‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢ ‡πÑ‡∏°‡πà‡∏£‡∏ß‡∏°‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢, ‚â•6% = ‡∏î‡∏µ)
              </div>
              <div class="glossary-item">
                <span class="glossary-term">NOI:</span> Net Operating Income = Rent √ó Occ% - Agent - Opex
                (‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏™‡∏∏‡∏ó‡∏ò‡∏¥‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏±‡∏Å‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢)
              </div>
              <div class="glossary-item">
                <span class="glossary-term">CoC Return:</span> Cash-on-Cash = (Net Cashflow √ó 12 √∑ Equity) √ó 100
                (‡∏ú‡∏•‡∏ï‡∏≠‡∏ö‡πÅ‡∏ó‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î ‡∏£‡∏ß‡∏° leverage, >10% = ‡∏î‡∏µ)
              </div>
              <div class="glossary-item">
                <span class="glossary-term">DTI:</span> Debt-to-Income = (PMT √∑ Salary) √ó 100 (‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏´‡∏ô‡∏µ‡πâ‡∏ï‡πà‡∏≠‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ, ‚â§30%
                = ‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢, >40% = ‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á)
              </div>
              <div class="glossary-item">
                <span class="glossary-term">Payback:</span> ‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏Ñ‡∏∑‡∏ô‡∏ó‡∏∏‡∏ô = Cost Basis √∑ (NOI √ó 12) (‡∏õ‡∏µ, <12=‡πÄ‡∏£‡πá‡∏ß,>18 =
                  ‡∏ä‡πâ‡∏≤)
              </div>
              <div class="glossary-item">
                <span class="glossary-term">PMT:</span> Monthly Payment = Annuity formula (‡∏Ñ‡πà‡∏≤‡∏ú‡πà‡∏≠‡∏ô‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
                ‡∏£‡∏ß‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô+‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢)
              </div>
              <div class="glossary-item">
                <span class="glossary-term">Net Cashflow:</span> ‡∏Å‡∏£‡∏∞‡πÅ‡∏™‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ = NOI - PMT (‡∏ö‡∏≤‡∏ó/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô, ‡∏ö‡∏ß‡∏Å =
                ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏Å‡πá‡∏ö, ‡∏•‡∏ö = ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ï‡∏¥‡∏°)
              </div>

              <h4>Exit Metrics (‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î Exit)</h4>
              <div class="glossary-item">
                <span class="glossary-term">IRR:</span> Internal Rate of Return (% ‡∏ï‡πà‡∏≠‡∏õ‡∏µ, ‡∏ú‡∏•‡∏ï‡∏≠‡∏ö‡πÅ‡∏ó‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏£‡∏ß‡∏°
                cashflow+‡∏Ç‡∏≤‡∏¢, >10% = ‡∏î‡∏µ)
              </div>
              <div class="glossary-item">
                <span class="glossary-term">Equity Multiple:</span> ‡∏ï‡∏±‡∏ß‡∏Ñ‡∏π‡∏ì‡∏ú‡∏•‡∏ï‡∏≠‡∏ö‡πÅ‡∏ó‡∏ô = (Total Cashflow + Net Proceeds) √∑
                Equity (‡πÄ‡∏ó‡πà‡∏≤, 2.0√ó = ‡∏Å‡∏≥‡πÑ‡∏£ 100%, >2√ó = ‡∏î‡∏µ)
              </div>
              <div class="glossary-item">
                <span class="glossary-term">Terminal Value:</span> ‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î = Purchase √ó (1 + Growth%)^Years
                (‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏Å‡∏≤‡∏£)
              </div>
              <div class="glossary-item">
                <span class="glossary-term">Net Proceeds:</span> ‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏±‡∏ö‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ = Terminal - Selling Cost - CGT
                (‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏à‡∏£‡∏¥‡∏á‡∏´‡∏•‡∏±‡∏á‡∏´‡∏±‡∏Å‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢+‡∏†‡∏≤‡∏©‡∏µ)
              </div>
              <div class="glossary-item">
                <span class="glossary-term">Capital Gain:</span> ‡∏Å‡∏≥‡πÑ‡∏£‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢ = Net Proceeds - Initial Equity
                (‡∏Å‡∏≥‡πÑ‡∏£‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡πÑ‡∏°‡πà‡∏£‡∏ß‡∏°‡∏Å‡∏£‡∏∞‡πÅ‡∏™‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ñ‡∏∑‡∏≠‡∏Ñ‡∏£‡∏≠‡∏á)
              </div>
              <div class="glossary-item">
                <span class="glossary-term">Capital Gain (incl. cashflow):</span> ‡∏Å‡∏≥‡πÑ‡∏£‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î = Net Proceeds +
                Cumulative Cashflow - Initial Equity
                (‡∏Å‡∏≥‡πÑ‡∏£‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢ + ‡∏Å‡∏£‡∏∞‡πÅ‡∏™‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î‡∏™‡∏∞‡∏™‡∏°‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ñ‡∏∑‡∏≠‡∏Ñ‡∏£‡∏≠‡∏á - ‡πÄ‡∏á‡∏¥‡∏ô‡∏•‡∏á‡∏ó‡∏∏‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô, ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ï‡∏≠‡∏ö‡πÅ‡∏ó‡∏ô‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∏‡∏ô)
              </div>
            </div>
          </div>

          <!-- Key Metrics Explained (NEW v6.1) -->
          <div class="accordion-section">
            <div class="accordion-header" onclick="toggleAccordion(this)">
              <span>üí° Key Metrics Explained</span>
              <span class="accordion-icon">‚ñ∏</span>
            </div>
            <div class="accordion-content">

              <!-- CoC Section -->
              <h4>CoC (Cash-on-Cash Return)</h4>

              <div class="glossary-item">
                <strong>‡∏´‡∏•‡∏±‡∏Å‡∏Ñ‡∏¥‡∏î: ‡∏ß‡∏±‡∏î‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û‡πÄ‡∏á‡∏¥‡∏ô‡∏•‡∏á‡∏ó‡∏∏‡∏ô‡∏à‡∏£‡∏¥‡∏á</strong><br>
                CoC = ‡∏ú‡∏•‡∏ï‡∏≠‡∏ö‡πÅ‡∏ó‡∏ô‡∏ï‡πà‡∏≠‡∏õ‡∏µ √∑ ‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏™‡πà‡∏à‡∏≤‡∏Å‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡∏à‡∏£‡∏¥‡∏á<br>
                <em>‡∏ï‡πà‡∏≤‡∏á‡∏à‡∏≤‡∏Å Net Yield ‡∏ó‡∏µ‡πà‡∏î‡∏π‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ã‡∏∑‡πâ‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‚Üí CoC ‡∏î‡∏π‡πÅ‡∏Ñ‡πà‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡πÉ‡∏™‡πà‡∏à‡∏£‡∏¥‡∏á</em>
              </div>

              <h4>üî¢ ‡∏™‡∏π‡∏ï‡∏£</h4>
              <div class="example-card">
                <strong>CoC (%) = (‡∏Å‡∏£‡∏∞‡πÅ‡∏™‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î‡∏ï‡πà‡∏≠‡∏õ‡∏µ √∑ ‡πÄ‡∏á‡∏¥‡∏ô‡∏•‡∏á‡∏ó‡∏∏‡∏ô‡∏à‡∏£‡∏¥‡∏á) √ó 100</strong><br><br>
                ‡πÇ‡∏î‡∏¢‡∏ó‡∏µ‡πà:<br>
                ‚Ä¢ ‡∏Å‡∏£‡∏∞‡πÅ‡∏™‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î‡∏ï‡πà‡∏≠‡∏õ‡∏µ = (NOI - ‡∏Ñ‡πà‡∏≤‡∏ú‡πà‡∏≠‡∏ô‡∏ö‡πâ‡∏≤‡∏ô) √ó 12 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô<br>
                ‚Ä¢ ‡πÄ‡∏á‡∏¥‡∏ô‡∏•‡∏á‡∏ó‡∏∏‡∏ô‡∏à‡∏£‡∏¥‡∏á = Down + ‡∏Ñ‡πà‡∏≤‡πÇ‡∏≠‡∏ô + ‡∏Ñ‡πà‡∏≤‡∏ï‡∏Å‡πÅ‡∏ï‡πà‡∏á + ‡∏≠‡∏∑‡πà‡∏ô‡πÜ
              </div>

              <h4>üìä 3 ‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö</h4>

              <div class="example-card">
                <strong>‡∏Å‡∏£‡∏ì‡∏µ 1: ‡πÑ‡∏°‡πà‡∏Å‡∏π‡πâ (‡∏à‡πà‡∏≤‡∏¢‡∏™‡∏î 100%)</strong><br>
                ‚Ä¢ Purchase: 4,000,000 ‡∏ö‡∏≤‡∏ó<br>
                ‚Ä¢ ‡πÄ‡∏á‡∏¥‡∏ô‡∏•‡∏á‡∏ó‡∏∏‡∏ô: 4,000,000 ‡∏ö‡∏≤‡∏ó (‡∏à‡πà‡∏≤‡∏¢‡∏™‡∏î)<br>
                ‚Ä¢ NOI: 16,400/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô<br>
                ‚Ä¢ ‡∏Ñ‡πà‡∏≤‡∏ú‡πà‡∏≠‡∏ô: 0 ‡∏ö‡∏≤‡∏ó<br>
                ‚Ä¢ Cashflow: +16,400/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô<br>
                ‚Ä¢ <strong>CoC = 4.9%</strong><br><br>
                üí° <em>CoC ‚âà Net Yield (‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÑ‡∏°‡πà‡∏°‡∏µ leverage)</em>
              </div>

              <div class="example-card">
                <strong>‡∏Å‡∏£‡∏ì‡∏µ 2: ‡∏Å‡∏π‡πâ 90% (Down 10%)</strong><br>
                ‚Ä¢ Purchase: 4,000,000 ‡∏ö‡∏≤‡∏ó<br>
                ‚Ä¢ ‡πÄ‡∏á‡∏¥‡∏ô‡∏•‡∏á‡∏ó‡∏∏‡∏ô: 420,000 ‡∏ö‡∏≤‡∏ó (Down + ‡∏Ñ‡πà‡∏≤‡πÇ‡∏≠‡∏ô)<br>
                ‚Ä¢ NOI: 16,400/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô<br>
                ‚Ä¢ ‡∏Ñ‡πà‡∏≤‡∏ú‡πà‡∏≠‡∏ô: 18,241/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô<br>
                ‚Ä¢ Cashflow: -1,841/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô<br>
                ‚Ä¢ <strong>CoC = -5.3%</strong><br><br>
                üí° <em>‡∏ï‡∏¥‡∏î‡∏•‡∏ö = ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô 1,841 ‡∏ö‡∏≤‡∏ó/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô<br>
                  ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÅ‡∏õ‡∏•‡∏ß‡πà‡∏≤‡πÅ‡∏¢‡πà!</em><br>
                ‚úÖ ‡πÑ‡∏î‡πâ asset ‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤ 4 ‡∏•‡πâ‡∏≤‡∏ô<br>
                ‚úÖ ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏≠‡∏≠‡∏° (‡∏ú‡πà‡∏≠‡∏ô‡∏ö‡πâ‡∏≤‡∏ô = ‡πÄ‡∏û‡∏¥‡πà‡∏° equity)<br>
                ‚úÖ ‡∏£‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏∂‡πâ‡∏ô (capital gain)<br>
                ‚úÖ ‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î‡∏†‡∏≤‡∏©‡∏µ (‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏•‡∏î‡∏´‡∏¢‡πà‡∏≠‡∏ô‡πÑ‡∏î‡πâ)
              </div>

              <div class="example-card">
                <strong>‡∏Å‡∏£‡∏ì‡∏µ 3: ‡∏Å‡∏π‡πâ 70% + ‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤‡∏™‡∏π‡∏á (Down 30%)</strong><br>
                ‚Ä¢ Purchase: 4,000,000 ‡∏ö‡∏≤‡∏ó<br>
                ‚Ä¢ ‡πÄ‡∏á‡∏¥‡∏ô‡∏•‡∏á‡∏ó‡∏∏‡∏ô: 1,220,000 ‡∏ö‡∏≤‡∏ó<br>
                ‚Ä¢ NOI: 20,000/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤‡∏™‡∏π‡∏á‡∏Ç‡∏∂‡πâ‡∏ô)<br>
                ‚Ä¢ ‡∏Ñ‡πà‡∏≤‡∏ú‡πà‡∏≠‡∏ô: 12,769/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô<br>
                ‚Ä¢ Cashflow: +7,231/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô<br>
                ‚Ä¢ <strong>CoC = 7.1%</strong><br><br>
                üí° <em>CoC ‡∏ö‡∏ß‡∏Å = ‡∏°‡∏µ passive income ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏•‡∏∞ 7,231 ‡∏ö‡∏≤‡∏ó</em>
              </div>

              <h4>üéØ ‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£?</h4>

              <div class="glossary-item">
                <strong>‚úÖ CoC ‡∏ö‡∏ß‡∏Å (+)</strong><br>
                ‚Ä¢ ‡∏°‡∏µ passive income ‡∏à‡∏£‡∏¥‡∏á<br>
                ‚Ä¢ ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏Å‡∏±‡∏ö: ‡∏ô‡∏±‡∏Å‡∏•‡∏á‡∏ó‡∏∏‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡πÅ‡∏™‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î
              </div>

              <div class="glossary-item">
                <strong>‚ö†Ô∏è CoC ‡∏ï‡∏¥‡∏î‡∏•‡∏ö (-) ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÅ‡∏¢‡πà‡πÄ‡∏™‡∏°‡∏≠‡πÑ‡∏õ</strong><br>
                ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢:<br>
                ‚Ä¢ ‡∏™‡∏£‡πâ‡∏≤‡∏á asset (‡πÑ‡∏î‡πâ‡∏ö‡πâ‡∏≤‡∏ô/‡∏Ñ‡∏≠‡∏ô‡πÇ‡∏î)<br>
                ‚Ä¢ ‡∏£‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏∂‡πâ‡∏ô (‡πÄ‡∏Å‡πá‡∏á‡∏Å‡∏≥‡πÑ‡∏£‡∏£‡∏∞‡∏¢‡∏∞‡∏¢‡∏≤‡∏ß)<br>
                ‚Ä¢ ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏≠‡∏≠‡∏° (‡∏ú‡πà‡∏≠‡∏ô‡∏ö‡πâ‡∏≤‡∏ô = ‡πÄ‡∏û‡∏¥‡πà‡∏° equity)<br>
                ‚Ä¢ ‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î‡∏†‡∏≤‡∏©‡∏µ (‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏•‡∏î‡∏´‡∏¢‡πà‡∏≠‡∏ô‡πÑ‡∏î‡πâ)
              </div>

              <h4>üí° ‡∏ó‡∏≥‡πÑ‡∏° CoC ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç?</h4>

              <ul>
                <li><strong>‡∏ß‡∏±‡∏î leverage effect:</strong> ‡∏ñ‡πâ‡∏≤‡∏Å‡∏π‡πâ‡πÄ‡∏¢‡∏≠‡∏∞ ‚Üí CoC ‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤ Net Yield</li>
                <li><strong>‡∏ß‡∏±‡∏î‡∏™‡∏†‡∏≤‡∏û‡∏Ñ‡∏•‡πà‡∏≠‡∏á‡∏à‡∏£‡∏¥‡∏á:</strong> ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏î‡πâ‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏•‡∏∞‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏£</li>
                <li><strong>‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∏‡∏ô‡∏≠‡∏∑‡πà‡∏ô:</strong> CoC 7% vs ‡∏´‡∏∏‡πâ‡∏ô 8-10% vs ‡∏û‡∏±‡∏ô‡∏ò‡∏ö‡∏±‡∏ï‡∏£ 3-5%</li>
              </ul>

              <h4>üîÑ ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡∏Å‡∏±‡∏ö Net Yield</h4>

              <table class="threshold-table">
                <tr>
                  <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå</th>
                  <th>‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå</th>
                </tr>
                <tr>
                  <td>‡πÑ‡∏°‡πà‡∏Å‡∏π‡πâ (‡∏à‡πà‡∏≤‡∏¢‡∏™‡∏î)</td>
                  <td>CoC ‚âà Net Yield</td>
                </tr>
                <tr>
                  <td>‡∏Å‡∏π‡πâ‡πÄ‡∏¢‡∏≠‡∏∞ (Down ‡∏ô‡πâ‡∏≠‡∏¢)</td>
                  <td>CoC > Net Yield (leverage effect)</td>
                </tr>
                <tr>
                  <td>‡∏Å‡∏π‡πâ‡∏ô‡πâ‡∏≠‡∏¢ (Down ‡πÄ‡∏¢‡∏≠‡∏∞)</td>
                  <td>CoC ‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á Net Yield</td>
                </tr>
              </table>

            </div>
          </div>

          <!-- Examples -->
          <div class="accordion-section">
            <div class="accordion-header" onclick="toggleAccordion(this)">
              <span>üí° Examples (Real Scenarios)</span>
              <span class="accordion-icon">‚ñ∏</span>
            </div>
            <div class="accordion-content">
              <div class="example-card">
                <strong>Example 1: ‡∏Ñ‡∏≠‡∏ô‡πÇ‡∏î‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û (‡πÉ‡∏Å‡∏•‡πâ BTS)</strong><br><br>
                <strong>Input:</strong><br>
                Purchase 4,000,000 | Area 35 sqm | Rent 20,000/mo | Salary 70,000 | Down 10% | Switches: Revenue ON,
                Financing ON<br><br>
                <strong>Output:</strong><br>
                ‚Ä¢ Gross Yield: 6.0%<br>
                ‚Ä¢ Net Yield: 4.9% ‚ö†Ô∏è<br>
                ‚Ä¢ Net Cashflow: -1,824 ‡∏ö‡∏≤‡∏ó/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ï‡∏¥‡∏°)<br>
                ‚Ä¢ DTI: 26.1% ‚úÖ<br>
                ‚Ä¢ Payback: 24.8 ‡∏õ‡∏µ<br>
                ‚Ä¢ CoC: -5.2%<br><br>
                <strong>Verdict:</strong><br>
                ‚ö†Ô∏è ‡∏û‡∏≠‡πÉ‡∏ä‡πâ - Net Yield ‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô (‡∏Ñ‡∏ß‡∏£ ‚â•6%)<br>
                ‚ö†Ô∏è Cashflow ‡∏ï‡∏¥‡∏î‡∏•‡∏ö ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏•‡∏∞ 1,824 ‡∏ö‡∏≤‡∏ó<br>
                ‚úÖ DTI ‡∏î‡∏µ ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢<br>
                ‚ùå Payback ‡∏ô‡∏≤‡∏ô ‡πÄ‡∏Å‡∏∑‡∏≠‡∏ö 25 ‡∏õ‡∏µ<br><br>
                <strong>‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥:</strong> ‡πÄ‡∏à‡∏£‡∏à‡∏≤‡∏•‡∏î‡∏£‡∏≤‡∏Ñ‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏≤‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤ (‚â•22,000)
              </div>

              <div class="example-card">
                <strong>Example 2: ‡∏Ñ‡∏≠‡∏ô‡πÇ‡∏î‡πÉ‡∏´‡∏°‡πà (‡πÉ‡∏Å‡∏•‡πâ‡∏£‡∏ñ‡πÑ‡∏ü‡∏ü‡πâ‡∏≤)</strong><br><br>
                <strong>Input:</strong><br>
                Purchase 3,500,000 | Area 32 sqm | Rent 22,000/mo | Salary 80,000 | Down 20% | Switches: Revenue ON,
                Financing ON<br><br>
                <strong>Output:</strong><br>
                ‚Ä¢ Gross Yield: 7.5% ‚úÖ<br>
                ‚Ä¢ Net Yield: 6.2% ‚úÖ<br>
                ‚Ä¢ Net Cashflow: +1,450 ‡∏ö‡∏≤‡∏ó/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏Å‡πá‡∏ö)<br>
                ‚Ä¢ DTI: 21.8% ‚úÖ<br>
                ‚Ä¢ Payback: 18.2 ‡∏õ‡∏µ<br>
                ‚Ä¢ CoC: 5.1%<br><br>
                <strong>Verdict:</strong><br>
                ‚úÖ ‡∏î‡∏µ - Net Yield ‡πÄ‡∏Å‡∏¥‡∏ô 6%<br>
                ‚úÖ Cashflow ‡∏ö‡∏ß‡∏Å ‡∏°‡∏µ passive income<br>
                ‚úÖ DTI ‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢ ‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤ 30%<br>
                ‚ö†Ô∏è Payback ‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á 18 ‡∏õ‡∏µ<br><br>
                <strong>‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥:</strong> ‡πÇ‡∏≠‡πÄ‡∏Ñ ‡∏•‡∏á‡∏ó‡∏∏‡∏ô‡πÑ‡∏î‡πâ ‡∏ú‡∏•‡∏ï‡∏≠‡∏ö‡πÅ‡∏ó‡∏ô‡∏î‡∏µ ‡∏°‡∏µ cashflow ‡∏ö‡∏ß‡∏Å
              </div>

              <div class="example-card">
                <strong>Example 3: ‡∏ó‡∏≤‡∏ß‡∏ô‡πå‡πÄ‡∏Æ‡πâ‡∏≤‡∏™‡πå‡∏ä‡∏≤‡∏ô‡πÄ‡∏°‡∏∑‡∏≠‡∏á</strong><br><br>
                <strong>Input:</strong><br>
                Purchase 2,800,000 | Area 80 sqm | Rent 15,000/mo | Salary 60,000 | Down 15% | Switches: Revenue ON,
                Financing ON<br><br>
                <strong>Output:</strong><br>
                ‚Ä¢ Gross Yield: 6.4% ‚úÖ<br>
                ‚Ä¢ Net Yield: 5.4% ‚ö†Ô∏è<br>
                ‚Ä¢ Net Cashflow: -1,200 ‡∏ö‡∏≤‡∏ó/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô<br>
                ‚Ä¢ DTI: 27.5% ‚úÖ<br>
                ‚Ä¢ Payback: 21.5 ‡∏õ‡∏µ<br>
                ‚Ä¢ CoC: -3.4%<br><br>
                <strong>Verdict:</strong><br>
                ‚ö†Ô∏è ‡∏û‡∏≠‡πÉ‡∏ä‡πâ - Net Yield ‡πÉ‡∏Å‡∏•‡πâ 6% ‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏∂‡∏á<br>
                ‚ö†Ô∏è Cashflow ‡∏ï‡∏¥‡∏î‡∏•‡∏ö‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢<br>
                ‚úÖ DTI ‡∏î‡∏µ ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢<br>
                ‚ùå Payback ‡∏Ñ‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≤‡∏á‡∏ô‡∏≤‡∏ô<br><br>
                <strong>‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥:</strong> ‡∏ï‡πà‡∏≠‡∏£‡∏≠‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤‡πÉ‡∏´‡πâ‡∏™‡∏π‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏õ‡πá‡∏ô 16,500 ‡∏à‡∏∞‡πÑ‡∏î‡πâ Net ‚â•6%
              </div>
            </div>
          </div>

          <!-- Threshold Guide -->
          <div class="accordion-section">
            <div class="accordion-header" onclick="toggleAccordion(this)">
              <span>üìè Threshold Guide</span>
              <span class="accordion-icon">‚ñ∏</span>
            </div>
            <div class="accordion-content">
              <h4>Quick Reference Table</h4>
              <table class="threshold-table">
                <tr>
                  <th>Metric</th>
                  <th>Excellent (‡∏î‡∏µ‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°)</th>
                  <th>Good (‡∏î‡∏µ)</th>
                  <th>Fair (‡∏û‡∏≠‡πÉ‡∏ä‡πâ)</th>
                  <th>Poor (‡∏Ñ‡∏ß‡∏£‡∏ó‡∏ö‡∏ó‡∏ß‡∏ô)</th>
                </tr>
                <tr>
                  <td>Gross Yield</td>
                  <td>‚Äî</td>
                  <td>‚â•6%</td>
                  <td>5-6%</td>
                  <td>&lt;5%</td>
                </tr>
                <tr>
                  <td>Net Yield</td>
                  <td>‚Äî</td>
                  <td>‚â•6%</td>
                  <td>5-6%</td>
                  <td>&lt;5%</td>
                </tr>
                <tr>
                  <td>DTI</td>
                  <td>&lt;20% üü¢</td>
                  <td>20-30%</td>
                  <td>30-40% üü°</td>
                  <td>&gt;40% üî¥</td>
                </tr>
                <tr>
                  <td>Payback</td>
                  <td>&lt;12 ‡∏õ‡∏µ</td>
                  <td>12-18 ‡∏õ‡∏µ</td>
                  <td>&gt;18 ‡∏õ‡∏µ</td>
                </tr>
                <tr>
                  <td>CoC Return</td>
                  <td>&gt;10%</td>
                  <td>5-10%</td>
                  <td>&lt;5%</td>
                </tr>
                <tr>
                  <td>IRR (5-10y)</td>
                  <td>&gt;10%</td>
                  <td>6-10%</td>
                  <td>&lt;6%</td>
                </tr>
                <tr>
                  <td>Equity Multiple</td>
                  <td>&gt;2.0√ó</td>
                  <td>1.5-2.0√ó</td>
                  <td>&lt;1.5√ó</td>
                </tr>
                <tr>
                  <td>Cashflow/mo</td>
                  <td>&gt;0 (‡∏ö‡∏ß‡∏Å)</td>
                  <td>-2K to 0</td>
                  <td>&lt;-2K (‡∏ï‡∏¥‡∏î‡∏•‡∏ö‡∏°‡∏≤‡∏Å)</td>
                </tr>
              </table>

              <h4>Context Notes</h4>
              <div class="glossary-item">
                <strong>Gross/Net Yield:</strong><br>
                ‚Ä¢ ‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏Ø ‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ 4-8%, ‡∏ï‡πà‡∏≤‡∏á‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î 6-12%<br>
                ‚Ä¢ Net Yield ‡∏Ñ‡∏ß‡∏£‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤ Fixed Deposit (1-2%) ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 3-4%
              </div>
              <div class="glossary-item">
                <strong>DTI (Debt-to-Income):</strong><br>
                ‚Ä¢ ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏™‡πà‡∏ß‡∏ô‡πÉ‡∏´‡∏ç‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÑ‡∏î‡πâ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 40-45%<br>
                ‚Ä¢ ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ ‚â§30% ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏°‡∏µ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢
              </div>
              <div class="glossary-item">
                <strong>Payback Period:</strong><br>
                ‚Ä¢ ‡∏¢‡∏¥‡πà‡∏á‡πÄ‡∏£‡πá‡∏ß‡∏¢‡∏¥‡πà‡∏á‡∏î‡∏µ ‡πÅ‡∏ï‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏î‡∏π quality ‡∏Ç‡∏≠‡∏á‡∏ó‡∏≥‡πÄ‡∏•<br>
                ‚Ä¢ &gt;20 ‡∏õ‡∏µ = ‡∏Ñ‡∏ß‡∏£‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤‡∏ß‡πà‡∏≤‡∏Ñ‡∏∏‡πâ‡∏°‡∏Ñ‡πà‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
              </div>
              <div class="glossary-item">
                <strong>CoC Return:</strong><br>
                ‚Ä¢ CoC ‡∏ï‡∏¥‡∏î‡∏•‡∏ö‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÅ‡∏õ‡∏•‡∏ß‡πà‡∏≤‡πÅ‡∏¢‡πà‡πÄ‡∏™‡∏°‡∏≠ - ‡∏≠‡∏≤‡∏à‡πÅ‡∏•‡∏Å‡∏Å‡∏±‡∏ö capital gain<br>
                ‚Ä¢ ‡∏î‡∏π IRR ‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏ñ‡πâ‡∏≤‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏Ç‡∏≤‡∏¢
              </div>
              <div class="glossary-item">
                <strong>IRR vs Stock Market:</strong><br>
                ‚Ä¢ Stock market average ~8-10%<br>
                ‚Ä¢ Bond ~3-5%<br>
                ‚Ä¢ Real estate ‡∏Ñ‡∏ß‡∏£ &gt;6% ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ä‡∏î‡πÄ‡∏ä‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á
              </div>
              <div class="glossary-item">
                <strong>Equity Multiple:</strong><br>
                ‚Ä¢ 2.5√ó = ‡∏•‡∏á‡∏ó‡∏∏‡∏ô 1 ‡∏•‡πâ‡∏≤‡∏ô ‡πÑ‡∏î‡πâ‡∏Å‡∏•‡∏±‡∏ö 2.5 ‡∏•‡πâ‡∏≤‡∏ô (‡∏Å‡∏≥‡πÑ‡∏£ 1.5 ‡∏•‡πâ‡∏≤‡∏ô)
              </div>
              <div class="glossary-item">
                <strong>Net Cashflow Strategy:</strong><br>
                ‚Ä¢ Cashflow ‡∏ï‡∏¥‡∏î‡∏•‡∏ö = ‡πÅ‡∏•‡∏Å‡∏Å‡∏±‡∏ö capital gain + forced savings
              </div>
            </div>
          </div>

          <!-- Common Mistakes -->
          <div class="accordion-section">
            <div class="accordion-header" onclick="toggleAccordion(this)">
              <span>‚ö†Ô∏è Common Mistakes</span>
              <span class="accordion-icon">‚ñ∏</span>
            </div>
            <div class="accordion-content">
              <div class="glossary-item">
                <strong>1. ‡∏•‡∏∑‡∏°‡∏£‡∏ß‡∏°‡∏Ñ‡πà‡∏≤ Acquisition Cost</strong><br>
                ‚ùå ‡∏ú‡∏¥‡∏î: ‡∏Ñ‡∏¥‡∏î‡πÅ‡∏Ñ‡πà‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ã‡∏∑‡πâ‡∏≠ 4,000,000<br>
                ‚úÖ ‡∏ñ‡∏π‡∏Å: ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ã‡∏∑‡πâ‡∏≠ 4,000,000 + ‡πÇ‡∏≠‡∏ô 3% (120,000) = 4,120,000<br>
                <em>‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö:</em> Payback ‡∏ô‡∏≤‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô, CoC ‡∏ï‡πà‡∏≥‡∏•‡∏á<br>
                <em>‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏Å‡πâ:</em> ‡πÄ‡∏õ‡∏¥‡∏î Investment Switch ON
              </div>
              <div class="glossary-item">
                <strong>2. ‡∏ï‡∏±‡πâ‡∏á Occupancy 100% (‡πÑ‡∏°‡πà‡∏™‡∏°‡∏à‡∏£‡∏¥‡∏á)</strong><br>
                ‚ùå ‡∏ú‡∏¥‡∏î: ‡∏Ñ‡∏¥‡∏î‡∏ß‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤‡πÄ‡∏ï‡πá‡∏° 12 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏∏‡∏Å‡∏õ‡∏µ<br>
                ‚úÖ ‡∏ñ‡∏π‡∏Å: ‡πÉ‡∏ä‡πâ 85-95% (‡∏°‡∏µ‡∏ä‡πà‡∏ß‡∏á‡∏ß‡πà‡∏≤‡∏á‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡πà‡∏≤)<br>
                <em>‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö:</em> Net Yield ‡∏™‡∏π‡∏á‡πÄ‡∏Å‡∏¥‡∏ô‡∏à‡∏£‡∏¥‡∏á, ‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î<br>
                <em>‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏Å‡πâ:</em> ‡πÉ‡∏ä‡πâ 90% (‡∏ß‡πà‡∏≤‡∏á ~1 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏õ‡∏µ)
              </div>
              <div class="glossary-item">
                <strong>3. ‡∏•‡∏∑‡∏°‡∏Ñ‡∏¥‡∏î‡∏Ñ‡πà‡∏≤ Agent Fee</strong><br>
                ‚ùå ‡∏ú‡∏¥‡∏î: ‡∏Ñ‡∏¥‡∏î‡∏ß‡πà‡∏≤‡∏´‡∏≤‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡πà‡∏≤‡πÑ‡∏î‡πâ‡πÄ‡∏≠‡∏á ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢<br>
                ‚úÖ ‡∏ñ‡∏π‡∏Å: ‡πÉ‡∏ä‡πâ‡∏ô‡∏≤‡∏¢‡∏´‡∏ô‡πâ‡∏≤ ~1 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤/‡∏õ‡∏µ<br>
                <em>‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö:</em> NOI ‡∏™‡∏π‡∏á‡πÄ‡∏Å‡∏¥‡∏ô‡∏à‡∏£‡∏¥‡∏á ~8%<br>
                <em>‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏Å‡πâ:</em> ‡∏ï‡∏±‡πâ‡∏á Agent Fee = 1 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏õ‡∏µ
              </div>
              <div class="glossary-item">
                <strong>4. DTI ‡πÄ‡∏Å‡∏¥‡∏ô 40% (‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏¢‡∏≤‡∏Å)</strong><br>
                ‚ùå ‡∏ú‡∏¥‡∏î: ‡∏Å‡∏π‡πâ‡πÄ‡∏ï‡πá‡∏°‡∏ó‡∏µ‡πà Down 10% ‡πÅ‡∏ï‡πà‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÑ‡∏°‡πà‡∏û‡∏≠<br>
                ‚úÖ ‡∏ñ‡∏π‡∏Å: ‡πÄ‡∏ä‡πá‡∏Ñ DTI ‡∏Å‡πà‡∏≠‡∏ô‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à ‡∏Ñ‡∏ß‡∏£ ‚â§30%<br>
                <em>‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö:</em> ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏™‡∏¥‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠<br>
                <em>‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏Å‡πâ:</em> ‡πÄ‡∏û‡∏¥‡πà‡∏° Down payment ‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡πà‡∏≠‡∏£‡∏≠‡∏á‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ã‡∏∑‡πâ‡∏≠
              </div>
              <div class="glossary-item">
                <strong>5. ‡πÑ‡∏°‡πà‡∏Ñ‡∏¥‡∏î Two-way Binding</strong><br>
                ‚ùå ‡∏ú‡∏¥‡∏î: ‡∏Å‡∏£‡∏≠‡∏Å Purchase, Avg/sqm, Area ‡πÅ‡∏¢‡∏Å‡∏Å‡∏±‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô<br>
                ‚úÖ ‡∏ñ‡∏π‡∏Å: Purchase ‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏±‡∏Å ‚Üí ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Avg/sqm ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥<br>
                <em>‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö:</em> ‡∏™‡∏±‡∏ö‡∏™‡∏ô ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏Ç‡∏±‡∏î‡πÅ‡∏¢‡πâ‡∏á‡∏Å‡∏±‡∏ô<br>
                <em>‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏Å‡πâ:</em> ‡∏õ‡∏•‡πà‡∏≠‡∏¢‡πÉ‡∏´‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì 1 ‡πÉ‡∏ô 3 ‡∏ä‡πà‡∏≠‡∏á
              </div>
              <div class="glossary-item">
                <strong>6. ‡πÉ‡∏ä‡πâ Gross Yield ‡πÅ‡∏ó‡∏ô Net Yield ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à</strong><br>
                ‚ùå ‡∏ú‡∏¥‡∏î: Gross 6% ‡∏î‡∏π‡∏î‡∏µ ‡πÄ‡∏•‡∏¢‡∏•‡∏á‡∏ó‡∏∏‡∏ô<br>
                ‚úÖ ‡∏ñ‡∏π‡∏Å: ‡∏ï‡πâ‡∏≠‡∏á‡∏î‡∏π Net Yield (‡∏´‡∏•‡∏±‡∏á‡∏´‡∏±‡∏Å‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢)<br>
                <em>‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö:</em> ‡∏ú‡∏•‡∏ï‡∏≠‡∏ö‡πÅ‡∏ó‡∏ô‡∏à‡∏£‡∏¥‡∏á‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏Ñ‡∏¥‡∏î<br>
                <em>‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏Å‡πâ:</em> ‡πÄ‡∏õ‡∏¥‡∏î Revenue Switch ON ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π Net Yield
              </div>
              <div class="glossary-item">
                <strong>7. ‡∏Ñ‡∏¥‡∏î‡∏ß‡πà‡∏≤ CoC ‡∏ï‡∏¥‡∏î‡∏•‡∏ö = ‡πÅ‡∏¢‡πà‡πÄ‡∏™‡∏°‡∏≠</strong><br>
                ‚ùå ‡∏ú‡∏¥‡∏î: CoC -5% ‡πÄ‡∏•‡∏¢‡πÑ‡∏°‡πà‡∏•‡∏á‡∏ó‡∏∏‡∏ô<br>
                ‚úÖ ‡∏ñ‡∏π‡∏Å: CoC ‡∏ï‡∏¥‡∏î‡∏•‡∏ö‡∏≠‡∏≤‡∏à‡πÄ‡∏õ‡πá‡∏ô forced savings + ‡∏£‡∏≠ capital gain<br>
                <em>Context:</em> ‡∏ñ‡πâ‡∏≤ IRR ‡∏î‡∏µ (&gt;10%) ‡πÅ‡∏°‡πâ CoC ‡∏ï‡∏¥‡∏î‡∏•‡∏ö‡∏Å‡πá‡∏¢‡∏±‡∏á‡∏Ñ‡∏∏‡πâ‡∏°<br>
                <em>‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏Å‡πâ:</em> ‡∏î‡∏π IRR ‡πÅ‡∏•‡∏∞ Equity Multiple ‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö
              </div>
            </div>
          </div>

          <!-- FAQ -->
          <div class="accordion-section">
            <div class="accordion-header" onclick="toggleAccordion(this)">
              <span>‚ùì FAQ</span>
              <span class="accordion-icon">‚ñ∏</span>
            </div>
            <div class="accordion-content">
              <div class="faq-item">
                <strong>Q1: ‡∏ó‡∏≥‡πÑ‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å Purchase ‡∏Å‡πà‡∏≠‡∏ô?</strong><br>
                A: Purchase ‡πÄ‡∏õ‡πá‡∏ô "‡∏´‡∏±‡∏ß‡πÉ‡∏à" ‡∏Ç‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Yield ‡πÅ‡∏•‡∏∞ Payback - ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ Purchase ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Yield ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ (‡πÅ‡∏ï‡πà‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
                Avg/sqm + Area ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Purchase ‡πÉ‡∏´‡πâ)
              </div>
              <div class="faq-item">
                <strong>Q2: ‡∏ó‡∏≥‡πÑ‡∏° DTI ‡πÅ‡∏™‡∏î‡∏á "‚Äî"?</strong><br>
                A: ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å Salary ‡∏Å‡πà‡∏≠‡∏ô - DTI = PMT √∑ Salary, ‡πÑ‡∏°‡πà‡∏°‡∏µ Salary ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ
              </div>
              <div class="faq-item">
                <strong>Q3: Switch ‡∏Ñ‡∏∑‡∏≠‡∏≠‡∏∞‡πÑ‡∏£? ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏´‡∏£‡πà‡∏Ñ‡∏ß‡∏£‡πÄ‡∏õ‡∏¥‡∏î?</strong><br>
                A: Switch = ‡∏õ‡∏∏‡πà‡∏°‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏ß‡πà‡∏≤‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡∏à‡∏£‡∏¥‡∏á‡∏´‡∏£‡∏∑‡∏≠ neutral baseline<br>
                ‚Ä¢ OFF = ‡∏ú‡∏•‡∏ï‡∏≠‡∏ö‡πÅ‡∏ó‡∏ô‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î (best case)<br>
                ‚Ä¢ ON = ‡∏ú‡∏•‡∏ï‡∏≠‡∏ö‡πÅ‡∏ó‡∏ô‡∏à‡∏£‡∏¥‡∏á (realistic)<br>
                ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: ‡∏°‡∏∑‡∏≠‡πÉ‡∏´‡∏°‡πà‡∏õ‡∏¥‡∏î‡∏ó‡∏∏‡∏Å switch ‡∏î‡∏π Gross ‡∏Å‡πà‡∏≠‡∏ô, ‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à‡∏à‡∏£‡∏¥‡∏á‡πÄ‡∏õ‡∏¥‡∏î Revenue + Financing
              </div>
              <div class="faq-item">
                <strong>Q4: ‡∏ó‡∏≥‡πÑ‡∏° Net Yield ‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤ Gross Yield ‡πÄ‡∏¢‡∏≠‡∏∞?</strong><br>
                A: ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏´‡∏±‡∏Å‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß - Occupancy 90% + Opex 15% + Agent Fee 1 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏õ‡∏µ (‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì 1-2%)
              </div>
              <div class="faq-item">
                <strong>Q5: CoC ‡∏ï‡∏¥‡∏î‡∏•‡∏ö‡πÅ‡∏õ‡∏•‡∏ß‡πà‡∏≤‡πÅ‡∏¢‡πà‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°?</strong><br>
                A: ‡πÑ‡∏°‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô! CoC ‡∏ï‡∏¥‡∏î‡∏•‡∏ö = ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏∏‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ‡πÅ‡∏ï‡πà‡πÑ‡∏î‡πâ asset + forced savings - ‡∏ñ‡πâ‡∏≤ IRR &gt;10% + EM
                &gt;2√ó ‡∏¢‡∏±‡∏á‡∏Ñ‡∏∏‡πâ‡∏°
              </div>
              <div class="faq-item">
                <strong>Q6: Scenario Low/Base/High ‡∏Ñ‡∏∑‡∏≠‡∏≠‡∏∞‡πÑ‡∏£?</strong><br>
                A: ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô ¬±10% - Low (-10%) = worst case, Base (0%) = expected, High
                (+10%) = best case
              </div>
              <div class="faq-item">
                <strong>Q7: Payback 25 ‡∏õ‡∏µ ‡∏ô‡∏≤‡∏ô‡πÑ‡∏õ‡πÑ‡∏´‡∏°?</strong><br>
                A: ‡∏Ç‡∏∂‡πâ‡∏ô‡∏Å‡∏±‡∏ö‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ - ‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∑‡∏ô‡∏ó‡∏∏‡∏ô‡πÄ‡∏£‡πá‡∏ß (&lt;12 ‡∏õ‡∏µ) ‡∏ô‡∏≤‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ, ‡∏ñ‡πâ‡∏≤‡∏ñ‡∏∑‡∏≠‡∏¢‡∏≤‡∏ß + ‡∏£‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏∂‡πâ‡∏ô ‡∏£‡∏±‡∏ö‡πÑ‡∏î‡πâ
                (‡πÇ‡∏î‡∏¢‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ &lt;18 ‡∏õ‡∏µ = ‡∏î‡∏µ, &gt;20 ‡∏õ‡∏µ = ‡∏Ñ‡∏ß‡∏£‡∏ó‡∏ö‡∏ó‡∏ß‡∏ô)
              </div>
              <div class="faq-item">
                <strong>Q8: ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡∏¥‡∏î Exit Switch ‡πÄ‡∏™‡∏°‡∏≠‡πÑ‡∏´‡∏°?</strong><br>
                A: ‡πÑ‡∏°‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô - ‡πÄ‡∏õ‡∏¥‡∏î‡∏ñ‡πâ‡∏≤‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏Ç‡∏≤‡∏¢‡πÉ‡∏ô 5-10 ‡∏õ‡∏µ (‡∏î‡∏π IRR, EM), ‡∏õ‡∏¥‡∏î‡∏ñ‡πâ‡∏≤‡∏ñ‡∏∑‡∏≠‡∏¢‡∏≤‡∏ß‡πÑ‡∏°‡πà‡∏Ñ‡∏¥‡∏î‡∏Ç‡∏≤‡∏¢ (‡∏î‡∏π Net Yield, Cashflow)
              </div>
              <div class="faq-item">
                <strong>Q9: Two-way binding ‡∏Ñ‡∏∑‡∏≠‡∏≠‡∏∞‡πÑ‡∏£?</strong><br>
                A: ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á Purchase ‚áÑ Avg/sqm ‚áÑ Area - ‡∏Å‡∏£‡∏≠‡∏Å 2 ‡πÉ‡∏ô 3 ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà 3 ‡πÉ‡∏´‡πâ (‡∏Å‡∏é: Purchase
                ‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏±‡∏Å ‡∏ñ‡πâ‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏£‡∏ö 3 ‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á ‡∏¢‡∏∂‡∏î Purchase ‡∏õ‡∏£‡∏±‡∏ö Avg/sqm)
              </div>
              <div class="faq-item">
                <strong>Q10: ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏°‡∏∑‡∏≠‡πÉ‡∏´‡∏°‡πà?</strong><br>
                A: ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏ö‡∏ö‡∏á‡πà‡∏≤‡∏¢ - (1) ‡∏Å‡∏£‡∏≠‡∏Å Purchase + Rent ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß (2) ‡∏î‡∏π Gross Yield (‡∏Ñ‡∏ß‡∏£ ‚â•6%) (3) ‡πÄ‡∏õ‡∏¥‡∏î Revenue
                Switch ‚Üí ‡∏î‡∏π Net Yield (4) ‡∏°‡∏µ‡πÅ‡∏ú‡∏ô‡∏Å‡∏π‡πâ ‡∏Å‡∏£‡∏≠‡∏Å Salary ‚Üí ‡∏î‡∏π DTI (5) ‡∏û‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à ‡∏Ñ‡πà‡∏≠‡∏¢‡∏•‡∏≠‡∏á‡πÄ‡∏õ‡∏¥‡∏î Exit
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>

  <script>
    function clamp(v, min, max) { return Math.min(Math.max(v, min), max); }
    function n(v) {
      if (typeof v === 'string') {
        // Remove commas and convert to number
        v = v.replace(/,/g, '');
      }
      const x = Number(v);
      return Number.isFinite(x) ? x : NaN;
    }
    function thb(nu) { return Number.isFinite(nu) ? nu.toLocaleString('th-TH', { maximumFractionDigits: 0 }) + ' ‡∏ø' : '‚Äî'; }
    function pct(nu) { return Number.isFinite(nu) ? (nu * 100).toFixed(1) + '%' : '‚Äî'; }
    function formatNumber(num) {
      if (!Number.isFinite(num)) return '';
      return num.toLocaleString('en-US');
    }
    function isValidNumber(str) {
      if (!str || str.trim() === '') return true; // Empty is valid
      const cleanStr = str.replace(/,/g, '');
      const num = Number(cleanStr);
      return Number.isFinite(num) && num >= 0;
    }
    const el = (id) => document.getElementById(id);

    const E = {
      purchase: el('purchase'), avgpsm: el('avgpsm'), area: el('area'),
      acq: el('acq_pct'), fit: el('fitout'), other: el('other'),
      rent: el('rent'), tgt_gross: el('tgt_gross'),
      occ: el('occ'), opex: el('opex'), agentm: el('agentm'),
      salary: el('salary'), down: el('down'), rate: el('rate'), tenor: el('tenor'),
      exit_on: el('exit_on'), hold: el('hold'), pgrow: el('pgrow'), sellc: el('sellc'),
      exit_mode: el('exit_mode'), exit_price: el('exit_price'), tax_pct: el('tax_pct'),
      swInv: el('swInv'), swRev: el('swRev'), swFin: el('swFin'), swExit: el('swExit')
    };

    const O = {
      gross: el('gross'), net: el('net'), coc: el('coc'), dti: el('dti'),
      netmo: el('netmo'), pmt: el('pmt'), payback: el('payback'),
      tval: el('tval'), npro: el('npro'), cgain: el('cgain'),
      irr: el('irr'), emult: el('emult'),
      loan_amt: el('loan_amt'), pmt2: el('pmt2'), tot_int: el('tot_int'), aff_warn: el('aff_warn')
    };

    const H = { acq_thb: el('acq_thb'), occ_eff: el('occ_eff'), opex_thb: el('opex_thb'), agent_thb: el('agent_thb') };
    const ai = el('ai_note');
    let activeScenario = 'base';

    document.querySelectorAll('.adv-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const t = document.querySelector(btn.dataset.target);
        t.style.display = (t.style.display === 'none' || t.style.display === '') ? 'block' : 'none'; recalc();
      });
    });

    ['swInv', 'swRev', 'swFin', 'swExit'].forEach(id => { const s = E[id]; s.addEventListener('change', async () => await recalc()); });

    function setErr(node, bad, msg = '') { if (!node) return; node.classList.toggle('err', !!bad); if (bad && msg) node.title = msg; else node.removeAttribute('title'); }

    // Add number formatting to all numeric input fields
    const numericFields = ['rent', 'salary', 'fitout', 'other', 'exit_price'];
    numericFields.forEach(id => {
      const field = E[id];
      if (field) {
        field.addEventListener('input', (e) => {
          const cursorPos = e.target.selectionStart;
          const oldValue = e.target.value;
          const newValue = formatInputNumber(oldValue);

          if (newValue !== oldValue) {
            e.target.value = newValue;
            const commasAdded = (newValue.match(/,/g) || []).length - (oldValue.match(/,/g) || []).length;
            e.target.setSelectionRange(cursorPos + commasAdded, cursorPos + commasAdded);
          }

          // Validate number format
          if (e.target.value !== '' && !isValidNumber(e.target.value)) {
            setErr(e.target, true, '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
          } else {
            setErr(e.target, false);
          }
        });

        field.addEventListener('blur', () => {
          if (field.value !== '' && !isValidNumber(field.value)) {
            setErr(field, true, '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
          } else {
            setErr(field, false);
          }
        });
      }
    });

    // Investment two-way - LAST-CHANGED-WINS logic
    let lastChanged = null;
    let isUpdating = false;

    ['purchase', 'avgpsm', 'area'].forEach(id => {
      E[id].addEventListener('input', (e) => {
        if (isUpdating) return;
        lastChanged = id;

        // Format number with commas as user types
        const cursorPos = e.target.selectionStart;
        const oldValue = e.target.value;
        const newValue = formatInputNumber(oldValue);

        if (newValue !== oldValue) {
          e.target.value = newValue;
          const commasAdded = (newValue.match(/,/g) || []).length - (oldValue.match(/,/g) || []).length;
          e.target.setSelectionRange(cursorPos + commasAdded, cursorPos + commasAdded);
        }

        // Instant update on every keystroke
        twoWayInvestment();
        recalc();
      });
    });

    function formatInputNumber(value) {
      if (!value) return '';
      // Remove all non-digits and decimal points
      const cleanValue = value.replace(/[^\d.]/g, '');
      const parts = cleanValue.split('.');

      // Format integer part with commas
      if (parts[0]) {
        parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ',');
      }

      // Return formatted number (with decimal if exists)
      return parts.length > 1 ? parts[0] + '.' + parts[1] : parts[0];
    }

    function twoWayInvestment() {
      if (isUpdating) return;

      const P = n(E.purchase.value);
      const A = n(E.area.value);
      const U = n(E.avgpsm.value);

      const hasP = Number.isFinite(P) && P > 0;
      const hasA = Number.isFinite(A) && A > 0;
      const hasU = Number.isFinite(U) && U > 0;

      // Clear all error states
      setErr(E.purchase, false);
      setErr(E.area, false);
      setErr(E.avgpsm, false);

      // Validate number format
      if (E.purchase.value !== '' && !isValidNumber(E.purchase.value)) {
        setErr(E.purchase, true, '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
        return;
      }
      if (E.area.value !== '' && !isValidNumber(E.area.value)) {
        setErr(E.area, true, '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
        return;
      }
      if (E.avgpsm.value !== '' && !isValidNumber(E.avgpsm.value)) {
        setErr(E.avgpsm, true, '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
        return;
      }

      // LAST-CHANGED-WINS LOGIC
      // Last field edited = source of truth, calculate other 2 fields from it
      // Formula: Purchase = Avg/sqm √ó Area

      isUpdating = true;

      if (lastChanged === 'purchase' && hasP) {
        // User edited Purchase ‚Üí calculate Avg (if Area exists) OR Area (if Avg exists)
        if (hasA && !hasU) {
          // Calculate Avg from Purchase / Area
          E.avgpsm.value = formatNumber(Math.round(P / A));
        }
        else if (hasU && !hasA) {
          // Calculate Area from Purchase / Avg
          E.area.value = formatNumber((P / U).toFixed(2));
        }
        else if (hasA && hasU) {
          // Both exist, recalculate Avg to maintain Purchase as source
          E.avgpsm.value = formatNumber(Math.round(P / A));
        }
      }
      else if (lastChanged === 'avgpsm' && hasU) {
        // User edited Avg ‚Üí calculate Purchase (if Area exists) OR Area (if Purchase exists)
        if (hasA && !hasP) {
          // Calculate Purchase from Avg √ó Area
          E.purchase.value = formatNumber(Math.round(U * A));
        }
        else if (hasP && !hasA) {
          // Calculate Area from Purchase / Avg
          E.area.value = formatNumber((P / U).toFixed(2));
        }
        else if (hasP && hasA) {
          // Both exist, recalculate Purchase to maintain Avg as source
          E.purchase.value = formatNumber(Math.round(U * A));
        }
      }
      else if (lastChanged === 'area' && hasA) {
        // User edited Area ‚Üí calculate Purchase (if Avg exists) OR Avg (if Purchase exists)
        if (hasU && !hasP) {
          // Calculate Purchase from Avg √ó Area
          E.purchase.value = formatNumber(Math.round(U * A));
        }
        else if (hasP && !hasU) {
          // Calculate Avg from Purchase / Area
          E.avgpsm.value = formatNumber(Math.round(P / A));
        }
        else if (hasP && hasU) {
          // Both exist, recalculate Purchase to maintain Area as source
          E.purchase.value = formatNumber(Math.round(U * A));
        }
      }

      // Handle single non-Purchase field errors
      const filledCount = (hasP ? 1 : 0) + (hasA ? 1 : 0) + (hasU ? 1 : 0);
      if (filledCount === 1) {
        if (hasU && !hasP && !hasA) {
          setErr(E.purchase, true, '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ã‡∏∑‡πâ‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà');
          setErr(E.area, true, '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ã‡∏∑‡πâ‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà');
        }
        else if (hasA && !hasP && !hasU) {
          setErr(E.purchase, true, '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ã‡∏∑‡πâ‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏ï‡∏£.‡∏°.');
          setErr(E.avgpsm, true, '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ã‡∏∑‡πâ‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏ï‡∏£.‡∏°.');
        }
      }

      isUpdating = false;
    }

    // Revenue two-way (base = Purchase)
    E.rent.addEventListener('input', () => { twoWayRevenue('rent'); recalc(); });
    E.tgt_gross.addEventListener('input', () => { twoWayRevenue('tgt'); recalc(); });
    function twoWayRevenue(changed) {
      const P = n(E.purchase.value);
      const rent = n(E.rent.value), tgt = (n(E.tgt_gross.value)) / 100;
      const hasP = Number.isFinite(P);

      // Validate number format
      if (E.rent.value !== '' && !isValidNumber(E.rent.value)) {
        setErr(E.rent, true, '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
        return;
      }
      if (E.tgt_gross.value !== '' && !isValidNumber(E.tgt_gross.value)) {
        setErr(E.tgt_gross, true, '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
        return;
      }

      if (!hasP) {
        setErr(E.tgt_gross, true, '‡∏Å‡∏£‡∏≠‡∏Å Purchase ‡∏Å‡πà‡∏≠‡∏ô');
        setErr(E.rent, !Number.isFinite(rent) && E.rent.value !== '');
        return;
      }

      setErr(E.tgt_gross, false);
      setErr(E.rent, false);

      if (changed === 'tgt' && Number.isFinite(tgt)) {
        E.rent.value = formatNumber(Math.round((tgt * P) / 12));
      }
      else if (changed === 'rent' && Number.isFinite(rent) && P > 0) {
        E.tgt_gross.value = ((rent * 12) / P * 100).toFixed(2);
      }
    }

    // Helpers
    function PMT(rateAPR, years, principal) {
      const i = rateAPR / 1200, n = years * 12; return (i > 0) ? principal * i / (1 - Math.pow(1 + i, -n)) : (n > 0 ? principal / n : 0);
    }
    function IRR(flows) {
      function npv(r) { let s = 0; for (let t = 0; t < flows.length; t++) s += flows[t] / Math.pow(1 + r, t); return s; }
      let r0 = 0.1, r1 = 0.11, f0 = npv(r0), f1 = npv(r1);
      for (let i = 0; i < 50; i++) {
        const r2 = r1 - f1 * (r1 - r0) / (f1 - f0); if (!isFinite(r2)) return NaN;
        r0 = r1; f0 = f1; r1 = r2; f1 = npv(r1); if (Math.abs(f1) < 1e-8) break;
      }
      return r1;
    }

    // Global variables for API integration
    const API_CONFIG = {
      baseURL: window.location.hostname === 'localhost'
        ? 'http://localhost:8000'
        : 'https://your-api-domain.com',
      timeout: 10000
    };

    let apiCache = {};
    let isCalculating = false;
    let tooltipsData = {};

    // v1.5: Default tooltips (fallback if API fails)
    const DEFAULT_TOOLTIPS = {
      purchase_price: "‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≤‡∏¢‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô ‡∏£‡∏ß‡∏° VAT (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)|‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: 4,000,000 ‡∏ö‡∏≤‡∏ó|‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Yield ‡πÅ‡∏•‡∏∞ Payback",
      avg_psm: "‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ï‡πà‡∏≠‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏°‡∏ï‡∏£|‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≤‡∏Å ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ã‡∏∑‡πâ‡∏≠ √∑ ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà|‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏±‡∏ö‡∏ï‡∏•‡∏≤‡∏î",
      area_sqm: "‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏™‡∏≠‡∏¢‡∏Ç‡∏≠‡∏á‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô|‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: 35 ‡∏ï‡∏£.‡∏°.|‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏ï‡πà‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏°‡∏ï‡∏£",
      monthly_rent: "‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏±‡∏Å‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢|‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: 20,000 ‡∏ö‡∏≤‡∏ó|‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Gross Yield",
      target_gross_yield: "‡∏ú‡∏•‡∏ï‡∏≠‡∏ö‡πÅ‡∏ó‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£|‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≤‡∏Å (‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤√ó12)√∑‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ã‡∏∑‡πâ‡∏≠√ó100|‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ 5-8%",
      gross_salary: "‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏£‡∏ß‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏±‡∏Å‡∏†‡∏≤‡∏©‡∏µ|‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: 70,000 ‡∏ö‡∏≤‡∏ó|‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì DTI Ratio",
      down_payment_pct: "‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå‡πÄ‡∏á‡∏¥‡∏ô‡∏î‡∏≤‡∏ß‡∏ô‡πå‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ã‡∏∑‡πâ‡∏≠|‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: 10%|‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏ï‡πà‡∏≠‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡∏π‡πâ‡πÅ‡∏•‡∏∞ CoC",
      holding_years: "‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏ñ‡∏∑‡∏≠‡∏Ñ‡∏£‡∏≠‡∏á‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏Ç‡∏≤‡∏¢|‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: 5 ‡∏õ‡∏µ|‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì IRR ‡πÅ‡∏•‡∏∞ Capital Gain",
      price_growth: "‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏¥‡∏ö‡πÇ‡∏ï‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô‡∏ï‡πà‡∏≠‡∏õ‡∏µ|‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: 3%|‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ï‡∏•‡∏≤‡∏î 2-5% ‡∏ï‡πà‡∏≠‡∏õ‡∏µ",
      selling_cost: "‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢ ‡πÄ‡∏ä‡πà‡∏ô ‡∏Ñ‡πà‡∏≤‡∏ô‡∏≤‡∏¢‡∏´‡∏ô‡πâ‡∏≤ ‡∏†‡∏≤‡∏©‡∏µ|‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: 3%|‡∏õ‡∏Å‡∏ï‡∏¥ 2-5% ‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢"
    };

    async function computeScenario(rentBase, delta) {
      const rent = (rentBase || 0) * (1 + delta);
      const cacheKey = `${rentBase}_${delta}_${JSON.stringify(getInputValues())}`;

      // Return cached result if available
      if (apiCache[cacheKey]) {
        return apiCache[cacheKey];
      }

      try {
        const requestData = prepareApiRequest(rent);
        const response = await apiCall('/calc/scenario', requestData);

        if (response.status === 'success') {
          const result = parseApiResponse(response.data, rent);
          apiCache[cacheKey] = result;
          return result;
        } else {
          throw new Error(response.error?.message || 'Calculation failed');
        }
      } catch (error) {
        console.warn('API call failed, using fallback calculation:', error);
        return computeScenarioFallback(rentBase, delta);
      }
    }

    function computeScenarioFallback(rentBase, delta) {
      const P = n(E.purchase.value) || 0;

      // INVESTMENT
      const useInv = E.swInv.checked; // side switch
      const acqPct = useInv ? (n(E.acq.value) || 3) / 100 : 0;
      const fit = useInv ? (n(E.fit.value) || 0) : 0;
      const other = useInv ? (n(E.other.value) || 0) : 0;
      const cost_basis = P + P * acqPct + fit + other;

      // REVENUE
      const useRev = E.swRev.checked;
      const occ = useRev ? clamp((n(E.occ.value) || 90) / 100, 0.5, 1) : 1.0;   // neutral 100%
      const opex = useRev ? clamp((n(E.opex.value) || 15) / 100, 0, 0.6) : 0.0; // neutral 0%
      const agentm = useRev ? clamp(n(E.agentm.value) || 1, 0, 12) : 0;       // neutral 0

      // FINANCING
      const down = clamp((n(E.down.value) || 10) / 100, 0, 0.9),
        rate = (E.swFin.checked ? (n(E.rate.value) || 4.5) : 4.5), // neutral APR 4.5
        years = (E.swFin.checked ? +(E.tenor.value || 30) : 30);   // neutral 30y
      const salary = n(E.salary.value);
      const financeOn = Number.isFinite(salary) && salary > 0;

      const rent = (rentBase || 0) * (1 + delta);
      const acqCost = P * acqPct;
      const loan = Number.isFinite(P) ? Math.max(P - P * down, 0) : NaN;
      const pmt = financeOn && Number.isFinite(loan) ? PMT(rate, years, loan) : 0;
      const rentEff = rent * occ;
      const agentTHB = rent * (agentm / 12);
      const opexTHB = rent * opex;
      const noiMonthly = rentEff - agentTHB - opexTHB;
      const netMonthly = noiMonthly - pmt;

      // Yields on Purchase
      const grossYield = P > 0 ? (rent * 12) / P : NaN;
      const netYield = P > 0 ? (noiMonthly * 12) / P : NaN;

      const downAmount = Number.isFinite(P) && Number.isFinite(down) ? P * down : 0;
      const equity = downAmount + acqCost + fit + other;
      const coc = equity > 0 ? (netMonthly * 12) / equity : NaN;
      const dti = financeOn && Number.isFinite(pmt) && salary > 0 ? pmt / salary : NaN;
      const payback = (noiMonthly > 0 && cost_basis > 0) ? (cost_basis / (noiMonthly * 12)) : NaN;

      return {
        rent, noiMonthly, netMonthly, grossYield, netYield, coc, dti, payback, pmt, loan, cost_basis, equity, financeOn,
        P, occ, opex
      };
    }

    function getInputValues() {
      return {
        purchase: n(E.purchase.value),
        rent: n(E.rent.value),
        salary: n(E.salary.value),
        swInv: E.swInv.checked,
        swRev: E.swRev.checked,
        swFin: E.swFin.checked,
        swExit: E.swExit.checked
      };
    }

    function prepareApiRequest(rent) {
      const P = n(E.purchase.value) || 0;
      const salary = n(E.salary.value);

      return {
        purchase_price: P,
        monthly_rent: rent,
        area_sqm: n(E.area.value) || null,
        gross_salary: Number.isFinite(salary) ? salary : null,
        loan_tenor_years: E.swFin.checked ? parseInt(E.tenor.value) || 30 : 30,
        interest_rate_annual: E.swFin.checked ? (n(E.rate.value) || 4.5) : 4.5,
        down_payment_pct: n(E.down.value) || 10,
        occupancy_rate: E.swRev.checked ? (n(E.occ.value) || 90) : 100,
        opex_rate: E.swRev.checked ? (n(E.opex.value) || 15) : 0,
        agent_fee_months: E.swRev.checked ? (n(E.agentm.value) || 1) : 0,
        target_net_yield: 6,
        currency_code: 'THB',
        trace_id: `v5d_${Date.now()}`
      };
    }

    async function apiCall(endpoint, data) {
      const url = `${API_CONFIG.baseURL}${endpoint}`;
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), API_CONFIG.timeout);

      try {
        const response = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data),
          signal: controller.signal
        });

        clearTimeout(timeoutId);

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        return await response.json();
      } catch (error) {
        clearTimeout(timeoutId);
        if (error.name === 'AbortError') {
          throw new Error('Request timeout - please try again');
        }
        throw error;
      }
    }

    function parseApiResponse(data, rent) {
      const combined = data.combined_results || {};
      const yieldResults = combined.yield_results || {};
      const affordabilityResults = combined.affordability_results || {};

      const parseVal = (v) => parseFloat(v) || 0;

      const noiMonthly = parseVal(yieldResults.net_monthly_income);
      const pmt = parseVal(affordabilityResults.monthly_payment);
      const netMonthly = noiMonthly - pmt;

      return {
        rent: rent,
        noiMonthly: noiMonthly,
        netMonthly: netMonthly,
        grossYield: parseVal(yieldResults.gross_yield),
        netYield: parseVal(yieldResults.net_yield),
        coc: 0, // TODO: Calculate from equity
        dti: parseVal(affordabilityResults.dti_ratio),
        payback: parseVal(yieldResults.payback_years),
        pmt: pmt,
        loan: parseVal(affordabilityResults.loan_amount),
        cost_basis: 0, // TODO: Calculate
        equity: 0, // TODO: Calculate
        financeOn: pmt > 0,
        P: n(E.purchase.value) || 0,
        occ: E.swRev.checked ? (n(E.occ.value) || 90) / 100 : 1.0,
        opex: E.swRev.checked ? (n(E.opex.value) || 15) / 100 : 0.0
      };
    }

    function clsNetYield(v) { if (!isFinite(v)) return ''; return v >= 0.06 ? 'good' : (v >= 0.05 ? 'warn' : 'bad'); }
    function clsPayback(y) { if (!isFinite(y)) return ''; return y < 12 ? 'good' : (y <= 18 ? 'warn' : 'bad'); }
    function clsDTI(v) { if (!isFinite(v)) return ''; return v <= 0.30 ? 'good' : (v <= 0.40 ? 'warn' : 'bad'); }
    function clsCash(nu) { if (!isFinite(nu)) return ''; return nu >= 0 ? 'good' : 'bad'; }
    function clsCoC(v) { if (!isFinite(v)) return ''; return v < 0 ? 'bad' : (v > 0.10 ? 'good' : (v > 0.05 ? 'warn' : '')); }
    function setKpiClass(elm, cls) { if (!elm) return; elm.className = 'kpi kval ' + (cls || ''); }

    // ============================================================================
    // CAPITAL GAIN AI NOTE
    // ============================================================================

    /**
     * Generate AI Note for Capital Gain based on exit scenario
     * @param {Object} data - Calculation results
     * @returns {string} HTML formatted AI note
     */
    function generateCapitalGainAINote(data) {
      const {
        capitalGain,
        equity,
        priceGrowth,
        hasRevenue,
        holdingYears,
        purchase,
        terminalValue,
        cumulativeCF
      } = data;

      // Calculate metrics
      const roi = (capitalGain / equity) * 100;
      const actualGrowth = ((terminalValue / purchase - 1) / holdingYears * 100).toFixed(1);
      const appreciation = ((terminalValue / purchase - 1) * 100).toFixed(0);

      // === SCENARIO 1: NEGATIVE CAPITAL GAIN ===
      if (capitalGain < 0) {

        // Sub-case A: Low price growth + no revenue
        if (priceGrowth < 3 && !hasRevenue) {
          return `‚ùå Capital Gain ‡∏ï‡∏¥‡∏î‡∏•‡∏ö ${thb(capitalGain)} ‚Üí Exit price ‡∏ï‡πà‡∏≥‡πÄ‡∏Å‡∏¥‡∏ô (growth ${priceGrowth}%/‡∏õ‡∏µ) + ‡πÑ‡∏°‡πà‡∏°‡∏µ revenue ‡∏ä‡∏î‡πÄ‡∏ä‡∏¢ PMT ‚Üí ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: ‡∏õ‡∏£‡∏±‡∏ö Price Growth 4-5% ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡∏¥‡∏î Revenue`;
        }

        // Sub-case B: Normal growth but no revenue
        if (priceGrowth >= 3 && !hasRevenue) {
          const monthlyOut = Math.abs(cumulativeCF) / holdingYears / 12;
          return `‚ùå Capital Gain ‡∏ï‡∏¥‡∏î‡∏•‡∏ö ${thb(capitalGain)} ‚Üí Price growth ‡∏ï‡∏≤‡∏°‡∏Ñ‡∏≤‡∏î (${actualGrowth}%/‡∏õ‡∏µ) ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ revenue ‡∏ä‡∏î‡πÄ‡∏ä‡∏¢ ‚Üí ‡∏à‡πà‡∏≤‡∏¢‡∏ú‡πà‡∏≠‡∏ô ${thb(monthlyOut)}/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö ‚Üí ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: ‡∏´‡∏≤ tenant ‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤ exit ‡πÄ‡∏£‡πá‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏î‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡∏Ç‡∏≤‡∏î‡∏ó‡∏∏‡∏ô`;
        }

        // Sub-case C: Has revenue but short holding
        if (hasRevenue && holdingYears < 7) {
          return `‚ö†Ô∏è Capital Gain ‡∏ï‡∏¥‡∏î‡∏•‡∏ö ${thb(capitalGain)} ‚Üí Hold ‡πÄ‡∏û‡∏µ‡∏¢‡∏á ${holdingYears} ‡∏õ‡∏µ loan balance ‡∏¢‡∏±‡∏á‡∏™‡∏π‡∏á (${appreciation}% appreciation) ‚Üí ‡∏°‡∏µ revenue ‡∏ä‡πà‡∏ß‡∏¢‡πÅ‡∏•‡πâ‡∏ß Hold ‡∏ô‡∏≤‡∏ô 10-15 ‡∏õ‡∏µ‡∏à‡∏∞‡∏Ñ‡∏∏‡πâ‡∏°‡∏ó‡∏∏‡∏ô`;
        }

        // Sub-case D: Default negative
        return `‚ùå Capital Gain ‡∏ï‡∏¥‡∏î‡∏•‡∏ö ${thb(capitalGain)} ‚Üí ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö: Price Growth ${priceGrowth}%/‡∏õ‡∏µ ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏´‡∏°? | ‡∏°‡∏µ tenant ‡πÑ‡∏´‡∏°? | ‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏¢‡∏π‡πà‡πÄ‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏Ç‡∏≤‡∏¢?`;
      }

      // === SCENARIO 2: POSITIVE BUT LOW ===
      if (capitalGain > 0 && roi < 50) {
        return `‚ö†Ô∏è Capital Gain ‡∏ï‡πà‡∏≥ ${thb(capitalGain)} (ROI ${roi.toFixed(0)}%) ‚Üí ‡∏ú‡∏•‡∏ï‡∏≠‡∏ö‡πÅ‡∏ó‡∏ô‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏£ ‚Üí ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: ‡πÄ‡∏û‡∏¥‡πà‡∏° Price Growth ‡∏´‡∏£‡∏∑‡∏≠ Revenue ‡πÄ‡∏û‡∏∑‡πà‡∏≠ ROI >100%`;
      }

      // === SCENARIO 3: GOOD RETURN ===
      if (roi >= 50 && roi < 200) {
        return `‚úÖ Capital Gain ‡∏î‡∏µ ${thb(capitalGain)} (ROI ${roi.toFixed(0)}%) ‚Üí ‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏≤‡∏°‡πÄ‡∏õ‡πâ‡∏≤ (${actualGrowth}%/‡∏õ‡∏µ)${hasRevenue ? ' + ‡∏°‡∏µ revenue ‡∏ä‡πà‡∏ß‡∏¢' : ''} ‚Üí ‡∏ú‡∏•‡∏ï‡∏≠‡∏ö‡πÅ‡∏ó‡∏ô‡∏î‡∏µ ‡∏ñ‡πâ‡∏≤‡∏û‡∏≠‡πÉ‡∏à‡∏Ñ‡∏ß‡∏£ Hold ‡∏ï‡πà‡∏≠`;
      }

      // === SCENARIO 4: EXCELLENT RETURN ===
      if (roi >= 200) {
        return `üéâ Capital Gain ‡∏™‡∏π‡∏á ${thb(capitalGain)} (ROI ${roi.toFixed(0)}%!) ‚Üí ‡∏ú‡∏•‡∏ï‡∏≠‡∏ö‡πÅ‡∏ó‡∏ô‡∏î‡∏µ‡∏°‡∏≤‡∏Å${hasRevenue ? ' + ‡∏°‡∏µ revenue ‡πÄ‡∏™‡∏£‡∏¥‡∏°' : ''} ‚Üí Hold ‡∏ï‡πà‡∏≠‡∏Å‡πá‡∏î‡∏µ exit ‡∏Ç‡∏≤‡∏¢‡∏Å‡πá‡∏Ñ‡∏∏‡πâ‡∏°‡∏Ñ‡πà‡∏≤`;
      }

      // Fallback (should not reach here)
      return `‚ÑπÔ∏è Capital Gain: ${thb(capitalGain)} (ROI ${roi.toFixed(0)}%)`;
    }

    // ============================================================================
    // TIMELINE CHART FUNCTIONS
    // ============================================================================

    let timelineChart = null;

    function getTimelineDuration() {
      const tenorYears = parseInt(E.tenor?.value) || 30;
      const exitEnabled = E.exit_on?.checked || false;
      const exitYears = exitEnabled ? (parseInt(E.hold?.value) || 5) : 0;
      return Math.min(Math.max(tenorYears, exitYears, 30), 50);
    }

    function calculateTimelineScenario(rentMultiplier, displayYears) {
      const purchase = n(E.purchase.value) || 0;
      const rent = (n(E.rent.value) || 0) * rentMultiplier;
      const downPct = (n(E.down.value) || 10) / 100;
      const acqPct = (n(E.acq.value) || 3) / 100;
      const fitout = n(E.fit.value) || 0;
      const other = n(E.other.value) || 0;
      const occ = (n(E.occ.value) || 90) / 100;
      const opex = (n(E.opex.value) || 10) / 100;
      const agentMonths = n(E.agentm.value) || 1;
      const apr = n(E.rate.value) || 4.5;
      const tenor = parseInt(E.tenor.value) || 30;

      const exitEnabled = E.exit_on?.checked || false;
      const priceGrowth = exitEnabled ? (n(E.pgrow.value) || 3) : 3;
      const growthRate = priceGrowth / 100;

      // Check if financing is enabled
      const financingEnabled = E.swFin?.checked && n(E.salary.value) > 0;

      const costBasis = purchase * (1 + acqPct) + fitout + other;
      const equity = purchase * downPct + (purchase * acqPct) + fitout + other;
      const loan = financingEnabled ? (purchase - (purchase * downPct)) : 0;
      const pmt = financingEnabled ? PMT(apr, tenor, loan) : 0;

      // Initial values logged for debugging

      // Check if revenue is enabled
      const revenueEnabled = E.swRev?.checked || false;

      const rentEffective = revenueEnabled ? (rent * occ) : 0;
      const agentFee = revenueEnabled ? (rent * (agentMonths / 12)) : 0;
      const opexCost = revenueEnabled ? (rent * opex) : 0;
      const noiMonthly = rentEffective - agentFee - opexCost;
      const noiAnnual = noiMonthly * 12;

      const netMonthly = noiMonthly - pmt;
      const netAnnual = netMonthly * 12;

      // Cashflow calculations completed

      const timeline = [];
      let cumulativeCashflow = -equity;
      let cumulativeNOI = 0;
      let loanBalance = loan;
      let paybackYear = null;

      const annualPrincipal = (pmt * 12) * 0.45;

      for (let year = 0; year <= displayYears; year++) {
        if (year === 0) {
          // Year 0 initialization

          timeline.push({
            year: 0,
            netWorth: -equity,
            propertyValue: purchase,
            loanBalance: loan,
            cumulativeCashflow: -equity,
            cumulativeNOI: 0
          });
          continue;
        }

        // Year calculation in progress

        cumulativeCashflow += netAnnual;
        cumulativeNOI += noiAnnual;

        if (paybackYear === null && cumulativeNOI >= costBasis) {
          const prevCumNOI = cumulativeNOI - noiAnnual;
          const fraction = (costBasis - prevCumNOI) / noiAnnual;
          paybackYear = year - 1 + fraction;
        }

        if (year <= tenor) {
          loanBalance = Math.max(0, loanBalance - annualPrincipal);
        } else {
          loanBalance = 0;
        }

        const propertyValue = purchase * Math.pow(1 + growthRate, year);

        const currentEquity = propertyValue - loanBalance;

        let netWorth = cumulativeCashflow + currentEquity;
        // Year calculation completed

        const isExit = exitEnabled && year === (parseInt(E.hold.value) || 5);
        if (isExit) {
          const sellingCost = propertyValue * 0.03;
          const netProceeds = propertyValue - loanBalance - sellingCost;
          netWorth = cumulativeCashflow + netProceeds;

          // Exit year calculation completed
        }

        timeline.push({
          year,
          netWorth,
          propertyValue,
          loanBalance,
          cumulativeCashflow,
          cumulativeNOI,
          isExit
        });
      }

      return { timeline, paybackYear };
    }

    function calculateAllScenarios() {
      const displayYears = getTimelineDuration();
      const rent = n(E.rent.value) || 0;

      // If no revenue, all scenarios are the same
      if (rent === 0 || !(E.swRev?.checked)) {
        const scenario = calculateTimelineScenario(1.0, displayYears);
        return {
          displayYears,
          scenarios: {
            low: scenario,
            base: scenario,
            high: scenario
          }
        };
      }

      // Normal case with revenue
      const low = calculateTimelineScenario(0.9, displayYears);
      const base = calculateTimelineScenario(1.0, displayYears);
      const high = calculateTimelineScenario(1.1, displayYears);
      return { displayYears, scenarios: { low, base, high } };
    }

    // Helper function to get Y value at specific year (with interpolation)
    function getYValueAtYear(data, year) {
      if (!data || data.length === 0) return null;

      const index = Math.round(year);
      if (index < 0 || index >= data.length) return null;

      // For fractional years, use linear interpolation
      const floor = Math.floor(year);
      const ceil = Math.ceil(year);

      if (floor === ceil || ceil >= data.length) {
        return data[floor];
      }

      const fraction = year - floor;
      return data[floor] + (data[ceil] - data[floor]) * fraction;
    }

    function renderTimelineChart() {
      const data = calculateAllScenarios();
      const { displayYears, scenarios } = data;

      const years = scenarios.base.timeline.map(d => d.year);
      const lowData = scenarios.low.timeline.map(d => d.netWorth);
      const baseData = scenarios.base.timeline.map(d => d.netWorth);
      const highData = scenarios.high.timeline.map(d => d.netWorth);

      // Store payback data globally for tooltip and legend
      window.paybackYears = {
        low: scenarios.low.paybackYear || null,
        base: scenarios.base.paybackYear || null,
        high: scenarios.high.paybackYear || null
      };

      // Update Legend
      const pbLegendLow = document.getElementById('pb-legend-low');
      const pbLegendBase = document.getElementById('pb-legend-base');
      const pbLegendHigh = document.getElementById('pb-legend-high');

      if (pbLegendLow) pbLegendLow.textContent = window.paybackYears.low ? window.paybackYears.low.toFixed(1) : '‚Äî';
      if (pbLegendBase) pbLegendBase.textContent = window.paybackYears.base ? window.paybackYears.base.toFixed(1) : '‚Äî';
      if (pbLegendHigh) pbLegendHigh.textContent = window.paybackYears.high ? window.paybackYears.high.toFixed(1) : '‚Äî';

      // Property Value data (same for all scenarios - based on purchase price growth)
      const propertyValueData = scenarios.base.timeline.map(d => d.propertyValue);

      // Loan Balance data (decreasing over time)
      const loanBalanceData = scenarios.base.timeline.map(d => d.loanBalance);

      const canvas = document.getElementById('timeline-canvas');
      if (!canvas) return;
      const ctx = canvas.getContext('2d');

      if (timelineChart) timelineChart.destroy();

      const annotations = {};

      // Crosshair - vertical line that follows mouse
      annotations.crosshair = {
        type: 'line',
        xMin: 0,
        xMax: 0,
        borderColor: 'rgba(167, 176, 187, 0.3)',
        borderWidth: 1,
        borderDash: [5, 5],
        display: false
      };

      // Payback markers - circular points on the Net Worth lines
      if (document.getElementById('show-payback')?.checked) {
        const paybackLow = scenarios.low.paybackYear;
        if (paybackLow && paybackLow <= displayYears) {
          const yValue = getYValueAtYear(lowData, paybackLow);
          if (yValue !== null) {
            annotations.paybackLow = {
              type: 'point',
              xValue: paybackLow,
              yValue: yValue,
              backgroundColor: '#ef4444',
              borderColor: '#ef4444',
              borderWidth: 2,
              radius: 6,
              pointStyle: 'circle'
            };
          }
        }

        const paybackBase = scenarios.base.paybackYear;
        if (paybackBase && paybackBase <= displayYears) {
          const yValue = getYValueAtYear(baseData, paybackBase);
          if (yValue !== null) {
            annotations.paybackBase = {
              type: 'point',
              xValue: paybackBase,
              yValue: yValue,
              backgroundColor: '#15d4cf',
              borderColor: '#15d4cf',
              borderWidth: 2,
              radius: 7,
              pointStyle: 'circle'
            };
          }
        }

        const paybackHigh = scenarios.high.paybackYear;
        if (paybackHigh && paybackHigh <= displayYears) {
          const yValue = getYValueAtYear(highData, paybackHigh);
          if (yValue !== null) {
            annotations.paybackHigh = {
              type: 'point',
              xValue: paybackHigh,
              yValue: yValue,
              backgroundColor: '#22c55e',
              borderColor: '#22c55e',
              borderWidth: 2,
              radius: 6,
              pointStyle: 'circle'
            };
          }
        }
      }

      // Loan Paid Off marker - always show (not controlled by toggle)
      const tenorYears = parseInt(E.tenor.value) || 30;
      if (tenorYears <= displayYears) {
        annotations.loanPaid = {
          type: 'line',
          xMin: tenorYears,
          xMax: tenorYears,
          borderColor: '#f59e0b',
          borderWidth: 2,
          borderDash: [8, 4],
          label: {
            display: true,
            content: `üè† Loan Paid Off`,
            position: 'end',
            backgroundColor: 'rgba(245, 158, 11, 0.9)',
            color: 'white',
            font: { size: 11 }
          }
        };
      }

      const exitEnabled = E.exit_on?.checked || false;
      if (exitEnabled) {
        const exitYear = parseInt(E.hold.value) || 5;
        if (exitYear <= displayYears) {
          annotations.exit = {
            type: 'line',
            xMin: exitYear,
            xMax: exitYear,
            borderColor: '#8b5cf6',
            borderWidth: 3,
            label: {
              display: true,
              content: `üèÅ Exit (${exitYear}y)`,
              position: 'center',
              backgroundColor: '#8b5cf6',
              color: 'white',
              font: { size: 12, weight: 'bold' }
            }
          };
        }
      }

      // Prepare datasets array
      const datasets = [
        {
          label: 'Property Value',
          data: propertyValueData,
          borderColor: '#8b5cf6',
          backgroundColor: 'rgba(139, 92, 246, 0.1)',
          borderWidth: 2,
          borderDash: [8, 4],
          tension: 0.4,
          fill: false,
          pointRadius: 0,
          pointHoverRadius: 4
        }
      ];

      // Add Loan Balance line only if toggle is checked
      if (document.getElementById('show-loan-paid')?.checked) {
        datasets.push({
          label: 'üè¶ Loan Balance',
          data: loanBalanceData,
          borderColor: '#f59e0b',
          backgroundColor: 'rgba(245, 158, 11, 0.1)',
          borderWidth: 2,
          borderDash: [5, 5],
          tension: 0.4,
          fill: false,
          pointRadius: 0,
          pointHoverRadius: 4
        });
      }

      // Add Net Worth scenarios
      datasets.push(
        {
          label: 'High (+10%)',
          data: highData,
          borderColor: '#22c55e',
          borderWidth: 2.5,
          tension: 0.4,
          fill: false,
          pointRadius: 0,
          pointHoverRadius: 5
        },
        {
          label: 'Base',
          data: baseData,
          borderColor: '#15d4cf',
          borderWidth: 3,
          tension: 0.4,
          fill: false,
          pointRadius: 0,
          pointHoverRadius: 6
        },
        {
          label: 'Low (-10%)',
          data: lowData,
          borderColor: '#ef4444',
          borderWidth: 2.5,
          tension: 0.4,
          fill: false,
          pointRadius: 0,
          pointHoverRadius: 5
        }
      );

      // Custom plugin for colored tooltip labels
      const coloredTooltipPlugin = {
        id: 'coloredTooltip',
        beforeDraw: (chart) => {
          const tooltip = chart.tooltip;
          if (tooltip && tooltip._active && tooltip._active.length) {
            const ctx = chart.ctx;
            ctx.save();

            // Custom rendering will be handled by labelTextColor callback

            ctx.restore();
          }
        }
      };

      timelineChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: years,
          datasets: datasets
        },
        plugins: [coloredTooltipPlugin],
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { mode: 'index', intersect: false },
          plugins: {
            legend: {
              display: true,
              position: 'top',
              labels: { color: '#e9eef3', font: { size: 12 }, usePointStyle: true, padding: 15 }
            },
            tooltip: {
              backgroundColor: 'rgba(0, 0, 0, 0.95)',
              titleColor: '#15d4cf',
              bodyColor: '#e9eef3',
              borderColor: 'rgba(255, 255, 255, 0.1)',
              borderWidth: 1,
              padding: 14,
              cornerRadius: 10,
              bodySpacing: 6,
              footerMarginTop: 10,
              displayColors: false,
              titleFont: {
                size: 14,
                weight: 'bold',
                family: 'system-ui, -apple-system, sans-serif'
              },
              bodyFont: {
                size: 12,
                family: 'system-ui, -apple-system, sans-serif',
                lineHeight: 1.8
              },
              footerColor: '#a7b0bb',
              footerFont: {
                size: 11,
                family: 'system-ui, -apple-system, sans-serif'
              },
              callbacks: {
                title: (items) => {
                  return `Year ${items[0].label}`;
                },
                label: (context) => {
                  const datasetLabel = context.dataset.label;
                  const value = context.parsed.y;

                  // Show all datasets (Net Worth, Property Value, Loan Balance)
                  let label = '';

                  if (datasetLabel.includes('High')) {
                    label = 'High Net Worth:';
                  } else if (datasetLabel.includes('Base')) {
                    label = 'Base Net Worth:';
                  } else if (datasetLabel.includes('Low')) {
                    label = 'Low Net Worth:';
                  } else if (datasetLabel === 'Property Value') {
                    label = 'Property Value:';
                  } else if (datasetLabel && datasetLabel.includes('Loan Balance')) {
                    label = 'Loan Balance:';
                  } else {
                    return null;
                  }

                  // Format value in millions with proper spacing
                  const valueInM = (value / 1000000).toFixed(2);
                  const spacing = ' '.repeat(Math.max(0, 20 - label.length));

                  // Add emoji for Property and Loan
                  let icon = '‚óè';
                  if (datasetLabel === 'Property Value') icon = 'üè†';
                  else if (datasetLabel && datasetLabel.includes('Loan Balance')) icon = 'üí≥';

                  return `${icon} ${label}${spacing}${valueInM}M ‡∏ø`;
                },
                labelTextColor: (context) => {
                  const label = context.dataset.label;
                  if (label && label.includes('High')) return '#22c55e';
                  if (label && label.includes('Base')) return '#15d4cf';
                  if (label && label.includes('Low')) return '#ef4444';
                  if (label === 'Property Value') return '#8b5cf6';
                  if (label && label.includes('Loan Balance')) return '#f59e0b';
                  return '#e9eef3';
                },
                labelPointStyle: () => {
                  return {
                    pointStyle: 'circle',
                    rotation: 0
                  };
                },
                afterBody: (tooltipItems) => {
                  // No need for afterBody anymore since we show everything in label
                  return [];
                },
                footer: (tooltipItems) => {
                  // Calculate range from Net Worth scenarios only
                  const values = tooltipItems
                    .filter(item => item.dataset.label && item.dataset.label.includes('Net Worth'))
                    .map(item => item.parsed.y);

                  if (values.length === 0) return '';

                  const high = Math.max(...values);
                  const low = Math.min(...values);
                  const range = ((high - low) / 1000000).toFixed(2);

                  return `\nRange: ${range}M ‡∏ø`;
                }
              }
            },
            annotation: { annotations: annotations }
          },
          scales: {
            x: {
              title: { display: true, text: 'Years', color: '#a7b0bb', font: { size: 12 } },
              grid: { color: 'rgba(255, 255, 255, 0.05)' },
              ticks: { color: '#a7b0bb', font: { size: 11 } }
            },
            y: {
              title: { display: true, text: 'Net Worth (‡∏ø)', color: '#a7b0bb', font: { size: 12 } },
              grid: { color: 'rgba(255, 255, 255, 0.05)' },
              ticks: {
                color: '#a7b0bb',
                font: { size: 11 },
                callback: (value) => {
                  if (value >= 1000000) return (value / 1000000).toFixed(1) + 'M';
                  if (value >= 1000) return (value / 1000).toFixed(0) + 'K';
                  return value;
                }
              }
            }
          },
          onHover: (event, activeElements, chart) => {
            const canvasPosition = Chart.helpers.getRelativePosition(event, chart);
            const dataX = chart.scales.x.getValueForPixel(canvasPosition.x);

            if (dataX !== null && dataX >= 0 && dataX <= displayYears) {
              chart.options.plugins.annotation.annotations.crosshair.xMin = dataX;
              chart.options.plugins.annotation.annotations.crosshair.xMax = dataX;
              chart.options.plugins.annotation.annotations.crosshair.display = true;
              chart.update('none');
            }
          }
        }
      });

      // Add mouse leave handler to hide crosshair
      canvas.addEventListener('mouseleave', () => {
        if (timelineChart && timelineChart.options.plugins.annotation.annotations.crosshair) {
          timelineChart.options.plugins.annotation.annotations.crosshair.display = false;
          timelineChart.update('none');
        }
      });
    }

    function toggleTimeline() {
      const card = document.getElementById('timeline-card');
      const toggleBtn = document.getElementById('timeline-toggle-btn');
      const hideBtn = document.getElementById('timeline-hide-btn');
      const isVisible = card.style.display !== 'none';

      if (!isVisible) {
        // Show chart
        card.style.display = 'block';
        toggleBtn.textContent = 'üìä Hide Timeline';
        if (hideBtn) hideBtn.textContent = 'Hide';
        card.scrollIntoView({ behavior: 'smooth', block: 'start' });
        updateTimelineChart();
      } else {
        // Hide chart
        card.style.display = 'none';
        toggleBtn.textContent = 'üìä Show Investment Timeline';
      }
    }

    function closeTimeline() {
      document.getElementById('timeline-card').style.display = 'none';
      document.getElementById('timeline-toggle-btn').textContent = 'üìä Show Investment Timeline';
    }

    function updateTimelineChart() {
      const displayYears = getTimelineDuration();
      document.getElementById('timeline-title').textContent = `üìà ${displayYears}-Year Investment Timeline`;
      updateTimelineRemark();
      renderTimelineChart();
    }

    function updateTimelineRemark() {
      const exitEnabled = E.exit_on?.checked || false;
      const priceGrowth = exitEnabled ? (n(E.pgrow.value) || 3) : 3;
      const tenorYears = parseInt(E.tenor.value) || 30;
      const displayYears = getTimelineDuration();

      let remark = '';

      if (exitEnabled) {
        const exitYears = parseInt(E.hold.value) || 5;
        remark = `‚ÑπÔ∏è Using ${priceGrowth}% property appreciation from Exit settings. `;
        remark += `Exit at Year ${exitYears}. Loan tenor: ${tenorYears} years.`;
      } else {
        remark = `‚ÑπÔ∏è Using default ${priceGrowth}% property appreciation. `;
        remark += `Loan tenor: ${tenorYears} years.`;
      }

      document.getElementById('timeline-remark').innerHTML = remark;
    }

    /**
     * Generate AI Note comment for CoC Return
     * @param {number} coc - CoC value (decimal, e.g., 0.071 for 7.1%)
     * @param {number} netYield - Net Yield value (decimal)
     * @param {boolean} hasLeverage - True if Financing switch is ON
     * @returns {string} Formatted CoC comment
     */
    function getCoCComment(coc, netYield, hasLeverage) {
      const cocPct = (coc * 100).toFixed(1) + '%';

      // Case 1: Excellent (‚â•10%)
      if (coc >= 0.10) {
        return `CoC = ${cocPct} ‚Üí ‡∏î‡∏µ‡∏°‡∏≤‡∏Å, ‡∏°‡∏µ passive income ‡∏™‡∏π‡∏á (leverage ‡πÑ‡∏î‡πâ‡∏ú‡∏•)`;
      }

      // Case 2: Good (5-10%)
      if (coc >= 0.05) {
        return `CoC = ${cocPct} ‚Üí ‡∏î‡∏µ, ‡∏°‡∏µ passive income ‡∏™‡∏°‡πà‡∏≥‡πÄ‡∏™‡∏°‡∏≠`;
      }

      // Case 3: Fair (0-5%)
      if (coc >= 0) {
        // Special case: CoC ‚âà Net Yield (no leverage)
        if (!hasLeverage || Math.abs(coc - netYield) < 0.005) {
          return `CoC = ${cocPct} ‚Üí ‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á Net Yield (‡πÑ‡∏°‡πà‡∏°‡∏µ leverage)`;
        }
        return `CoC = ${cocPct} ‚Üí ‡∏û‡∏≠‡πÉ‡∏ä‡πâ, cashflow ‡∏ö‡∏ß‡∏Å‡∏ô‡πâ‡∏≠‡∏¢ (‡∏£‡∏≠ capital gain)`;
      }

      // Case 4: Slightly Negative (0 to -5%)
      if (coc >= -0.05) {
        return `CoC = ${cocPct} ‚Üí ‡∏ï‡∏¥‡∏î‡∏•‡∏ö‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢, ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö ‡πÅ‡∏ï‡πà‡πÑ‡∏î‡πâ asset (‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏≠‡∏≠‡∏°)`;
      }

      // Case 5: Very Negative (<-5%)
      return `CoC = ${cocPct} ‚Üí ‡∏ï‡∏¥‡∏î‡∏•‡∏ö‡∏°‡∏≤‡∏Å, ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡πÄ‡∏¢‡∏≠‡∏∞ (‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤‡∏•‡∏î loan ‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏≤ rent ‡∏™‡∏π‡∏á‡∏Ç‡∏∂‡πâ‡∏ô)`;
    }

    async function recalc() {
      if (isCalculating) return;

      // Don't call twoWayInvestment here as it's already called in input handlers

      const rentBase = n(E.rent.value);

      // Skip calculation if no basic inputs
      if (!rentBase && !n(E.purchase.value)) {
        clearOutputs();
        return;
      }

      isCalculating = true;
      showCalculating(true);

      try {
        const scLow = await computeScenario(rentBase, -0.10);
        const scBase = await computeScenario(rentBase, 0.00);
        const scHigh = await computeScenario(rentBase, +0.10);

        function setCard(sc, id) {
          const rentId = id === 'low' ? 'rent_low' : (id === 'high' ? 'rent_high' : 'rent_base');
          const nyId = id === 'low' ? 'ny_low' : (id === 'high' ? 'ny_high' : 'ny_base');
          const cfId = id === 'low' ? 'cf_low' : (id === 'high' ? 'cf_high' : 'cf_base');
          const dtiId = id === 'low' ? 'dti_low' : (id === 'high' ? 'dti_high' : 'dti_base');
          const pbId = id === 'low' ? 'pb_low' : (id === 'high' ? 'pb_high' : 'pb_base');
          const cocId = id === 'low' ? 'coc_low' : (id === 'high' ? 'coc_high' : 'coc_base');
          document.getElementById(rentId).textContent = thb(sc.rent);
          const nyEl = el(nyId), cfEl = el(cfId), dtiEl = el(dtiId), pbEl = el(pbId), cocEl = el(cocId);
          nyEl.textContent = pct(sc.netYield); nyEl.className = 'sc-val ' + clsNetYield(sc.netYield);
          cfEl.textContent = thb(sc.netMonthly); cfEl.className = 'sc-val ' + clsCash(sc.netMonthly);
          dtiEl.textContent = pct(sc.dti); dtiEl.className = 'sc-val ' + clsDTI(sc.dti);
          pbEl.textContent = isFinite(sc.payback) ? sc.payback.toFixed(1) + 'y' : '‚Äî'; pbEl.className = 'sc-val ' + clsPayback(sc.payback);
          cocEl.textContent = pct(sc.coc); cocEl.className = 'sc-val ' + clsCoC(sc.coc);
        }
        setCard(scLow, 'low'); setCard(scBase, 'base'); setCard(scHigh, 'high');

        const sc = activeScenario === 'low' ? scLow : (activeScenario === 'high' ? scHigh : scBase);
        document.getElementById('card-low').classList.toggle('active', activeScenario === 'low');
        document.getElementById('card-base').classList.toggle('active', activeScenario === 'base');
        document.getElementById('card-high').classList.toggle('active', activeScenario === 'high');

        // Investment details & equity box (for display hints)
        const useInv = E.swInv.checked;
        const P = n(E.purchase.value);
        const acqPct = useInv ? (n(E.acq.value) || 3) / 100 : 0;
        const fit = useInv ? (n(E.fit.value) || 0) : 0;
        const other = useInv ? (n(E.other.value) || 0) : 0;
        const acqCost = (Number.isFinite(P) ? P : 0) * acqPct;
        if (Number.isFinite(P)) {
          el('equity_box')?.classList?.toggle('dim', !useInv);
          el('equity_box').textContent = thb((P * (n(E.down.value) || 10) / 100) + fit + other);
          el('eq_down')?.classList?.toggle('dim', !useInv); el('eq_acq')?.classList?.toggle('dim', !useInv); el('eq_fo')?.classList?.toggle('dim', !useInv);
          el('eq_down').textContent = thb(P * (n(E.down.value) || 10) / 100);
          el('eq_acq').textContent = thb(acqCost);
          el('eq_fo').textContent = thb(fit + other);
          if (H.acq_thb) H.acq_thb.textContent = thb(acqCost).replace(' ‡∏ø', '');
        } else {
          if (el('equity_box')) el('equity_box').textContent = '‚Äî';
          if (el('eq_down')) el('eq_down').textContent = '‚Äî';
          if (el('eq_acq')) el('eq_acq').textContent = '‚Äî';
          if (el('eq_fo')) el('eq_fo').textContent = '‚Äî';
          if (H.acq_thb) H.acq_thb.textContent = '‚Äî';
        }

        // Revenue adv helpers for hints (dim if off)
        const useRev = E.swRev.checked;
        const occ = useRev ? clamp((n(E.occ.value) || 90) / 100, 0.5, 1) : 1.0;
        const opex = useRev ? clamp((n(E.opex.value) || 15) / 100, 0, 0.6) : 0.0;
        const agentm = useRev ? clamp(n(E.agentm.value) || 1, 0, 12) : 0;
        const rentEff = (n(E.rent.value) || 0) * occ; const agentTHB = (n(E.rent.value) || 0) * (agentm / 12); const opexTHB = (n(E.rent.value) || 0) * opex;
        ;['occ_eff', 'agent_thb', 'opex_thb'].forEach(id => { const k = el(id); if (k) k.parentElement.parentElement.classList.toggle('dim', !useRev); });
        if (H.occ_eff) H.occ_eff.textContent = Number.isFinite(rentEff) ? rentEff.toLocaleString('th-TH', { maximumFractionDigits: 0 }) : '‚Äî';
        if (H.agent_thb) H.agent_thb.textContent = Number.isFinite(agentTHB) ? agentTHB.toLocaleString('th-TH', { maximumFractionDigits: 0 }) : '‚Äî';
        if (H.opex_thb) H.opex_thb.textContent = Number.isFinite(opexTHB) ? opexTHB.toLocaleString('th-TH', { maximumFractionDigits: 0 }) : '‚Äî';

        // Key Metrics (with colors)
        // Set white color for 0, 0.0%, or - values
        const grossText = pct(sc.grossYield);
        O.gross.textContent = grossText;
        if (grossText === '‚Äî' || grossText === '0.0%' || sc.grossYield === 0) {
          O.gross.style.color = 'var(--text)';
          O.gross.classList.remove('good', 'warn', 'bad');
        } else {
          setKpiClass(O.gross, clsNetYield(sc.grossYield));
        }

        const netText = pct(sc.netYield);
        O.net.textContent = netText;
        if (netText === '‚Äî' || netText === '0.0%' || sc.netYield === 0) {
          O.net.style.color = 'var(--text)';
          O.net.classList.remove('good', 'warn', 'bad');
        } else {
          setKpiClass(O.net, clsNetYield(sc.netYield));
        }

        const cocText = pct(sc.coc);
        O.coc.textContent = cocText;
        if (cocText === '‚Äî' || !isFinite(sc.coc)) {
          O.coc.style.color = 'var(--text)';
          O.coc.classList.remove('good', 'warn', 'bad');
        } else {
          setKpiClass(O.coc, clsCoC(sc.coc));
        }
        O.netmo.textContent = thb(sc.netMonthly); setKpiClass(O.netmo, clsCash(sc.netMonthly));
        O.pmt.textContent = thb(sc.pmt); setKpiClass(O.pmt, '');
        const dti = sc.dti; O.dti.textContent = pct(dti); setKpiClass(O.dti, clsDTI(dti));
        O.payback.textContent = isFinite(sc.payback) ? sc.payback.toFixed(1) + ' yrs' : '‚Äî'; setKpiClass(O.payback, clsPayback(sc.payback));

        // Affordability (clear if financing off)
        if (sc.financeOn && Number.isFinite(sc.loan)) {
          const pmt = sc.pmt;
          const tenorYears = E.swFin.checked ? +(E.tenor.value || 30) : 30;
          const totInterest = pmt * tenorYears * 12 - sc.loan;
          O.loan_amt.textContent = thb(sc.loan);
          O.pmt2.textContent = thb(pmt);
          O.tot_int.textContent = thb(totInterest);
          // Update Total Interest label with tenor years
          document.getElementById('tot_int_label').textContent = `Total Interest (${tenorYears}y)`;

          // DTI color coding
          if (isFinite(dti)) {
            if (dti > 0.4) {
              O.aff_warn.textContent = 'High Risk: DTI > 40%.';
              O.aff_warn.style.color = 'var(--bad)';
            } else if (dti > 0.3) {
              O.aff_warn.textContent = 'Caution: DTI 30‚Äì40%.';
              O.aff_warn.style.color = 'var(--warn)';
            } else if (dti < 0.2) {
              O.aff_warn.textContent = 'Excellent: DTI < 20%.';
              O.aff_warn.style.color = 'var(--good)';
            } else {
              O.aff_warn.textContent = 'OK: DTI ‚â§ 30%.';
              O.aff_warn.style.color = 'var(--text)';
            }
          } else {
            O.aff_warn.textContent = '‚Äî';
            O.aff_warn.style.color = 'var(--muted)';
          }
        } else {
          O.loan_amt.textContent = '‚Äî';
          O.pmt2.textContent = '‚Äî';
          O.tot_int.textContent = '‚Äî';
          document.getElementById('tot_int_label').textContent = 'Total Interest';
          O.aff_warn.textContent = '‡∏Å‡∏£‡∏≠‡∏Å Salary ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô DTI/PMT';
          O.aff_warn.style.color = 'var(--muted)';
        }

        // Exit & IRR (uses active scenario for cashflow-dependent calculations)
        let tval = NaN, npro = NaN, cgain = NaN, irr = NaN, em = NaN;

        if (E.exit_on.checked && Number.isFinite(P) && Number.isFinite(n(E.hold.value)) && Number.isFinite(n(E.pgrow.value))) {
          const hold = n(E.hold.value) || 5, g = Math.max(n(E.pgrow.value) || 0, 0) / 100, scsell = clamp((n(E.sellc.value) || 0) / 100, 0, 0.20);
          const useExit = E.swExit.checked;
          const manual = useExit ? (n(E.exit_price.value) || 0) : 0;
          const term = (manual > 0) ? manual : P * Math.pow(1 + g, hold);
          const tax = useExit ? Math.max(n(E.tax_pct.value) || 0, 0) / 100 : 0;
          // need cost basis consistent with Investment switch:
          const useInv = E.swInv.checked; const acqPct = useInv ? (n(E.acq.value) || 3) / 100 : 0;
          const fit = useInv ? (n(E.fit.value) || 0) : 0; const other = useInv ? (n(E.other.value) || 0) : 0;
          const cost_basis = P + P * acqPct + fit + other;

          const sellCosts = term * scsell; const taxTHB = Math.max(term - cost_basis, 0) * tax;
          tval = term;

          // Calculate remaining loan balance at exit
          const annualCF = sc.netMonthly * 12;
          const equity = sc.equity;
          const loan = sc.loan || 0;
          const pmt = sc.pmt || 0;
          const annualPrincipal = (pmt * 12) * 0.45; // Approximate principal portion
          let remainingLoan = loan;
          for (let y = 1; y <= hold; y++) {
            if (y <= 30) { // tenor
              remainingLoan = Math.max(0, remainingLoan - annualPrincipal);
            } else {
              remainingLoan = 0;
            }
          }

          // Net Proceeds = Terminal Value - Loan Balance - Selling Costs - Tax
          npro = term - remainingLoan - sellCosts - taxTHB;

          // Capital Gain = Net Proceeds + Cumulative Cashflow - Initial Equity
          // Net Proceeds already has loan balance deducted
          // Cumulative Cashflow is negative (cash out for loan payments)
          const cumulativeCF = annualCF * hold;
          cgain = npro + cumulativeCF - equity;

          if (equity > 0) { em = (annualCF * hold + npro) / equity; }
          const flows = [-equity];
          for (let y = 1; y <= hold; y++) {
            flows.push(y === hold ? (annualCF + npro) : annualCF);
          }

          irr = IRR(flows);
        }
        O.tval.textContent = Number.isFinite(tval) ? thb(tval) : '‚Äî';
        O.npro.textContent = Number.isFinite(npro) ? thb(npro) : '‚Äî';
        O.cgain.textContent = Number.isFinite(cgain) ? thb(cgain) : '‚Äî';

        // Capital Gain color: red if negative
        if (Number.isFinite(cgain)) {
          O.cgain.style.color = cgain < 0 ? 'var(--bad)' : 'var(--text)';
        } else {
          O.cgain.style.color = 'var(--text)';
        }

        // IRR color: white for 0/-, red if negative
        if (Number.isFinite(irr)) {
          O.irr.textContent = (irr * 100).toFixed(1) + '%';
          if (irr < 0) {
            O.irr.style.color = 'var(--bad)';
          } else if (irr === 0) {
            O.irr.style.color = 'var(--text)';
          } else {
            O.irr.style.color = 'var(--text)';
          }
        } else {
          O.irr.textContent = '‚Äî';
          O.irr.style.color = 'var(--text)';
        }

        O.emult.textContent = Number.isFinite(em) ? em.toFixed(2) + '√ó' : '‚Äî';

        // Status pills
        const pills = [];
        function Ppill(txt, cls) { pills.push('<span class="pill ' + cls + '">' + txt + '</span>'); }
        Ppill(sc.netYield >= 0.06 ? 'Net ‚â• 6%' : 'Net < 6%', clsNetYield(sc.netYield));
        if (isFinite(dti)) { if (dti > 0.40) Ppill('DTI > 40%', 'bad'); else if (dti > 0.30) Ppill('DTI 30‚Äì40%', 'warn'); else Ppill('DTI ‚â§ 30%', 'good'); }
        Ppill(sc.netMonthly >= 0 ? 'Cashflow ‡∏ö‡∏ß‡∏Å' : 'Cashflow ‡∏ï‡∏¥‡∏î‡∏•‡∏ö', clsCash(sc.netMonthly));
        document.getElementById('status_pills').innerHTML = pills.join(' ');

        // AI Note
        const lines = [];

        // Build default AI Note lines
        if (isFinite(sc.netYield)) lines.push('Net Yield = ' + pct(sc.netYield) + ' ‚Üí ' + (sc.netYield >= 0.07 ? '‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ï‡∏•‡∏≤‡∏î ‚Äî ‡∏ô‡πà‡∏≤‡∏™‡∏ô‡πÉ‡∏à' : (sc.netYield >= 0.06 ? '‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ï‡∏•‡∏≤‡∏î ‚Äî ‡∏û‡∏≠‡πÉ‡∏ä‡πâ' : '‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ï‡∏•‡∏≤‡∏î ‚Äî ‡∏Ñ‡∏ß‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏°‡∏ï‡∏¥‡∏ê‡∏≤‡∏ô')));

        // CoC Comment (NEW v6.1)
        if (isFinite(sc.coc)) {
          lines.push(getCoCComment(sc.coc, sc.netYield, E.swFin.checked));
        }

        if (isFinite(sc.payback)) lines.push('Payback = ' + (isFinite(sc.payback) ? sc.payback.toFixed(1) : '‚Äî') + ' ‡∏õ‡∏µ ‚Üí ' + (sc.payback < 12 ? '‡πÄ‡∏£‡πá‡∏ß' : (sc.payback <= 18 ? '‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á' : '‡∏ä‡πâ‡∏≤')));
        if (isFinite(dti)) lines.push('DTI = ' + pct(dti) + ' ‚Üí ' + (dti <= 0.30 ? '‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢' : (dti <= 0.40 ? '‡πÄ‡∏ù‡πâ‡∏≤‡∏£‡∏∞‡∏ß‡∏±‡∏á' : '‡πÄ‡∏Å‡∏¥‡∏ô‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡πÅ‡∏ö‡∏á‡∏Å‡πå')));
        lines.push('Revenue advance: ' + (E.swRev.checked ? 'ON' : 'OFF') + ' ¬∑ Financing advance: ' + (E.swFin.checked ? 'ON' : 'OFF'));

        // If Exit is enabled and Capital Gain is calculated, add Capital Gain AI Note
        if (E.exit_on.checked && Number.isFinite(cgain)) {
          const capitalGainNote = generateCapitalGainAINote({
            capitalGain: cgain,
            equity: sc.equity,
            priceGrowth: n(E.pgrow.value) || 3,
            hasRevenue: E.swRev.checked,
            holdingYears: n(E.hold.value) || 5,
            purchase: P,
            terminalValue: tval,
            cumulativeCF: (sc.netMonthly * 12) * (n(E.hold.value) || 5)
          });

          // Combine default AI Note with Capital Gain analysis
          const defaultNote = lines.map(s => '<div>‚Ä¢ ' + s + '</div>').join('');
          const exitNote = '<div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border);"><strong>üìä Exit Analysis:</strong><br><div style="margin-top: 6px; line-height: 1.6;">' + capitalGainNote + '</div></div>';
          ai.innerHTML = defaultNote + exitNote;
        } else {
          // Default AI Note only (no Exit)
          ai.innerHTML = lines.map(s => '<div>‚Ä¢ ' + s + '</div>').join('');
        }

        // Update timeline if visible
        const timelineCard = document.getElementById('timeline-card');
        if (timelineCard && timelineCard.style.display !== 'none') {
          updateTimelineChart();
        }

      } catch (error) {
        console.error('Calculation error:', error);
        showError('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì: ' + error.message);
      } finally {
        isCalculating = false;
        showCalculating(false);
      }
    }

    function clearOutputs() {
      // Clear all output displays
      Object.values(O).forEach(el => {
        if (el && el.textContent !== undefined) {
          el.textContent = '‚Äî';
          el.className = 'kpi kval';
        }
      });
      el('status_pills').innerHTML = '';
    }

    function showCalculating(show) {
      // Add subtle loading indication
      const cards = document.querySelectorAll('.card');
      cards.forEach(card => {
        card.style.opacity = show ? '0.7' : '1';
      });
    }

    function showError(message) {
      // Show error in AI note area
      if (ai) {
        ai.textContent = `‚ö†Ô∏è ${message}`;
        ai.style.color = 'var(--bad)';
        setTimeout(() => {
          ai.style.color = '';
          ai.textContent = '‚Äî';
        }, 5000);
      }
    }

    // v1.5: Tooltips functions
    async function loadTooltips() {
      try {
        const response = await fetch(`${API_CONFIG.baseURL}/tooltips`);
        if (response.ok) {
          const data = await response.json();
          tooltipsData = data.data || {};
        } else {
          console.warn('Tooltips API failed, using defaults');
          tooltipsData = DEFAULT_TOOLTIPS;
        }
      } catch (error) {
        console.warn('Tooltips loading failed:', error);
        tooltipsData = DEFAULT_TOOLTIPS;
      }

      // Always inject tooltips after loading
      injectTooltips();
    }

    function injectTooltips() {
      document.querySelectorAll('.tooltip-icon').forEach(icon => {
        const field = icon.getAttribute('data-tooltip');
        let content = tooltipsData[field] || DEFAULT_TOOLTIPS[field] || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠';

        // Remove existing tooltip content if any
        const existingTooltip = icon.querySelector('.tooltip-content');
        if (existingTooltip) {
          existingTooltip.remove();
        }

        // Create tooltip content element
        const tooltipDiv = document.createElement('div');
        tooltipDiv.className = 'tooltip-content';

        // Convert pipe (|) to line breaks for better formatting
        // This prevents awkward line breaks in the middle of phrases
        const lines = content.split('|');
        lines.forEach((line, index) => {
          const textNode = document.createTextNode(line.trim());
          tooltipDiv.appendChild(textNode);
          if (index < lines.length - 1) {
            tooltipDiv.appendChild(document.createElement('br'));
          }
        });

        icon.appendChild(tooltipDiv);

        // DO NOT set title attribute - it causes double tooltips (vertical + horizontal)
        // Remove title attribute if it exists
        icon.removeAttribute('title');

        // Add hover event listeners for better control
        icon.addEventListener('mouseenter', function () {
          const tooltip = this.querySelector('.tooltip-content');
          if (tooltip) {
            tooltip.style.opacity = '1';
            tooltip.style.visibility = 'visible';
          }
        });

        icon.addEventListener('mouseleave', function () {
          const tooltip = this.querySelector('.tooltip-content');
          if (tooltip) {
            tooltip.style.opacity = '0';
            tooltip.style.visibility = 'hidden';
          }
        });
      });
    }

    // v1.6: Help Modal functions with Accordion
    function openHelpModal() {
      document.getElementById('help-modal').style.display = 'flex';
    }

    function closeHelpModal() {
      document.getElementById('help-modal').style.display = 'none';
    }

    // Accordion functionality
    function toggleAccordion(header) {
      const content = header.nextElementSibling;
      const isActive = content.classList.contains('active');

      // Toggle active state
      header.classList.toggle('active');
      content.classList.toggle('active');

      // Smooth scroll to section when opened
      if (!isActive) {
        setTimeout(() => {
          header.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }, 100);
      }
    }

    // Close modal when clicking outside
    window.addEventListener('click', function (event) {
      const modal = document.getElementById('help-modal');
      if (event.target === modal) {
        closeHelpModal();
      }
    });

    // scenario card clicks
    ['card-low', 'card-base', 'card-high'].forEach((id, i) => {
      const name = i === 0 ? 'low' : (i === 1 ? 'base' : 'high');
      const node = document.getElementById(id);
      node.addEventListener('click', async () => { activeScenario = name; await recalc(); });
    });
    // mobile segmented
    const segL = document.getElementById('seg-low'), segB = document.getElementById('seg-base'), segH = document.getElementById('seg-high');
    if (segL) { segL.addEventListener('click', () => { activeScenario = 'low'; segL.classList.add('active'); segB.classList.remove('active'); segH.classList.remove('active'); recalc(); }); }
    if (segB) { segB.addEventListener('click', () => { activeScenario = 'base'; segB.classList.add('active'); segL.classList.remove('active'); segH.classList.remove('active'); recalc(); }); }
    if (segH) { segH.addEventListener('click', () => { activeScenario = 'high'; segH.classList.add('active'); segL.classList.remove('active'); segB.classList.remove('active'); recalc(); }); }

    // Exit price Last-Edit-Wins logic
    let lastExitFieldEdited = null;

    if (E.exit_price) {
      E.exit_price.addEventListener('input', () => {
        lastExitFieldEdited = 'manual';
        // If user enters manual price, clear price growth to avoid confusion
        if (n(E.exit_price.value) > 0 && E.pgrow) {
          E.pgrow.value = '';
        }
      });
    }

    if (E.pgrow) {
      E.pgrow.addEventListener('input', () => {
        lastExitFieldEdited = 'growth';
        // If user enters price growth, clear manual price to avoid confusion
        if (n(E.pgrow.value) > 0 && E.exit_price) {
          E.exit_price.value = '0';
        }
      });
    }

    // Inputs update
    ['acq_pct', 'fitout', 'other', 'occ', 'opex', 'agentm', 'salary', 'down', 'rate', 'tenor', 'exit_on', 'hold', 'pgrow', 'sellc', 'exit_mode', 'exit_price', 'tax_pct', 'rent', 'tgt_gross']
      .forEach(id => { const node = el(id); if (node) { node.addEventListener('input', () => recalc()); node.addEventListener('change', () => recalc()); } });

    // Initialize everything
    document.addEventListener('DOMContentLoaded', function () {
      // v1.5: Help button
      document.getElementById('help-btn')?.addEventListener('click', openHelpModal);

      // v1.5: Load tooltips on page load
      loadTooltips();

      // Initial calculation
      recalc();
    });

    // Fallback if DOMContentLoaded already fired
    if (document.readyState === 'loading') {
      // Do nothing, DOMContentLoaded will fire
    } else {
      // DOM is already ready
      document.getElementById('help-btn')?.addEventListener('click', openHelpModal);
      loadTooltips();
      recalc();
    }
  </script>
</body>

</html>
